createservice util
=====

Creates a scaffold for a custom GraphQL mutation or query.

```shell
yarn workspace @app/${APP} createservice --help
```

Where `${APP}` is a name of an application in `apps/`, where a custom query or mutation will be generated.
For example, `apps/condo` has a name `@app/condo`, specified in `apps/condo/package.json` as a Yarn workspace.

To create a `CustomUserActionService.js` module, that will be saved to `domains/user/schema`, a following command should be executed:

```shell
yarn workspace @app/condo createservice user.CustomUserActionService --type queries
```

Pay attention to following:
- domain name should start with lower case, so we have `user`
- service name should end with `Service` postfix, so we have `CustomUserActionService`

After successful execution of this command, you will get a new module in `apps/[APP]/<domain>/schema` folder

Don't delete automatically generated comment "Generated by…" in resulting module.

Look carefully at errors of this generator, in most cases they are self-explanatory.

## Input validation

Validation should be performed in resolver.
Don't validate input in access control modules.

## Returning result

**When an instance of a Keystone list is to be returned, you should use data-access utils, that using Keystone database adapter under the hood.**
For example, `getById` from `@core/keystone/schema`.

```js
// some custom logic
// ...

const result = await getById('Property', id)
return result
```

Wrong usage, that will get you some weird effects (read below):

```js
return await Ticket.create(/*...*/)
```

This way from resolver we can query any set of fields for given Keystone list with any nesting.

For example, consider a `Property` schema and following custom Query: `customPropertyQuery( id: ID! ): Property`.
Suppose, that we have declared only `id name` fields in `apps/condo/domains/property/gql.js`. This will be the only fields, that utils from `generateServerUtils` will return.
Suppose, that we are using this custom query in a following way — `customPropertyQuery('asdf-123') { id name unitsCount organization { id name } }`.
This way we will get an error in resolver, because set of queried fields mismatches to what we have manually declared in `apps/condo/domains/property/gql.js`.

So, to avoid this side effect, use wrappers around Keystone database adapter.

## Debugging

### `null` is returned for some fields, that have a value in DB

Probably, you're not using wrappers from `@core/keystone/schema` to query data for returning result.
You're having a mismatch between what you're querying and what is actually returned.
Read "Returning result" section above.

## Testing

Pay attention to cover following cases:
- Catch all exceptions, supposed to be explicitly thrown in internal logic of custom query or mutation
- Execution of custom query or mutation from all roles 

Following cases may not be a subject of testing, **when they are already covered** in tests for appropriate Keystone list schema:
- Violations of database constraints
- Side effects, implemented in hooks of some Keystone list schema