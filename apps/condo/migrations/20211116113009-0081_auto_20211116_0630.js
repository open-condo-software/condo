// auto generated by kmigrator
// KMIGRATOR:0081_auto_20211116_0630:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi41IG9uIDIwMjEtMTEtMTYgMDY6MzAKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKaW1wb3J0IGRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24KCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAwODBfYXV0b18yMDIxMTExMV8xNDQwJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdtZXRlcnJlYWRpbmcnLAogICAgICAgICAgICBuYW1lPSdwcm9wZXJ0eScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Gb3JlaWduS2V5KGJsYW5rPVRydWUsIGRiX2NvbHVtbj0ncHJvcGVydHknLCBudWxsPVRydWUsIG9uX2RlbGV0ZT1kamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uLkRPX05PVEhJTkcsIHJlbGF0ZWRfbmFtZT0nKycsIHRvPSdfZGphbmdvX3NjaGVtYS5wcm9wZXJ0eScpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nbWV0ZXJyZWFkaW5nJywKICAgICAgICAgICAgbmFtZT0ndW5pdE5hbWUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdtZXRlcnJlYWRpbmdoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0ncHJvcGVydHknLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdtZXRlcnJlYWRpbmdoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0ndW5pdE5hbWUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field property to meterreading
--
ALTER TABLE "MeterReading" ADD COLUMN "property" uuid NULL CONSTRAINT "MeterReading_property_30fef7b6_fk_Property_id" REFERENCES "Property"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "MeterReading_property_30fef7b6_fk_Property_id" IMMEDIATE;
--
-- Add field unitName to meterreading
--
ALTER TABLE "MeterReading" ADD COLUMN "unitName" text NULL;
--
-- Add field property to meterreadinghistoryrecord
--
ALTER TABLE "MeterReadingHistoryRecord" ADD COLUMN "property" uuid NULL;
--
-- Add field unitName to meterreadinghistoryrecord
--
ALTER TABLE "MeterReadingHistoryRecord" ADD COLUMN "unitName" text NULL;
CREATE INDEX "MeterReading_property_30fef7b6" ON "MeterReading" ("property");

-- Update existing meter reading properties and unitNames

    UPDATE "MeterReading" SET "property" = (SELECT "property" FROM "Meter" WHERE "Meter".id = "MeterReading".meter);
    UPDATE "MeterReading" SET "unitName" = (SELECT "unitName" FROM "Meter" WHERE "Meter".id = "MeterReading".meter);

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field unitName to meterreadinghistoryrecord
--
ALTER TABLE "MeterReadingHistoryRecord" DROP COLUMN "unitName" CASCADE;
--
-- Add field property to meterreadinghistoryrecord
--
ALTER TABLE "MeterReadingHistoryRecord" DROP COLUMN "property" CASCADE;
--
-- Add field unitName to meterreading
--
ALTER TABLE "MeterReading" DROP COLUMN "unitName" CASCADE;
--
-- Add field property to meterreading
--
ALTER TABLE "MeterReading" DROP COLUMN "property" CASCADE;
COMMIT;

    `)
}
