// auto generated by kmigrator
// KMIGRATOR:0483_remove_customvalue_unique_organization_customfield_objectid_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDUuMS40IG9uIDIwMjUtMDktMjkgMTY6MjIKCmltcG9ydCBkamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzA0ODJfYjJiYXBwYWNjZXNzcmlnaHRzZXRfY2FuZXhlY3V0ZXNldHBheW1lbnRwb3NyZWNlaXB0dXJsX2FuZF9tb3JlJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUNvbnN0cmFpbnQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2N1c3RvbXZhbHVlJywKICAgICAgICAgICAgbmFtZT0ndW5pcXVlX29yZ2FuaXphdGlvbl9jdXN0b21GaWVsZF9vYmplY3RJZCcsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdjdXN0b21maWVsZCcsCiAgICAgICAgICAgIG5hbWU9J3NjaGVtYU5hbWUnLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5SZW1vdmVGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nY3VzdG9tZmllbGRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nc2NoZW1hTmFtZScsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdjdXN0b212YWx1ZScsCiAgICAgICAgICAgIG5hbWU9J29iamVjdElkJywKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuUmVtb3ZlRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2N1c3RvbXZhbHVlaGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J29iamVjdElkJywKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2N1c3RvbWZpZWxkJywKICAgICAgICAgICAgbmFtZT0nbW9kZWxOYW1lJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkNoYXJGaWVsZChkZWZhdWx0PSdtaWdyYXRpb24nLCBtYXhfbGVuZ3RoPTUwKSwKICAgICAgICAgICAgcHJlc2VydmVfZGVmYXVsdD1GYWxzZSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2N1c3RvbWZpZWxkaGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J21vZGVsTmFtZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2N1c3RvbXZhbHVlJywKICAgICAgICAgICAgbmFtZT0naXRlbUlkJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChkZWZhdWx0PSdtaWdyYXRpb24nKSwKICAgICAgICAgICAgcHJlc2VydmVfZGVmYXVsdD1GYWxzZSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2N1c3RvbXZhbHVlaGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2l0ZW1JZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2V4ZWN1dGlvbmFpZmxvd3Rhc2snLAogICAgICAgICAgICBuYW1lPSdpdGVtSWQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdleGVjdXRpb25haWZsb3d0YXNrJywKICAgICAgICAgICAgbmFtZT0nbW9kZWxOYW1lJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nZXhlY3V0aW9uYWlmbG93dGFzaycsCiAgICAgICAgICAgIG5hbWU9J29yZ2FuaXphdGlvbicsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Gb3JlaWduS2V5KGJsYW5rPVRydWUsIGRiX2NvbHVtbj0nb3JnYW5pemF0aW9uJywgbnVsbD1UcnVlLCBvbl9kZWxldGU9ZGphbmdvLmRiLm1vZGVscy5kZWxldGlvbi5TRVRfTlVMTCwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLm9yZ2FuaXphdGlvbicpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nZXhlY3V0aW9uYWlmbG93dGFza2hpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdpdGVtSWQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdleGVjdXRpb25haWZsb3d0YXNraGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J21vZGVsTmFtZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2V4ZWN1dGlvbmFpZmxvd3Rhc2toaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nb3JnYW5pemF0aW9uJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlVVSURGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSdjdXN0b212YWx1ZScsCiAgICAgICAgICAgIGNvbnN0cmFpbnQ9bW9kZWxzLlVuaXF1ZUNvbnN0cmFpbnQoY29uZGl0aW9uPW1vZGVscy5RKCgnZGVsZXRlZEF0X19pc251bGwnLCBUcnVlKSwgKCdpc1VuaXF1ZVBlck9iamVjdCcsIFRydWUpKSwgZmllbGRzPSgnb3JnYW5pemF0aW9uJywgJ2N1c3RvbUZpZWxkJywgJ2l0ZW1JZCcpLCBuYW1lPSd1bmlxdWVfb3JnYW5pemF0aW9uX2N1c3RvbUZpZWxkX2l0ZW1JZCcpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Remove constraint unique_organization_customField_objectId from model customvalue
--
-- DROP INDEX IF EXISTS "unique_organization_customField_objectId";
--
-- Remove field schemaName from customfield
--
-- ALTER TABLE "CustomField" DROP COLUMN "schemaName" CASCADE;
ALTER TABLE "CustomField" ALTER COLUMN "schemaName" DROP NOT NULL;
--
-- Remove field schemaName from customfieldhistoryrecord
--
-- ALTER TABLE "CustomFieldHistoryRecord" DROP COLUMN "schemaName" CASCADE;
--
-- Remove field objectId from customvalue
--
-- ALTER TABLE "CustomValue" DROP COLUMN "objectId" CASCADE;
ALTER TABLE "CustomValue" ALTER COLUMN "objectId" DROP NOT NULL;
--
-- Remove field objectId from customvaluehistoryrecord
--
-- ALTER TABLE "CustomValueHistoryRecord" DROP COLUMN "objectId" CASCADE;
--
-- Add field modelName to customfield
--
ALTER TABLE "CustomField" ADD COLUMN "modelName" varchar(50);
UPDATE "CustomField" SET "modelName" = "schemaName";
ALTER TABLE "CustomField" ALTER COLUMN "modelName" SET NOT NULL;
--
-- Add field modelName to customfieldhistoryrecord
--
ALTER TABLE "CustomFieldHistoryRecord" ADD COLUMN "modelName" text NULL;
UPDATE "CustomFieldHistoryRecord" SET "modelName" = "schemaName";
--
-- Add field itemId to customvalue
--
ALTER TABLE "CustomValue" ADD COLUMN "itemId" text;
UPDATE "CustomValue" SET "itemId" = "objectId";
ALTER TABLE "CustomValue" ALTER COLUMN "itemId" SET NOT NULL;
--
-- Add field itemId to customvaluehistoryrecord
--
ALTER TABLE "CustomValueHistoryRecord" ADD COLUMN "itemId" text NULL;
UPDATE "CustomValueHistoryRecord" SET "itemId" = "objectId";
--
-- Add field itemId to executionaiflowtask
--
ALTER TABLE "ExecutionAIFlowTask" ADD COLUMN "itemId" text NULL;
--
-- Add field modelName to executionaiflowtask
--
ALTER TABLE "ExecutionAIFlowTask" ADD COLUMN "modelName" text NULL;
--
-- Add field organization to executionaiflowtask
--
ALTER TABLE "ExecutionAIFlowTask" ADD COLUMN "organization" uuid NULL CONSTRAINT "ExecutionAIFlowTask_organization_5b29825e_fk_Organization_id" REFERENCES "Organization"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "ExecutionAIFlowTask_organization_5b29825e_fk_Organization_id" IMMEDIATE;
--
-- Add field itemId to executionaiflowtaskhistoryrecord
--
ALTER TABLE "ExecutionAIFlowTaskHistoryRecord" ADD COLUMN "itemId" text NULL;
--
-- Add field modelName to executionaiflowtaskhistoryrecord
--
ALTER TABLE "ExecutionAIFlowTaskHistoryRecord" ADD COLUMN "modelName" text NULL;
--
-- Add field organization to executionaiflowtaskhistoryrecord
--
ALTER TABLE "ExecutionAIFlowTaskHistoryRecord" ADD COLUMN "organization" uuid NULL;
--
-- Create constraint unique_organization_customField_itemId on model customvalue
--
CREATE UNIQUE INDEX "unique_organization_customField_itemId" ON "CustomValue" ("organization", "customField", "itemId") WHERE ("deletedAt" IS NULL AND "isUniquePerObject");
CREATE INDEX "ExecutionAIFlowTask_organization_5b29825e" ON "ExecutionAIFlowTask" ("organization");
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint unique_organization_customField_itemId on model customvalue
--
DROP INDEX IF EXISTS "unique_organization_customField_itemId";
--
-- Add field organization to executionaiflowtaskhistoryrecord
--
ALTER TABLE "ExecutionAIFlowTaskHistoryRecord" DROP COLUMN "organization" CASCADE;
--
-- Add field modelName to executionaiflowtaskhistoryrecord
--
ALTER TABLE "ExecutionAIFlowTaskHistoryRecord" DROP COLUMN "modelName" CASCADE;
--
-- Add field itemId to executionaiflowtaskhistoryrecord
--
ALTER TABLE "ExecutionAIFlowTaskHistoryRecord" DROP COLUMN "itemId" CASCADE;
--
-- Add field organization to executionaiflowtask
--
ALTER TABLE "ExecutionAIFlowTask" DROP COLUMN "organization" CASCADE;
--
-- Add field modelName to executionaiflowtask
--
ALTER TABLE "ExecutionAIFlowTask" DROP COLUMN "modelName" CASCADE;
--
-- Add field itemId to executionaiflowtask
--
ALTER TABLE "ExecutionAIFlowTask" DROP COLUMN "itemId" CASCADE;
--
-- Add field itemId to customvaluehistoryrecord
--
ALTER TABLE "CustomValueHistoryRecord" DROP COLUMN "itemId" CASCADE;
--
-- Add field itemId to customvalue
--
ALTER TABLE "CustomValue" DROP COLUMN "itemId" CASCADE;
--
-- Add field modelName to customfieldhistoryrecord
--
ALTER TABLE "CustomFieldHistoryRecord" DROP COLUMN "modelName" CASCADE;
--
-- Add field modelName to customfield
--
ALTER TABLE "CustomField" DROP COLUMN "modelName" CASCADE;
--
-- Remove field objectId from customvaluehistoryrecord
--
ALTER TABLE "CustomValueHistoryRecord" ADD COLUMN IF NOT EXISTS "objectId" text NULL;
--
-- Remove field objectId from customvalue
--
ALTER TABLE "CustomValue" ADD COLUMN IF NOT EXISTS "objectId" text NOT NULL;
--
-- Remove field schemaName from customfieldhistoryrecord
--
ALTER TABLE "CustomFieldHistoryRecord" ADD COLUMN IF NOT EXISTS "schemaName" text NULL;
--
-- Remove field schemaName from customfield
--
ALTER TABLE "CustomField" ADD COLUMN IF NOT EXISTS "schemaName" varchar(50) NOT NULL;
--
-- Remove constraint unique_organization_customField_objectId from model customvalue
--
CREATE UNIQUE INDEX IF NOT EXISTS "unique_organization_customField_objectId" ON "CustomValue" ("organization", "customField", "objectId") WHERE ("deletedAt" IS NULL AND "isUniquePerObject");
COMMIT;

    `)
}
