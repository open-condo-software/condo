// auto generated by kmigrator
// KMIGRATOR:0043_auto_20210817_1117:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi42IG9uIDIwMjEtMDgtMTcgMTE6MTcKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAwNDJfZGl2aXNpb25fZGl2aXNpb25fZXhlY3V0b3JzX21hbnlfZGl2aXNpb25fcHJvcGVydGllc19tYW55X2RpdmlzaW9uaGlzdG9yeXJlY29yZCcpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BbHRlckZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdkaXZpc2lvbmhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdyZXNwb25zaWJsZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uZW1wbG95ZWUnLAogICAgICAgICAgICBuYW1lPSdpZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQocHJpbWFyeV9rZXk9VHJ1ZSwgc2VyaWFsaXplPUZhbHNlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uZW1wbG95ZWUnLAogICAgICAgICAgICBuYW1lPSduZXdJZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uZW1wbG95ZWVoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0naGlzdG9yeV9pZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQoZGJfaW5kZXg9VHJ1ZSksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
        --
        -- These constraints depend on OrganizationEmployee.id column, that will be changed
        -- 
        ALTER TABLE "Division" DROP CONSTRAINT "Division_responsible_eed68a68_fk_OrganizationEmployee_id";
        ALTER TABLE "Division_executors_many" DROP CONSTRAINT "Division_executors_m_OrganizationEmployee_67cbc5c6_fk_Organizat";
        
        --
        -- Change type of OrganizationEmployee.id column from integer to uuid
        --
        
        CREATE EXTENSION if not exists "uuid-ossp";

        ALTER TABLE "OrganizationEmployee" RENAME COLUMN "id" TO "old_id";
        ALTER TABLE "OrganizationEmployee" ADD COLUMN "id" UUID NULL;

        UPDATE "OrganizationEmployee" SET "id" = uuid_generate_v4();

        ALTER TABLE "OrganizationEmployee" DROP CONSTRAINT "OrganizationEmployee_pkey";
        ALTER TABLE "OrganizationEmployee" ADD PRIMARY KEY ("id");

        ALTER TABLE "OrganizationEmployeeHistoryRecord" RENAME COLUMN "history_id" TO "old_history_id";
        ALTER TABLE "OrganizationEmployeeHistoryRecord" ADD COLUMN "history_id" UUID NULL;

        UPDATE "OrganizationEmployeeHistoryRecord" hr
        SET "history_id" = e."id"
        FROM "OrganizationEmployee" as e
        WHERE(
            e."old_id" = hr."old_history_id"
        );

        ALTER TABLE "OrganizationEmployeeHistoryRecord" ALTER COLUMN "history_id" SET NOT NULL;
        -- All future history record will not have old id anymore, because plugin does not saves them
        ALTER TABLE "OrganizationEmployeeHistoryRecord" ALTER COLUMN "old_history_id" DROP NOT NULL;

        ALTER TABLE "OrganizationEmployee" RENAME COLUMN "newId" TO "old_newId";
        ALTER TABLE "OrganizationEmployee" ADD COLUMN "newId" UUID NULL;
        
        
        --
        -- Change type of columns in all referenced tables
        --
        
        ALTER TABLE "DivisionHistoryRecord" DROP COLUMN "responsible";
        ALTER TABLE "DivisionHistoryRecord" ADD COLUMN "responsible" uuid NULL;

        ALTER TABLE "Division" DROP COLUMN "responsible";
        ALTER TABLE "Division" ADD COLUMN "responsible" uuid NOT NULL;
        ALTER TABLE "Division" ADD CONSTRAINT "Division_responsible_eed68a68_fk_OrganizationEmployee_id" FOREIGN KEY ("responsible") REFERENCES "OrganizationEmployee" ("id") DEFERRABLE INITIALLY DEFERRED;

        ALTER TABLE "Division_executors_many" DROP COLUMN "OrganizationEmployee_right_id";
        ALTER TABLE "Division_executors_many" ADD COLUMN "OrganizationEmployee_right_id" uuid NOT NULL;
        ALTER TABLE "Division_executors_many" ADD CONSTRAINT "Division_executors_m_OrganizationEmployee_67cbc5c6_fk_Organizat" FOREIGN KEY ("OrganizationEmployee_right_id") REFERENCES "OrganizationEmployee" ("id") DEFERRABLE INITIALLY DEFERRED;
    COMMIT;
    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
        --
        -- These constraints depend on OrganizationEmployee.id column, that will be changed
        -- 
        ALTER TABLE "Division" DROP CONSTRAINT "Division_responsible_eed68a68_fk_OrganizationEmployee_id";
        ALTER TABLE "Division_executors_many" DROP CONSTRAINT "Division_executors_m_OrganizationEmployee_67cbc5c6_fk_Organizat";
        
        
        --
        -- Change type of OrganizationEmployee.id column back to integer
        --
        
        ALTER TABLE "OrganizationEmployee" RENAME COLUMN "id" TO "_old_id";
        ALTER TABLE "OrganizationEmployee" RENAME COLUMN "old_id" TO "id";

        ALTER TABLE "OrganizationEmployeeHistoryRecord" RENAME COLUMN "history_id" TO "_old_history_id";
        ALTER TABLE "OrganizationEmployeeHistoryRecord" RENAME COLUMN "old_history_id" TO "history_id";

        ALTER TABLE "OrganizationEmployee" RENAME COLUMN "newId" TO "_old_newId";
        ALTER TABLE "OrganizationEmployee" RENAME COLUMN "old_newId" TO "newId";
        ALTER TABLE "OrganizationEmployee" DROP COLUMN "_old_newId";

        -- Set old format values of history_id, that was not saved after up-migration for further inserted rows
        UPDATE "OrganizationEmployeeHistoryRecord" hr
        SET "history_id" = e."id"
        FROM "OrganizationEmployee" as e
        WHERE(
            e."_old_id" = hr."_old_history_id" AND
            "history_id" IS NULL
        );
        ALTER TABLE "OrganizationEmployee" DROP CONSTRAINT "OrganizationEmployee_pkey";
        ALTER TABLE "OrganizationEmployee" ADD PRIMARY KEY ("id");
        ALTER TABLE "OrganizationEmployeeHistoryRecord" ALTER COLUMN "history_id" SET NOT NULL;
        ALTER TABLE "OrganizationEmployee" DROP COLUMN "_old_id";
        ALTER TABLE "OrganizationEmployeeHistoryRecord" DROP COLUMN "_old_history_id";
        
        
        --
        -- Change type of columns in all referenced tables
        --
        
        ALTER TABLE "DivisionHistoryRecord" DROP COLUMN "responsible";
        ALTER TABLE "DivisionHistoryRecord" ADD COLUMN "responsible" integer NULL CHECK ("responsible" >= 0);

        ALTER TABLE "Division" DROP COLUMN "responsible";
        ALTER TABLE "Division" ADD COLUMN "responsible" integer NOT NULL;
        ALTER TABLE "Division" ADD CONSTRAINT "Division_responsible_eed68a68_fk_OrganizationEmployee_id" FOREIGN KEY ("responsible") REFERENCES "OrganizationEmployee" ("id") DEFERRABLE INITIALLY DEFERRED;

        ALTER TABLE "Division_executors_many" DROP COLUMN "OrganizationEmployee_right_id";
        ALTER TABLE "Division_executors_many" ADD COLUMN "OrganizationEmployee_right_id" integer NOT NULL;
        ALTER TABLE "Division_executors_many" ADD CONSTRAINT "Division_executors_m_OrganizationEmployee_67cbc5c6_fk_Organizat" FOREIGN KEY ("OrganizationEmployee_right_id") REFERENCES "OrganizationEmployee" ("id") DEFERRABLE INITIALLY DEFERRED;
        
    COMMIT;
    `)
}
