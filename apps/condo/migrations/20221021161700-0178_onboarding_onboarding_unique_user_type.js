// auto generated by kmigrator
// KMIGRATOR:0178_onboarding_onboarding_unique_user_type:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMS4yIG9uIDIwMjItMTAtMjEgMTM6MTcKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAxNzdfYWx0ZXJfbXVsdGlwYXltZW50X3VzZXInKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkQ29uc3RyYWludCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb25ib2FyZGluZycsCiAgICAgICAgICAgIGNvbnN0cmFpbnQ9bW9kZWxzLlVuaXF1ZUNvbnN0cmFpbnQoY29uZGl0aW9uPW1vZGVscy5RKCgnZGVsZXRlZEF0X19pc251bGwnLCBUcnVlKSksIGZpZWxkcz0oJ3VzZXInLCAndHlwZScpLCBuYW1lPSdPbkJvYXJkaW5nX3VuaXF1ZV91c2VyX3R5cGUnKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';  

update "OnBoarding" t
SET "deletedAt" = '2022-10-21T11:11:12Z'
where t."deletedAt" IS NULL and exists (
  select 1 from "OnBoarding"
  where "user" = t."user" and "createdAt" < t."createdAt" and id != t."id" and "deletedAt" IS NULL
);
    
--
-- Create constraint OnBoarding_unique_user_type on model onboarding
--
CREATE UNIQUE INDEX "OnBoarding_unique_user_type" ON "OnBoarding" ("user", "type") WHERE "deletedAt" IS NULL;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint OnBoarding_unique_user_type on model onboarding
--
DROP INDEX IF EXISTS "OnBoarding_unique_user_type";
COMMIT;

    `)
}
