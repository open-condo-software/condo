// auto generated by kmigrator
// KMIGRATOR:0395_organizationemployeerole_deletedat_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDUtMjAgMDc6MDcKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzOTRfcGF5bWVudF9kZXBvc2l0ZWRkYXRlX3BheW1lbnRfdHJhbnNmZXJkYXRlX2FuZF9tb3JlJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdvcmdhbml6YXRpb25lbXBsb3llZXJvbGUnLAogICAgICAgICAgICBuYW1lPSdkZWxldGVkQXQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBkYl9pbmRleD1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uZW1wbG95ZWVyb2xlJywKICAgICAgICAgICAgbmFtZT0naXNEZWZhdWx0JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkJvb2xlYW5GaWVsZChkZWZhdWx0PUZhbHNlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J29yZ2FuaXphdGlvbmVtcGxveWVlcm9sZScsCiAgICAgICAgICAgIG5hbWU9J2lzRWRpdGFibGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGRlZmF1bHQ9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdvcmdhbml6YXRpb25lbXBsb3llZXJvbGUnLAogICAgICAgICAgICBuYW1lPSduZXdJZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J29yZ2FuaXphdGlvbmVtcGxveWVlcm9sZWhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdpc0RlZmF1bHQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdvcmdhbml6YXRpb25lbXBsb3llZXJvbGVoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0naXNFZGl0YWJsZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkQ29uc3RyYWludCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uZW1wbG95ZWVyb2xlJywKICAgICAgICAgICAgY29uc3RyYWludD1tb2RlbHMuVW5pcXVlQ29uc3RyYWludChjb25kaXRpb249bW9kZWxzLlEoKCdkZWxldGVkQXRfX2lzbnVsbCcsIFRydWUpKSwgZmllbGRzPSgnb3JnYW5pemF0aW9uJywgJ25hbWUnKSwgbmFtZT0nb3JnYW5pemF0aW9uX2VtcGxveWVlX3JvbGVfdW5pcXVlX29yZ2FuaXphdGlvbl9hbmRfbmFtZScpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';

--
-- Add field deletedAt to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" ADD COLUMN "deletedAt" timestamp with time zone NULL;
--
-- Add field isDefault to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" ADD COLUMN "isDefault" boolean DEFAULT false NOT NULL;
ALTER TABLE "OrganizationEmployeeRole" ALTER COLUMN "isDefault" DROP DEFAULT;
--
-- Add field isEditable to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" ADD COLUMN "isEditable" boolean DEFAULT true NOT NULL;
ALTER TABLE "OrganizationEmployeeRole" ALTER COLUMN "isEditable" DROP DEFAULT;
--
-- Add field newId to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" ADD COLUMN "newId" uuid NULL;
--
-- Add field isDefault to organizationemployeerolehistoryrecord
--
ALTER TABLE "OrganizationEmployeeRoleHistoryRecord" ADD COLUMN "isDefault" boolean NULL;
--
-- Add field isEditable to organizationemployeerolehistoryrecord
--
ALTER TABLE "OrganizationEmployeeRoleHistoryRecord" ADD COLUMN "isEditable" boolean NULL;
--
-- Create constraint organization_employee_role_unique_organization_and_name on model organizationemployeerole
--
CREATE UNIQUE INDEX "organization_employee_role_unique_organization_and_name" ON "OrganizationEmployeeRole" ("organization", "name") WHERE "deletedAt" IS NULL;
CREATE INDEX "OrganizationEmployeeRole_deletedAt_aad14361" ON "OrganizationEmployeeRole" ("deletedAt");

--
-- [CUSTOM] Set "isDefault"=true for default roles
--
UPDATE "OrganizationEmployeeRole"
SET "isDefault" = true
WHERE "name" = 'employee.role.Administrator.name'
    OR "name" = 'employee.role.Contractor.name'
    OR "name" = 'employee.role.Dispatcher.name'
    OR "name" = 'employee.role.Manager.name'
    OR "name" = 'employee.role.Foreman.name'
    OR "name" = 'employee.role.Technician.name';

--
-- [CUSTOM] Set all permissions to true and set "isEditable"=false for administrator role
--
UPDATE "OrganizationEmployeeRole"
SET ("v", "updatedAt", "isEditable", "canManageOrganization", "canReadEmployees", "canManageEmployees", "canManageRoles", "canManageIntegrations", "canReadProperties", "canManageProperties", "canReadDocuments", "canManageDocuments", "canReadTickets", "canManageTickets", "canManageMeters", "canManageMeterReadings", "canReadContacts", "canManageContacts", "canManageContactRoles", "canManageTicketComments", "canShareTickets", "canReadBillingReceipts", "canImportBillingReceipts", "canReadPayments", "canInviteNewOrganizationEmployees", "canBeAssignedAsResponsible", "canBeAssignedAsExecutor", "canManageTicketPropertyHints", "canManagePropertyScopes", "canManageBankAccounts", "canManageBankAccountReportTasks", "canManageBankIntegrationAccountContexts", "canManageBankIntegrationOrganizationContexts", "canManageBankContractorAccounts", "canManageBankTransactions", "canManageBankAccountReports", "canReadIncidents", "canManageIncidents", "canReadNewsItems", "canManageNewsItems", "canManageNewsItemTemplates", "canManageCallRecords", "canDownloadCallRecords", "canManageMobileFeatureConfigs", "canManageB2BApps", "canReadAnalytics", "canReadInvoices", "canManageInvoices", "canReadMarketItems", "canManageMarketItems", "canReadMeters", "canReadSettings", "canReadExternalReports", "canReadServices", "canReadCallRecords", "canReadMarketItemPrices", "canManageMarketItemPrices", "canReadMarketPriceScopes", "canManageMarketPriceScopes", "canReadPaymentsWithInvoices", "canReadMarketplace", "canManageMarketplace", "canReadTour", "canManageTour") = ("v" + 1, NOW(), false, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true)
WHERE "name" = 'employee.role.Administrator.name';

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint organization_employee_role_unique_organization_and_name on model organizationemployeerole
--
DROP INDEX IF EXISTS "organization_employee_role_unique_organization_and_name";
--
-- Add field isEditable to organizationemployeerolehistoryrecord
--
ALTER TABLE "OrganizationEmployeeRoleHistoryRecord" DROP COLUMN "isEditable" CASCADE;
--
-- Add field isDefault to organizationemployeerolehistoryrecord
--
ALTER TABLE "OrganizationEmployeeRoleHistoryRecord" DROP COLUMN "isDefault" CASCADE;
--
-- Add field newId to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" DROP COLUMN "newId" CASCADE;
--
-- Add field isEditable to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" DROP COLUMN "isEditable" CASCADE;
--
-- Add field isDefault to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" DROP COLUMN "isDefault" CASCADE;
--
-- Add field deletedAt to organizationemployeerole
--
ALTER TABLE "OrganizationEmployeeRole" DROP COLUMN "deletedAt" CASCADE;
COMMIT;

    `)
}
