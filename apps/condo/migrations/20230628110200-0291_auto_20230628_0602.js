// auto generated by kmigrator
// KMIGRATOR:0291_auto_20230628_0602:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMSBvbiAyMDIzLTA2LTI4IDA2OjAyCgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucywgbW9kZWxzCgoKY2xhc3MgTWlncmF0aW9uKG1pZ3JhdGlvbnMuTWlncmF0aW9uKToKCiAgICBkZXBlbmRlbmNpZXMgPSBbCiAgICAgICAgKCdfZGphbmdvX3NjaGVtYScsICcwMjkwX2F1dG9fMjAyMzA2MjdfMDcyNCcpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ3JlY2VpcHQnLAogICAgICAgICAgICBuYW1lPSdiYWxhbmNlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRlY2ltYWxGaWVsZChibGFuaz1UcnVlLCBkZWNpbWFsX3BsYWNlcz04LCBtYXhfZGlnaXRzPTE4LCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ3JlY2VpcHQnLAogICAgICAgICAgICBuYW1lPSdjaGFyZ2UnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTgsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdCcsCiAgICAgICAgICAgIG5hbWU9J2Zvcm11bGEnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdCcsCiAgICAgICAgICAgIG5hbWU9J3BhaWQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTgsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdCcsCiAgICAgICAgICAgIG5hbWU9J3BlbmFsdHknLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTgsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdCcsCiAgICAgICAgICAgIG5hbWU9J3ByaXZpbGVnZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EZWNpbWFsRmllbGQoYmxhbms9VHJ1ZSwgZGVjaW1hbF9wbGFjZXM9OCwgbWF4X2RpZ2l0cz0xOCwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2JpbGxpbmdyZWNlaXB0JywKICAgICAgICAgICAgbmFtZT0ncmVjYWxjdWxhdGlvbicsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EZWNpbWFsRmllbGQoYmxhbms9VHJ1ZSwgZGVjaW1hbF9wbGFjZXM9OCwgbWF4X2RpZ2l0cz0xOCwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2JpbGxpbmdyZWNlaXB0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2JhbGFuY2UnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTQsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdjaGFyZ2UnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTQsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdmb3JtdWxhJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ3JlY2VpcHRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0ncGFpZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EZWNpbWFsRmllbGQoYmxhbms9VHJ1ZSwgZGVjaW1hbF9wbGFjZXM9NCwgbWF4X2RpZ2l0cz0xOCwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2JpbGxpbmdyZWNlaXB0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J3BlbmFsdHknLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTQsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdwcml2aWxlZ2UnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGVjaW1hbEZpZWxkKGJsYW5rPVRydWUsIGRlY2ltYWxfcGxhY2VzPTQsIG1heF9kaWdpdHM9MTgsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5ncmVjZWlwdGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdyZWNhbGN1bGF0aW9uJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRlY2ltYWxGaWVsZChibGFuaz1UcnVlLCBkZWNpbWFsX3BsYWNlcz00LCBtYXhfZGlnaXRzPTE4LCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';
    
--
-- Add field balance to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "balance" numeric(18, 8) NULL;
--
-- Add field charge to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "charge" numeric(18, 8) NULL;
--
-- Add field formula to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "formula" text NULL;
--
-- Add field paid to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "paid" numeric(18, 8) NULL;
--
-- Add field penalty to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "penalty" numeric(18, 8) NULL;
--
-- Add field privilege to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "privilege" numeric(18, 8) NULL;
--
-- Add field recalculation to billingreceipt
--
ALTER TABLE "BillingReceipt" ADD COLUMN "recalculation" numeric(18, 8) NULL;
--
-- Add field balance to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "balance" numeric(18, 4) NULL;
--
-- Add field charge to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "charge" numeric(18, 4) NULL;
--
-- Add field formula to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "formula" text NULL;
--
-- Add field paid to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "paid" numeric(18, 4) NULL;
--
-- Add field penalty to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "penalty" numeric(18, 4) NULL;
--
-- Add field privilege to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "privilege" numeric(18, 4) NULL;
--
-- Add field recalculation to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" ADD COLUMN "recalculation" numeric(18, 4) NULL;

--
-- [CUSTOM] create transform function that convert text value to numeric. Otherwise return null
--
CREATE OR REPLACE FUNCTION convert_to_numeric(v_input text)
RETURNS NUMERIC AS $$
DECLARE v_numeric_value NUMERIC DEFAULT NULL;
BEGIN
    BEGIN
        v_numeric_value := v_input::NUMERIC;
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Invalid NUMERIC value: "%".  Returning NULL.', v_input;
        RETURN NULL;
    END;
RETURN v_numeric_value;
END;
$$ LANGUAGE plpgsql;

--
-- [CUSTOM] Synchronize values for every key of toPayDetails from BillingReceipt model 
--

UPDATE "BillingReceipt"
SET "formula" = "toPayDetails"->>'formula'
WHERE "toPayDetails"->>'formula' IS NOT NULL;

UPDATE "BillingReceipt"
SET "charge" = convert_to_numeric("toPayDetails"->>'charge')
WHERE "toPayDetails"->>'charge' IS NOT NULL;

UPDATE "BillingReceipt"
SET "balance" = convert_to_numeric("toPayDetails"->>'balance')
WHERE "toPayDetails"->>'balance' IS NOT NULL;

UPDATE "BillingReceipt"
SET "recalculation" = convert_to_numeric("toPayDetails"->>'recalculation')
WHERE "toPayDetails"->>'recalculation' IS NOT NULL;

UPDATE "BillingReceipt"
SET "privilege" = convert_to_numeric("toPayDetails"->>'privilege')
WHERE "toPayDetails"->>'privilege' IS NOT NULL;

UPDATE "BillingReceipt"
SET "penalty" = convert_to_numeric("toPayDetails"->>'penalty')
WHERE "toPayDetails"->>'penalty' IS NOT NULL;

UPDATE "BillingReceipt"
SET "paid" = convert_to_numeric("toPayDetails"->>'paid')
WHERE "toPayDetails"->>'paid' IS NOT NULL;

--
-- [CUSTOM] drop function convert_to_numeric
--
DROP FUNCTION convert_to_numeric;
--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field recalculation to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "recalculation" CASCADE;
--
-- Add field privilege to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "privilege" CASCADE;
--
-- Add field penalty to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "penalty" CASCADE;
--
-- Add field paid to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "paid" CASCADE;
--
-- Add field formula to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "formula" CASCADE;
--
-- Add field charge to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "charge" CASCADE;
--
-- Add field balance to billingreceipthistoryrecord
--
ALTER TABLE "BillingReceiptHistoryRecord" DROP COLUMN "balance" CASCADE;
--
-- Add field recalculation to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "recalculation" CASCADE;
--
-- Add field privilege to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "privilege" CASCADE;
--
-- Add field penalty to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "penalty" CASCADE;
--
-- Add field paid to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "paid" CASCADE;
--
-- Add field formula to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "formula" CASCADE;
--
-- Add field charge to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "charge" CASCADE;
--
-- Add field balance to billingreceipt
--
ALTER TABLE "BillingReceipt" DROP COLUMN "balance" CASCADE;
COMMIT;

    `)
}
