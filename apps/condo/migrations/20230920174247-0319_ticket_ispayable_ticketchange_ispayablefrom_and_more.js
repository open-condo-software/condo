// auto generated by kmigrator
// KMIGRATOR:0319_ticket_ispayable_ticketchange_ispayablefrom_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjMtMDktMjAgMTI6NDMKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzMThfYXV0b18yMDIzMDkxOV8wNzE2JyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXQnLAogICAgICAgICAgICBuYW1lPSdpc1BheWFibGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGRlZmF1bHQ9RmFsc2UpLAogICAgICAgICAgICBwcmVzZXJ2ZV9kZWZhdWx0PUZhbHNlLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0naXNQYXlhYmxlRnJvbScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2lzUGF5YWJsZVRvJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkJvb2xlYW5GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2lzUGF5YWJsZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--

SET statement_timeout = '1500s';

--
-- Add field isPayable to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "isPayable" boolean DEFAULT false NOT NULL;
ALTER TABLE "Ticket" ALTER COLUMN "isPayable" DROP DEFAULT;
--
-- Add field isPayableFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "isPayableFrom" boolean NULL;
--
-- Add field isPayableTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "isPayableTo" boolean NULL;
--
-- Add field isPayable to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "isPayable" boolean NULL;

--
-- [CUSTOM] Migrate Ticket.isPaid to Ticket.isPayable
--

UPDATE public."Ticket" SET "isPayable" = "isPaid";

--
-- [CUSTOM] Migrate TicketChange.isPaidFrom to TicketChange.isPayableFrom
--

UPDATE public."TicketChange" SET "isPayableFrom" = "isPaidFrom";

--
-- [CUSTOM] Migrate TicketChange.isPaidTo to TicketChange.isPayableTo
--

UPDATE public."TicketChange" SET "isPayableTo" = "isPaidTo";

--
-- [CUSTOM] Change TicketFilterTemplate.fields.attributes from value "isPaid" to "isPayable"
--

UPDATE public."TicketFilterTemplate"
    SET "fields" = REPLACE(
        "fields"::text,
        "fields"->>'attributes',
        REPLACE("fields"->>'attributes', 'isPaid', 'isPayable')
    )::jsonb
    WHERE ("fields"->'attributes') IS NOT NULL;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--

SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--

SET statement_timeout = '1500s';

--
-- Add field isPayable to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "isPayable" CASCADE;
--
-- Add field isPayableTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "isPayableTo" CASCADE;
--
-- Add field isPayableFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "isPayableFrom" CASCADE;
--
-- Add field isPayable to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "isPayable" CASCADE;

--
-- [CUSTOM] Change TicketFilterTemplate.fields.attributes from value "isPayable" to "isPaid"
--

UPDATE public."TicketFilterTemplate"
    SET "fields" = REPLACE(
        "fields"::text,
        "fields"->>'attributes',
        REPLACE("fields"->>'attributes', 'isPayable', 'isPaid')
    )::jsonb
    WHERE ("fields"->'attributes') IS NOT NULL;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--

SET statement_timeout = '10s';

COMMIT;

    `)
}
