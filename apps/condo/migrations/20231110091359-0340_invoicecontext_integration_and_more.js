// auto generated by kmigrator
// KMIGRATOR:0340_invoicecontext_integration_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMi40IG9uIDIwMjMtMTEtMTAgMDQ6MTQKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKaW1wb3J0IGRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24KCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzMzlfYjJiYXBwbmV3c3NoYXJpbmdjb25maWdoaXN0b3J5cmVjb3JkX2FuZF9tb3JlJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdpbnZvaWNlY29udGV4dCcsCiAgICAgICAgICAgIG5hbWU9J2ludGVncmF0aW9uJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoZGJfY29sdW1uPSdpbnRlZ3JhdGlvbicsIGRlZmF1bHQ9JycsIG9uX2RlbGV0ZT1kamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uLlBST1RFQ1QsIHJlbGF0ZWRfbmFtZT0nKycsIHRvPSdfZGphbmdvX3NjaGVtYS5hY3F1aXJpbmdpbnRlZ3JhdGlvbicpLAogICAgICAgICAgICBwcmVzZXJ2ZV9kZWZhdWx0PUZhbHNlLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0naW52b2ljZWNvbnRleHRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0naW50ZWdyYXRpb24nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFsdGVyRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3BheW1lbnQnLAogICAgICAgICAgICBuYW1lPSdhY2NvdW50TnVtYmVyJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;



--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';




--
-- Add field integration to invoicecontext
--
ALTER TABLE "InvoiceContext" ADD COLUMN "integration" uuid NOT NULL CONSTRAINT "InvoiceContext_integration_cdad2d29_fk_AcquiringIntegration_id" REFERENCES "AcquiringIntegration"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "InvoiceContext_integration_cdad2d29_fk_AcquiringIntegration_id" IMMEDIATE;
--
-- Add field integration to invoicecontexthistoryrecord
--
ALTER TABLE "InvoiceContextHistoryRecord" ADD COLUMN "integration" uuid NULL;
--
-- Alter field accountNumber on payment
--
ALTER TABLE "Payment" ALTER COLUMN "accountNumber" DROP NOT NULL;
CREATE INDEX "InvoiceContext_integration_cdad2d29" ON "InvoiceContext" ("integration");



--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';




COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;



--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';



--
-- [CUSTOM] Set empty string to prevent not null constraint
--
UPDATE "Payment" SET "accountNumber" = '' WHERE "accountNumber" IS NULL;




--
-- Alter field accountNumber on payment
--
ALTER TABLE "Payment" ALTER COLUMN "accountNumber" SET NOT NULL;
--
-- Add field integration to invoicecontexthistoryrecord
--
ALTER TABLE "InvoiceContextHistoryRecord" DROP COLUMN "integration" CASCADE;
--
-- Add field integration to invoicecontext
--
ALTER TABLE "InvoiceContext" DROP COLUMN "integration" CASCADE;



--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';




COMMIT;

    `)
}
