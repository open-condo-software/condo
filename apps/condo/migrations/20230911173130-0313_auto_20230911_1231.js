// auto generated by kmigrator
// KMIGRATOR:0313_auto_20230911_1231:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMSBvbiAyMDIzLTA5LTExIDEyOjMxCgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucwoKCmNsYXNzIE1pZ3JhdGlvbihtaWdyYXRpb25zLk1pZ3JhdGlvbik6CgogICAgZGVwZW5kZW5jaWVzID0gWwogICAgICAgICgnX2RqYW5nb19zY2hlbWEnLCAnMDMxMl91c2VycmlnaHRzc2V0aGlzdG9yeXJlY29yZF9hbmRfbW9yZScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
    --
    -- [CUSTOM] create transform function that remove provided value from jsonb array
    --
    CREATE OR REPLACE FUNCTION jsonb_remove_array_element(arr jsonb, element jsonb)
    RETURNS jsonb language sql immutable as $$
        SELECT arr- (
            SELECT ordinality- 1
            FROM jsonb_array_elements(arr) WITH ordinality
            WHERE value = element)::int
    $$;
    
    --
    -- [CUSTOM] remove all "ANALYTICS_V3" values from features field of Organization model
    --
    
    UPDATE "Organization" SET features = jsonb_remove_array_element(features, '"ANALYTICS_V3"') 
    WHERE features::jsonb @> '"ANALYTICS_V3"';
    
    --
    -- [CUSTOM] drop custom function
    --
    DROP FUNCTION jsonb_remove_array_element;
    
    COMMIT;
    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
    
    --
    -- This is an irreversible migration, because organization feature was completely removed from features field
    -- 
    
    COMMIT;
    `)
}
