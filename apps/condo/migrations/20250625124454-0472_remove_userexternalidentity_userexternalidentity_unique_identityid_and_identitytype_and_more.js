// auto generated by kmigrator
// KMIGRATOR:0472_remove_userexternalidentity_userexternalidentity_unique_identityid_and_identitytype_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDUuMS41IG9uIDIwMjUtMDYtMjUgMDc6NDUKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzA0NzFfZXhlY3V0aW9uYWlmbG93dGFza2hpc3RvcnlyZWNvcmRfZXhlY3V0aW9uYWlmbG93dGFzaycpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5SZW1vdmVDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSd1c2VyZXh0ZXJuYWxpZGVudGl0eScsCiAgICAgICAgICAgIG5hbWU9J3VzZXJFeHRlcm5hbElkZW50aXR5X3VuaXF1ZV9pZGVudGl0eWlkX2FuZF9pZGVudGl0eXR5cGUnLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndXNlcmV4dGVybmFsaWRlbnRpdHknLAogICAgICAgICAgICBuYW1lPSd1c2VyVHlwZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5DaGFyRmllbGQoZGVmYXVsdD0ncmVzaWRlbnQnLCBtYXhfbGVuZ3RoPTUwKSwKICAgICAgICAgICAgcHJlc2VydmVfZGVmYXVsdD1GYWxzZSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3VzZXJleHRlcm5hbGlkZW50aXR5aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J3VzZXJUeXBlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSd1c2VyZXh0ZXJuYWxpZGVudGl0eScsCiAgICAgICAgICAgIGNvbnN0cmFpbnQ9bW9kZWxzLlVuaXF1ZUNvbnN0cmFpbnQoY29uZGl0aW9uPW1vZGVscy5RKCgnZGVsZXRlZEF0X19pc251bGwnLCBUcnVlKSksIGZpZWxkcz0oJ2lkZW50aXR5SWQnLCAnaWRlbnRpdHlUeXBlJywgJ3VzZXJUeXBlJyksIG5hbWU9J3VzZXJFeHRlcm5hbElkZW50aXR5X3VuaXF1ZV9pZGVudGl0eWlkX2FuZF9pZGVudGl0eXR5cGVfYW5kX3VzZXJ0eXBlJyksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Remove constraint userExternalIdentity_unique_identityid_and_identitytype from model userexternalidentity
--
DROP INDEX IF EXISTS "userExternalIdentity_unique_identityid_and_identitytype";
--
-- Add field userType to userexternalidentity
--
ALTER TABLE "UserExternalIdentity" ADD COLUMN "userType" varchar(50) DEFAULT 'resident' NOT NULL;
ALTER TABLE "UserExternalIdentity" ALTER COLUMN "userType" DROP DEFAULT;
--
-- [CUSTOM] fill userType's by identityType
--
UPDATE "UserExternalIdentity" SET "userType" = 'resident' WHERE "identityType" in ('sber_id', 'apple_id');
UPDATE "UserExternalIdentity" SET "userType" = 'staff' WHERE "identityType" in ('sbbol');
--
-- Add field userType to userexternalidentityhistoryrecord
--
ALTER TABLE "UserExternalIdentityHistoryRecord" ADD COLUMN "userType" text NULL;
--
-- [CUSTOM] fill userType's by identityType
--
UPDATE "UserExternalIdentityHistoryRecord" SET "userType" = 'resident' WHERE "identityType" in ('sber_id', 'apple_id');
UPDATE "UserExternalIdentityHistoryRecord" SET "userType" = 'staff' WHERE "identityType" in ('sbbol');
--
-- Create constraint userExternalIdentity_unique_identityid_and_identitytype_and_usertype on model userexternalidentity
--
CREATE UNIQUE INDEX "userExternalIdentity_unique_identityid_and_identitytype_and_usertype" ON "UserExternalIdentity" ("identityId", "identityType", "userType") WHERE "deletedAt" IS NULL;
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint userExternalIdentity_unique_identityid_and_identitytype_and_usertype on model userexternalidentity
--
DROP INDEX IF EXISTS "userExternalIdentity_unique_identityid_and_identitytype_and_usertype";
--
-- Add field userType to userexternalidentityhistoryrecord
--
ALTER TABLE "UserExternalIdentityHistoryRecord" DROP COLUMN "userType" CASCADE;
--
-- Add field userType to userexternalidentity
--
ALTER TABLE "UserExternalIdentity" DROP COLUMN "userType" CASCADE;
--
-- [CUSTOM] drop new rows that may not meet old constraint
--
DELETE FROM "UserExternalIdentity" WHERE "identityType" not in ('sber_id', 'apple_id', 'sbbol');
--
-- Remove constraint userExternalIdentity_unique_identityid_and_identitytype from model userexternalidentity
--
CREATE UNIQUE INDEX "userExternalIdentity_unique_identityid_and_identitytype" ON "UserExternalIdentity" ("identityId", "identityType") WHERE "deletedAt" IS NULL;
COMMIT;

    `)
}
