// auto generated by kmigrator
// KMIGRATOR:0439_b2baccesstoken_b2baccesstokenhistoryrecord_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDUuMSBvbiAyMDI0LTExLTE0IDA2OjA3CgppbXBvcnQgZGphbmdvLmRiLm1vZGVscy5kZWxldGlvbgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucywgbW9kZWxzCgoKY2xhc3MgTWlncmF0aW9uKG1pZ3JhdGlvbnMuTWlncmF0aW9uKToKCiAgICBkZXBlbmRlbmNpZXMgPSBbCiAgICAgICAgKCdfZGphbmdvX3NjaGVtYScsICcwNDM4X2F1dG9fMjAyNDExMTJfMTE1OScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5DcmVhdGVNb2RlbCgKICAgICAgICAgICAgbmFtZT0nYjJiYWNjZXNzdG9rZW4nLAogICAgICAgICAgICBmaWVsZHM9WwogICAgICAgICAgICAgICAgKCdzZXNzaW9uSWQnLCBtb2RlbHMuVGV4dEZpZWxkKCkpLAogICAgICAgICAgICAgICAgKCdleHBpcmVzQXQnLCBtb2RlbHMuRGF0ZVRpbWVGaWVsZCgpKSwKICAgICAgICAgICAgICAgICgnaWQnLCBtb2RlbHMuVVVJREZpZWxkKHByaW1hcnlfa2V5PVRydWUsIHNlcmlhbGl6ZT1GYWxzZSkpLAogICAgICAgICAgICAgICAgKCd2JywgbW9kZWxzLkludGVnZXJGaWVsZChkZWZhdWx0PTEpKSwKICAgICAgICAgICAgICAgICgnY3JlYXRlZEF0JywgbW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgZGJfaW5kZXg9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3VwZGF0ZWRBdCcsIG1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIGRiX2luZGV4PVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdkZWxldGVkQXQnLCBtb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBkYl9pbmRleD1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnbmV3SWQnLCBtb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdkdicsIG1vZGVscy5JbnRlZ2VyRmllbGQoKSksCiAgICAgICAgICAgICAgICAoJ3NlbmRlcicsIG1vZGVscy5KU09ORmllbGQoKSksCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIG9wdGlvbnM9ewogICAgICAgICAgICAgICAgJ2RiX3RhYmxlJzogJ0IyQkFjY2Vzc1Rva2VuJywKICAgICAgICAgICAgfSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQ3JlYXRlTW9kZWwoCiAgICAgICAgICAgIG5hbWU9J2IyYmFjY2Vzc3Rva2VuaGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIGZpZWxkcz1bCiAgICAgICAgICAgICAgICAoJ3Nlc3Npb25JZCcsIG1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2NvbnRleHQnLCBtb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCd1c2VyJywgbW9kZWxzLlVVSURGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgncmlnaHRTZXQnLCBtb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdleHBpcmVzQXQnLCBtb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnaWQnLCBtb2RlbHMuVVVJREZpZWxkKHByaW1hcnlfa2V5PVRydWUsIHNlcmlhbGl6ZT1GYWxzZSkpLAogICAgICAgICAgICAgICAgKCd2JywgbW9kZWxzLkludGVnZXJGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnY3JlYXRlZEF0JywgbW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3VwZGF0ZWRBdCcsIG1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdjcmVhdGVkQnknLCBtb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCd1cGRhdGVkQnknLCBtb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdkZWxldGVkQXQnLCBtb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnbmV3SWQnLCBtb2RlbHMuSlNPTkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdkdicsIG1vZGVscy5JbnRlZ2VyRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3NlbmRlcicsIG1vZGVscy5KU09ORmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2hpc3RvcnlfZGF0ZScsIG1vZGVscy5EYXRlVGltZUZpZWxkKCkpLAogICAgICAgICAgICAgICAgKCdoaXN0b3J5X2FjdGlvbicsIG1vZGVscy5DaGFyRmllbGQobWF4X2xlbmd0aD01MCkpLAogICAgICAgICAgICAgICAgKCdoaXN0b3J5X2lkJywgbW9kZWxzLlVVSURGaWVsZChkYl9pbmRleD1UcnVlKSksCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIG9wdGlvbnM9ewogICAgICAgICAgICAgICAgJ2RiX3RhYmxlJzogJ0IyQkFjY2Vzc1Rva2VuSGlzdG9yeVJlY29yZCcsCiAgICAgICAgICAgIH0sCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUNvbnN0cmFpbnQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2IyYmFwcGFjY2Vzc3JpZ2h0c2V0JywKICAgICAgICAgICAgbmFtZT0nYjJiX2FwcF9hY2Nlc3NfcmlnaHRfc2V0X3VuaXF1ZV9hcHAnLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYjJiYXBwYWNjZXNzcmlnaHRzZXQnLAogICAgICAgICAgICBuYW1lPSduYW1lJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYjJiYXBwYWNjZXNzcmlnaHRzZXQnLAogICAgICAgICAgICBuYW1lPSd0eXBlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkNoYXJGaWVsZChibGFuaz1UcnVlLCBtYXhfbGVuZ3RoPTUwLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYjJiYXBwYWNjZXNzcmlnaHRzZXRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nbmFtZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2IyYmFwcGFjY2Vzc3JpZ2h0c2V0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J3R5cGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZENvbnN0cmFpbnQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2IyYmFwcGFjY2Vzc3JpZ2h0c2V0JywKICAgICAgICAgICAgY29uc3RyYWludD1tb2RlbHMuVW5pcXVlQ29uc3RyYWludChjb25kaXRpb249bW9kZWxzLlEoKCdkZWxldGVkQXRfX2lzbnVsbCcsIFRydWUpLCAoJ3R5cGUnLCAnbWluaWFwcCcpKSwgZmllbGRzPSgnYXBwJywpLCBuYW1lPSdiMmJfYXBwX2FjY2Vzc19yaWdodF9zZXRfdW5pcXVlX2FwcCcpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYjJiYWNjZXNzdG9rZW4nLAogICAgICAgICAgICBuYW1lPSdjb250ZXh0JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoZGJfY29sdW1uPSdjb250ZXh0Jywgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uQ0FTQ0FERSwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLmIyYmFwcGNvbnRleHQnKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2IyYmFjY2Vzc3Rva2VuJywKICAgICAgICAgICAgbmFtZT0nY3JlYXRlZEJ5JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoYmxhbms9VHJ1ZSwgZGJfY29sdW1uPSdjcmVhdGVkQnknLCBudWxsPVRydWUsIG9uX2RlbGV0ZT1kamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uLlNFVF9OVUxMLCByZWxhdGVkX25hbWU9JysnLCB0bz0nX2RqYW5nb19zY2hlbWEudXNlcicpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYjJiYWNjZXNzdG9rZW4nLAogICAgICAgICAgICBuYW1lPSdyaWdodFNldCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Gb3JlaWduS2V5KGRiX2NvbHVtbj0ncmlnaHRTZXQnLCBvbl9kZWxldGU9ZGphbmdvLmRiLm1vZGVscy5kZWxldGlvbi5DQVNDQURFLCByZWxhdGVkX25hbWU9JysnLCB0bz0nX2RqYW5nb19zY2hlbWEuYjJiYXBwYWNjZXNzcmlnaHRzZXQnKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2IyYmFjY2Vzc3Rva2VuJywKICAgICAgICAgICAgbmFtZT0ndXBkYXRlZEJ5JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoYmxhbms9VHJ1ZSwgZGJfY29sdW1uPSd1cGRhdGVkQnknLCBudWxsPVRydWUsIG9uX2RlbGV0ZT1kamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uLlNFVF9OVUxMLCByZWxhdGVkX25hbWU9JysnLCB0bz0nX2RqYW5nb19zY2hlbWEudXNlcicpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYjJiYWNjZXNzdG9rZW4nLAogICAgICAgICAgICBuYW1lPSd1c2VyJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoZGJfY29sdW1uPSd1c2VyJywgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uQ0FTQ0FERSwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLnVzZXInKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create model b2baccesstoken
--
CREATE TABLE "B2BAccessToken" ("sessionId" text NOT NULL, "expiresAt" timestamp with time zone NOT NULL, "id" uuid NOT NULL PRIMARY KEY, "v" integer NOT NULL, "createdAt" timestamp with time zone NULL, "updatedAt" timestamp with time zone NULL, "deletedAt" timestamp with time zone NULL, "newId" uuid NULL, "dv" integer NOT NULL, "sender" jsonb NOT NULL);
--
-- Create model b2baccesstokenhistoryrecord
--
CREATE TABLE "B2BAccessTokenHistoryRecord" ("sessionId" text NULL, "context" uuid NULL, "user" uuid NULL, "rightSet" uuid NULL, "expiresAt" timestamp with time zone NULL, "id" uuid NOT NULL PRIMARY KEY, "v" integer NULL, "createdAt" timestamp with time zone NULL, "updatedAt" timestamp with time zone NULL, "createdBy" uuid NULL, "updatedBy" uuid NULL, "deletedAt" timestamp with time zone NULL, "newId" jsonb NULL, "dv" integer NULL, "sender" jsonb NULL, "history_date" timestamp with time zone NOT NULL, "history_action" varchar(50) NOT NULL, "history_id" uuid NOT NULL);
--
-- Remove constraint b2b_app_access_right_set_unique_app from model b2bappaccessrightset
--
DROP INDEX IF EXISTS "b2b_app_access_right_set_unique_app";
--
-- Add field name to b2bappaccessrightset
-- [CUSTOM] Set 'default' for all existing
--
ALTER TABLE "B2BAppAccessRightSet" ADD COLUMN "name" text DEFAULT 'default' NOT NULL;
ALTER TABLE "B2BAppAccessRightSet" ALTER COLUMN "name" DROP DEFAULT;
--
-- Add field type to b2bappaccessrightset
-- [CUSTOM] Set 'miniapp' for all existing
--
ALTER TABLE "B2BAppAccessRightSet" ADD COLUMN "type" varchar(50) DEFAULT 'miniapp' NOT NULL;
ALTER TABLE "B2BAppAccessRightSet" ALTER COLUMN "type" DROP DEFAULT;
--
-- Add field name to b2bappaccessrightsethistoryrecord
--
ALTER TABLE "B2BAppAccessRightSetHistoryRecord" ADD COLUMN "name" text NULL;
--
-- Add field type to b2bappaccessrightsethistoryrecord
--
ALTER TABLE "B2BAppAccessRightSetHistoryRecord" ADD COLUMN "type" text NULL;
--
-- Create constraint b2b_app_access_right_set_unique_app on model b2bappaccessrightset
--
CREATE UNIQUE INDEX "b2b_app_access_right_set_unique_app" ON "B2BAppAccessRightSet" ("app") WHERE ("deletedAt" IS NULL AND "type" = 'miniapp');
--
-- Add field context to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" ADD COLUMN "context" uuid NOT NULL CONSTRAINT "B2BAccessToken_context_701dbbdf_fk_B2BAppContext_id" REFERENCES "B2BAppContext"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "B2BAccessToken_context_701dbbdf_fk_B2BAppContext_id" IMMEDIATE;
--
-- Add field createdBy to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" ADD COLUMN "createdBy" uuid NULL CONSTRAINT "B2BAccessToken_createdBy_1db4340e_fk_User_id" REFERENCES "User"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "B2BAccessToken_createdBy_1db4340e_fk_User_id" IMMEDIATE;
--
-- Add field rightSet to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" ADD COLUMN "rightSet" uuid NOT NULL CONSTRAINT "B2BAccessToken_rightSet_79e1b380_fk_B2BAppAccessRightSet_id" REFERENCES "B2BAppAccessRightSet"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "B2BAccessToken_rightSet_79e1b380_fk_B2BAppAccessRightSet_id" IMMEDIATE;
--
-- Add field updatedBy to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" ADD COLUMN "updatedBy" uuid NULL CONSTRAINT "B2BAccessToken_updatedBy_bc9b277b_fk_User_id" REFERENCES "User"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "B2BAccessToken_updatedBy_bc9b277b_fk_User_id" IMMEDIATE;
--
-- Add field user to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" ADD COLUMN "user" uuid NOT NULL CONSTRAINT "B2BAccessToken_user_e783323b_fk_User_id" REFERENCES "User"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "B2BAccessToken_user_e783323b_fk_User_id" IMMEDIATE;
CREATE INDEX "B2BAccessToken_createdAt_1792b5ef" ON "B2BAccessToken" ("createdAt");
CREATE INDEX "B2BAccessToken_updatedAt_61055ffa" ON "B2BAccessToken" ("updatedAt");
CREATE INDEX "B2BAccessToken_deletedAt_95d14da7" ON "B2BAccessToken" ("deletedAt");
CREATE INDEX "B2BAccessTokenHistoryRecord_history_id_7dfc348c" ON "B2BAccessTokenHistoryRecord" ("history_id");
CREATE INDEX "B2BAccessToken_context_701dbbdf" ON "B2BAccessToken" ("context");
CREATE INDEX "B2BAccessToken_createdBy_1db4340e" ON "B2BAccessToken" ("createdBy");
CREATE INDEX "B2BAccessToken_rightSet_79e1b380" ON "B2BAccessToken" ("rightSet");
CREATE INDEX "B2BAccessToken_updatedBy_bc9b277b" ON "B2BAccessToken" ("updatedBy");
CREATE INDEX "B2BAccessToken_user_e783323b" ON "B2BAccessToken" ("user");
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field user to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" DROP COLUMN "user" CASCADE;
--
-- Add field updatedBy to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" DROP COLUMN "updatedBy" CASCADE;
--
-- Add field rightSet to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" DROP COLUMN "rightSet" CASCADE;
--
-- Add field createdBy to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" DROP COLUMN "createdBy" CASCADE;
--
-- Add field context to b2baccesstoken
--
ALTER TABLE "B2BAccessToken" DROP COLUMN "context" CASCADE;
--
-- Create constraint b2b_app_access_right_set_unique_app on model b2bappaccessrightset
--
DROP INDEX IF EXISTS "b2b_app_access_right_set_unique_app";
--
-- Add field type to b2bappaccessrightsethistoryrecord
--
ALTER TABLE "B2BAppAccessRightSetHistoryRecord" DROP COLUMN "type" CASCADE;
--
-- Add field name to b2bappaccessrightsethistoryrecord
--
ALTER TABLE "B2BAppAccessRightSetHistoryRecord" DROP COLUMN "name" CASCADE;

--
-- Add field name to b2bappaccessrightset
--
ALTER TABLE "B2BAppAccessRightSet" DROP COLUMN "name" CASCADE;

--
-- Create model b2baccesstokenhistoryrecord
--
DROP TABLE "B2BAccessTokenHistoryRecord" CASCADE;
--
-- Create model b2baccesstoken
--
DROP TABLE "B2BAccessToken" CASCADE;

-- [CUSTOM Change execution order to successfully return old unique index]
--
-- [CUSTOM] Drop non default type rows to satisfy unique constraint
--
ALTER TABLE "B2BAppAccessRight" DROP CONSTRAINT "B2BAppAccessRight_accessRightSet_d66bc7b6_fk_B2BAppAcc";
DELETE FROM "B2BAppAccessRightSet" WHERE "type" != 'miniapp';
ALTER TABLE "B2BAppAccessRight" ADD CONSTRAINT "B2BAppAccessRight_accessRightSet_d66bc7b6_fk_B2BAppAcc" FOREIGN KEY ("accessRightSet") REFERENCES "B2BAppAccessRightSet"("id");
--
-- Add field type to b2bappaccessrightset
--
ALTER TABLE "B2BAppAccessRightSet" DROP COLUMN "type" CASCADE;
--
-- Remove constraint b2b_app_access_right_set_unique_app from model b2bappaccessrightset
--
CREATE UNIQUE INDEX "b2b_app_access_right_set_unique_app" ON "B2BAppAccessRightSet" ("app") WHERE "deletedAt" IS NULL;

COMMIT;

    `)
}
