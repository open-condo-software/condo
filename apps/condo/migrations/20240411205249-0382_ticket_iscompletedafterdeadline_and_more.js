// auto generated by kmigrator
// KMIGRATOR:0382_ticket_iscompletedafterdeadline_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDQtMTEgMTU6NTIKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzODFfYWx0ZXJfbWVzc2FnZV90eXBlX2FsdGVyX21lc3NhZ2VhcHBibGFja2xpc3RfdHlwZV9hbmRfbW9yZScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0JywKICAgICAgICAgICAgbmFtZT0naXNDb21wbGV0ZWRBZnRlckRlYWRsaW5lJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkJvb2xlYW5GaWVsZChkZWZhdWx0PUZhbHNlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdpc0NvbXBsZXRlZEFmdGVyRGVhZGxpbmUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';  

--
-- Add field isCompletedAfterDeadline to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "isCompletedAfterDeadline" boolean DEFAULT false NOT NULL;
ALTER TABLE "Ticket" ALTER COLUMN "isCompletedAfterDeadline" DROP DEFAULT;
--
-- Add field isCompletedAfterDeadline to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "isCompletedAfterDeadline" boolean NULL;

--
-- [CUSTOM] Set "isCompletedAfterDeadline" to "true" for tickets in status "completed" and "closed" that were completed after the deadline
UPDATE "Ticket" SET "isCompletedAfterDeadline" = true WHERE "status" IN ('5b9decd7-792c-42bb-b16d-822142fd2d69', 'c14a58e0-6b5d-4ec2-b91c-980a90111c7d') AND "deadline" < "completedAt";

--
-- [CUSTOM] Set "isCompletedAfterDeadline" to "true" for tickets in status "closed" that has not "completedAt" and has "statusUpdatedAt" more then "deadline"
UPDATE "Ticket" SET "isCompletedAfterDeadline" = true WHERE "status" = 'c14a58e0-6b5d-4ec2-b91c-980a90111c7d' AND "completedAt" IS NULL AND "deadline" < "statusUpdatedAt";

--
-- [CUSTOM] Set "isCompletedAfterDeadline" to "true" for tickets in status "cancelled" that has "statusUpdatedAt" more then "deadline"
UPDATE "Ticket" SET "isCompletedAfterDeadline" = true WHERE "status" = 'f0fa0093-8d86-4e69-ae1a-70a2914da82f' AND "deadline" < "statusUpdatedAt";


--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field isCompletedAfterDeadline to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "isCompletedAfterDeadline" CASCADE;
--
-- Add field isCompletedAfterDeadline to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "isCompletedAfterDeadline" CASCADE;
COMMIT;

    `)
}
