// auto generated by kmigrator
// KMIGRATOR:0287_newsitem_publishedat_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC4xIG9uIDIwMjMtMDYtMjIgMDQ6MzkKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAyODZfbmV3c2l0ZW1zY29wZV90eXBlX25ld3NpdGVtc2NvcGVoaXN0b3J5cmVjb3JkX3R5cGUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J25ld3NpdGVtJywKICAgICAgICAgICAgbmFtZT0ncHVibGlzaGVkQXQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nbmV3c2l0ZW1oaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0ncHVibGlzaGVkQXQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field publishedAt to newsitem
--
ALTER TABLE "NewsItem" ADD COLUMN "publishedAt" timestamp with time zone NULL;



----- MANUAL
update "NewsItem" set "publishedAt"="NewsItem"."updatedAt" where "isPublished"=true and "publishedAt" is null;

UPDATE "OrganizationEmployeeRole"
SET "canManageOrganizationNews" = false
WHERE "name" in ('employee.role.Dispatcher.name');

UPDATE "OrganizationEmployeeRole"
SET "canManageNewsItemTemplates" = false
WHERE "name" in ('employee.role.Dispatcher.name');
-----



--
-- Add field publishedAt to newsitemhistoryrecord
--
ALTER TABLE "NewsItemHistoryRecord" ADD COLUMN "publishedAt" timestamp with time zone NULL;
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field publishedAt to newsitemhistoryrecord
--
ALTER TABLE "NewsItemHistoryRecord" DROP COLUMN "publishedAt" CASCADE;
--
-- Add field publishedAt to newsitem
--
ALTER TABLE "NewsItem" DROP COLUMN "publishedAt" CASCADE;
COMMIT;

    `)
}
