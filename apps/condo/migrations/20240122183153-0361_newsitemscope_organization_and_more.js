// auto generated by kmigrator
// KMIGRATOR:0361_newsitemscope_organization_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDEtMjIgMTM6MzIKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKaW1wb3J0IGRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24KCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNjBfb2lkY2NsaWVudF9pbXBvcnRpZF9vaWRjY2xpZW50X2ltcG9ydHJlbW90ZXN5c3RlbV9hbmRfbW9yZScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nbmV3c2l0ZW1zY29wZScsCiAgICAgICAgICAgIG5hbWU9J29yZ2FuaXphdGlvbicsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Gb3JlaWduS2V5KGRiX2NvbHVtbj0nb3JnYW5pemF0aW9uJywgZGVmYXVsdD0nYTZmMTE1NjgtZGZjNC00YzY3LThkOWQtZmZkOGExOGFkYWI4Jywgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uQ0FTQ0FERSwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLm9yZ2FuaXphdGlvbicpLAogICAgICAgICAgICBwcmVzZXJ2ZV9kZWZhdWx0PUZhbHNlLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nbmV3c2l0ZW1zY29wZWhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdvcmdhbml6YXRpb24nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';  

--
-- NOTE
--
-- Since the new organization field cannot be empty,
-- and records in "NewsItemScope" table already exist in the database, we cannot simply add the field.
-- Therefore, we need to follow these steps:
--     1) Add an organization column with ability to set NULL.
--     2) Set "organization" value from table "NewsItem" to "NewsItemScope"
--     3) Prohibit ability to set NULL in "organization" column
--

--
-- (no-op) Add field organization to newsitemscope
--
-- ALTER TABLE "NewsItemScope" ADD COLUMN "organization" uuid DEFAULT 'a6f11568-dfc4-4c67-8d9d-ffd8a18adab8'::uuid NOT NULL CONSTRAINT "NewsItemScope_organization_7c3fe07b_fk_Organization_id" REFERENCES "Organization"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "NewsItemScope_organization_7c3fe07b_fk_Organization_id" IMMEDIATE;
-- ALTER TABLE "NewsItemScope" ALTER COLUMN "organization" DROP DEFAULT;

--
-- [CUSTOM] (1) Add field organization to newsitemscope (Like the line above, but without DEFAULT and NOT NULL)
--
ALTER TABLE "NewsItemScope" ADD COLUMN "organization" uuid NULL CONSTRAINT "NewsItemScope_organization_7c3fe07b_fk_Organization_id" REFERENCES "Organization"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "NewsItemScope_organization_7c3fe07b_fk_Organization_id" IMMEDIATE;

--
-- [CUSTOM] (2) Set "organization" value from table "NewsItem" to "NewsItemScope"
--
WITH organizationData as (
    SELECT ni."organization" as id
    FROM public."NewsItemScope" as scope
        LEFT JOIN public."NewsItem" AS ni ON ni."id" = scope."newsItem"
)
UPDATE "NewsItemScope"
SET "organization" = org.id
FROM organizationData AS org;

--
-- [CUSTOM] (3) Alter field format on newsitemscope (Prohibit ability to set NULL)
--
ALTER TABLE "NewsItemScope" ALTER COLUMN "organization" SET NOT NULL;

--
-- Add field organization to newsitemscopehistoryrecord
--
ALTER TABLE "NewsItemScopeHistoryRecord" ADD COLUMN "organization" uuid NULL;
CREATE INDEX "NewsItemScope_organization_7c3fe07b" ON "NewsItemScope" ("organization");

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field organization to newsitemscopehistoryrecord
--
ALTER TABLE "NewsItemScopeHistoryRecord" DROP COLUMN "organization" CASCADE;
--
-- Add field organization to newsitemscope
--
ALTER TABLE "NewsItemScope" DROP COLUMN "organization" CASCADE;
COMMIT;

    `)
}
