// auto generated by kmigrator
// KMIGRATOR:0500_auto_20251217_1209:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi41IG9uIDIwMjUtMTItMTcgMTI6MDkKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKaW1wb3J0IGRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24KCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzA0OTlfYXV0b18yMDI1MTIxMV8wNjI1JyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0JywKICAgICAgICAgICAgbmFtZT0nYXBwbGllZFJ1bGVzJywKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuUmVtb3ZlRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3N1YnNjcmlwdGlvbmNvbnRleHQnLAogICAgICAgICAgICBuYW1lPSdiYXNlUHJpY2UnLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5SZW1vdmVGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nc3Vic2NyaXB0aW9uY29udGV4dCcsCiAgICAgICAgICAgIG5hbWU9J2NhbGN1bGF0ZWRQcmljZScsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2FwcGxpZWRSdWxlcycsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2Jhc2VQcmljZScsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2NhbGN1bGF0ZWRQcmljZScsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0JywKICAgICAgICAgICAgbmFtZT0nZnJvemVuUHJpY2luZ1J1bGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuSlNPTkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0JywKICAgICAgICAgICAgbmFtZT0ncHJpY2luZ1J1bGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRm9yZWlnbktleShibGFuaz1UcnVlLCBkYl9jb2x1bW49J3ByaWNpbmdSdWxlJywgbnVsbD1UcnVlLCBvbl9kZWxldGU9ZGphbmdvLmRiLm1vZGVscy5kZWxldGlvbi5QUk9URUNULCByZWxhdGVkX25hbWU9JysnLCB0bz0nX2RqYW5nb19zY2hlbWEuc3Vic2NyaXB0aW9ucGxhbnByaWNpbmdydWxlJyksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdzdWJzY3JpcHRpb25jb250ZXh0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2Zyb3plblByaWNpbmdSdWxlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkpTT05GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nc3Vic2NyaXB0aW9uY29udGV4dGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdwcmljaW5nUnVsZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3N1YnNjcmlwdGlvbnBsYW4nLAogICAgICAgICAgICBuYW1lPSdjdXN0b21pemF0aW9uJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkJvb2xlYW5GaWVsZChkZWZhdWx0PUZhbHNlKSwKICAgICAgICAgICAgcHJlc2VydmVfZGVmYXVsdD1GYWxzZSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3N1YnNjcmlwdGlvbnBsYW5oaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nY3VzdG9taXphdGlvbicsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Clean up existing subscription contexts before schema changes.
-- Existing contexts were created during development/testing and need to be recreated with new schema.
--
DELETE FROM "SubscriptionContext";
DELETE FROM "SubscriptionContextHistoryRecord";
--
-- Remove field appliedRules from subscriptioncontext
--
ALTER TABLE "SubscriptionContext" DROP COLUMN "appliedRules" CASCADE;
--
-- Remove field basePrice from subscriptioncontext
--
ALTER TABLE "SubscriptionContext" DROP COLUMN "basePrice" CASCADE;
--
-- Remove field calculatedPrice from subscriptioncontext
--
ALTER TABLE "SubscriptionContext" DROP COLUMN "calculatedPrice" CASCADE;
--
-- Remove field appliedRules from subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" DROP COLUMN "appliedRules" CASCADE;
--
-- Remove field basePrice from subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" DROP COLUMN "basePrice" CASCADE;
--
-- Remove field calculatedPrice from subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" DROP COLUMN "calculatedPrice" CASCADE;
--
-- Add field frozenPricingRule to subscriptioncontext
--
ALTER TABLE "SubscriptionContext" ADD COLUMN "frozenPricingRule" jsonb NULL;
--
-- Add field pricingRule to subscriptioncontext
--
ALTER TABLE "SubscriptionContext" ADD COLUMN "pricingRule" uuid NULL CONSTRAINT "SubscriptionContext_pricingRule_91d5e7e9_fk_Subscript" REFERENCES "SubscriptionPlanPricingRule"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "SubscriptionContext_pricingRule_91d5e7e9_fk_Subscript" IMMEDIATE;
--
-- Add field frozenPricingRule to subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" ADD COLUMN "frozenPricingRule" jsonb NULL;
--
-- Add field pricingRule to subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" ADD COLUMN "pricingRule" uuid NULL;
--
-- Add field customization to subscriptionplan
--
ALTER TABLE "SubscriptionPlan" ADD COLUMN "customization" boolean DEFAULT false NOT NULL;
ALTER TABLE "SubscriptionPlan" ALTER COLUMN "customization" DROP DEFAULT;
--
-- Add field customization to subscriptionplanhistoryrecord
--
ALTER TABLE "SubscriptionPlanHistoryRecord" ADD COLUMN "customization" boolean NULL;
CREATE INDEX "SubscriptionContext_pricingRule_91d5e7e9" ON "SubscriptionContext" ("pricingRule");
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field customization to subscriptionplanhistoryrecord
--
ALTER TABLE "SubscriptionPlanHistoryRecord" DROP COLUMN "customization" CASCADE;
--
-- Add field customization to subscriptionplan
--
ALTER TABLE "SubscriptionPlan" DROP COLUMN "customization" CASCADE;
--
-- Add field pricingRule to subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" DROP COLUMN "pricingRule" CASCADE;
--
-- Add field frozenPricingRule to subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" DROP COLUMN "frozenPricingRule" CASCADE;
--
-- Add field pricingRule to subscriptioncontext
--
ALTER TABLE "SubscriptionContext" DROP COLUMN "pricingRule" CASCADE;
--
-- Add field frozenPricingRule to subscriptioncontext
--
ALTER TABLE "SubscriptionContext" DROP COLUMN "frozenPricingRule" CASCADE;
--
-- Remove field calculatedPrice from subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" ADD COLUMN "calculatedPrice" numeric(18, 4) NULL;
--
-- Remove field basePrice from subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" ADD COLUMN "basePrice" numeric(18, 4) NULL;
--
-- Remove field appliedRules from subscriptioncontexthistoryrecord
--
ALTER TABLE "SubscriptionContextHistoryRecord" ADD COLUMN "appliedRules" jsonb NULL;
--
-- Remove field calculatedPrice from subscriptioncontext
--
ALTER TABLE "SubscriptionContext" ADD COLUMN "calculatedPrice" numeric(18, 8) NULL;
--
-- Remove field basePrice from subscriptioncontext
--
ALTER TABLE "SubscriptionContext" ADD COLUMN "basePrice" numeric(18, 8) NULL;
--
-- Remove field appliedRules from subscriptioncontext
--
ALTER TABLE "SubscriptionContext" ADD COLUMN "appliedRules" jsonb NOT NULL;
COMMIT;

    `)
}
