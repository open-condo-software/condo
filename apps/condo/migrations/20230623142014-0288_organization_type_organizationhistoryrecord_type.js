// auto generated by kmigrator
// KMIGRATOR:0288_organization_type_organizationhistoryrecord_type:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMS41IG9uIDIwMjMtMDYtMjMgMDk6MjAKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAyODdfbmV3c2l0ZW1fcHVibGlzaGVkYXRfYW5kX21vcmUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J29yZ2FuaXphdGlvbicsCiAgICAgICAgICAgIG5hbWU9J3R5cGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGRlZmF1bHQ9J01BTkFHSU5HX0NPTVBBTlknKSwKICAgICAgICAgICAgcHJlc2VydmVfZGVmYXVsdD1GYWxzZSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J29yZ2FuaXphdGlvbmhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSd0eXBlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field type to organization
--
ALTER TABLE "Organization" ADD COLUMN "type" text DEFAULT 'MANAGING_COMPANY' NOT NULL;
ALTER TABLE "Organization" ALTER COLUMN "type" DROP DEFAULT;
--
-- Add field type to organizationhistoryrecord
--
ALTER TABLE "OrganizationHistoryRecord" ADD COLUMN "type" text NULL;

-- [MANUAL PART] SET type holding to each non-deleted parent organization of non-deleted organization link
 UPDATE "Organization" AS O SET "type" = 'HOLDING' FROM (SELECT "from" FROM "OrganizationLink" where "deletedAt" is null) AS OL WHERE OL.from = O.id AND O."deletedAt" is null;

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field type to organizationhistoryrecord
--
ALTER TABLE "OrganizationHistoryRecord" DROP COLUMN "type" CASCADE;
--
-- Add field type to organization
--
ALTER TABLE "Organization" DROP COLUMN "type" CASCADE;
COMMIT;

    `)
}
