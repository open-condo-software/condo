// auto generated by kmigrator
// KMIGRATOR:0159_auto_20220728_2100:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi43IG9uIDIwMjItMDctMjggMjE6MDAKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKaW1wb3J0IGRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24KCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAxNThfYWx0ZXJfdGlja2V0Y29tbWVudGZpbGVfb3JnYW5pemF0aW9uX2FuZF9tb3JlJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkNyZWF0ZU1vZGVsKAogICAgICAgICAgICBuYW1lPSdyZW1vdGVjbGllbnQnLAogICAgICAgICAgICBmaWVsZHM9WwogICAgICAgICAgICAgICAgKCdkdicsIG1vZGVscy5JbnRlZ2VyRmllbGQoKSksCiAgICAgICAgICAgICAgICAoJ3NlbmRlcicsIG1vZGVscy5KU09ORmllbGQoKSksCiAgICAgICAgICAgICAgICAoJ2RldmljZUlkJywgbW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2FwcElkJywgbW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3B1c2hUb2tlbicsIG1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlLCB1bmlxdWU9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdwdXNoVHJhbnNwb3J0JywgbW9kZWxzLkNoYXJGaWVsZChibGFuaz1UcnVlLCBjaG9pY2VzPVsoJ2ZpcmViYXNlJywgJ2ZpcmViYXNlJyksICgnYXBwbGUnLCAnYXBwbGUnKSwgKCdodWF3ZWknLCAnaHVhd2VpJyldLCBtYXhfbGVuZ3RoPTUwLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnZGV2aWNlUGxhdGZvcm0nLCBtb2RlbHMuQ2hhckZpZWxkKGJsYW5rPVRydWUsIGNob2ljZXM9WygnYW5kcm9pZCcsICdhbmRyb2lkJyksICgnaW9zJywgJ2lvcycpLCAoJ3dlYicsICd3ZWInKV0sIG1heF9sZW5ndGg9NTAsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdtZXRhJywgbW9kZWxzLkpTT05GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnaWQnLCBtb2RlbHMuVVVJREZpZWxkKHByaW1hcnlfa2V5PVRydWUsIHNlcmlhbGl6ZT1GYWxzZSkpLAogICAgICAgICAgICAgICAgKCd2JywgbW9kZWxzLkludGVnZXJGaWVsZChkZWZhdWx0PTEpKSwKICAgICAgICAgICAgICAgICgnY3JlYXRlZEF0JywgbW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgZGJfaW5kZXg9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3VwZGF0ZWRBdCcsIG1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIGRiX2luZGV4PVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdkZWxldGVkQXQnLCBtb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBkYl9pbmRleD1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnbmV3SWQnLCBtb2RlbHMuVVVJREZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdjcmVhdGVkQnknLCBtb2RlbHMuRm9yZWlnbktleShibGFuaz1UcnVlLCBkYl9jb2x1bW49J2NyZWF0ZWRCeScsIG51bGw9VHJ1ZSwgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uU0VUX05VTEwsIHJlbGF0ZWRfbmFtZT0nKycsIHRvPSdfZGphbmdvX3NjaGVtYS51c2VyJykpLAogICAgICAgICAgICAgICAgKCdvd25lcicsIG1vZGVscy5Gb3JlaWduS2V5KGJsYW5rPVRydWUsIGRiX2NvbHVtbj0nb3duZXInLCBudWxsPVRydWUsIG9uX2RlbGV0ZT1kamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uLlNFVF9OVUxMLCByZWxhdGVkX25hbWU9JysnLCB0bz0nX2RqYW5nb19zY2hlbWEudXNlcicpKSwKICAgICAgICAgICAgICAgICgndXBkYXRlZEJ5JywgbW9kZWxzLkZvcmVpZ25LZXkoYmxhbms9VHJ1ZSwgZGJfY29sdW1uPSd1cGRhdGVkQnknLCBudWxsPVRydWUsIG9uX2RlbGV0ZT1kamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uLlNFVF9OVUxMLCByZWxhdGVkX25hbWU9JysnLCB0bz0nX2RqYW5nb19zY2hlbWEudXNlcicpKSwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgb3B0aW9ucz17CiAgICAgICAgICAgICAgICAnZGJfdGFibGUnOiAnUmVtb3RlQ2xpZW50JywKICAgICAgICAgICAgfSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQ3JlYXRlTW9kZWwoCiAgICAgICAgICAgIG5hbWU9J3JlbW90ZWNsaWVudGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBmaWVsZHM9WwogICAgICAgICAgICAgICAgKCdkdicsIG1vZGVscy5JbnRlZ2VyRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3NlbmRlcicsIG1vZGVscy5KU09ORmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2RldmljZUlkJywgbW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnYXBwSWQnLCBtb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdwdXNoVG9rZW4nLCBtb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdwdXNoVHJhbnNwb3J0JywgbW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgnZGV2aWNlUGxhdGZvcm0nLCBtb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdvd25lcicsIG1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ21ldGEnLCBtb2RlbHMuSlNPTkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdpZCcsIG1vZGVscy5VVUlERmllbGQocHJpbWFyeV9rZXk9VHJ1ZSwgc2VyaWFsaXplPUZhbHNlKSksCiAgICAgICAgICAgICAgICAoJ3YnLCBtb2RlbHMuSW50ZWdlckZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCdjcmVhdGVkQXQnLCBtb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpKSwKICAgICAgICAgICAgICAgICgndXBkYXRlZEF0JywgbW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2NyZWF0ZWRCeScsIG1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ3VwZGF0ZWRCeScsIG1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2RlbGV0ZWRBdCcsIG1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSkpLAogICAgICAgICAgICAgICAgKCduZXdJZCcsIG1vZGVscy5KU09ORmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSksCiAgICAgICAgICAgICAgICAoJ2hpc3RvcnlfZGF0ZScsIG1vZGVscy5EYXRlVGltZUZpZWxkKCkpLAogICAgICAgICAgICAgICAgKCdoaXN0b3J5X2FjdGlvbicsIG1vZGVscy5DaGFyRmllbGQoY2hvaWNlcz1bKCdjJywgJ2MnKSwgKCd1JywgJ3UnKSwgKCdkJywgJ2QnKV0sIG1heF9sZW5ndGg9NTApKSwKICAgICAgICAgICAgICAgICgnaGlzdG9yeV9pZCcsIG1vZGVscy5VVUlERmllbGQoZGJfaW5kZXg9VHJ1ZSkpLAogICAgICAgICAgICBdLAogICAgICAgICAgICBvcHRpb25zPXsKICAgICAgICAgICAgICAgICdkYl90YWJsZSc6ICdSZW1vdGVDbGllbnRIaXN0b3J5UmVjb3JkJywKICAgICAgICAgICAgfSwKICAgICAgICApLAojICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAojICAgICAgICAgICAgbW9kZWxfbmFtZT0nZGV2aWNlJywKIyAgICAgICAgICAgIG5hbWU9J2NyZWF0ZWRCeScsCiMgICAgICAgICksCiMgICAgICAgIG1pZ3JhdGlvbnMuUmVtb3ZlRmllbGQoCiMgICAgICAgICAgICBtb2RlbF9uYW1lPSdkZXZpY2UnLAojICAgICAgICAgICAgbmFtZT0nb3duZXInLAojICAgICAgICApLAojICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAojICAgICAgICAgICAgbW9kZWxfbmFtZT0nZGV2aWNlJywKIyAgICAgICAgICAgIG5hbWU9J3VwZGF0ZWRCeScsCiMgICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSdyZW1vdGVjbGllbnQnLAogICAgICAgICAgICBjb25zdHJhaW50PW1vZGVscy5VbmlxdWVDb25zdHJhaW50KGNvbmRpdGlvbj1tb2RlbHMuUSgoJ2RlbGV0ZWRBdF9faXNudWxsJywgVHJ1ZSkpLCBmaWVsZHM9KCdkZXZpY2VJZCcsICdhcHBJZCcpLCBuYW1lPSdyZW1vdGVfY2xpZW50X3VuaXF1ZV9kZXZpY2VJZF9hcHBJZCcpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5EZWxldGVNb2RlbCgKICAgICAgICAgICAgbmFtZT0nZGV2aWNlJywKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuRGVsZXRlTW9kZWwoCiAgICAgICAgICAgIG5hbWU9J2RldmljZWhpc3RvcnlyZWNvcmQnLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
        --
        -- Add "appId" field and update it's values
        --
        ALTER TABLE "Device" ADD COLUMN IF NOT EXISTS "appId" text DEFAULT 'unknown' NOT NULL;
        ALTER TABLE "Device" ALTER COLUMN "appId" DROP DEFAULT;        

        --
        -- Add "devicePlatform" field and update it's values
        --
        ALTER TABLE "Device" ADD COLUMN IF NOT EXISTS "devicePlatform" varchar(50) NULL;

        --
        -- Remove unique constraint on "deviceId" field
        --
        ALTER TABLE "Device" DROP CONSTRAINT "Device_deviceId_dcfed0de_uniq";
        
        --
        -- Add "appId" and "devicePlatform" fields to "RemoteClientHistoryRecord" 
        --
        ALTER TABLE "DeviceHistoryRecord" ADD COLUMN IF NOT EXISTS "appId" text NULL;
        ALTER TABLE "DeviceHistoryRecord" ADD COLUMN IF NOT EXISTS "devicePlatform" text NULL;

        --
        -- Rename model "Device" to "RemoteClient"
        --
        ALTER TABLE "Device" RENAME TO "RemoteClient";
        
        --
        -- Add unique constraint on "deviceId" + "appId" fields
        --
        CREATE UNIQUE INDEX IF NOT EXISTS "remote_client_unique_deviceId_appId" ON "RemoteClient" ("deviceId", "appId") WHERE "deletedAt" IS NULL;
        
        --
        -- Rename model "DeviceHistoryRecord" to "RemoteClientHistoryRecord";
        --
        ALTER TABLE "DeviceHistoryRecord" RENAME TO "RemoteClientHistoryRecord";
    
    COMMIT;
    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;

        --
        -- Remove unique constraint on "deviceId" + "appId" fields
        --
        DROP INDEX IF EXISTS "remote_client_unique_deviceId_appId";

        --
        -- Rename model "RemoteClient" back to "Device" 
        --
        ALTER TABLE "RemoteClient" RENAME TO "Device";

        --
        -- Restore unique constraint on "deviceId" field
        --
        ALTER TABLE "Device" ADD CONSTRAINT "Device_deviceId_dcfed0de_uniq" UNIQUE ("deviceId");

        --
        -- Remove "appId" and "devicePlatform" fields from "Device" 
        --
        ALTER TABLE "Device" DROP COLUMN "devicePlatform" CASCADE;
        ALTER TABLE "Device" DROP COLUMN "appId" CASCADE;

        --
        -- Rename model "RemoteClientHistoryRecord" back to "DeviceHistoryRecord" 
        --
        ALTER TABLE "RemoteClientHistoryRecord" RENAME TO "DeviceHistoryRecord";
        
        --
        -- Remove "appId" and "devicePlatform" fields from "RemoteClientHistoryRecord" 
        --
        ALTER TABLE "DeviceHistoryRecord" DROP COLUMN "devicePlatform" CASCADE;
        ALTER TABLE "DeviceHistoryRecord" DROP COLUMN "appId" CASCADE;

    COMMIT;
    `)
}
