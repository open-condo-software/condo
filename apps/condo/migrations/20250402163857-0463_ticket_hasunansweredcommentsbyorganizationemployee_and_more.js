// auto generated by kmigrator
// KMIGRATOR:0463_ticket_hasunansweredcommentsbyorganizationemployee_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDUuMC43IG9uIDIwMjUtMDQtMDIgMTE6MzgKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzA0NjJfYmlsbGluZ2NhdGVnb3J5X3JlY2VpcHR2YWxpZGl0eW1vbnRoc19hbmRfbW9yZScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0JywKICAgICAgICAgICAgbmFtZT0naGFzVW5hbnN3ZXJlZENvbW1lbnRzQnlPcmdhbml6YXRpb25FbXBsb3llZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldCcsCiAgICAgICAgICAgIG5hbWU9J2xhc3RDb21tZW50V2l0aE9yZ2FuaXphdGlvblR5cGVBdCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRjaGFuZ2UnLAogICAgICAgICAgICBuYW1lPSdoYXNVbmFuc3dlcmVkQ29tbWVudHNCeU9yZ2FuaXphdGlvbkVtcGxveWVlRnJvbScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2hhc1VuYW5zd2VyZWRDb21tZW50c0J5T3JnYW5pemF0aW9uRW1wbG95ZWVUbycsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2xhc3RDb21tZW50V2l0aE9yZ2FuaXphdGlvblR5cGVBdEZyb20nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0nbGFzdENvbW1lbnRXaXRoT3JnYW5pemF0aW9uVHlwZUF0VG8nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2hhc1VuYW5zd2VyZWRDb21tZW50c0J5T3JnYW5pemF0aW9uRW1wbG95ZWUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nbGFzdENvbW1lbnRXaXRoT3JnYW5pemF0aW9uVHlwZUF0JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Add field hasUnansweredCommentsByOrganizationEmployee to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "hasUnansweredCommentsByOrganizationEmployee" boolean NULL;
-- 
-- [CUSTOM] Update the hasUnansweredCommentsByOrganizationEmployee value to true or false 
UPDATE "Ticket"
SET "hasUnansweredCommentsByOrganizationEmployee" = 
    CASE 
        WHEN "lastResidentCommentAt" IS NULL OR "lastCommentWithResidentTypeAt" IS NULL THEN FALSE
        WHEN "lastResidentCommentAt" = "lastCommentWithResidentTypeAt" THEN TRUE
        WHEN "lastResidentCommentAt" < "lastCommentWithResidentTypeAt" THEN FALSE
        ELSE FALSE
    END;
--
-- [CUSTOM] Add field lastCommentWithOrganizationTypeAt to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "lastCommentWithOrganizationTypeAt" timestamp with time zone NULL;
--
-- [CUSTOM] Update the lastCommentWithOrganizationTypeAt value, where there are organization comments
UPDATE "Ticket" t
SET "lastCommentWithOrganizationTypeAt" = tc."lastCreatedAtOrganizationComment"
FROM (
    SELECT "TicketComment"."ticket", MAX("TicketComment"."createdAt") AS "lastCreatedAtOrganizationComment"
    FROM "TicketComment"
    WHERE "TicketComment"."type" = 'organization'
    GROUP BY "TicketComment"."ticket"
) AS tc
WHERE t."id" = tc."ticket";
--
-- Add field hasUnansweredCommentsByOrganizationEmployeeFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "hasUnansweredCommentsByOrganizationEmployeeFrom" boolean NULL;
--
-- Add field hasUnansweredCommentsByOrganizationEmployeeTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "hasUnansweredCommentsByOrganizationEmployeeTo" boolean NULL;
--
-- Add field lastCommentWithOrganizationTypeAtFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "lastCommentWithOrganizationTypeAtFrom" timestamp with time zone NULL;
--
-- Add field lastCommentWithOrganizationTypeAtTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "lastCommentWithOrganizationTypeAtTo" timestamp with time zone NULL;
--
-- Add field hasUnansweredCommentsByOrganizationEmployee to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "hasUnansweredCommentsByOrganizationEmployee" boolean NULL;
--
-- Add field lastCommentWithOrganizationTypeAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "lastCommentWithOrganizationTypeAt" timestamp with time zone NULL;
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field lastCommentWithOrganizationTypeAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "lastCommentWithOrganizationTypeAt" CASCADE;
--
-- Add field hasUnansweredCommentsByOrganizationEmployee to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "hasUnansweredCommentsByOrganizationEmployee" CASCADE;
--
-- Add field lastCommentWithOrganizationTypeAtTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "lastCommentWithOrganizationTypeAtTo" CASCADE;
--
-- Add field lastCommentWithOrganizationTypeAtFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "lastCommentWithOrganizationTypeAtFrom" CASCADE;
--
-- Add field hasUnansweredCommentsByOrganizationEmployeeTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "hasUnansweredCommentsByOrganizationEmployeeTo" CASCADE;
--
-- Add field hasUnansweredCommentsByOrganizationEmployeeFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "hasUnansweredCommentsByOrganizationEmployeeFrom" CASCADE;
--
-- Add field lastCommentWithOrganizationTypeAt to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "lastCommentWithOrganizationTypeAt" CASCADE;
--
-- Add field hasUnansweredCommentsByOrganizationEmployee to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "hasUnansweredCommentsByOrganizationEmployee" CASCADE;
COMMIT;

    `)
}
