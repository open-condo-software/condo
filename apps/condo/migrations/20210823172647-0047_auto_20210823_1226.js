// auto generated by kmigrator
// KMIGRATOR:0047_auto_20210823_1226:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi40IG9uIDIwMjEtMDgtMjMgMTI6MjYKCmltcG9ydCBkamFuZ28uY29udHJpYi5wb3N0Z3Jlcy5maWVsZHMuanNvbmIKZnJvbSBkamFuZ28uZGIgaW1wb3J0IG1pZ3JhdGlvbnMsIG1vZGVscwoKCmNsYXNzIE1pZ3JhdGlvbihtaWdyYXRpb25zLk1pZ3JhdGlvbik6CgogICAgZGVwZW5kZW5jaWVzID0gWwogICAgICAgICgnX2RqYW5nb19zY2hlbWEnLCAnMDA0Nl9hdXRvXzIwMjEwODIwXzEzMjgnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2JpbGxpbmdpbnRlZ3JhdGlvbicsCiAgICAgICAgICAgIG5hbWU9J2RhdGFGb3JtYXQnLAogICAgICAgICAgICBmaWVsZD1kamFuZ28uY29udHJpYi5wb3N0Z3Jlcy5maWVsZHMuanNvbmIuSlNPTkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5naW50ZWdyYXRpb25oaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nZGF0YUZvcm1hdCcsCiAgICAgICAgICAgIGZpZWxkPWRqYW5nby5jb250cmliLnBvc3RncmVzLmZpZWxkcy5qc29uYi5KU09ORmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ3JlY2VpcHQnLAogICAgICAgICAgICBuYW1lPSdpbXBvcnRJZCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQodW5pcXVlPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field dataFormat to billingintegration
--
ALTER TABLE "BillingIntegration" ADD COLUMN "dataFormat" jsonb NULL;
--
-- Add field dataFormat to billingintegrationhistoryrecord
--
ALTER TABLE "BillingIntegrationHistoryRecord" ADD COLUMN "dataFormat" jsonb NULL;
--
-- Truncate all rows on billingReceipts (made intentionally by @toplenboren)
--
TRUNCATE TABLE "BillingReceipt";
--
-- Alter field importId on billingreceipt and set UNIQUE as combination of contextId and importId (made intentionally by @toplenboren)
--
ALTER TABLE "BillingReceipt" ALTER COLUMN "importId" SET NOT NULL;
ALTER TABLE "BillingReceipt" ADD CONSTRAINT "BillingReceipt_importId_9da6acbf_uniq" UNIQUE ("context", "importId");
CREATE INDEX "BillingReceipt_importId_9da6acbf_like" ON "BillingReceipt" ("importId" text_pattern_ops);
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Alter field importId on billingreceipt
--
ALTER TABLE "BillingReceipt" ALTER COLUMN "importId" DROP NOT NULL;
DROP INDEX IF EXISTS "BillingReceipt_importId_9da6acbf_like";
--
-- Add field dataFormat to billingintegrationhistoryrecord
--
ALTER TABLE "BillingIntegrationHistoryRecord" DROP COLUMN "dataFormat" CASCADE;
--
-- Add field dataFormat to billingintegration
--
ALTER TABLE "BillingIntegration" DROP COLUMN "dataFormat" CASCADE;
COMMIT;

    `)
}
