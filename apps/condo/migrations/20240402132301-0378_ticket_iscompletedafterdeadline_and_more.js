// auto generated by kmigrator
// KMIGRATOR:0378_ticket_iscompletedafterdeadline_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDQtMDIgMDg6MjMKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNzdfYXV0b18yMDI0MDMyN18xNjU1JyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXQnLAogICAgICAgICAgICBuYW1lPSdpc0NvbXBsZXRlZEFmdGVyRGVhZGxpbmUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGRlZmF1bHQ9RmFsc2UpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2lzQ29tcGxldGVkQWZ0ZXJEZWFkbGluZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';  

--
-- Add field isCompletedAfterDeadline to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "isCompletedAfterDeadline" boolean DEFAULT false NOT NULL;
ALTER TABLE "Ticket" ALTER COLUMN "isCompletedAfterDeadline" DROP DEFAULT;
--
-- Add field isCompletedAfterDeadline to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "isCompletedAfterDeadline" boolean NULL;

-- [CUSTOM] Set "isCompletedAfterDeadline" to "true" for tickets in status "completed" and "closed" that were completed after the deadline
UPDATE "Ticket" SET "isCompletedAfterDeadline" = true WHERE "status" IN ('5b9decd7-792c-42bb-b16d-822142fd2d69', 'c14a58e0-6b5d-4ec2-b91c-980a90111c7d') AND "deadline" < "completedAt";

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field isCompletedAfterDeadline to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "isCompletedAfterDeadline" CASCADE;
--
-- Add field isCompletedAfterDeadline to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "isCompletedAfterDeadline" CASCADE;
COMMIT;

    `)
}
