// auto generated by kmigrator
// KMIGRATOR:0380_auto_20240410_0515:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi41IG9uIDIwMjQtMDQtMTAgMDU6MTUKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNzlfdXNlcmhlbHByZXF1ZXN0X3VzZXJoZWxwcmVxdWVzdGZpbGVfdXNlcmhlbHByZXF1ZXN0ZmlsZWhpc3RvcnlyZWNvcmRfdXNlcmhlbHByZXF1ZXN0aGlzdG9yeXJlY29yZCcpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0JywKICAgICAgICAgICAgbmFtZT0nbGFzdENvbW1lbnRXaXRoUmVzaWRlbnRUeXBlQXQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0nbGFzdENvbW1lbnRXaXRoUmVzaWRlbnRUeXBlQXRGcm9tJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2xhc3RDb21tZW50V2l0aFJlc2lkZW50VHlwZUF0VG8nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2xhc3RDb21tZW50V2l0aFJlc2lkZW50VHlwZUF0JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';      

--
-- Add field lastCommentWithResidentTypeAt to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "lastCommentWithResidentTypeAt" timestamp with time zone NULL;
--
-- Add field lastCommentWithResidentTypeAtFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "lastCommentWithResidentTypeAtFrom" timestamp with time zone NULL;
--
-- Add field lastCommentWithResidentTypeAtTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "lastCommentWithResidentTypeAtTo" timestamp with time zone NULL;
--
-- Add field lastCommentWithResidentTypeAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "lastCommentWithResidentTypeAt" timestamp with time zone NULL;

--
-- [CUSTOM] Remove TicketCommentsTime duplicates with same ticket
--
UPDATE "TicketCommentsTime" t1
SET "deletedAt" = now()
WHERE "lastCommentAt" < (
    SELECT MAX("lastCommentAt")
    FROM "TicketCommentsTime" t2
    WHERE t1.ticket = t2.ticket and t2."deletedAt" is null and t1."deletedAt" is null
);

--
-- [CUSTOM] Set Ticket.lastCommentWithResidentType = TicketCommentsTime.lastCommentAt
--
UPDATE "Ticket"
SET "lastCommentWithResidentTypeAt" = (
    SELECT "lastCommentAt"
    FROM "TicketCommentsTime"
    WHERE "ticket" = "Ticket".id AND "TicketCommentsTime"."deletedAt" IS NULL
    LIMIT 1
);

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field lastCommentWithResidentTypeAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "lastCommentWithResidentTypeAt" CASCADE;
--
-- Add field lastCommentWithResidentTypeAtTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "lastCommentWithResidentTypeAtTo" CASCADE;
--
-- Add field lastCommentWithResidentTypeAtFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "lastCommentWithResidentTypeAtFrom" CASCADE;
--
-- Add field lastCommentWithResidentTypeAt to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "lastCommentWithResidentTypeAt" CASCADE;
COMMIT;

    `)
}
