// auto generated by kmigrator
// KMIGRATOR:0376_newsitem_postponeuntil_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDMtMjYgMTQ6MjQKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNzVfYjJjYXBwYWNjZXNzcmlnaHRfaW1wb3J0aWRfYW5kX21vcmUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J25ld3NpdGVtJywKICAgICAgICAgICAgbmFtZT0ncG9zdHBvbmVVbnRpbCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSduZXdzaXRlbWhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdwb3N0cG9uZVVudGlsJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';  

--
-- Add field postponeUntil to newsitem
--
ALTER TABLE "NewsItem" ADD COLUMN "postponeUntil" timestamp with time zone NULL;
--
-- Add field postponeUntil to newsitemhistoryrecord
--
ALTER TABLE "NewsItemHistoryRecord" ADD COLUMN "postponeUntil" timestamp with time zone NULL;

--
-- [CUSTOM] 1. Move data from "sendAt" to "postponeUntil" in "NewsItem" and "NewsItemHistoryRecord" tables
--
UPDATE "NewsItem" SET "postponeUntil" = "sendAt";
UPDATE "NewsItemHistoryRecord" SET "postponeUntil" = "sendAt";
--
-- [CUSTOM] 2. Update "sendAt" to NULL in "NewsItem" and "NewsItemHistoryRecord" tables
--
UPDATE "NewsItem" SET "sendAt" = NULL;
UPDATE "NewsItemHistoryRecord" SET "sendAt" = NULL;
--
-- [CUSTOM] 3. Set "sendAt" to "publishedAt" + 15 seconds if news is already published and has not "postponeUntil"
--
UPDATE "NewsItem" SET "sendAt" = "publishedAt" + interval '15 seconds' WHERE "isPublished" = TRUE AND "postponeUntil" IS NULL AND "publishedAt" IS NOT NULL;
--
-- [CUSTOM] 4. Set "sendAt" to "postponeUntil" if news is already published and has "postponeUntil"
--
UPDATE "NewsItem" SET "sendAt" = "postponeUntil" WHERE "isPublished" = TRUE AND "postponeUntil" IS NOT NULL;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';

--
-- [CUSTOM] Move data from "postponeUntil" to "sendAt" in "NewsItem" and "NewsItemHistoryRecord" tables
--
UPDATE "NewsItem" SET "sendAt" = "postponeUntil";
UPDATE "NewsItemHistoryRecord" SET "sendAt" = "postponeUntil";

--
-- Add field postponeUntil to newsitemhistoryrecord
--
ALTER TABLE "NewsItemHistoryRecord" DROP COLUMN "postponeUntil" CASCADE;
--
-- Add field postponeUntil to newsitem
--
ALTER TABLE "NewsItem" DROP COLUMN "postponeUntil" CASCADE;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}
