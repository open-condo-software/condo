// auto generated by kmigrator
// KMIGRATOR:0380_auto_20240411_0615:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi41IG9uIDIwMjQtMDQtMTEgMDY6MTUKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNzlfdXNlcmhlbHByZXF1ZXN0X3VzZXJoZWxwcmVxdWVzdGZpbGVfdXNlcmhlbHByZXF1ZXN0ZmlsZWhpc3RvcnlyZWNvcmRfdXNlcmhlbHByZXF1ZXN0aGlzdG9yeXJlY29yZCcpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiMgICAgICAgIG1pZ3JhdGlvbnMuUmVtb3ZlRmllbGQoCiMgICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRjb21tZW50c3RpbWUnLAojICAgICAgICAgICAgbmFtZT0nY3JlYXRlZEJ5JywKIyAgICAgICAgKSwKIyAgICAgICAgbWlncmF0aW9ucy5SZW1vdmVGaWVsZCgKIyAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNvbW1lbnRzdGltZScsCiMgICAgICAgICAgICBuYW1lPSdvcmdhbml6YXRpb24nLAojICAgICAgICApLAojICAgICAgICBtaWdyYXRpb25zLlJlbW92ZUZpZWxkKAojICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y29tbWVudHN0aW1lJywKIyAgICAgICAgICAgIG5hbWU9J3RpY2tldCcsCiMgICAgICAgICksCiMgICAgICAgIG1pZ3JhdGlvbnMuUmVtb3ZlRmllbGQoCiMgICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRjb21tZW50c3RpbWUnLAojICAgICAgICAgICAgbmFtZT0ndXBkYXRlZEJ5JywKIyAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXQnLAogICAgICAgICAgICBuYW1lPSdsYXN0Q29tbWVudFdpdGhSZXNpZGVudFR5cGVBdCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nbGFzdENvbW1lbnRXaXRoUmVzaWRlbnRUeXBlQXQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRGF0ZVRpbWVGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5EZWxldGVNb2RlbCgKICAgICAgICAgICAgbmFtZT0ndGlja2V0Y29tbWVudHN0aW1lJywKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuRGVsZXRlTW9kZWwoCiAgICAgICAgICAgIG5hbWU9J3RpY2tldGNvbW1lbnRzdGltZWhpc3RvcnlyZWNvcmQnLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';      
    
--
-- Add field lastCommentWithResidentTypeAt to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "lastCommentWithResidentTypeAt" timestamp with time zone NULL;
--
-- Add field lastCommentWithResidentTypeAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "lastCommentWithResidentTypeAt" timestamp with time zone NULL;

--
-- [CUSTOM] Remove TicketCommentsTime duplicates with same ticket
--
UPDATE "TicketCommentsTime" t1
SET "deletedAt" = now()
WHERE "lastCommentAt" < (
    SELECT MAX("lastCommentAt")
    FROM "TicketCommentsTime" t2
    WHERE t1.ticket = t2.ticket and t2."deletedAt" is null and t1."deletedAt" is null
);

--
-- [CUSTOM] Set Ticket.lastCommentWithResidentType = TicketCommentsTime.lastCommentAt
--
UPDATE "Ticket"
SET "lastCommentWithResidentTypeAt" = (
    SELECT "lastCommentAt"
    FROM "TicketCommentsTime"
    WHERE "ticket" = "Ticket".id AND "TicketCommentsTime"."deletedAt" IS NULL
    LIMIT 1
);

--
-- Delete model ticketcommentstime
--
-- DROP TABLE "TicketCommentsTime" CASCADE;
--
-- Delete model ticketcommentstimehistoryrecord
--
-- DROP TABLE "TicketCommentsTimeHistoryRecord" CASCADE;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Delete model ticketcommentstimehistoryrecord
--
CREATE TABLE "TicketCommentsTimeHistoryRecord" ("dv" integer NULL, "sender" jsonb NULL, "organization" uuid NULL, "ticket" uuid NULL, "lastCommentAt" timestamp with time zone NULL, "lastResidentCommentAt" timestamp with time zone NULL, "id" uuid NOT NULL PRIMARY KEY, "v" integer NULL, "createdAt" timestamp with time zone NULL, "updatedAt" timestamp with time zone NULL, "createdBy" uuid NULL, "updatedBy" uuid NULL, "deletedAt" timestamp with time zone NULL, "newId" jsonb NULL, "history_date" timestamp with time zone NOT NULL, "history_action" varchar(50) NOT NULL, "history_id" uuid NOT NULL);
--
-- Delete model ticketcommentstime
--
CREATE TABLE "TicketCommentsTime" ("dv" integer NOT NULL, "sender" jsonb NOT NULL, "lastCommentAt" timestamp with time zone NOT NULL, "lastResidentCommentAt" timestamp with time zone NULL, "id" uuid NOT NULL PRIMARY KEY, "v" integer NOT NULL, "createdAt" timestamp with time zone NULL, "updatedAt" timestamp with time zone NULL, "deletedAt" timestamp with time zone NULL, "newId" uuid NULL, "createdBy" uuid NULL, "organization" uuid NOT NULL, "ticket" uuid NOT NULL, "updatedBy" uuid NULL);
--
-- Add field lastCommentWithResidentTypeAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "lastCommentWithResidentTypeAt" CASCADE;
--
-- Add field lastCommentWithResidentTypeAt to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "lastCommentWithResidentTypeAt" CASCADE;
CREATE INDEX "TicketCommentsTimeHistoryRecord_history_id_e7111640" ON "TicketCommentsTimeHistoryRecord" ("history_id");
ALTER TABLE "TicketCommentsTime" ADD CONSTRAINT "TicketCommentsTime_createdBy_1afab486_fk_User_id" FOREIGN KEY ("createdBy") REFERENCES "User" ("id") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "TicketCommentsTime" ADD CONSTRAINT "TicketCommentsTime_organization_53dc9c14_fk_Organization_id" FOREIGN KEY ("organization") REFERENCES "Organization" ("id") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "TicketCommentsTime" ADD CONSTRAINT "TicketCommentsTime_ticket_c029460f_fk_Ticket_id" FOREIGN KEY ("ticket") REFERENCES "Ticket" ("id") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "TicketCommentsTime" ADD CONSTRAINT "TicketCommentsTime_updatedBy_f363c717_fk_User_id" FOREIGN KEY ("updatedBy") REFERENCES "User" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "TicketCommentsTime_createdAt_45c0dd44" ON "TicketCommentsTime" ("createdAt");
CREATE INDEX "TicketCommentsTime_updatedAt_d2bc7de3" ON "TicketCommentsTime" ("updatedAt");
CREATE INDEX "TicketCommentsTime_deletedAt_783b0035" ON "TicketCommentsTime" ("deletedAt");
CREATE INDEX "TicketCommentsTime_createdBy_1afab486" ON "TicketCommentsTime" ("createdBy");
CREATE INDEX "TicketCommentsTime_organization_53dc9c14" ON "TicketCommentsTime" ("organization");
CREATE INDEX "TicketCommentsTime_ticket_c029460f" ON "TicketCommentsTime" ("ticket");
CREATE INDEX "TicketCommentsTime_updatedBy_f363c717" ON "TicketCommentsTime" ("updatedBy");
COMMIT;

    `)
}
