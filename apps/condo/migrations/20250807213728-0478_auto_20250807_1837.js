// auto generated by kmigrator
// KMIGRATOR:0478_auto_20250807_1837:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMi4xMyBvbiAyMDI1LTA4LTA3IDE4OjM3Cgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucwoKCmNsYXNzIE1pZ3JhdGlvbihtaWdyYXRpb25zLk1pZ3JhdGlvbik6CgogICAgZGVwZW5kZW5jaWVzID0gWwogICAgICAgICgnX2RqYW5nb19zY2hlbWEnLCAnMDQ3N191c2VyX2V4dGVybmFsZW1haWxfdXNlcl9leHRlcm5hbHBob25lX2FuZF9tb3JlJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
        BEGIN;

        UPDATE "MeterReadingFilterTemplate"
        SET "fields" = jsonb_set(
        "fields"::jsonb,
        '{place}',
        jsonb_build_array("fields"->>'place'),
        true)
        WHERE "fields"->>'place' IS NOT NULL
        AND jsonb_typeof("fields"->'place') = 'string';

        COMMIT;
  `)
}

exports.down = async (knex) => {
    await knex.raw(`
        BEGIN;

        UPDATE "MeterReadingFilterTemplate"
        SET "fields" = jsonb_set(
        "fields"::jsonb,
        '{place}',
        CASE
            WHEN jsonb_array_length("fields"->'place') > 0
            THEN to_jsonb("fields"->'place'->>0)
            ELSE 'null'::jsonb
        END,
        true)
        WHERE jsonb_typeof("fields"->'place') = 'array';

        COMMIT;
  `)
}
