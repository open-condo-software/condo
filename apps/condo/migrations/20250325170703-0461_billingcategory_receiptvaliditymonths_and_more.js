// auto generated by kmigrator
// KMIGRATOR:0461_billingcategory_receiptvaliditymonths_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMi4xMyBvbiAyMDI1LTAzLTI1IDE0OjA3Cgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucywgbW9kZWxzCgoKY2xhc3MgTWlncmF0aW9uKG1pZ3JhdGlvbnMuTWlncmF0aW9uKToKCiAgICBkZXBlbmRlbmNpZXMgPSBbCiAgICAgICAgKCdfZGphbmdvX3NjaGVtYScsICcwNDYwX2F1dG9fMjAyNTAzMTNfMDQ1OScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ2NhdGVnb3J5JywKICAgICAgICAgICAgbmFtZT0ncmVjZWlwdFZhbGlkaXR5TW9udGhzJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkludGVnZXJGaWVsZChkZWZhdWx0PTMpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ2NhdGVnb3J5JywKICAgICAgICAgICAgbmFtZT0ncmVxdWlyZXNGdWxsUGF5bWVudCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5Cb29sZWFuRmllbGQoZGVmYXVsdD1GYWxzZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5nY2F0ZWdvcnknLAogICAgICAgICAgICBuYW1lPSdzZW5kUmVjZWlwdE5vdGlmaWNhdGlvbnMnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGRlZmF1bHQ9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5nY2F0ZWdvcnloaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0ncmVjZWlwdFZhbGlkaXR5TW9udGhzJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkludGVnZXJGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nYmlsbGluZ2NhdGVnb3J5aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J3JlcXVpcmVzRnVsbFBheW1lbnQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQm9vbGVhbkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdiaWxsaW5nY2F0ZWdvcnloaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nc2VuZFJlY2VpcHROb3RpZmljYXRpb25zJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkJvb2xlYW5GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
    --
    -- Add field receiptValidityMonths to billingcategory
    --
    ALTER TABLE "BillingCategory" ADD COLUMN "receiptValidityMonths" integer DEFAULT 3 NOT NULL;
    ALTER TABLE "BillingCategory" ALTER COLUMN "receiptValidityMonths" DROP DEFAULT;
    --
    -- Add field requiresFullPayment to billingcategory
    --
    ALTER TABLE "BillingCategory" ADD COLUMN "requiresFullPayment" boolean DEFAULT false NOT NULL;
    ALTER TABLE "BillingCategory" ALTER COLUMN "requiresFullPayment" DROP DEFAULT;
    --
    -- Add field sendReceiptNotifications to billingcategory
    --
    ALTER TABLE "BillingCategory" ADD COLUMN "sendReceiptNotifications" boolean DEFAULT true NOT NULL;
    ALTER TABLE "BillingCategory" ALTER COLUMN "sendReceiptNotifications" DROP DEFAULT;
    --
    -- Add field receiptValidityMonths to billingcategoryhistoryrecord
    --
    ALTER TABLE "BillingCategoryHistoryRecord" ADD COLUMN "receiptValidityMonths" integer NULL;
    --
    -- Add field requiresFullPayment to billingcategoryhistoryrecord
    --
    ALTER TABLE "BillingCategoryHistoryRecord" ADD COLUMN "requiresFullPayment" boolean NULL;
    --
    -- Add field sendReceiptNotifications to billingcategoryhistoryrecord
    --
    ALTER TABLE "BillingCategoryHistoryRecord" ADD COLUMN "sendReceiptNotifications" boolean NULL;
    
    
    -- MANUAL
    
    --
    -- Add insurance category to billingCategory with sendReceiptNotifications set to FALSE,
    -- receiptValidityMonths set to 1 and requiresFullPayment set to TRUE
    --
    INSERT INTO public."BillingCategory" (dv, sender, name, id, v, "createdAt", "updatedAt", "deletedAt", "newId", "createdBy", "updatedBy",
        "sendReceiptNotifications", "receiptValidityMonths", "requiresFullPayment")
    VALUES (1::integer, '{"dv": 1, "fingerprint":"sql-migration"}'::jsonb, 'billing.category.insurance.name'::text,
            '55dd01e4-a87c-4713-8a91-951516b543f3'::uuid, 1::integer, null::timestamp with time zone,
            null::timestamp with time zone, null::timestamp with time zone, null::uuid, null::uuid, null::uuid,
            FALSE, 1::integer, TRUE);
            
    --
    -- Set correct fields to membership fee category  
    --
    UPDATE public."BillingCategory"
    SET 
        "sendReceiptNotifications" = FALSE,
        "receiptValidityMonths" = 12,
        "requiresFullPayment" = FALSE
    WHERE 
        id = 'ceede926-055d-417b-b6ef-b2161ed7b684'; 
    
    COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
    --
    -- Add field sendReceiptNotifications to billingcategoryhistoryrecord
    --
    ALTER TABLE "BillingCategoryHistoryRecord" DROP COLUMN "sendReceiptNotifications" CASCADE;
    --
    -- Add field requiresFullPayment to billingcategoryhistoryrecord
    --
    ALTER TABLE "BillingCategoryHistoryRecord" DROP COLUMN "requiresFullPayment" CASCADE;
    --
    -- Add field receiptValidityMonths to billingcategoryhistoryrecord
    --
    ALTER TABLE "BillingCategoryHistoryRecord" DROP COLUMN "receiptValidityMonths" CASCADE;
    --
    -- Add field sendReceiptNotifications to billingcategory
    --
    ALTER TABLE "BillingCategory" DROP COLUMN "sendReceiptNotifications" CASCADE;
    --
    -- Add field requiresFullPayment to billingcategory
    --
    ALTER TABLE "BillingCategory" DROP COLUMN "requiresFullPayment" CASCADE;
    --
    -- Add field receiptValidityMonths to billingcategory
    --
    ALTER TABLE "BillingCategory" DROP COLUMN "receiptValidityMonths" CASCADE;
    
    --
    -- MANUAL. Remove insurance category from billingCategory
    --
    DELETE FROM "BillingCategory" where id = '55dd01e4-a87c-4713-8a91-951516b543f3';
    
    COMMIT;

    `)
}
