// auto generated by kmigrator
// KMIGRATOR:0339_auto_20231101_1152:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi41IG9uIDIwMjMtMTEtMDEgMTE6NTIKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzMzhfdXNlcnJpZ2h0c3NldF9jYW5tYW5hZ2VpbnZvaWNlY29udGV4dHNfYW5kX21vcmUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuUmVtb3ZlQ29uc3RyYWludCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0cHJvcGVydHloaW50cHJvcGVydHknLAogICAgICAgICAgICBuYW1lPSd1bmlxdWVfdGlja2V0UHJvcGVydHlIaW50X2FuZF9wcm9wZXJ0eScsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZENvbnN0cmFpbnQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldHByb3BlcnR5aGludHByb3BlcnR5JywKICAgICAgICAgICAgY29uc3RyYWludD1tb2RlbHMuVW5pcXVlQ29uc3RyYWludChjb25kaXRpb249bW9kZWxzLlEoKCdkZWxldGVkQXRfX2lzbnVsbCcsIFRydWUpKSwgZmllbGRzPSgncHJvcGVydHknLCksIG5hbWU9J1RpY2tldFByb3BlcnR5SGludFByb3BlcnR5X3VuaXF1ZV9wcm9wZXJ0eScpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s'; 

UPDATE "TicketPropertyHintProperty" AS t1
SET "deletedAt" = NOW()
WHERE EXISTS (
  SELECT 1
  FROM "TicketPropertyHintProperty" AS t2
  WHERE t1.property = t2.property
  AND t1."deletedAt" IS NULL
  AND t2."deletedAt" IS NULL
);

--
-- Remove constraint unique_ticketPropertyHint_and_property from model ticketpropertyhintproperty
--
DROP INDEX IF EXISTS "unique_ticketPropertyHint_and_property";
--
-- Create constraint TicketPropertyHintProperty_unique_property on model ticketpropertyhintproperty
--
CREATE UNIQUE INDEX "TicketPropertyHintProperty_unique_property" ON "TicketPropertyHintProperty" ("property") WHERE "deletedAt" IS NULL;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint TicketPropertyHintProperty_unique_property on model ticketpropertyhintproperty
--
DROP INDEX IF EXISTS "TicketPropertyHintProperty_unique_property";
--
-- Remove constraint unique_ticketPropertyHint_and_property from model ticketpropertyhintproperty
--
CREATE UNIQUE INDEX "unique_ticketPropertyHint_and_property" ON "TicketPropertyHintProperty" ("ticketPropertyHint", "property") WHERE "deletedAt" IS NULL;
COMMIT;

    `)
}
