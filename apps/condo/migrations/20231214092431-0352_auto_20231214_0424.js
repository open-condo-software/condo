// auto generated by kmigrator
// KMIGRATOR:0352_auto_20231214_0424:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMi41IG9uIDIwMjMtMTItMTQgMDQ6MjQKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNTFfbmV3c2l0ZW1zaGFyaW5naGlzdG9yeXJlY29yZF9hbmRfbW9yZScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5SZW1vdmVDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRwcm9wZXJ0eWhpbnRwcm9wZXJ0eScsCiAgICAgICAgICAgIG5hbWU9J3VuaXF1ZV90aWNrZXRQcm9wZXJ0eUhpbnRfYW5kX3Byb3BlcnR5JywKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkQ29uc3RyYWludCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0cHJvcGVydHloaW50cHJvcGVydHknLAogICAgICAgICAgICBjb25zdHJhaW50PW1vZGVscy5VbmlxdWVDb25zdHJhaW50KGNvbmRpdGlvbj1tb2RlbHMuUSgoJ2RlbGV0ZWRBdF9faXNudWxsJywgVHJ1ZSkpLCBmaWVsZHM9KCdwcm9wZXJ0eScsKSwgbmFtZT0nVGlja2V0UHJvcGVydHlIaW50UHJvcGVydHlfdW5pcXVlX3Byb3BlcnR5JyksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s'; 

UPDATE "TicketPropertyHintProperty" AS t1
SET "deletedAt" = NOW()
WHERE EXISTS (
  SELECT 1
  FROM "TicketPropertyHintProperty" AS t2
  WHERE t1.property = t2.property
  AND t1."deletedAt" IS NULL
  AND t2."deletedAt" IS NULL
);

--
-- Remove constraint unique_ticketPropertyHint_and_property from model ticketpropertyhintproperty
--
DROP INDEX IF EXISTS "unique_ticketPropertyHint_and_property";
--
-- Create constraint TicketPropertyHintProperty_unique_property on model ticketpropertyhintproperty
--
CREATE UNIQUE INDEX "TicketPropertyHintProperty_unique_property" ON "TicketPropertyHintProperty" ("property") WHERE "deletedAt" IS NULL;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint TicketPropertyHintProperty_unique_property on model ticketpropertyhintproperty
--
DROP INDEX IF EXISTS "TicketPropertyHintProperty_unique_property";
--
-- Remove constraint unique_ticketPropertyHint_and_property from model ticketpropertyhintproperty
--
CREATE UNIQUE INDEX "unique_ticketPropertyHint_and_property" ON "TicketPropertyHintProperty" ("ticketPropertyHint", "property") WHERE "deletedAt" IS NULL;
COMMIT;

    `)
}
