// auto generated by kmigrator
// KMIGRATOR:0198_alter_organizationemployee_role:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMSBvbiAyMDIyLTEyLTA4IDA5OjI4Cgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucywgbW9kZWxzCmltcG9ydCBkamFuZ28uZGIubW9kZWxzLmRlbGV0aW9uCgoKY2xhc3MgTWlncmF0aW9uKG1pZ3JhdGlvbnMuTWlncmF0aW9uKToKCiAgICBkZXBlbmRlbmNpZXMgPSBbCiAgICAgICAgKCdfZGphbmdvX3NjaGVtYScsICcwMTk2X2NvbnRhY3RfY29udGFjdF91bmlxdWVfcHJvcGVydHlfdW5pdG5hbWVfdW5pdHR5cGVfcGhvbmUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uZW1wbG95ZWUnLAogICAgICAgICAgICBuYW1lPSdyb2xlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoZGJfY29sdW1uPSdyb2xlJywgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uQ0FTQ0FERSwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLm9yZ2FuaXphdGlvbmVtcGxveWVlcm9sZScpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';  

--
-- [CUSTOM] Set contractor role and soft delete existing employees without role
--
UPDATE "OrganizationEmployee"
SET "role" = (
    SELECT id FROM "OrganizationEmployeeRole"
    WHERE name = 'employee.role.Contractor.name'
      AND "OrganizationEmployeeRole".organization = "OrganizationEmployee".organization
    ),
    "deletedAt" = now()
WHERE "role" IS NULL;

--
-- Alter field role on organizationemployee
--
SET CONSTRAINTS "OrganizationEmployee_role_d3e010b5_fk_Organizat" IMMEDIATE; 
ALTER TABLE "OrganizationEmployee" DROP CONSTRAINT "OrganizationEmployee_role_d3e010b5_fk_Organizat";
ALTER TABLE "OrganizationEmployee" ALTER COLUMN "role" SET NOT NULL;
ALTER TABLE "OrganizationEmployee" ADD CONSTRAINT "OrganizationEmployee_role_d3e010b5_fk_Organizat" FOREIGN KEY ("role") REFERENCES "OrganizationEmployeeRole" ("id") DEFERRABLE INITIALLY DEFERRED;

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Alter field role on organizationemployee
--
SET CONSTRAINTS "OrganizationEmployee_role_d3e010b5_fk_Organizat" IMMEDIATE; ALTER TABLE "OrganizationEmployee" DROP CONSTRAINT "OrganizationEmployee_role_d3e010b5_fk_Organizat";
ALTER TABLE "OrganizationEmployee" ALTER COLUMN "role" DROP NOT NULL;
ALTER TABLE "OrganizationEmployee" ADD CONSTRAINT "OrganizationEmployee_role_d3e010b5_fk_Organizat" FOREIGN KEY ("role") REFERENCES "OrganizationEmployeeRole" ("id") DEFERRABLE INITIALLY DEFERRED;
COMMIT;

    `)
}
