// auto generated by kmigrator
// KMIGRATOR:0276_ticket_feedbackadditionaloptions_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjMtMDYtMDEgMTI6MTIKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAyNzVfYWx0ZXJfbWVzc2FnZV9zdGF0dXMnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldCcsCiAgICAgICAgICAgIG5hbWU9J2ZlZWRiYWNrQWRkaXRpb25hbE9wdGlvbnMnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuSlNPTkZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXQnLAogICAgICAgICAgICBuYW1lPSdmZWVkYmFja0NvbW1lbnQnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXQnLAogICAgICAgICAgICBuYW1lPSdmZWVkYmFja1VwZGF0ZWRBdCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXQnLAogICAgICAgICAgICBuYW1lPSdmZWVkYmFja1ZhbHVlJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkNoYXJGaWVsZChibGFuaz1UcnVlLCBjaG9pY2VzPVsoJ2JhZCcsICdiYWQnKSwgKCdnb29kJywgJ2dvb2QnKSwgKCdyZXR1cm5lZCcsICdyZXR1cm5lZCcpXSwgbWF4X2xlbmd0aD01MCwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2ZlZWRiYWNrQWRkaXRpb25hbE9wdGlvbnNGcm9tJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkpTT05GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0nZmVlZGJhY2tBZGRpdGlvbmFsT3B0aW9uc1RvJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkpTT05GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0nZmVlZGJhY2tDb21tZW50RnJvbScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2ZlZWRiYWNrQ29tbWVudFRvJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0nZmVlZGJhY2tWYWx1ZUZyb20nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQ2hhckZpZWxkKGJsYW5rPVRydWUsIGNob2ljZXM9WygnYmFkJywgJ2JhZCcpLCAoJ2dvb2QnLCAnZ29vZCcpLCAoJ3JldHVybmVkJywgJ3JldHVybmVkJyldLCBtYXhfbGVuZ3RoPTUwLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0Y2hhbmdlJywKICAgICAgICAgICAgbmFtZT0nZmVlZGJhY2tWYWx1ZVRvJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkNoYXJGaWVsZChibGFuaz1UcnVlLCBjaG9pY2VzPVsoJ2JhZCcsICdiYWQnKSwgKCdnb29kJywgJ2dvb2QnKSwgKCdyZXR1cm5lZCcsICdyZXR1cm5lZCcpXSwgbWF4X2xlbmd0aD01MCwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdmZWVkYmFja0FkZGl0aW9uYWxPcHRpb25zJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkpTT05GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICAgICAgbWlncmF0aW9ucy5BZGRGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndGlja2V0aGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2ZlZWRiYWNrQ29tbWVudCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J3RpY2tldGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdmZWVkYmFja1VwZGF0ZWRBdCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRoaXN0b3J5cmVjb3JkJywKICAgICAgICAgICAgbmFtZT0nZmVlZGJhY2tWYWx1ZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

--
-- [CUSTOM] 0 - Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--

SET statement_timeout = '1500s';

--
-- Add field feedbackAdditionalOptions to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "feedbackAdditionalOptions" jsonb NULL;
--
-- Add field feedbackComment to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "feedbackComment" text NULL;
--
-- Add field feedbackUpdatedAt to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "feedbackUpdatedAt" timestamp with time zone NULL;
--
-- Add field feedbackValue to ticket
--
ALTER TABLE "Ticket" ADD COLUMN "feedbackValue" varchar(50) NULL;
--
-- Add field feedbackAdditionalOptionsFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "feedbackAdditionalOptionsFrom" jsonb NULL;
--
-- Add field feedbackAdditionalOptionsTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "feedbackAdditionalOptionsTo" jsonb NULL;
--
-- Add field feedbackCommentFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "feedbackCommentFrom" text NULL;
--
-- Add field feedbackCommentTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "feedbackCommentTo" text NULL;
--
-- Add field feedbackValueFrom to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "feedbackValueFrom" varchar(50) NULL;
--
-- Add field feedbackValueTo to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "feedbackValueTo" varchar(50) NULL;
--
-- Add field feedbackAdditionalOptions to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "feedbackAdditionalOptions" jsonb NULL;
--
-- Add field feedbackComment to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "feedbackComment" text NULL;
--
-- Add field feedbackUpdatedAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "feedbackUpdatedAt" timestamp with time zone NULL;
--
-- Add field feedbackValue to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" ADD COLUMN "feedbackValue" text NULL;

--
-- [CUSTOM] 1 - Add some helper functions
--

CREATE OR REPLACE FUNCTION getFeedbackOptionKeyFromReviewCommentOption(option text)
    returns text
as
$getFeedbackOptionKeyFromReviewCommentOption$
BEGIN
    if option = 'Сделали на совесть' or option = 'Made in good faith' then return 'highQuality';
    elseif option = 'Быстро сделали' or option = 'Quickly done' then return 'quickly';
    elseif option = 'Сделали некачественно' or option = 'It was done poorly' then return 'lowQuality';
    elseif option = 'Долго делали' or option = 'It took a long time' then return 'slowly';
    else return '';
    end if;
end
$getFeedbackOptionKeyFromReviewCommentOption$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION convertReviewCommentToFeedbackAdditionalOptions(value text)
    returns jsonb
as
$convertReviewCommentToFeedbackAdditionalOptions$
declare
    key1 text;
    key2 text;
BEGIN
    key1 := getFeedbackOptionKeyFromReviewCommentOption(split_part(trim(value), ';', 1));
    key2 := getFeedbackOptionKeyFromReviewCommentOption(split_part(trim(value), ';', 2));

    if key1 = key2 and key1 != '' then return jsonb_build_array(key1);
    elseif key1 = key2 and key1 = '' then return null::jsonb;
    elseif key1 != '' and key2 != '' then return jsonb_build_array(key1, key2);
    elseif key1 = '' and key2 != '' then return jsonb_build_array(key2);
    elseif key1 != '' and key2 = '' then return jsonb_build_array(key1);
    else return null::jsonb;
    end if;
end
$convertReviewCommentToFeedbackAdditionalOptions$ LANGUAGE plpgsql;

--
-- [CUSTOM] 2.1 - Set feedbackValue from reviewValue for Ticket
--

UPDATE public."Ticket"
    SET "feedbackValue" = "reviewValue"
    WHERE "reviewValue" IS NOT NULL;

--
-- [CUSTOM] 2.2 - Set feedbackAdditionalOptions from reviewComment for Ticket
--

UPDATE public."Ticket"
    SET "feedbackAdditionalOptions" = convertReviewCommentToFeedbackAdditionalOptions("reviewComment")
    WHERE "reviewComment" IS NOT NULL AND "reviewComment" != '';

--
-- [CUSTOM] 3.1 - Set feedbackValueFrom from reviewValueFrom for TicketChange
--

UPDATE public."TicketChange"
    SET "feedbackValueFrom" = "reviewValueFrom"
    WHERE "reviewValueFrom" IS NOT NULL;

--
-- [CUSTOM] 3.2 - Set feedbackValueTo from reviewValueTo for TicketChange
--

UPDATE public."TicketChange"
    SET "feedbackValueTo" = "reviewValueTo"
    WHERE "reviewValueTo" IS NOT NULL;

--
-- [CUSTOM] 3.3 - Set feedbackAdditionalOptionsFrom from reviewCommentFrom for TicketChange
--

UPDATE public."TicketChange"
    SET "feedbackAdditionalOptionsFrom" = convertReviewCommentToFeedbackAdditionalOptions("reviewCommentFrom")
    WHERE "reviewCommentFrom" IS NOT NULL AND "reviewCommentFrom" != '';

--
-- [CUSTOM] 3.4 - Set feedbackAdditionalOptionsTo from reviewCommentTo for TicketChange
--

UPDATE public."TicketChange"
    SET "feedbackAdditionalOptionsTo" = convertReviewCommentToFeedbackAdditionalOptions("reviewCommentTo")
    WHERE "reviewCommentTo" IS NOT NULL AND "reviewCommentTo" != '';

--
-- [CUSTOM] 4 - Add feedbackValue from reviewValue for TicketFilterTemplate
--

UPDATE public."TicketFilterTemplate"
    SET "fields" = "fields"::jsonb || jsonb_build_object('feedbackValue', "fields"->'reviewValue')
    WHERE ("fields"->'reviewValue') IS NOT NULL;

--
-- [CUSTOM] 5 - Drop helper functions
--

DROP FUNCTION convertReviewCommentToFeedbackAdditionalOptions;
DROP FUNCTION getFeedbackOptionKeyFromReviewCommentOption;

--
-- [CUSTOM] 6 - Revert Statement Timeout to default amount - 10 secs
--

SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field feedbackValue to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "feedbackValue" CASCADE;
--
-- Add field feedbackUpdatedAt to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "feedbackUpdatedAt" CASCADE;
--
-- Add field feedbackComment to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "feedbackComment" CASCADE;
--
-- Add field feedbackAdditionalOptions to tickethistoryrecord
--
ALTER TABLE "TicketHistoryRecord" DROP COLUMN "feedbackAdditionalOptions" CASCADE;
--
-- Add field feedbackValueTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "feedbackValueTo" CASCADE;
--
-- Add field feedbackValueFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "feedbackValueFrom" CASCADE;
--
-- Add field feedbackCommentTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "feedbackCommentTo" CASCADE;
--
-- Add field feedbackCommentFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "feedbackCommentFrom" CASCADE;
--
-- Add field feedbackAdditionalOptionsTo to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "feedbackAdditionalOptionsTo" CASCADE;
--
-- Add field feedbackAdditionalOptionsFrom to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "feedbackAdditionalOptionsFrom" CASCADE;
--
-- Add field feedbackValue to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "feedbackValue" CASCADE;
--
-- Add field feedbackUpdatedAt to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "feedbackUpdatedAt" CASCADE;
--
-- Add field feedbackComment to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "feedbackComment" CASCADE;
--
-- Add field feedbackAdditionalOptions to ticket
--
ALTER TABLE "Ticket" DROP COLUMN "feedbackAdditionalOptions" CASCADE;
COMMIT;

    `)
}
