// auto generated by kmigrator
// KMIGRATOR:0339_invoicecontext_integration_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMi40IG9uIDIwMjMtMTEtMDggMDU6NTkKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKaW1wb3J0IGRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24KCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzMzhfdXNlcnJpZ2h0c3NldF9jYW5tYW5hZ2VpbnZvaWNlY29udGV4dHNfYW5kX21vcmUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J2ludm9pY2Vjb250ZXh0JywKICAgICAgICAgICAgbmFtZT0naW50ZWdyYXRpb24nLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuRm9yZWlnbktleShkYl9jb2x1bW49J2ludGVncmF0aW9uJywgZGVmYXVsdD0nJywgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uUFJPVEVDVCwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLmFjcXVpcmluZ2ludGVncmF0aW9uJyksCiAgICAgICAgICAgIHByZXNlcnZlX2RlZmF1bHQ9RmFsc2UsCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdpbnZvaWNlY29udGV4dGhpc3RvcnlyZWNvcmQnLAogICAgICAgICAgICBuYW1lPSdpbnRlZ3JhdGlvbicsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5VVUlERmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ncGF5bWVudCcsCiAgICAgICAgICAgIG5hbWU9J2FjY291bnROdW1iZXInLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;


--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';



--
-- Add field integration to invoicecontext
--
ALTER TABLE "InvoiceContext" ADD COLUMN "integration" uuid NOT NULL CONSTRAINT "InvoiceContext_integration_cdad2d29_fk_AcquiringIntegration_id" REFERENCES "AcquiringIntegration"("id") DEFERRABLE INITIALLY DEFERRED; SET CONSTRAINTS "InvoiceContext_integration_cdad2d29_fk_AcquiringIntegration_id" IMMEDIATE;
--
-- Add field integration to invoicecontexthistoryrecord
--
ALTER TABLE "InvoiceContextHistoryRecord" ADD COLUMN "integration" uuid NULL;
--
-- Alter field accountNumber on payment
--
ALTER TABLE "Payment" ALTER COLUMN "accountNumber" DROP NOT NULL;
CREATE INDEX "InvoiceContext_integration_cdad2d29" ON "InvoiceContext" ("integration");



--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';




COMMIT;
    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
    
    
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
SET statement_timeout = '1500s';




--
-- Alter field accountNumber on payment
--
UPDATE "Payment" SET "accountNumber" = '' WHERE "accountNumber" IS NULL;
ALTER TABLE "Payment" ALTER COLUMN "accountNumber" SET NOT NULL;
--
-- Add field integration to invoicecontexthistoryrecord
--
ALTER TABLE "InvoiceContextHistoryRecord" DROP COLUMN "integration" CASCADE;
--
-- Add field integration to invoicecontext
--
ALTER TABLE "InvoiceContext" DROP COLUMN "integration" CASCADE;



--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
SET statement_timeout = '10s';




COMMIT;
    `)
}
