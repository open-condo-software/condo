// auto generated by kmigrator
// KMIGRATOR:0376_newsitem_deliverat_newsitemhistoryrecord_deliverat:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDMtMjAgMTQ6MTAKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNzVfYjJjYXBwYWNjZXNzcmlnaHRfaW1wb3J0aWRfYW5kX21vcmUnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J25ld3NpdGVtJywKICAgICAgICAgICAgbmFtZT0nZGVsaXZlckF0JywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkRhdGVUaW1lRmllbGQoYmxhbms9VHJ1ZSwgbnVsbD1UcnVlKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWRkRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9J25ld3NpdGVtaGlzdG9yeXJlY29yZCcsCiAgICAgICAgICAgIG5hbWU9J2RlbGl2ZXJBdCcsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5EYXRlVGltZUZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgIF0K

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field deliverAt to newsitem
--
ALTER TABLE "NewsItem" ADD COLUMN "deliverAt" timestamp with time zone NULL;
--
-- Add field deliverAt to newsitemhistoryrecord
--
ALTER TABLE "NewsItemHistoryRecord" ADD COLUMN "deliverAt" timestamp with time zone NULL;

--
-- [CUSTOM] Set "deliverAt" to "publishedAt" + 15 seconds if news is already published and has not "sendAt"
--
UPDATE "NewsItem" SET "deliverAt" = "publishedAt" + interval '15 seconds' WHERE "isPublished" = TRUE AND "sendAt" IS NULL AND "publishedAt" IS NOT NULL;

--
-- [CUSTOM] Set "deliverAt" to "sendAt" if news is already published and has not "sendAt"
--
UPDATE "NewsItem" SET "deliverAt" = "sendAt" WHERE "isPublished" = TRUE AND "sendAt" IS NOT NULL;

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field deliverAt to newsitemhistoryrecord
--
ALTER TABLE "NewsItemHistoryRecord" DROP COLUMN "deliverAt" CASCADE;
--
-- Add field deliverAt to newsitem
--
ALTER TABLE "NewsItem" DROP COLUMN "deliverAt" CASCADE;
COMMIT;

    `)
}
