// auto generated by kmigrator
// KMIGRATOR:0157_organizationemployee_organizationemployee_unique_user_and_organization:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMCBvbiAyMDIyLTA3LTI4IDA1OjE4Cgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucywgbW9kZWxzCgoKY2xhc3MgTWlncmF0aW9uKG1pZ3JhdGlvbnMuTWlncmF0aW9uKToKCiAgICBkZXBlbmRlbmNpZXMgPSBbCiAgICAgICAgKCdfZGphbmdvX3NjaGVtYScsICcwMTU2X3RpY2tldF9sYXN0Y29tbWVudGF0X3RpY2tldGNoYW5nZV9sYXN0Y29tbWVudGF0ZnJvbV9hbmRfbW9yZScpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSdvcmdhbml6YXRpb25lbXBsb3llZScsCiAgICAgICAgICAgIGNvbnN0cmFpbnQ9bW9kZWxzLlVuaXF1ZUNvbnN0cmFpbnQoY29uZGl0aW9uPW1vZGVscy5RKCgnZGVsZXRlZEF0X19pc251bGwnLCBUcnVlKSksIGZpZWxkcz0oJ3VzZXInLCAnb3JnYW5pemF0aW9uJyksIG5hbWU9J09yZ2FuaXphdGlvbkVtcGxveWVlX3VuaXF1ZV91c2VyX2FuZF9vcmdhbml6YXRpb24nKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;

update "OrganizationEmployee" t
SET "deletedAt" = '2022-08-10T11:11:11Z'
where t."deletedAt" IS NULL and exists (
  select 1 from "OrganizationEmployee"
  where "user" = t."user" and "organization" = t."organization" and "createdAt" < t."createdAt" and id != t."id" and "deletedAt" IS NULL
);


--
-- Create constraint OrganizationEmployee_unique_user_and_organization on model organizationemployee
--
CREATE UNIQUE INDEX "OrganizationEmployee_unique_user_and_organization" ON "OrganizationEmployee" ("user", "organization") WHERE "deletedAt" IS NULL;
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint OrganizationEmployee_unique_user_and_organization on model organizationemployee
--
DROP INDEX IF EXISTS "OrganizationEmployee_unique_user_and_organization";
COMMIT;

    `)
}
