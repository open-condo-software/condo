/**
 * Generated by `createschema organization.OrganizationLink 'from:Relationship:Organization:CASCADE; to:Relationship:Organization:SET_NULL;'`
 */

const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')
const { createTestOrganization } = require('../utils/testSchema')
const { makeLoggedInAdminClient, makeClient, UUID_RE } = require('@core/keystone/test.utils')
const { createTestOrganizationLink, updateTestOrganizationLink } = require('@condo/domains/organization/utils/testSchema')
const { expectToThrowAccessDeniedErrorToObj } = require('../../common/utils/testSchema')

describe('OrganizationLink', () => {
    test('admin: can create OrganizationLink', async () => {
        const admin = await makeLoggedInAdminClient()
        const [organizationFrom] = await createTestOrganization(admin)
        const [organizationTo] = await createTestOrganization(admin)
        const [obj] = await createTestOrganizationLink(admin, organizationFrom, organizationTo)

        expect(obj.id).toMatch(UUID_RE)
    })

    test('admin: can update OrganizationLink', async () => {
        const admin = await makeLoggedInAdminClient()
        const [organizationFrom] = await createTestOrganization(admin)
        const [organizationTo1] = await createTestOrganization(admin)
        const [organizationTo2] = await createTestOrganization(admin)
        const [link] = await createTestOrganizationLink(admin, organizationFrom, organizationTo1)

        const [updatedLink] = await updateTestOrganizationLink(admin, link.id, {
            to: { connect: { id: organizationTo2.id } },
        })

        expect(updatedLink.to.id).toEqual(organizationTo2.id)
    })

    test('user: create OrganizationLink', async () => {
        const admin = await makeLoggedInAdminClient()
        const user = await makeClientWithNewRegisteredAndLoggedInUser()
        const [organizationFrom] = await createTestOrganization(admin)
        const [organizationTo] = await createTestOrganization(admin)

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestOrganizationLink(user, organizationFrom, organizationTo)
        })
    })

    test('anonymous: create OrganizationLink', async () => {
        const client = await makeClient()
        const admin = await makeLoggedInAdminClient()
        const [organizationFrom] = await createTestOrganization(admin)
        const [organizationTo] = await createTestOrganization(admin)

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestOrganizationLink(client, organizationFrom, organizationTo)
        })
    })
})
