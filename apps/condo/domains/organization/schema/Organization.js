/**
 * Generated by `createschema organization.Organization 'country:Select:ru,en; name:Text; description?:Text; avatar?:File; meta:Json; employees:Relationship:OrganizationEmployee:CASCADE; statusTransitions:Json; defaultEmployeeRoleStatusTransitions:Json' --force`
 */

const get = require('lodash/get')
const { File, Text, Relationship, Select, Virtual } = require('@keystonejs/fields')
const { Wysiwyg } = require('@keystonejs/fields-wysiwyg-tinymce')

const { GQLListSchema } = require('@core/keystone/schema')
const { Json } = require('@core/keystone/fields')
const { historical, versioned, uuided, tracked, softDeleted } = require('@core/keystone/plugins')

const FileAdapter = require('@condo/domains/common/utils/fileAdapter')
const { isValidTin } = require('@condo/domains/organization/utils/tin.utils')
const { COUNTRIES, RUSSIA_COUNTRY } = require('@condo/domains/common/constants/countries')

const access = require('@condo/domains/organization/access/Organization')
const userAccess = require('@condo/domains/user/access/User')
const { COUNTRY_RELATED_STATUS_TRANSITIONS } = require('@condo/domains/ticket/constants/statusTransitions')
const { dvAndSender } = require('../../common/schema/plugins/dvAndSender')

const AVATAR_FILE_ADAPTER = new FileAdapter('orgavatars')

const Organization = new GQLListSchema('Organization', {
    schemaDoc: 'B2B customer of the service, a legal entity or an association of legal entities (holding/group)',
    fields: {
        country: {
            schemaDoc: 'Country level specific',
            isRequired: true,
            type: Select,
            options: Object.keys(COUNTRIES).join(','),
        },
        name: {
            schemaDoc: 'Customer-friendly name',
            type: Text,
            isRequired: true,
            kmigratorOptions: { null: false },
        },
        // The reason for this field is to avoid adding check for resident user into global Organization read access.
        // This field have specific use case for mobile client.
        tin: {
            schemaDoc: 'Taxpayer identification number. Every country has its own identification. Examples: INN for Russia, IIN for Kazakhstan and so on',
            type: Text,
            isRequired: false,
            kmigratorOptions: { null: true },
            access: true,
            hooks: {
                validateInput: async ({ resolvedData, addFieldValidationError })  => {
                    const item = resolvedData

                    const country = get(item, 'country')
                    const tin = get(item, 'tin')

                    if (!country || !tin) {
                        addFieldValidationError('Country and Tin fields can not be empty')
                    }

                    // TODO: DOMA-663 add tin validations for countries other than Russian Federation
                    if (country !== RUSSIA_COUNTRY) {
                        return
                    }

                    if (!isValidTin(tin, country)) {
                        addFieldValidationError('Tin field has not a valid values supplied')
                    }
                },
            },
        },
        description: {
            schemaDoc: 'Customer-friendly description. Friendly text for employee and resident users',
            type: Wysiwyg,
            isRequired: false,
        },
        avatar: {
            schemaDoc: 'Customer-friendly avatar',
            type: File,
            isRequired: false,
            adapter: AVATAR_FILE_ADAPTER,
        },
        meta: {
            schemaDoc: 'Organization metadata. Depends on country level specific' +
                'Example of data key: `kpp`',
            type: Json,
            isRequired: false,
        },
        employees: {
            type: Relationship,
            ref: 'OrganizationEmployee.organization',
            many: true,
            access: userAccess.canAccessToIsAdminField,
        },
        relatedOrganizations: {
            type: Relationship,
            ref: 'OrganizationLink.to',
            many: true,
            access: userAccess.canAccessToIsAdminField,
        },
        statusTransitions: {
            schemaDoc: 'Graph of possible transitions for statuses. If there is no transition in this graph, ' +
                'it is impossible to change status if the user in the role has the right to do so.',
            type: Virtual,
            graphQLReturnType: 'JSON',
            resolver: (organization) => {
                const organizationCountry = get(organization, 'country', 'en')

                return COUNTRY_RELATED_STATUS_TRANSITIONS[organizationCountry]
            },
        },
        defaultEmployeeRoleStatusTransitions: {
            schemaDoc: 'Default employee role status transitions map which will be used as fallback for status transition validation' +
                'if user dont have OrganizationEmployeeRole',
            type: Virtual,
            graphQLReturnType: 'JSON',
            resolver: (organization) => {
                const organizationCountry = get(organization, 'country', 'en')

                return COUNTRY_RELATED_STATUS_TRANSITIONS[organizationCountry]
            },
        },
        importRemoteSystem: {
            schemaDoc: 'External provider for organization',
            type: Text,
            access: access.canAccessToImportField,
            kmigratorOptions: { null: true, unique: false },
        },
        importId: {
            schemaDoc: 'External system organization id. Used for integrations',
            type: Text,
            access: access.canAccessToImportField,
            kmigratorOptions: { null: true, unique: false },
        },
    },
    kmigratorOptions: {
        constraints: [
            {
                type: 'models.UniqueConstraint',
                fields: ['importId', 'importRemoteSystem'],
                name: 'unique_organization_importid_and_importremotesystem',
            },
        ],
    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical()],
    access: {
        read: access.canReadOrganizations,
        create: access.canManageOrganizations,
        update: access.canManageOrganizations,
        delete: false,
        auth: true,
    },
})

module.exports = {
    Organization,
}
