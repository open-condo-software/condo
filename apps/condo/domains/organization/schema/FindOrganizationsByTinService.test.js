/**
 * Generated by `createservice organization.FindOrganizationsByTinService --type queries`
 */

const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient,
    makeClient,
    expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult,
    expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const { COUNTRIES, DEFAULT_ENGLISH_COUNTRY } = require('@condo/domains/common/constants/countries')
const {
    findOrganizationsByTinByTestClient,
    generateTin,
    registerNewOrganization,
    Organization,
    createTestOrganization,
    FindOrganizationsByTinLog,
} = require('@condo/domains/organization/utils/testSchema')
const { GQL_ERRORS: USER_ERRORS } = require('@condo/domains/user/constants/errors')
const {
    makeClientWithStaffUser,
    makeClientWithResidentUser,
    makeClientWithServiceUser,
    makeClientWithSupportUser,
    updateTestUser,
    createTestPhone,
    createTestEmail,
} = require('@condo/domains/user/utils/testSchema')


const COUNTRY_KEYS = Object.keys(COUNTRIES)
const REQUEST_DAILY_LIMIT = 10


describe('FindOrganizationsByTinService', () => {
    let adminClient, supportClient, anonymousClient

    beforeAll(async () => {
        adminClient = await makeLoggedInAdminClient()
        supportClient = await makeClientWithSupportUser()
        anonymousClient = await makeClient()
    })

    describe('Accesses', () => {
        describe('Admin', () => {
            test('Can execute', async () => {
                const [result] = await findOrganizationsByTinByTestClient(adminClient, { tin: String(generateTin(faker.helpers.arrayElement(COUNTRY_KEYS))) })
                expect(result).toBeDefined()
            })
        })

        describe('Support', () => {
            test('Can execute', async () => {
                const [result] = await findOrganizationsByTinByTestClient(supportClient, { tin: String(generateTin(faker.helpers.arrayElement(COUNTRY_KEYS))) })
                expect(result).toBeDefined()
            })
        })

        describe('Staff', () => {
            test('Can execute', async () => {
                const staffClient = await makeClientWithStaffUser()
                const [result] = await findOrganizationsByTinByTestClient(staffClient, { tin: String(generateTin(faker.helpers.arrayElement(COUNTRY_KEYS))) })
                expect(result).toBeDefined()
            })
        })

        describe('Resident', () => {
            test('Cannot execute', async () => {
                const residentClient = await makeClientWithResidentUser()
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await findOrganizationsByTinByTestClient(residentClient, { tin: String(generateTin(faker.helpers.arrayElement(COUNTRY_KEYS))) })
                })
            })
        })

        describe('Service user', () => {
            test('Cannot execute', async () => {
                const serviceClient = await makeClientWithServiceUser()
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await findOrganizationsByTinByTestClient(serviceClient, { tin: String(generateTin(faker.helpers.arrayElement(COUNTRY_KEYS))) })
                })
            })
        })

        describe('Anonymous', () => {
            test('Cannot execute', async () => {
                await expectToThrowAuthenticationErrorToResult(async () => {
                    await findOrganizationsByTinByTestClient(anonymousClient, { tin: String(generateTin(faker.helpers.arrayElement(COUNTRY_KEYS))) })
                })
            })
        })
    })

    describe('Basic logic', () => {
        test('Should return all not deleted organizations with the specified TIN, where there are employees with the right "canManageEmployees" excluding service users', async () => {
            const staffClient = await makeClientWithStaffUser()
            const serviceClient = await makeClientWithServiceUser()
            const registeredStaffClient = await makeClientWithStaffUser()

            const tin = String(generateTin(DEFAULT_ENGLISH_COUNTRY))
            const tin2 = String(generateTin(DEFAULT_ENGLISH_COUNTRY))

            const [deletedO10nWithAdministrator] = await registerNewOrganization(staffClient, { tin, country: DEFAULT_ENGLISH_COUNTRY })
            await Organization.softDelete(adminClient, deletedO10nWithAdministrator.id)

            const [deletedO10nWithoutAdministrator] = await createTestOrganization(adminClient, { tin, country: DEFAULT_ENGLISH_COUNTRY })
            await Organization.softDelete(adminClient, deletedO10nWithoutAdministrator.id)

            const [o10nWithAdministrator] = await registerNewOrganization(staffClient, { tin, country: DEFAULT_ENGLISH_COUNTRY })
            const [o10nWithAdministrator2] = await registerNewOrganization(staffClient, { tin, country: DEFAULT_ENGLISH_COUNTRY })

            const [o10nWithoutAdministrator] = await createTestOrganization(adminClient, { tin, country: DEFAULT_ENGLISH_COUNTRY })

            const [o10nWithOtherTin] = await registerNewOrganization(staffClient, { tin: tin2, country: DEFAULT_ENGLISH_COUNTRY })

            const [o10nWithServiceUserOnly] = await registerNewOrganization(serviceClient, { tin, country: DEFAULT_ENGLISH_COUNTRY })

            const [result] = await findOrganizationsByTinByTestClient(registeredStaffClient, { tin })
            expect(result.organizations).toHaveLength(2)
            expect(result.organizations).toEqual(expect.arrayContaining([
                { id: o10nWithAdministrator.id, name: o10nWithAdministrator.name },
                { id: o10nWithAdministrator2.id, name: o10nWithAdministrator2.name },
            ]))
        })

        test('Requests should be logged in "FindOrganizationsByTinLog"', async () => {
            const staffClient = await makeClientWithStaffUser()
            const tin1 = String(generateTin())
            const tin2 = String(generateTin())

            const logs1 = await FindOrganizationsByTinLog.getAll(adminClient, { user: { id: staffClient.user.id } })
            expect(logs1).toHaveLength(0)

            const [result] = await findOrganizationsByTinByTestClient(staffClient, { tin: tin1 })
            expect(result).toEqual({ organizations: [] })

            const logs2 = await FindOrganizationsByTinLog.getAll(adminClient, { user: { id: staffClient.user.id } })
            expect(logs2).toHaveLength(1)
            expect(logs2).toEqual(expect.arrayContaining([
                expect.objectContaining({
                    tin: tin1,
                    userPhone: staffClient.userAttrs.phone,
                    userEmail: staffClient.userAttrs.email,
                }),
            ]))

            const [result2] = await findOrganizationsByTinByTestClient(staffClient, { tin: tin2 })
            expect(result2).toEqual({ organizations: [] })
            const [result3] = await findOrganizationsByTinByTestClient(staffClient, { tin: tin1 })
            expect(result3).toEqual({ organizations: [] })

            const logs3 = await FindOrganizationsByTinLog.getAll(adminClient,
                { user: { id: staffClient.user.id } },
                { sortBy: ['createdAt_ASC'] }
            )
            expect(logs3).toHaveLength(3)
            expect(logs3).toEqual([
                expect.objectContaining({
                    tin: tin1,
                }),
                expect.objectContaining({
                    tin: tin2,
                }),
                expect.objectContaining({
                    tin: tin1,
                }),
            ])
        })

        test('should throw error if find by unavailable tin', async () => {
            const staffClient = await makeClientWithStaffUser()

            const logs1 = await FindOrganizationsByTinLog.getAll(adminClient, { user: { id: staffClient.user.id } })
            expect(logs1).toHaveLength(0)

            await expectToThrowGQLError(async () => {
                await findOrganizationsByTinByTestClient(staffClient, { tin: '0000000000' })
            }, {
                query: 'findOrganizationsByTin',
                variable: ['data', 'tin'],
                code: 'BAD_USER_INPUT',
                type: 'UNAVAILABLE_TIN',
                message: 'Unavailable tin',
            }, 'result')

            await expectToThrowGQLError(async () => {
                await findOrganizationsByTinByTestClient(staffClient, { tin: '000000000000' })
            }, {
                query: 'findOrganizationsByTin',
                variable: ['data', 'tin'],
                code: 'BAD_USER_INPUT',
                type: 'UNAVAILABLE_TIN',
                message: 'Unavailable tin',
            }, 'result')

            const logs2 = await FindOrganizationsByTinLog.getAll(adminClient, { user: { id: staffClient.user.id } })
            expect(logs2).toHaveLength(2)
        })
    })

    describe('Request limit', () => {
        test('Should throw error if there are a lot of requests from user and save to logs all processed requests', async () => {
            const staffClient = await makeClientWithStaffUser()
            const tin = String(generateTin())

            for (let i = 0; i < REQUEST_DAILY_LIMIT; i++) {
                const [result] = await findOrganizationsByTinByTestClient(staffClient, { tin })
                expect(result).toBeDefined()
            }

            await expectToThrowGQLError(async () => {
                await findOrganizationsByTinByTestClient(staffClient, { tin })
            }, USER_ERRORS.DAILY_REQUEST_LIMIT_FOR_USER_REACHED, 'result')

            const logs = await FindOrganizationsByTinLog.getAll(adminClient, {
                user: { id: staffClient.user.id },
            })
            expect(logs).toHaveLength(10)

            // should not block other user
            const notBlockedStaffClient = await makeClientWithStaffUser()
            const [result] = await findOrganizationsByTinByTestClient(notBlockedStaffClient, { tin })
            expect(result).toBeDefined()
        })

        test('Should throw error if there are a lot of requests from phone and save to logs all processed requests', async () => {
            const staffClient = await makeClientWithStaffUser()
            const tin = String(generateTin())

            for (let i = 0; i < REQUEST_DAILY_LIMIT - 1; i++) {
                const [result] = await findOrganizationsByTinByTestClient(staffClient, { tin })
                expect(result).toBeDefined()
            }

            // NOTE: The phone number restriction is checked after the user restriction,
            // so we need to move the phone number to other user
            await updateTestUser(adminClient, staffClient.user.id, { phone: createTestPhone() })
            const staffClient2 = await makeClientWithStaffUser({ phone: staffClient.userAttrs.phone })
            const [orgs] = await findOrganizationsByTinByTestClient(staffClient2, { tin })
            expect(orgs).toBeDefined()

            await expectToThrowGQLError(async () => {
                await findOrganizationsByTinByTestClient(staffClient2, { tin })
            }, USER_ERRORS.DAILY_REQUEST_LIMIT_FOR_PHONE_REACHED, 'result')

            const logs = await FindOrganizationsByTinLog.getAll(adminClient, {
                user: { id: staffClient.user.id },
            })
            expect(logs).toHaveLength(9)
            const logs2 = await FindOrganizationsByTinLog.getAll(adminClient, {
                user: { id: staffClient2.user.id },
            })
            expect(logs2).toHaveLength(1)

            // should not block other user
            const notBlockedStaffClient = await makeClientWithStaffUser()
            const [result] = await findOrganizationsByTinByTestClient(notBlockedStaffClient, { tin })
            expect(result).toBeDefined()
        })

        test('Should throw error if there are a lot of requests from email and save to logs all processed requests', async () => {
            const staffClient = await makeClientWithStaffUser()
            const tin = String(generateTin())

            for (let i = 0; i < REQUEST_DAILY_LIMIT - 1; i++) {
                const [result] = await findOrganizationsByTinByTestClient(staffClient, { tin })
                expect(result).toBeDefined()
            }

            // NOTE: The email restriction is checked after the user and phone restriction,
            // so we need to move the email to other user
            await updateTestUser(adminClient, staffClient.user.id, { email: createTestEmail() })
            const staffClient2 = await makeClientWithStaffUser({ email: staffClient.userAttrs.email })
            const [orgs] = await findOrganizationsByTinByTestClient(staffClient2, { tin })
            expect(orgs).toBeDefined()

            await expectToThrowGQLError(async () => {
                await findOrganizationsByTinByTestClient(staffClient2, { tin })
            }, USER_ERRORS.DAILY_REQUEST_LIMIT_FOR_EMAIL_REACHED, 'result')

            const logs = await FindOrganizationsByTinLog.getAll(adminClient, {
                user: { id: staffClient.user.id },
            })
            expect(logs).toHaveLength(9)
            const logs2 = await FindOrganizationsByTinLog.getAll(adminClient, {
                user: { id: staffClient2.user.id },
            })
            expect(logs2).toHaveLength(1)

            // should not block other user
            const notBlockedStaffClient = await makeClientWithStaffUser()
            const [result] = await findOrganizationsByTinByTestClient(notBlockedStaffClient, { tin })
            expect(result).toBeDefined()
        })

        test('Admin should skip limit', async () => {
            const tin = String(generateTin())
            for (let i = 0; i < REQUEST_DAILY_LIMIT; i++) {
                const [result] = await findOrganizationsByTinByTestClient(adminClient, { tin })
                expect(result).toBeDefined()
            }
            const [result] = await findOrganizationsByTinByTestClient(adminClient, { tin })
            expect(result).toBeDefined()

            const logs = await FindOrganizationsByTinLog.getAll(adminClient, {
                user: { id: adminClient.user.id },
                tin,
            })
            expect(logs).toHaveLength(11)
        })

        test('Support should skip limit', async () => {
            const tin = String(generateTin())
            for (let i = 0; i < REQUEST_DAILY_LIMIT; i++) {
                const [result] = await findOrganizationsByTinByTestClient(supportClient, { tin })
                expect(result).toBeDefined()
            }
            const [result] = await findOrganizationsByTinByTestClient(supportClient, { tin })
            expect(result).toBeDefined()

            const logs = await FindOrganizationsByTinLog.getAll(supportClient, {
                user: { id: supportClient.user.id },
                tin,
            })
            expect(logs).toHaveLength(11)
        })
    })
})
