/**
 * Generated by `createservice notification.DisconnectUserFromDeviceService --type mutations`
 */
const { makeLoggedInAdminClient, makeClient, makeLoggedInClient } = require('@core/keystone/test.utils')

const { disconnectUserFromDeviceByTestClient, syncDeviceByTestClient, Device: DeviceAPI } = require('@condo/domains/notification/utils/testSchema')

const { getRandomTokenData } = require('../utils/testSchema/helpers')
const { expectToThrowGraphQLRequestError } = require('@condo/domains/common/utils/testSchema')

describe('DisconnectUserFromDeviceService', () => {
    describe('anonymous', () => {
        it('can disconnect user from device', async () => {
            const user = await makeLoggedInClient()
            const client = await makeClient()
            const admin = await makeLoggedInAdminClient()
            const payload = getRandomTokenData({ pushToken: undefined, meta: undefined })
            const [device] = await syncDeviceByTestClient(user, payload)

            expect(device.id).toBeDefined()
            expect(device.owner.id).toEqual(user.user.id)

            const { deviceId } = payload
            const [result] = await disconnectUserFromDeviceByTestClient(client, { deviceId })

            expect(result.status).toEqual('ok')

            const device2 = await DeviceAPI.getOne(admin, { id: device.id })
            expect(device2.owner).toBeNull()
        })

        it('ignores disconnect request for missing record with provided deviceId', async () => {
            const user = await makeLoggedInClient()
            const client = await makeClient()
            const admin = await makeLoggedInAdminClient()
            const payload = getRandomTokenData({ pushToken: undefined, meta: undefined })
            const [device] = await syncDeviceByTestClient(user, payload)

            expect(device.id).toBeDefined()
            expect(device.owner.id).toEqual(user.user.id)

            const [result] = await disconnectUserFromDeviceByTestClient(client, { deviceId: payload.deviceId + 'X' })

            expect(result.status).toEqual('ok')

            const device2 = await DeviceAPI.getOne(admin, { id: device.id })
            expect(device2.owner.id).toEqual(user.user.id)
        })

        it('fails disconnect request with missing deviceId', async () => {
            const user = await makeLoggedInClient()
            const client = await makeClient()
            const payload = getRandomTokenData({ pushToken: undefined, meta: undefined })
            const [device] = await syncDeviceByTestClient(user, payload)

            expect(device.id).toBeDefined()
            expect(device.owner.id).toEqual(user.user.id)

            await expectToThrowGraphQLRequestError(
                async () => await disconnectUserFromDeviceByTestClient(client, { deviceId: undefined }),
                'Field "deviceId" of required type "String!" was not provided.',
            )
        })
    })

    describe('user', () => {
        it('can disconnect user from device', async () => {
            const user = await makeLoggedInClient()
            const user1 = await makeLoggedInClient()
            const admin = await makeLoggedInAdminClient()
            const payload = getRandomTokenData({ pushToken: undefined, meta: undefined })
            const [device] = await syncDeviceByTestClient(user, payload)

            expect(device.id).toBeDefined()
            expect(device.owner.id).toEqual(user.user.id)

            const { deviceId } = payload
            const [result] = await disconnectUserFromDeviceByTestClient(user1, { deviceId })

            expect(result.status).toEqual('ok')

            const device2 = await DeviceAPI.getOne(admin, { id: device.id })

            expect(device2.owner).toBeNull()
        })

        it('ignores disconnect request for missing record with provided deviceId', async () => {
            const user = await makeLoggedInClient()
            const user1 = await makeLoggedInClient()
            const admin = await makeLoggedInAdminClient()
            const payload = getRandomTokenData({ pushToken: undefined, meta: undefined })
            const [device] = await syncDeviceByTestClient(user, payload)

            expect(device.id).toBeDefined()
            expect(device.owner.id).toEqual(user.user.id)

            const [result] = await disconnectUserFromDeviceByTestClient(user1, { deviceId: payload.deviceId + 'X' })

            expect(result.status).toEqual('ok')

            const device2 = await DeviceAPI.getOne(admin, { id: device.id })
            expect(device2.owner.id).toEqual(user.user.id)
        })

        it('fails disconnect request with missing deviceId', async () => {
            const user = await makeLoggedInClient()
            const user1 = await makeLoggedInClient()
            const payload = getRandomTokenData({ pushToken: undefined, meta: undefined })
            const [device] = await syncDeviceByTestClient(user, payload)

            expect(device.id).toBeDefined()
            expect(device.owner.id).toEqual(user.user.id)

            await expectToThrowGraphQLRequestError(
                async () => await disconnectUserFromDeviceByTestClient(user1, { deviceId: undefined }),
                'Field "deviceId" of required type "String!" was not provided.',
            )
        })
    })
})