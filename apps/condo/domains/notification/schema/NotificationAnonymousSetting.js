/**
 * Generated by `createschema notification.NotificationAnonymousSetting 'email:Text; phone:Text; messageType:Text; messageTransport:Text; isEnabled:Checkbox'`
 */
const { Text, Checkbox, Select } = require('@keystonejs/fields')
const get = require('lodash/get')

const { GQLError, GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const { historical, versioned, uuided, tracked, softDeleted, dvAndSender } = require('@open-condo/keystone/plugins')
const { GQLListSchema } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/notification/access/NotificationAnonymousSetting')
const { EMAIL_TRANSPORT, MESSAGE_TYPES } = require('@condo/domains/notification/constants/constants')
const {
    NO_NEED_TO_ENABLE_NOTIFICATIONS,
} = require('@condo/domains/notification/constants/errors')

const ERRORS = {
    NO_NEED_TO_ENABLE_NOTIFICATIONS: {
        code: BAD_USER_INPUT,
        type: NO_NEED_TO_ENABLE_NOTIFICATIONS,
        message: 'No need to enable notifications. All notifications enabled by default. You may just delete this setting instead.',
    },
}

const NotificationAnonymousSetting = new GQLListSchema('NotificationAnonymousSetting', {
    schemaDoc: 'Anonymous contact notifications settings',
    fields: {
        email: {
            schemaDoc: 'The settings will applied for',
            type: Text,
            isRequired: true,
        },

        messageType: {
            schemaDoc: `Affected message type. Possible values are: ${MESSAGE_TYPES.join(',')}`,
            type: Select,
            options: MESSAGE_TYPES,
            isRequired: false,
            knexOptions: { isNotNullable: false },
            kmigratorOptions: { null: true, max_length: 100 },
        },

        messageTransport: {
            schemaDoc: `Affected message transport. Possible values are: ${EMAIL_TRANSPORT}`,
            type: Select,
            options: [EMAIL_TRANSPORT], // for now, we are support only email notification settings for anon users
            isRequired: false,
            knexOptions: { isNotNullable: false },
            kmigratorOptions: { null: true },
        },

        isEnabled: {
            schemaDoc: 'Is notification enabled',
            type: Checkbox,
            isRequired: false,
            defaultValue: true,
        },

    },
    kmigratorOptions: {
        constraints: [
            {
                type: 'models.CheckConstraint',
                check: 'Q(messageType__isnull=False) | Q(messageTransport__isnull=False)',
                name: 'nas_has_messageType_or_messageTransport',
            },
            {
                type: 'models.UniqueConstraint',
                fields: ['email', 'messageType', 'messageTransport'],
                condition: 'Q(deletedAt__isnull=True)',
                name: 'nas_unique_email_messageType_messageTransport',
            },
            {
                type: 'models.UniqueConstraint',
                fields: ['email', 'messageType'],
                condition: 'Q(deletedAt__isnull=True) & Q(messageTransport__isnull=True)',
                name: 'nas_unique_email_messageType',
            },
            {
                type: 'models.UniqueConstraint',
                fields: ['email', 'messageTransport'],
                condition: 'Q(deletedAt__isnull=True) & Q(messageType__isnull=True)',
                name: 'nas_unique_email_messageTransport',
            },
        ],
        indexes: [
            {
                type: 'BTreeIndex',
                fields: ['email', 'messageType'],
                name: 'nas_email_messageType_idx',
            },
        ],
    },
    hooks: {
        validateInput: async (args) => {
            const { resolvedData, context } = args

            const isEnabled = get(resolvedData, 'isEnabled')

            // This is a temporary check.
            // It is actual as long we only control if the message enabled
            // All messages are enabled by default, so there is no needed to create model with isEnabled=true
            if (isEnabled) {
                throw new GQLError(ERRORS.NO_NEED_TO_ENABLE_NOTIFICATIONS, context)
            }
        },
    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical()],
    access: {
        read: access.canReadNotificationAnonymousSettings,
        create: access.canManageNotificationAnonymousSettings,
        update: access.canManageNotificationAnonymousSettings,
        delete: false,
        auth: true,
    },
})

module.exports = {
    NotificationAnonymousSetting,
}
