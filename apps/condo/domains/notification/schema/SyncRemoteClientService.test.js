// noinspection DuplicatedCode
/**
 * Generated by `createservice notification.SyncRemoteClientService --type mutations`
 */
const faker = require('faker')

const { makeClient, makeLoggedInClient, makeLoggedInAdminClient } = require('@open-condo/keystone/test.utils')

const { PUSH_TYPE_SILENT_DATA } = require('@condo/domains/notification/constants/constants')
const { getRandomTokenData } = require('@condo/domains/notification/utils/testSchema/helpers')
const {
    RemoteClient, syncRemoteClientByTestClient,
} = require('@condo/domains/notification/utils/testSchema')

describe('SyncRemoteClientService', () => {
    describe('Anonymous', () => {
        it('registers deviceId + pushTransport (no pushToken/meta | pushToken | meta | pushType | pushToken + meta)', async () => {
            const client = await makeClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null }) // no meta or pushToken
            const payload1 = getRandomTokenData({ meta: null }) // no meta, with pushToken
            const payload2 = getRandomTokenData({ pushToken: null }) // no pushToken, with meta
            const payload3 = getRandomTokenData() // with meta & pushToken
            const payload4 = getRandomTokenData({ pushType: PUSH_TYPE_SILENT_DATA }) // with pushType

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const [device1] = await syncRemoteClientByTestClient(client, payload1)

            expect(device1.id).not.toBeFalsy()
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toBeNull()
            expect(device1.owner).toBeNull()

            const [device2] = await syncRemoteClientByTestClient(client, payload2)

            expect(device2.id).not.toBeFalsy()
            expect(device2.deviceId).toEqual(payload2.deviceId)
            expect(device2.appId).toEqual(payload2.appId)
            expect(device2.pushTransport).toEqual(payload2.pushTransport)
            expect(device2.devicePlatform).toEqual(payload2.devicePlatform)
            expect(device2.pushToken).toBeNull()
            expect(device2.meta).toEqual(payload2.meta)
            expect(device2.owner).toBeNull()

            const [device3] = await syncRemoteClientByTestClient(client, payload3)

            expect(device3.id).not.toBeFalsy()
            expect(device3.deviceId).toEqual(payload3.deviceId)
            expect(device3.appId).toEqual(payload3.appId)
            expect(device3.pushTransport).toEqual(payload3.pushTransport)
            expect(device3.devicePlatform).toEqual(payload3.devicePlatform)
            expect(device3.pushToken).toEqual(payload3.pushToken)
            expect(device3.meta).toEqual(payload3.meta)
            expect(device3.owner).toBeNull()

            const [device4] = await syncRemoteClientByTestClient(client, payload4)

            expect(device4.id).not.toBeFalsy()
            expect(device4.deviceId).toEqual(payload4.deviceId)
            expect(device4.appId).toEqual(payload4.appId)
            expect(device4.pushTransport).toEqual(payload4.pushTransport)
            expect(device4.devicePlatform).toEqual(payload4.devicePlatform)
            expect(device4.pushToken).toEqual(payload4.pushToken)
            expect(device4.pushType).toEqual(payload4.pushType)
            expect(device4.owner).toBeNull()

        })

        it('registers deviceId + pushTransport & updates pushToken', async () => {
            const client = await makeClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const payload1 = {
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                pushToken: faker.datatype.uuid(),
            }
            const [device1] = await syncRemoteClientByTestClient(client, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(device.deviceId)
            expect(device1.appId).toEqual(device.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toBeNull()
            expect(device1.owner).toBeNull()
        })

        it('registers deviceId + pushTransport & updates meta', async () => {
            const client = await makeClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const payload1 = {
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                meta: { pushTransport: payload.pushTransport },
            }
            const [device1] = await syncRemoteClientByTestClient(client, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(device.deviceId)
            expect(device1.appId).toEqual(device.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toBeNull()
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).toBeNull()
        })

        it('registers deviceId + pushTransport & updates pushToken + meta', async () => {
            const client = await makeClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const pushToken = faker.datatype.uuid()
            const payload1 = {
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                pushToken,
                meta: { pushTransport: payload.pushTransport, pushToken },
            }
            const [device1] = await syncRemoteClientByTestClient(client, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(device.deviceId)
            expect(device1.appId).toEqual(device.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).toBeNull()
        })

        it('registers deviceId + pushTransport & connects to user', async () => {
            const client = await makeClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null })
            const payload1 = {
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
            }

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(device.deviceId)
            expect(device1.appId).toEqual(device.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toBeNull()
            expect(device1.meta).toBeNull()
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })

        it('registers deviceId + pushTransport & updates pushToken + connects to user', async () => {
            const client = await makeClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null, pushToken: null })
            const payload1 = getRandomTokenData({
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                meta: null,
            })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toBeNull()
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })

        it('registers deviceId + pushTransport & updates meta + connects to user', async () => {
            const client = await makeClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null, pushToken: null })
            const payload1 = getRandomTokenData({
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                pushToken: null,
            })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toBeNull()
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })

        it('registers deviceId + pushTransport & updates pushToken + meta + connects to user', async () => {
            const client = await makeClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null, pushToken: null })
            const payload1 = getRandomTokenData({
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
            })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })

        it('registers two devices and clears previously registered pushToken that is being reused for second device', async () => {
            const client = await makeClient()
            const client1 = await makeClient()
            const admin = await makeLoggedInAdminClient()
            const payload = getRandomTokenData({ meta: null })
            const payload1 = getRandomTokenData({ pushToken: payload.pushToken, meta: null })
            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toEqual(payload.pushToken)
            expect(device.meta).toBeNull()
            expect(device.owner).toBeNull()

            const [device1] = await syncRemoteClientByTestClient(client1, payload1)

            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toBeNull()
            expect(device1.owner).toBeNull()

            const device2 = RemoteClient.getOne(admin, { id: device.id })

            expect(device2.pushToken).toBeFalsy()

        })

    })

    describe('Authorized', () => {
        it('registers deviceId + pushTransport & connects to user', async () => {
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null })
            const [device] = await syncRemoteClientByTestClient(user, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).not.toBeNull()
            expect(device.owner.id).toEqual(user.user.id)
        })

        it('registers deviceId + pushTransport & reconnects to different user', async () => {
            const user = await makeLoggedInClient()
            const user1 = await makeLoggedInClient()
            const payload = getRandomTokenData({ pushToken: null, meta: null })
            const [device] = await syncRemoteClientByTestClient(user, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).not.toBeNull()
            expect(device.owner.id).toEqual(user.user.id)

            const payload1 = {
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
            }
            const [device1] = await syncRemoteClientByTestClient(user1, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(device.deviceId)
            expect(device1.appId).toEqual(device.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toBeNull()
            expect(device1.meta).toBeNull()
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user1.user.id)
        })

        it('registers deviceId + pushTransport + (pushToken | meta | pushToken + meta) & connects to user', async () => {
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null })
            const payload1 = getRandomTokenData({ pushToken: null })
            const payload2 = getRandomTokenData()

            const [device] = await syncRemoteClientByTestClient(user, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toEqual(payload.pushToken)
            expect(device.meta).toBeNull()
            expect(device.owner).not.toBeNull()
            expect(device.owner.id).toEqual(user.user.id)

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).not.toBeFalsy()
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toBeNull()
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)

            const [device2] = await syncRemoteClientByTestClient(user, payload2)

            expect(device2.id).not.toBeFalsy()
            expect(device2.deviceId).toEqual(payload2.deviceId)
            expect(device2.appId).toEqual(payload2.appId)
            expect(device2.pushTransport).toEqual(payload2.pushTransport)
            expect(device2.devicePlatform).toEqual(payload2.devicePlatform)
            expect(device2.pushToken).toEqual(payload2.pushToken)
            expect(device2.meta).toEqual(payload2.meta)
            expect(device2.owner).not.toBeNull()
            expect(device2.owner.id).toEqual(user.user.id)
        })

        it('registers deviceId + pushTransport & updates pushToken + reconnects to different user', async () => {
            const client = await makeLoggedInClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null, pushToken: null })
            const payload1 = getRandomTokenData({
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                meta: null,
            })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).not.toBeNull()
            expect(device.owner.id).toEqual(client.user.id)

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toBeNull()
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })

        it('register deviceId + pushTransport & update meta + reconnect to different user', async () => {
            const client = await makeLoggedInClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null, pushToken: null })
            const payload1 = getRandomTokenData({
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
                pushToken: null,
            })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).not.toBeNull()
            expect(device.owner.id).toEqual(client.user.id)

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toBeNull()
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })


        it('registers deviceId + pushTransport & updates pushToken + meta + reconnects to different user', async () => {
            const client = await makeLoggedInClient()
            const user = await makeLoggedInClient()
            const payload = getRandomTokenData({ meta: null, pushToken: null })
            const payload1 = getRandomTokenData({
                deviceId: payload.deviceId,
                appId: payload.appId,
                pushTransport: payload.pushTransport,
                devicePlatform: payload.devicePlatform,
            })

            const [device] = await syncRemoteClientByTestClient(client, payload)

            expect(device.id).not.toBeFalsy()
            expect(device.deviceId).toEqual(payload.deviceId)
            expect(device.appId).toEqual(payload.appId)
            expect(device.pushTransport).toEqual(payload.pushTransport)
            expect(device.devicePlatform).toEqual(payload.devicePlatform)
            expect(device.pushToken).toBeNull()
            expect(device.meta).toBeNull()
            expect(device.owner).not.toBeNull()
            expect(device.owner.id).toEqual(client.user.id)

            const [device1] = await syncRemoteClientByTestClient(user, payload1)

            expect(device1.id).toEqual(device.id)
            expect(device1.deviceId).toEqual(payload1.deviceId)
            expect(device1.appId).toEqual(payload1.appId)
            expect(device1.pushTransport).toEqual(payload1.pushTransport)
            expect(device1.devicePlatform).toEqual(payload1.devicePlatform)
            expect(device1.pushToken).toEqual(payload1.pushToken)
            expect(device1.meta).toEqual(payload1.meta)
            expect(device1.owner).not.toBeNull()
            expect(device1.owner.id).toEqual(user.user.id)
        })
    })
})