/**
 * Generated by `createschema notification.NotificationUserSetting 'user:Relationship:User:CASCADE; messageType:Text; messageTransport:Text; isEnabled:Checkbox'`
 */
const { historical, versioned, uuided, tracked, softDeleted, dvAndSender, analytical } = require('@open-condo/keystone/plugins')
const { GQLListSchema } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/notification/access/NotificationUserSetting')
const { MESSAGE_TRANSPORTS } = require('@condo/domains/notification/constants/constants')
const { getMessageTypeField } = require('@condo/domains/notification/schema/fields/MessageType')

const NotificationUserSetting = new GQLListSchema('NotificationUserSetting', {
    schemaDoc: 'User controlled notifications settings',
    fields: {

        user: {
            schemaDoc: `
                The user the settings will apply for. 
                If null - settings are global. 
                If not null - settings are user specific, which overrides global settings.
                By default all notifications are enabled for all users.
            `,
            type: 'Relationship',
            ref: 'User',
            isRequired: false,
            knexOptions: { isNotNullable: false },
            kmigratorOptions: { null: true, on_delete: 'models.CASCADE' },
        },

        messageType: getMessageTypeField({
            schemaDoc: 'Affected message type',
            isRequired: false,
        }),

        messageTransport: {
            schemaDoc: `Affected message transport. Possible values are: ${MESSAGE_TRANSPORTS.join(',')}`,
            type: 'Select',
            options: MESSAGE_TRANSPORTS,
            isRequired: false,
            knexOptions: { isNotNullable: false },
            kmigratorOptions: { null: true },
        },

        isEnabled: {
            schemaDoc: 'Is notification enabled',
            type: 'Checkbox',
            isRequired: false,
            defaultValue: true,
        },

    },
    kmigratorOptions: {
        constraints: [
            {
                type: 'models.CheckConstraint',
                check: 'Q(messageType__isnull=False) | Q(messageTransport__isnull=False)',
                name: 'has_messageType_or_messageTransport',
            },
            {
                type: 'models.CheckConstraint',
                check: 'Q(deletedAt__isnull=False) | ~(Q(user__isnull=True) & (Q(messageType__isnull=True) | Q(messageTransport__isnull=True)))',
                name: 'global_setting_requires_messageType_and_messageTransport',
            },
            {
                type: 'models.UniqueConstraint',
                fields: ['user', 'messageType', 'messageTransport'],
                condition: 'Q(deletedAt__isnull=True)',
                name: 'NotificationUserSetting_unique_user_messageType_messageTransport',
            },
            {
                type: 'models.UniqueConstraint',
                fields: ['user', 'messageType'],
                condition: 'Q(deletedAt__isnull=True) & Q(messageTransport__isnull=True)',
                name: 'NotificationUserSetting_unique_user_messageType',
            },
            {
                type: 'models.UniqueConstraint',
                fields: ['user', 'messageTransport'],
                condition: 'Q(deletedAt__isnull=True) & Q(messageType__isnull=True)',
                name: 'NotificationUserSetting_unique_user_messageTransport',
            },
        ],
        indexes: [
            {
                type: 'BTreeIndex',
                fields: ['user', 'messageType'],
                name: 'user_messageType_idx',
            },
        ],
    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical(), analytical()],
    access: {
        read: access.canReadNotificationUserSettings,
        create: access.canManageNotificationUserSettings,
        update: access.canManageNotificationUserSettings,
        delete: false,
        auth: true,
    },
})

module.exports = {
    NotificationUserSetting,
}
