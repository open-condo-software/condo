/**
 * Generated by `createservice notification.SyncRemoteClientService --type mutations`
 */
const get = require('lodash/get')
const isEqual = require('lodash/isEqual')
const pickBy = require('lodash/pickBy')

const { GQLCustomSchema, getById, getByCondition } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/notification/access/SyncRemoteClientService')
const { RemoteClient } = require('@condo/domains/notification/utils/serverSchema')

const { PUSH_TRANSPORT_TYPES, DEVICE_PLATFORM_TYPES, PUSH_TYPES } = require('../constants/constants')

const SyncRemoteClientService = new GQLCustomSchema('SyncRemoteClientService', {
    types: [
        {
            access: true,
            type: `enum PushTransportType { ${PUSH_TRANSPORT_TYPES.join(' ')} }`,
        },
        {
            access: true,
            type: `enum DevicePlatformType { ${DEVICE_PLATFORM_TYPES.join(' ')} }`,
        },
        {
            access: true,
            type: `enum PushType { ${PUSH_TYPES.join(' ')} }`,
        },
        {
            access: true,
            type: 'input SyncRemoteClientInput { dv: Int!, sender: SenderFieldInput!, deviceId: String!, appId: String!, pushToken: String, pushTransport: PushTransportType, devicePlatform: DevicePlatformType, pushType: PushType, meta: JSON, pushTokenVoIP: String, pushTransportVoIP: PushTransportType, pushTypeVoIP: PushType }',
        },
    ],

    mutations: [
        {
            access: access.canSyncRemoteClient,
            schema: 'syncRemoteClient(data: SyncRemoteClientInput!): RemoteClient',
            resolver: async (parent, args, context) => {
                const {
                    data: {
                        dv, sender, deviceId, appId,
                        pushToken, pushTransport, devicePlatform, pushType, meta,
                        pushTokenVoIP, pushTransportVoIP, pushTypeVoIP,
                    },
                } = args

                const userId = get(context, 'authedItem.id', null)
                const existing = await getByCondition('RemoteClient', { deviceId, appId })

                if (pushToken) {
                    const conflict = await getByCondition('RemoteClient', { pushToken })
                    if (conflict && conflict.id !== existing?.id) {
                        await RemoteClient.update(
                            context,
                            conflict.id,
                            {
                                dv,
                                sender,
                                pushToken: null,
                            }
                        )
                    }
                }

                if (pushTokenVoIP) {
                    const conflictVoIP = await getByCondition('RemoteClient', { pushTokenVoIP })
                    if (conflictVoIP && conflictVoIP.id !== existing?.id) {
                        await RemoteClient.update(
                            context,
                            conflictVoIP.id,
                            {
                                dv,
                                sender,
                                pushTokenVoIP: null,
                            }
                        )
                    }
                }

                const attrs = pickBy({
                    dv, sender, deviceId, appId,
                    pushToken, pushTransport, devicePlatform, pushType, meta,
                    pushTokenVoIP, pushTransportVoIP, pushTypeVoIP,
                    owner: userId ? { disconnectAll: true, connect: { id: userId } } : null,
                }, value => value !== undefined)

                let result
                if (!existing) {
                    result = await RemoteClient.create(context, attrs)
                } else {
                    const diff = {}
                    for (const [key, value] of Object.entries(attrs)) {
                        if (key === 'sender') continue

                        if (key === 'owner') {
                            const existingOwnerId =  existing?.owner?.id || existing?.owner
                            const newOwnerId = value?.connect?.id ?? null

                            if (existingOwnerId !== newOwnerId) {
                                diff.owner = value
                            }

                            continue
                        }
                        if (!isEqual(existing[key], value)) {
                            diff[key] = value
                        }
                    }

                    if (Object.keys(diff).length > 0) {
                        result = await RemoteClient.update(context, existing.id, attrs)
                    } else {
                        result = existing
                    }
                }

                return await getById('RemoteClient', result.id)
            },
        },
    ],
})

module.exports = {
    SyncRemoteClientService,
}
