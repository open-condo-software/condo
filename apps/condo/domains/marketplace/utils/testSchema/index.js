/**
 * Generated by `createschema marketplace.InvoiceContext 'organization:Relationship:Organization:PROTECT; recipient:Json; email:Text; settings:Json; state:Json;'`
 * In most cases you should not change it by hands
 * Please, don't remove `AUTOGENERATE MARKER`s
 */
const { faker } = require('@faker-js/faker')
const path = require('path')
const conf = require('@open-condo/config')
const { UploadingFile } = require('@open-condo/keystone/test.utils')

const { generateGQLTestUtils, throwIfError } = require('@open-condo/codegen/generate.test.utils')

const { Invoice: InvoiceGQL } = require('@condo/domains/marketplace/gql')
const { MarketCategory: MarketCategoryGQL } = require('@condo/domains/marketplace/gql')
const { MarketItem: MarketItemGQL } = require('@condo/domains/marketplace/gql')
const {  INVOICE_PAYMENT_TYPE_ONLINE } = require('@condo/domains/marketplace/constants')
const { MarketItemFile: MarketItemFileGQL } = require('@condo/domains/marketplace/gql')
const { MarketItemPrice: MarketItemPriceGQL } = require('@condo/domains/marketplace/gql')
const { MarketPriceScope: MarketPriceScopeGQL } = require('@condo/domains/marketplace/gql')
const { REGISTER_INVOICE_MUTATION } = require('@condo/domains/marketplace/gql')
const { GET_INVOICE_BY_USER_QUERY } = require('@condo/domains/marketplace/gql')
/* AUTOGENERATE MARKER <IMPORT> */

const MarketCategory = generateGQLTestUtils(MarketCategoryGQL)
const MarketItem = generateGQLTestUtils(MarketItemGQL)
const Invoice = generateGQLTestUtils(InvoiceGQL)

const MarketItemFile = generateGQLTestUtils(MarketItemFileGQL)
const MarketItemPrice = generateGQLTestUtils(MarketItemPriceGQL)
const MarketPriceScope = generateGQLTestUtils(MarketPriceScopeGQL)

/* AUTOGENERATE MARKER <CONST> */

const TEST_FILE = path.resolve(conf.PROJECT_ROOT, 'apps/condo/domains/common/test-assets/dino.png')

async function createTestMarketCategory (client, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        name: sender.fingerprint,
        image: new UploadingFile(TEST_FILE),
        mobileSettings: { bgColor: '#fff', titleColor: '#fff' },
        ...extraAttrs,
    }
    const obj = await MarketCategory.create(client, attrs)
    return [obj, attrs]
}

async function updateTestMarketCategory (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await MarketCategory.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestMarketItem (client, marketCategory, organization, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!marketCategory || !marketCategory.id) throw new Error('no marketCategory.id')
    if (!organization || !organization.id) throw new Error('no organization.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        sku: sender.fingerprint,
        name: sender.fingerprint,
        marketCategory: { connect: { id: marketCategory.id } },
        organization: { connect: { id: organization.id } },
        ...extraAttrs,
    }
    const obj = await MarketItem.create(client, attrs)
    return [obj, attrs]
}

async function updateTestMarketItem (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await MarketItem.update(client, id, attrs)
    return [obj, attrs]
}

function generateInvoiceRow (attrs = {}) {
    return {
        name: faker.commerce.productName(),
        toPay: String(faker.commerce.price()),
        count: faker.datatype.number({ min: 1, max: 3 }),
        isMin: false,
        ...attrs,
    }
}

/**
 * @param {Number} rowsCount
 * @returns {*[]}
 */
function generateInvoiceRows (rowsCount = null) {
    const count = rowsCount || faker.datatype.number({ min: 1, max: 5 })
    const rows = []
    for (let i = 0; i < count; i++) {
        rows.push(generateInvoiceRow())
    }

    return rows
}

function generatePriceRow (attrs = {}) {
    return {
        type: 'variant',
        name: faker.commerce.productName(),
        price: String(faker.commerce.price()),
        isMin: false,
        ...attrs,
    }
}

/**
 * @param {Number} rowsCount
 * @returns {*[]}
 */
function generatePriceRows (rowsCount) {
    const count = rowsCount || faker.datatype.number({ min: 1, max: 5 })
    const rows = []
    for (let i = 0; i < count; i++) {
        rows.push(generatePriceRow())
    }

    return rows
}

async function createTestInvoice (client, organization, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!organization || !organization.id) throw new Error('no organization.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const rows = generateInvoiceRows()

    const attrs = {
        dv: 1,
        sender,
        organization: { connect: { id: organization.id } },
        rows,
        accountNumber: faker.random.alphaNumeric(13),
        ...extraAttrs,
    }
    const obj = await Invoice.create(client, attrs)
    return [obj, attrs]
}

async function updateTestInvoice (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await Invoice.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestMarketItemFile (client, marketItem, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!marketItem || !marketItem.id) throw new Error('no marketItem.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        file: new UploadingFile(TEST_FILE),
        marketItem: { connect: { id: marketItem.id } },
        ...extraAttrs,
    }
    const obj = await MarketItemFile.create(client, attrs)
    return [obj, attrs]
}

async function updateTestMarketItemFile (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await MarketItemFile.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestMarketItemPrice (client, marketItem, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!marketItem || !marketItem.id) throw new Error('no marketItem.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        marketItem: { connect: { id: marketItem.id } },
        price: generatePriceRows(1),
        ...extraAttrs,
    }
    const obj = await MarketItemPrice.create(client, attrs)
    return [obj, attrs]
}

async function updateTestMarketItemPrice (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }


    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await MarketItemPrice.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestMarketPriceScope (client, itemPrice, property, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!itemPrice || !itemPrice.id) throw new Error('no itemPrice.id')
    if (!property || !property.id) throw new Error('no property.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        marketItemPrice: { connect: { id: itemPrice.id } },
        property: { connect: { id: property.id } },
        ...extraAttrs,
    }
    const obj = await MarketPriceScope.create(client, attrs)
    return [obj, attrs]
}

async function createTestMarketPriceScopes (client, createAttrs = []) {
    if (!client) throw new Error('no client')

    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const attrs = createAttrs.map(data => ({ data: {...data, dv: 1, sender} }))

    return await MarketPriceScope.createMany(client, attrs)
}

async function updateTestMarketPriceScope (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await MarketPriceScope.update(client, id, attrs)
    return [obj, attrs]
}

async function softDeleteTestMarketPriceScopes (client, ids) {
    if (!client) throw new Error('no client')

    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const attrs = ids.map(id => ({
        id,
        data: {
            dv: 1,
            sender,
            deletedAt: 'true',
        }
    }))

    return await MarketPriceScope.updateMany(client, attrs)
}

async function registerInvoiceByTestClient (client, resident, invoiceRows, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!resident || !resident.id) throw new Error('no resident.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        resident,
        invoiceRows,
        paymentType: INVOICE_PAYMENT_TYPE_ONLINE,
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(REGISTER_INVOICE_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}


async function getInvoiceByUserByTestClient(client, extraAttrs = {}) {
    if (!client) throw new Error('no client')

    const attrs = {
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(GET_INVOICE_BY_USER_QUERY, { data: attrs })
    throwIfError(data, errors)
    return [data.obj, attrs]
}
/* AUTOGENERATE MARKER <FACTORY> */

module.exports = {
    MarketCategory, createTestMarketCategory, updateTestMarketCategory,
    MarketItem, createTestMarketItem, updateTestMarketItem,
    Invoice, createTestInvoice, updateTestInvoice,
    generateInvoiceRow, generateInvoiceRows,
    generatePriceRow, generatePriceRows,
    MarketItemFile, createTestMarketItemFile, updateTestMarketItemFile,
    MarketItemPrice, createTestMarketItemPrice, updateTestMarketItemPrice,
    MarketPriceScope, createTestMarketPriceScope, updateTestMarketPriceScope,
    createTestMarketPriceScopes, softDeleteTestMarketPriceScopes,
    registerInvoiceByTestClient,
    getInvoiceByUserByTestClient,
/* AUTOGENERATE MARKER <EXPORTS> */
}
