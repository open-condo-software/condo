/**
 * Generated by `createschema marketplace.MarketItem 'name:Text; marketCategory:Relationship:MarketCategory:SET_NULL; sku:Text; description:Text; organization:Relationship:Organization:CASCADE;'`
 */

import {
    MarketItem,
    MarketItemCreateInput,
    MarketItemUpdateInput,
    QueryAllMarketItemsArgs,
} from '@app/condo/schema'
import { get } from 'lodash'
import isUndefined from 'lodash/isUndefined'

import { generateReactHooks } from '@open-condo/codegen/generate.hooks'

import { MarketItem as MarketItemGQL } from '@condo/domains/marketplace/gql'


const RELATIONS = ['marketCategory']
const DISCONNECT_ON_NULL = []
const IGNORE_FORM_FIELDS = ['parentCategory']

export enum PriceType {
    Exact = 'exact',
    Min = 'min',
    Contract = 'contract',
}

export type PriceFormValuesType = {
    properties?: string[]
    priceType?: PriceType
    price?: string
    hasAllProperties?: boolean
    id?: string
}

export type MarketItemFormValuesType = {
    name?: string
    sku?: string
    parentCategory?: string
    marketCategory?: string
    description?: string
    files?: string[]
    prices?: PriceFormValuesType[]
    selectedProperties?: string[]
}

export function convertToFormState (marketItem: MarketItem): MarketItemFormValuesType | undefined {
    const result: MarketItemFormValuesType = {}

    for (const key of Object.keys(marketItem)) {
        const relationId = get(marketItem[key], 'id')

        result[key] = relationId || marketItem[key]

        if (key === 'marketCategory') {
            result['parentCategory'] = get(marketItem, 'marketCategory.parentCategory.id')
        }
    }

    return result
}

type MarketItemMutationType = MarketItemUpdateInput | MarketItemCreateInput

export function formValuesProcessor (formValues: MarketItemFormValuesType): MarketItemMutationType {
    const result: MarketItemMutationType = {}

    for (const key of Object.keys(formValues)) {
        if (IGNORE_FORM_FIELDS.includes(key)) continue
        const isRelation = RELATIONS.includes(key)

        if (isRelation) {
            if (DISCONNECT_ON_NULL.includes(key) && formValues[key] === null) {
                result[key] = { disconnectAll: true }
            } else if (formValues[key]) {
                result[key] = { connect: { id: formValues[key] } }
            }
        } else if (!isUndefined(formValues[key])) {
            result[key] = formValues[key]
        }
    }

    return result
}

export const INITIAL_PRICE_FORM_VALUE = { properties: [], priceType: PriceType.Exact }

const {
    useObject,
    useObjects,
    useCreate,
    useUpdate,
    useSoftDelete,
    useCount,
} = generateReactHooks<MarketItem, MarketItemCreateInput, MarketItemUpdateInput, QueryAllMarketItemsArgs>(MarketItemGQL)

export {
    useObject,
    useObjects,
    useCreate,
    useUpdate,
    useSoftDelete,
    useCount,
}
