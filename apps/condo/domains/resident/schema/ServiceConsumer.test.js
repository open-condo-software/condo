/**
 * Generated by `createschema resident.ServiceConsumer 'resident:Relationship:Resident:CASCADE; billingAccount?:Relationship:BillingAccount:SET_NULL; accountNumber:Text;'`
 */

const faker = require('faker')
const { createTestResident } = require('../utils/testSchema')
const { createTestProperty, makeClientWithProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestBillingAccount, createTestBillingProperty, makeContextWithOrganizationAndIntegrationAsAdmin } = require('@condo/domains/billing/utils/testSchema')
const { buildingMapJson } = require('@condo/domains/property/constants/property')
const { registerNewOrganization } = require('@condo/domains/organization/utils/testSchema/Organization')
const { makeClientWithResidentUser } = require('@condo/domains/user/utils/testSchema')
const { createTestOrganization, createTestOrganizationEmployee, createTestOrganizationEmployeeRole } = require('@condo/domains/organization/utils/testSchema')
const { expectToThrowAccessDeniedErrorToObj } = require('@condo/domains/common/utils/testSchema')
const { makeClient } = require('@core/keystone/test.utils')
const { makeLoggedInAdminClient } = require('@core/keystone/test.utils')
const { createTestServiceConsumer } = require('@condo/domains/resident/utils/testSchema')


describe('ServiceConsumer', () => {

    describe('BillingAccountConnection', () => {

        it('connects to billing account if there is one with relevant Number', async () => {
            const userClient = await makeClientWithProperty()
            const adminClient = await makeLoggedInAdminClient()

            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin()
            const [billingProperty] = await createTestBillingProperty(adminClient, context)
            const [billingAccount, billingAccountAttrs] = await createTestBillingAccount(adminClient, context, billingProperty)
            const [resident] = await createTestResident(adminClient, userClient.user, userClient.organization, userClient.property, {
                unitName: billingAccountAttrs.unitName,
            })
            const [consumer] = await createTestServiceConsumer(adminClient, resident, {
                number: billingAccountAttrs.number,
            })

            expect(consumer.billingAccount.id).toEqual(billingAccount.id)
        })

        it('connects to billing account if there is one with relevant globalId', async () => {
            const userClient = await makeClientWithProperty()
            const adminClient = await makeLoggedInAdminClient()

            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin()
            const [billingProperty] = await createTestBillingProperty(adminClient, context)
            const [billingAccount, billingAccountAttrs] = await createTestBillingAccount(adminClient, context, billingProperty)
            const [resident] = await createTestResident(adminClient, userClient.user, userClient.organization, userClient.property, {
                unitName: billingAccountAttrs.unitName,
            })
            const [consumer] = await createTestServiceConsumer(adminClient, resident, {
                number: billingAccountAttrs.globalId,
            })

            expect(consumer.billingAccount.id).toEqual(billingAccount.id)
        })

        it('does not connect to billing account if there are none', async () => {
            const userClient = await makeClientWithProperty()
            const adminClient = await makeLoggedInAdminClient()

            const [resident] = await createTestResident(adminClient, userClient.user, userClient.organization, userClient.property, {
                unitName: faker.random.alphaNumeric(8).toString(),
            })
            const [consumer] = await createTestServiceConsumer(adminClient, resident, {
                number: faker.random.alphaNumeric(9).toString(),
            })

            expect(consumer.billingAccount).toEqual(null)
        })

    })

    describe('Create', () => {
        it('can be created by admin', async () => {
            const userClient = await makeClientWithProperty()
            const adminClient = await makeLoggedInAdminClient()

            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin()
            const [billingProperty] = await createTestBillingProperty(adminClient, context)
            const [billingAccount] = await createTestBillingAccount(adminClient, context, billingProperty)

            const fields = {
                billingAccount: { connect: { id: billingAccount.id } },
            }

            const [resident] = await createTestResident(adminClient, userClient.user, userClient.organization, userClient.property, fields)
            const [consumer] = await createTestServiceConsumer(adminClient, resident)
            expect(consumer.resident.id).toEqual(resident.id)
        })

        it('can be created by user with type === resident', async () => {
            const userClient = await makeClientWithResidentUser()
            const [organization] = await registerNewOrganization(userClient)
            const [property] = await createTestProperty(userClient, organization, { map: buildingMapJson })

            const [resident] = await createTestResident(userClient, userClient.user, organization, property)

            const [consumer] = await createTestServiceConsumer(userClient, resident)
            expect(consumer.resident.id).toEqual(resident.id)
        })

        it('cannot be created by other users', async () => {
            const adminClient = await makeLoggedInAdminClient()
            const userClient = await makeClientWithProperty()
            const [organization] = await createTestOrganization(adminClient)
            const [anotherOrganization] = await createTestOrganization(adminClient)
            const [role] = await createTestOrganizationEmployeeRole(adminClient, organization)
            await createTestOrganizationEmployee(adminClient, organization, userClient.user, role)
            const [resident] = await createTestResident(adminClient, userClient.user, anotherOrganization, userClient.property)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestServiceConsumer(userClient, resident)
            })
        })

        it('cannot be created by user, who is not employed in specified organization', async () => {
            const adminClient = await makeLoggedInAdminClient()
            const userClient = await makeClientWithProperty()
            const anotherUser = await makeClientWithProperty()
            const [resident] = await createTestResident(adminClient, userClient.user, userClient.organization, userClient.property)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestServiceConsumer(anotherUser, resident)
            })
        })

        it('cannot be created by anonymous', async () => {
            const adminClient = await makeLoggedInAdminClient()
            const userClient = await makeClientWithProperty()
            const anonymous = await makeClient()
            const [resident] = await createTestResident(adminClient, userClient.user, userClient.organization, userClient.property)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestServiceConsumer(anonymous, resident)
            })
        })
    })
})
