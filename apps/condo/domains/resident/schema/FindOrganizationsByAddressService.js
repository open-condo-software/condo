/**
 * Generated by `createservice resident.FindOrganizationsByAddressService --type queries`
 */
const { GQLCustomSchema, find } = require('@open-condo/keystone/schema')

const { CONTEXT_FINISHED_STATUS: BILLING_CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const access = require('@condo/domains/resident/access/FindOrganizationsByAddressService')
const {
    MAX_RESIDENT_FIND_ORGANIZATIONS_BY_WINDOW_SEC,
    RESIDENT_FIND_ORGANIZATIONS_WINDOW_SEC,
} = require('@condo/domains/resident/constants/constants')
const {
    getOrganizationIdsWithAcquiring,
    getOrganizationIdsWithMeters,
    findOrganizationsByAddressKeyTinAccountNumber,
    findOrganizationsByAddressKeyUnitNameUnitType,
    findOrganizationsByAddressKey,
} = require('@condo/domains/resident/utils/serverSchema/findOrganizationsByAddress')
const { RESIDENT } = require('@condo/domains/user/constants/common')
const { RedisGuard } = require('@condo/domains/user/utils/serverSchema/guards')

const redisGuard = new RedisGuard()

const checkLimits = async (uniqueField, context) => {
    await redisGuard.checkCustomLimitCounters(
        `find-organizations-by-address-${uniqueField}`,
        RESIDENT_FIND_ORGANIZATIONS_WINDOW_SEC,
        MAX_RESIDENT_FIND_ORGANIZATIONS_BY_WINDOW_SEC,
        context,
    )
}

const FindOrganizationsByAddressService = new GQLCustomSchema('FindOrganizationsByAddressService', {
    types: [
        {
            access: true,
            type: 'input FindOrganizationsByAddressInput { addressKey: String!, unitName: String, unitType: String, tin: String, accountNumber: String }',
        },
        {
            access: true,
            type: 'type FindOrganizationByAddressReceiptType { number: String, category: ID!, balance: String, routingNumber: String, bankAccount: String }',
        },
        {
            access: true,
            type: 'type FindOrganizationByAddressMeterType { resource: String!, number: String, account: String, value: String }',
        },
        {
            access: true,
            type: 'type FindOrganizationByAddressOutput { id: String!, name: String!, tin: String!, type:OrganizationTypeType!, receipts: [FindOrganizationByAddressReceiptType], meters: [FindOrganizationByAddressMeterType] }',
        },
    ],
    queries: [
        {
            access: access.canFindOrganizationsByAddress,
            schema: 'findOrganizationsByAddress (data: FindOrganizationsByAddressInput!): [FindOrganizationByAddressOutput]',
            resolver: async (parent, args, context) => {
                const { data } = args
                const { addressKey, unitName, unitType, tin, accountNumber } = data

                if (context.authedItem.type === RESIDENT) {
                    await checkLimits(context.authedItem.id, context)
                }

                const properties = await find('Property', { addressKey, deletedAt: null })
                if (!properties.length) return []

                const organizationIds = [...new Set(properties.map(({ organization }) => organization))]

                let organizations = await find('Organization', {
                    id_in: organizationIds,
                    ...(tin && { tin }),
                    deletedAt: null,
                })
                if (!organizations.length) return []

                const [withAcquiring, withMeters] = await Promise.all([
                    getOrganizationIdsWithAcquiring(organizations),
                    getOrganizationIdsWithMeters(organizations),
                ])

                organizations = organizations.filter(({ id }) => withAcquiring.has(id) || withMeters.has(id))
                if (!organizations.length) return []

                const billingContexts = await find('BillingIntegrationOrganizationContext', {
                    status: BILLING_CONTEXT_FINISHED_STATUS,
                    deletedAt: null,
                    organization: { id_in: organizations.map(({ id }) => id) },
                })
                if (!billingContexts.length) return []

                const billingContextIndex = billingContexts.reduce((acc, billingContext) => {
                    acc[billingContext.organization] = billingContext
                    return acc
                }, {})

                organizations = organizations.filter(({ id }) => billingContextIndex[id])

                if (tin && accountNumber) {
                    return findOrganizationsByAddressKeyTinAccountNumber(organizations, billingContextIndex, data)
                } else if (unitName && unitType) {
                    return findOrganizationsByAddressKeyUnitNameUnitType(organizations, billingContextIndex, context, data)
                } else {
                    return findOrganizationsByAddressKey(organizations, billingContextIndex, data)
                }
            },
        },
    ],
})

module.exports = {
    FindOrganizationsByAddressService,
}
