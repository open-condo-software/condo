/**
 * Generated by `createservice property.RegisterResidentService --type mutations`
 */

const omit = require('lodash/omit')

const { getById, GQLCustomSchema } = require('@core/keystone/schema')

const { Property: PropertyAPI } = require('@condo/domains/property/utils/serverSchema')
const { getAddressUpToBuildingFrom } = require('@condo/domains/property/utils/serverSchema/helpers')

const { Resident: ResidentAPI } = require('@condo/domains/resident/utils/serverSchema')
const access = require('@condo/domains/resident/access/RegisterResidentService')

const RegisterResidentService = new GQLCustomSchema('RegisterResidentService', {
    types: [
        {
            access: true,
            type: 'input RegisterResidentInput { dv: Int!, sender: SenderFieldInput!, address: String!, addressMeta: AddressMetaFieldInput!, unitName: String! }',
        },
    ],

    mutations: [
        {
            access: access.canRegisterResident,
            schema: 'registerResident(data: RegisterResidentInput!): Resident',
            resolver: async (parent, args, context) => {
                const {
                    data: { dv, sender, address, addressMeta, unitName },
                } = args
                const attrs = {
                    dv,
                    sender,
                    address,
                    addressMeta,
                    unitName,
                    user: { connect: { id: context.authedItem.id } },
                }
                const [existingResident] = await ResidentAPI.getAll(
                    context,
                    {
                        address_i: address,
                        unitName_i: unitName,
                        user: { id: context.authedItem.id },
                    },
                    {
                        first: 1,
                    },
                )

                const propertyAddress = getAddressUpToBuildingFrom(addressMeta)
                const [property] = await PropertyAPI.getAll(
                    context,
                    { address_i: propertyAddress, deletedAt: null },
                    { sortBy: ['createdAt_ASC'], first: 1 },
                )

                if (property) {
                    attrs.property = { connect: { id: property.id } }
                    attrs.organization = { connect: { id: property.organization.id } }
                }

                let id
                if (existingResident) {
                    const nextAttrs = omit({ ...attrs, deletedAt: null }, ['address', 'addressMeta', 'unitName'])

                    // TODO(DOMA-1780): we need to update address and addressMeta from property
                    await ResidentAPI.update(context, existingResident.id, nextAttrs)
                    id = existingResident.id
                } else {
                    const propertyAddress = getAddressUpToBuildingFrom(addressMeta)
                    const residentAttrs = { ...attrs, address: propertyAddress }
                    const resident = await ResidentAPI.create(context, residentAttrs)

                    id = resident.id
                }

                // Hack that helps to resolve all subfields in result of this mutation
                const result = await getById('Resident', id)

                return result
            },
        },
    ],
})

module.exports = {
    RegisterResidentService,
}
