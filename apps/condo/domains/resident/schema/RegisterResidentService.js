/**
 * Generated by `createservice property.RegisterResidentService --type mutations`
 */

const { GQLCustomSchema } = require('@core/keystone/schema')
const access = require('../access/RegisterResidentService')
const { Resident } = require('../utils/serverSchema/index')
const { Property } = require('@condo/domains/property/utils/serverSchema')


const RegisterResidentService = new GQLCustomSchema('RegisterResidentService', {
    types: [
        {
            access: true,
            type: 'input RegisterResidentInput { dv: Int!, sender: JSON!, address: String!, addressMeta: JSON!, unitName: String! }',
        },
    ],
    
    mutations: [
        {
            access: access.canRegisterResident,
            schema: 'registerResident(data: RegisterResidentInput!): Resident',
            resolver: async (parent, args, context, info, extra = {}) => {
                if (!context.authedItem.id) throw new Error('[error] User is not authenticated')
                const { data: { dv, sender, address, addressMeta, unitName } } = args
                const attrs = {
                    dv,
                    sender,
                    address,
                    addressMeta,
                    unitName,
                    user: { connect: { id: context.authedItem.id } },
                }
                const [property] = await Property.getAll(context, { address })
                if (property) {
                    attrs.property = { connect: { id: property.id } }
                    attrs.organization = { connect: { id: property.organization.id } }
                }
                const resident = await Resident.create(context, attrs)
                return resident
            },
        },
    ],
    
})

module.exports = {
    RegisterResidentService,
}
