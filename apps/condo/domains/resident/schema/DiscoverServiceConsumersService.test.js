/**
 * Generated by `createservice resident.DiscoverServiceConsumersService --type mutations`
 */
const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient, makeClient, expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult, waitFor, getIsFeatureFlagsEnabled, setIsFeatureFlagsEnabled,
} = require('@open-condo/keystone/test.utils')

const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/acquiring/constants/context')
const {
    createTestAcquiringIntegrationContext,
    createTestAcquiringIntegration,
} = require('@condo/domains/acquiring/utils/testSchema')
const {
    makeContextWithOrganizationAndIntegrationAsAdmin,
    createTestBillingProperty,
    createTestBillingAccount,
    ResidentBillingReceipt,
    createTestBillingIntegration,
    createTestBillingIntegrationOrganizationContext,
    createRegisterBillingReceiptsPayload,
    registerBillingReceiptsByTestClient,
} = require('@condo/domains/billing/utils/testSchema')
const { FLAT_UNIT_TYPE } = require('@condo/domains/property/constants/common')
const {
    makeClientWithResidentAccessAndProperty,
    makeClientWithProperty,
} = require('@condo/domains/property/utils/testSchema')
const {
    createTestResident,
    updateTestResident,
    ServiceConsumer,
    discoverServiceConsumersByTestClient,
    registerResidentByTestClient,
} = require('@condo/domains/resident/utils/testSchema')
const { makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

describe('DiscoverServiceConsumersService', () => {
    let admin
    let support
    let anonymous

    const randomPayload = {
        address: faker.random.alphaNumeric(32),
        unitName: faker.random.alphaNumeric(10),
        unitType: faker.random.alphaNumeric(10),
    }

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()
    })

    describe('access', () => {
        test('admin can discover service consumers', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property, {
                address: billingProperty.address,
            })

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
            }

            const [{ statistics }] = await discoverServiceConsumersByTestClient(admin, payload)

            expect(statistics).toEqual(expect.objectContaining({
                created: 0,
                residentsFound: 1,
                billingAccountsFound: 0,
            }))
        })

        test('user cannot discover service consumers', async () => {
            const user = await makeClientWithProperty()
            await expectToThrowAccessDeniedErrorToResult(async () => {
                await discoverServiceConsumersByTestClient(user, randomPayload)
            })
        })

        test('support cannot discover service consumers', async () => {
            await expectToThrowAccessDeniedErrorToResult(async () => {
                await discoverServiceConsumersByTestClient(support, randomPayload)
            })
        })

        test('anonymous cannot discover service consumers', async () => {
            await expectToThrowAuthenticationErrorToResult(async () => {
                await discoverServiceConsumersByTestClient(anonymous, randomPayload)
            })
        })
    })

    describe('logic tests', () => {
        test('discover one service consumer (case without accountNumber or resident passed)', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )

            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    resident: { id: resident.id },
                    deletedAt: null,
                })

                expect(createdServiceConsumers).toHaveLength(1)
                expect(createdServiceConsumers[0].organization.id).toEqual(user.organization.id)
                expect(createdServiceConsumers[0].accountNumber).toEqual(billingAccount.number)
            })
        })

        test('discover multiple service consumers (case without accountNumber or resident passed)', async () => {
            const user = await makeClientWithProperty()
            const user2 = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: 'Finished' },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident1] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )
            const [resident2] = await createTestResident(admin, user2.user, user.property,
                { address: billingProperty.address, unitName: resident1.unitName, unitType: resident1.unitType },
            )
            await updateTestResident(admin, resident2.id, { address: resident1.address })
            const [billingAccount1] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident1.unitName, unitType: resident1.unitType },
            )

            const [billingAccount2] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident1.unitName, unitType: resident1.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    OR: [
                        { resident: { id: resident1.id } },
                        { resident: { id: resident2.id } },
                    ],
                    deletedAt: null,
                })
                const residentIds = createdServiceConsumers.map(serviceConsumer => serviceConsumer.resident.id)
                const accountNumbers = createdServiceConsumers.map(serviceConsumer => serviceConsumer.accountNumber)

                expect(residentIds).toEqual(expect.arrayContaining([resident1.id, resident2.id]))
                expect(accountNumbers).toEqual(expect.arrayContaining([billingAccount1.number, billingAccount2.number]))
            })
        })

        test('discover one service consumer for specific resident', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    resident: { id: resident.id },
                    deletedAt: null,
                })

                expect(createdServiceConsumers).toHaveLength(1)
                expect(createdServiceConsumers[0].organization.id).toEqual(user.organization.id)
                expect(createdServiceConsumers[0].accountNumber).toEqual(billingAccount.number)
            })
        })

        test('discover multiple service consumers for specific resident', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )
            const [billingAccount1] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            const [billingAccount2] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    OR: [
                        { accountNumber: billingAccount1.number },
                        { accountNumber: billingAccount2.number },
                    ],
                    deletedAt: null,
                })
                const residentIds = createdServiceConsumers.map(serviceConsumer => serviceConsumer.resident.id)

                expect(residentIds).toContain(resident.id)
            })
        })

        test('discover one service consumer for specific accountNumber', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    resident: { id: resident.id },
                    deletedAt: null,
                })

                expect(createdServiceConsumers).toHaveLength(1)
                expect(createdServiceConsumers[0].organization.id).toEqual(user.organization.id)
                expect(createdServiceConsumers[0].accountNumber).toEqual(billingAccount.number)
                expect(createdServiceConsumers[0].resident.id).toEqual(resident.id)
            })
        })

        test('discover multiple service consumers for specific accountNumber', async () => {
            const user = await makeClientWithProperty()
            const user2 = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS },
            )

            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, user.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )
            const [resident2] = await createTestResident(admin, user2.user, user.property,
                { address: billingProperty.address, unitName: resident.unitName, unitType: resident.unitType },
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    OR: [
                        { resident: { id: resident.id } },
                        { resident: { id: resident2.id } },
                    ],
                    deletedAt: null,
                })
                const residentIds = createdServiceConsumers.map(serviceConsumer => serviceConsumer.resident.id)
                const accountNumbers = createdServiceConsumers.map(serviceConsumer => serviceConsumer.accountNumber)

                expect(residentIds).toEqual(expect.arrayContaining([resident.id, resident2.id]))
                expect(accountNumbers).toContain(billingAccount.number)
            })
        })

        test('discover no service consumers if the feature flag was disabled', async () => {
            const prevIsFeatureFlagsEnabled = getIsFeatureFlagsEnabled()
            setIsFeatureFlagsEnabled(false) // Disable feature flags

            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: 'Finished' },
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address },
            )
            await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType },
            )

            await waitFor(async () => {
                const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                    resident: { id: resident.id },
                    deletedAt: null,
                })
                expect(createdServiceConsumers).toHaveLength(0)
            })

            setIsFeatureFlagsEnabled(prevIsFeatureFlagsEnabled) // put the previous value back
        })
    })

    describe('real life cases', () => {
        test('Upload receipts => register resident => resident can see the receipts list', async () => {
            const residentClient1 = await makeClientWithResidentAccessAndProperty()

            const [billingIntegration] = await createTestBillingIntegration(admin)
            const [billingContext] = await createTestBillingIntegrationOrganizationContext(admin, residentClient1.organization, billingIntegration, { status: CONTEXT_FINISHED_STATUS })
            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, residentClient1.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const unitType1 = FLAT_UNIT_TYPE
            const unitName1 = faker.lorem.word()

            // 1/3 upload receipts
            const payload = {
                context: { id: billingContext.id },
                receipts: [
                    createRegisterBillingReceiptsPayload({
                        address: residentClient1.property.address,
                        unitType: unitType1,
                        unitName: unitName1,
                    }),
                    createRegisterBillingReceiptsPayload(),
                ],
            }
            const [registeredReceipts] = await registerBillingReceiptsByTestClient(admin, payload)

            // 2/3 register resident
            await registerResidentByTestClient(
                residentClient1,
                {
                    address: residentClient1.property.address,
                    addressMeta: residentClient1.property.addressMeta,
                    unitType: unitType1,
                    unitName: unitName1,
                })

            // 3/3 check that resident can see the receipts list
            const receipts = await ResidentBillingReceipt.getAll(
                residentClient1,
                {},
            )

            expect(receipts).toHaveLength(1)
            expect(registeredReceipts).toEqual(expect.arrayContaining([
                expect.objectContaining({ id: receipts[0].id }),
            ]))
        })

        test('Register resident => upload receipts => resident can see the receipts list', async () => {
            const residentClient1 = await makeClientWithResidentAccessAndProperty()

            const [billingIntegration] = await createTestBillingIntegration(admin)
            const [billingContext] = await createTestBillingIntegrationOrganizationContext(admin, residentClient1.organization, billingIntegration, { status: CONTEXT_FINISHED_STATUS })
            const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
            await createTestAcquiringIntegrationContext(admin, residentClient1.organization, acquiringIntegration, { status: CONTEXT_FINISHED_STATUS })

            const unitType1 = FLAT_UNIT_TYPE
            const unitName1 = faker.lorem.word()

            // 1/3 register resident
            await registerResidentByTestClient(
                residentClient1,
                {
                    address: residentClient1.property.address,
                    addressMeta: residentClient1.property.addressMeta,
                    unitType: unitType1,
                    unitName: unitName1,
                })

            // 2/3 upload receipts
            const payload = {
                context: { id: billingContext.id },
                receipts: [
                    createRegisterBillingReceiptsPayload({
                        address: residentClient1.property.address,
                        unitType: unitType1,
                        unitName: unitName1,
                    }),
                    createRegisterBillingReceiptsPayload(),
                ],
            }
            const [registeredReceipts] = await registerBillingReceiptsByTestClient(admin, payload)

            // 3/3 check that resident can see the receipts list
            await waitFor(async () => {
                const receipts = await ResidentBillingReceipt.getAll(residentClient1, {})

                expect(receipts).toHaveLength(1)
                expect(registeredReceipts).toEqual(expect.arrayContaining([
                    expect.objectContaining({ id: receipts[0].id }),
                ]))
            })
        })
    })
})
