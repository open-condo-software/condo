/**
 * Generated by `createservice resident.DiscoverServiceConsumersService --type mutations`
 */
const { faker } = require('@faker-js/faker')

const { makeLoggedInAdminClient, makeClient, expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult, catchErrorFrom,
} = require('@open-condo/keystone/test.utils')

const {
    makeContextWithOrganizationAndIntegrationAsAdmin,
    createTestBillingProperty,
    createTestBillingAccount,
} = require('@condo/domains/billing/utils/testSchema')
const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const { makeClientWithProperty } = require('@condo/domains/property/utils/testSchema')
const { MAX_RESIDENT_DISCOVER_CONSUMERS_BY_WINDOW } = require('@condo/domains/resident/constants/constants')
const { discoverServiceConsumersByTestClient } = require('@condo/domains/resident/utils/testSchema')
const { createTestResident, updateTestResident, ServiceConsumer } = require('@condo/domains/resident/utils/testSchema')
const { makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

describe('DiscoverServiceConsumersService', () => {
    let admin
    let support
    let anonymous

    const randomPayload = {
        address: faker.random.alphaNumeric(32),
        unitName: faker.random.alphaNumeric(10),
        unitType: faker.random.alphaNumeric(10),
    }

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()
    })
    describe('admin can:', () => {
        test('discover one service consumer (case without accountNumber or resident passed)', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: 'Finished' }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
            }

            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, payload)
            const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                resident: { id: resident.id },
                deletedAt: null,
            })
            expect(createdServiceConsumersTotal).toBe(1)
            expect(createdServiceConsumers[0].organization.id).toEqual(user.organization.id)
            expect(createdServiceConsumers[0].accountNumber).toEqual(billingAccount.number)
        })

        test('discover multiple service consumers (case without accountNumber or resident passed)', async () => {
            const user = await makeClientWithProperty()
            const user2 = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: 'Finished' }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident1] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            const [resident2] = await createTestResident(admin, user2.user, user.property,
                { address: billingProperty.address, unitName: resident1.unitName, unitType: resident1.unitType }
            )
            await updateTestResident(admin, resident2.id, { address: resident1.address })
            const [billingAccount1] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident1.unitName, unitType: resident1.unitType }
            )

            const [billingAccount2] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident1.unitName, unitType: resident1.unitType }
            )

            const payload = {
                address: resident1.address,
                unitName: resident1.unitName,
                unitType: resident1.unitType,
            }

            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, payload)
            const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                OR: [
                    { resident: { id: resident1.id } },
                    { resident: { id: resident2.id } },
                ],
                deletedAt: null,
            })
            const residentIds = createdServiceConsumers.map(serviceConsumer => serviceConsumer.resident.id)
            const accountNumbers = createdServiceConsumers.map(serviceConsumer => serviceConsumer.accountNumber)

            expect(createdServiceConsumersTotal).toBe(4)
            expect(residentIds).toContain(resident1.id, resident2.id)
            expect(accountNumbers).toContain(billingAccount1.number, billingAccount2.number)
        })

        test('discover one service consumer for specific resident', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
                resident: { id: resident.id },
            }

            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, payload)
            const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                resident: { id: resident.id },
                deletedAt: null,
            })
            expect(createdServiceConsumersTotal).toBe(1)
            expect(createdServiceConsumers[0].organization.id).toEqual(user.organization.id)
            expect(createdServiceConsumers[0].accountNumber).toEqual(billingAccount.number)
        })

        test('discover multiple service consumers for specific resident', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            const [billingAccount1] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const [billingAccount2] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
                resident: { id: resident.id },
            }

            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, payload)
            const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                OR: [
                    { accountNumber: billingAccount1.number },
                    { accountNumber: billingAccount2.number },
                ],
                deletedAt: null,
            })
            const residentIds = createdServiceConsumers.map(serviceConsumer => serviceConsumer.resident.id)

            expect(createdServiceConsumersTotal).toBe(2)
            expect(residentIds).toContain(resident.id)
        })

        test('discover one service consumer for specific accountNumber', async () => {
            const user = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )
            await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
                billingAccount: { id: billingAccount.id },
            }

            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, payload)
            const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                resident: { id: resident.id },
                deletedAt: null,
            })
            expect(createdServiceConsumersTotal).toBe(1)
            expect(createdServiceConsumers[0].organization.id).toEqual(user.organization.id)
            expect(createdServiceConsumers[0].accountNumber).toEqual(billingAccount.number)
            expect(createdServiceConsumers[0].resident.id).toEqual(resident.id)
        })

        test('discover multiple service consumers for specific accountNumber', async () => {
            const user = await makeClientWithProperty()
            const user2 = await makeClientWithProperty()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            const [resident2] = await createTestResident(admin, user2.user, user.property,
                { address: billingProperty.address, unitName: resident.unitName, unitType: resident.unitType  }
            )
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
                billingAccount: { id: billingAccount.id },
            }

            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, payload)
            const createdServiceConsumers = await ServiceConsumer.getAll(admin, {
                OR: [
                    { resident: { id: resident.id } },
                    { resident: { id: resident2.id } },
                ],
                deletedAt: null,
            })
            const residentIds = createdServiceConsumers.map(serviceConsumer => serviceConsumer.resident.id)
            const accountNumbers = createdServiceConsumers.map(serviceConsumer => serviceConsumer.accountNumber)

            expect(createdServiceConsumersTotal).toBe(2)
            expect(residentIds).toContain(resident.id, resident2.id)
            expect(accountNumbers).toContain(billingAccount.number)
        })

        test('should throw if limit of calls is exceeded for resident', async () => {
            const user = await makeClientWithProperty()
            const admin = await makeLoggedInAdminClient()
            const { context } = await makeContextWithOrganizationAndIntegrationAsAdmin(
                {}, {}, { status: CONTEXT_FINISHED_STATUS }
            )

            const [billingProperty] = await createTestBillingProperty(admin, context, { address: user.property.address })
            const [resident] = await createTestResident(admin, user.user, user.property,
                { address: billingProperty.address }
            )
            await createTestBillingAccount(admin, context, billingProperty,
                { unitName: resident.unitName, unitType: resident.unitType }
            )

            const payload = {
                address: resident.address,
                unitName: resident.unitName,
                unitType: resident.unitType,
                resident: { id: resident.id },
            }

            for await (const i of Array.from(Array(MAX_RESIDENT_DISCOVER_CONSUMERS_BY_WINDOW + 1).keys())) {
                if (i === MAX_RESIDENT_DISCOVER_CONSUMERS_BY_WINDOW) {
                    await catchErrorFrom(async () => {
                        await discoverServiceConsumersByTestClient(admin, payload)
                    }, ({ errors }) => {

                        expect(errors).toMatchObject([{
                            path: ['result'],
                            extensions: {
                                code: 'BAD_USER_INPUT',
                                type: 'TOO_MANY_REQUESTS',
                                message: 'You have to wait {secondsRemaining} seconds to be able to send request again',
                            },
                        }])
                    })
                } else {
                    await discoverServiceConsumersByTestClient(admin, payload)
                }
            }
        })

        test('discover no service consumers if there are none', async () => {
            const [{ createdServiceConsumersTotal }] = await discoverServiceConsumersByTestClient(admin, randomPayload)
            expect(createdServiceConsumersTotal).toBe(0)
        })
    })

    test('user cannot discover service consumers', async () => {
        const user = await makeClientWithProperty()
        await expectToThrowAccessDeniedErrorToResult(async () => {
            await discoverServiceConsumersByTestClient(user, randomPayload)
        })
    })

    test('support cannot discover service consumers', async () => {
        await expectToThrowAccessDeniedErrorToResult(async () => {
            await discoverServiceConsumersByTestClient(support, randomPayload)
        })
    })

    test('anonymous cannot discover service consumers', async () => {
        await expectToThrowAuthenticationErrorToResult(async () => {
            await discoverServiceConsumersByTestClient(anonymous, randomPayload)
        })
    })
})