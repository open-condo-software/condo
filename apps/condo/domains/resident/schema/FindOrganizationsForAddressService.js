/**
 * Generated by `createservice resident.FindOrganizationsForAddressService --type queries`
 */

const { GQLCustomSchema, find } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/resident/access/FindOrganizationsForAddressService')
const {
    MAX_RESIDENT_FIND_ORGANIZATIONS_BY_WINDOW_SEC,
    RESIDENT_FIND_ORGANIZATIONS_WINDOW_SEC,
} = require('@condo/domains/resident/constants/constants')
const {
    findBillingReceiptsForOrganizations,
    getOrganizationsWithAcquiring,
    getOrganizationsWithMeters,
    getBillingInformationForOrganizations,
} = require('@condo/domains/resident/utils/serverSchema/findOrganizationsForAddress')
const { RESIDENT } = require('@condo/domains/user/constants/common')
const { RedisGuard } = require('@condo/domains/user/utils/serverSchema/guards')

const redisGuard = new RedisGuard()

const checkLimits = async (uniqueField) => {
    await redisGuard.checkCustomLimitCounters(
        `find-organizations-by-address-${uniqueField}`,
        RESIDENT_FIND_ORGANIZATIONS_WINDOW_SEC,
        MAX_RESIDENT_FIND_ORGANIZATIONS_BY_WINDOW_SEC,
    )
}

const FindOrganizationsForAddressService = new GQLCustomSchema('FindOrganizationsForAddressService', {
    types: [
        {
            access: true,
            type: 'input FindOrganizationsForAddressInput { addressKey: String!, unitName: String, unitType: String, tin: String, accountNumber: String }',
        },
        {
            access: true,
            type: 'type FindOrganizationForAddressOrganizationType { id: ID!, name: String!, tin: String!, type: OrganizationTypeType! }',
        },
        {
            access: true,
            type: 'type FindOrganizationForAddressAccountType { number: String!, category: ID!, balance: String, routingNumber: String!, bankAccountNumber: String! }',
        },
        {
            access: true,
            type: 'type FindOrganizationForAddressOutput { organization: FindOrganizationForAddressOrganizationType!, account: FindOrganizationForAddressAccountType, hasMeters: Boolean!, hasBillingData: Boolean! }',
        },
    ],
    
    queries: [
        {
            access: access.canFindOrganizationsForAddress,
            schema: 'findOrganizationsForAddress (data: FindOrganizationsForAddressInput!): [FindOrganizationForAddressOutput]',
            resolver: async (parent, args, context) => {
                const { data } = args
                const { addressKey, unitName, unitType, tin, accountNumber } = data
                if (context.authedItem.type === RESIDENT) {
                    await checkLimits(context.authedItem.id)
                }
                const properties = await find('Property', { addressKey, deletedAt: null })
                if (!properties) {
                    return []
                }
                let organizations = await find('Organization', {
                    id_in: [...new Set(properties.map(({ organization }) => organization))],
                    ...tin ? { tin } : {},
                    deletedAt: null,
                })
                const organizationIds = organizations.map(({ id }) => id)
                const withAcquiring = await getOrganizationsWithAcquiring(organizationIds)
                organizations = organizations.filter(({ id }) => withAcquiring.has(id))
                const withMeters = await getOrganizationsWithMeters(organizationIds)
                const billingInformation = await getBillingInformationForOrganizations(organizations)
                organizations = organizations.filter(organization => organization.hasMeters || billingInformation[organization.id])
                if (!organizations) {
                    return  []
                }
                const organizationIndex = Object.fromEntries(organizations.map(({ id, name, tin, type }) => ([id, {
                    organization: { id, name, tin, type },
                    account: null,
                    hasMeters: withMeters.has(id),
                    hasBillingData: !!billingInformation[id],
                }])))
                if (accountNumber) {
                    const receipts = await findBillingReceiptsForOrganizations(organizations, billingInformation, {
                        number: accountNumber,
                        property: { addressKey, deletedAt: null },
                    })
                    const organizationsWithReceipts = new Set(receipts.map(({ organizationId }) => organizationId))
                    const checkMetersOrganizationIds = Object.values(organizationIndex).filter(({ organization: { id }, hasMeters }) => !organizationsWithReceipts.has(id) && hasMeters).map(({ organization: { id } }) => id)
                    const withMatchingMeters = checkMetersOrganizationIds.length ? await getOrganizationsWithMeters(checkMetersOrganizationIds, {
                        property: { addressKey, deletedAt: null },
                        accountNumber,
                    }) : new Set()
                    const organizationsWithMeters = Object.values(organizationIndex).filter(({ organization: { id } }) => withMatchingMeters.has(id))
                    return receipts.map(({ organizationId, ...account }) => ({
                        ...organizationIndex[organizationId],
                        account,
                    })).concat(organizationsWithMeters)
                } else if (unitName && unitType) {
                    const receipts = await findBillingReceiptsForOrganizations(organizations, billingInformation, {
                        property: { addressKey, deletedAt: null },
                        unitName, unitType,
                    })
                    const organizationsWithReceipts = new Set(receipts.map(({ organizationId }) => organizationId))
                    const organizationsWithoutReceipts = Object.values(organizationIndex).filter(({ organization: { id } }) => !organizationsWithReceipts.has(id))
                    return receipts.map(({ organizationId, ...account }) => ({
                        ...organizationIndex[organizationId],
                        account,
                    })).concat(organizationsWithoutReceipts)
                }
                return Object.values(organizationIndex)
            },
        },
    ],
    
})

module.exports = {
    FindOrganizationsForAddressService,
}
