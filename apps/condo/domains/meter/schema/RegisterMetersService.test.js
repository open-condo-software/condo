/**
 * Generated by `createservice meter.RegisterMetersService --type mutations`
 */
const { faker } = require('@faker-js/faker')
const dayjs = require('dayjs')
const { map } = require('lodash')

const {
    makeLoggedInAdminClient,
    makeClient,
    expectToThrowAuthenticationError,
    expectToThrowAccessDeniedErrorToResult,
} = require('@open-condo/keystone/test.utils')

const {
    COLD_WATER_METER_RESOURCE_ID,
    ELECTRICITY_METER_RESOURCE_ID,
    GAS_SUPPLY_METER_RESOURCE_ID,
    HEAT_SUPPLY_METER_RESOURCE_ID,
    HOT_WATER_METER_RESOURCE_ID,
    IMPORT_CONDO_METER_READING_SOURCE_ID,
} = require('@condo/domains/meter/constants/constants')
const { registerMetersByTestClient, Meter, MeterReading } = require('@condo/domains/meter/utils/testSchema')
const {
    createTestOrganization,
    makeEmployeeUserClientWithAbilities,
} = require('@condo/domains/organization/utils/testSchema')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const {
    makeClientWithSupportUser,
    makeClientWithResidentUser,
    makeClientWithServiceUser,
} = require('@condo/domains/user/utils/testSchema')

describe('RegisterMetersService', () => {

    let adminClient, supportClient, residentClient, anonymousClient

    beforeAll(async () => {
        adminClient = await makeLoggedInAdminClient()
        supportClient = await makeClientWithSupportUser()
        residentClient = await makeClientWithResidentUser()
        anonymousClient = await makeClient()
    })

    describe('access to execution', () => {

        let o10n

        beforeAll(async () => {
            [o10n] = await createTestOrganization(adminClient)
        })

        const getItemsForAccessTest = (property) => ([
            {
                address: property.address,
                unitType: 'flat',
                unitName: faker.random.alphaNumeric(4),
                accountNumber: faker.random.alphaNumeric(12),
                meters: [
                    {
                        numberOfTariffs: 1,
                        resourceTypeId: COLD_WATER_METER_RESOURCE_ID,
                        number: faker.random.numeric(8),
                        readings: [{
                            date: dayjs().toISOString(),
                            v1: faker.random.numeric(3),
                            v2: faker.random.numeric(4),
                        }],
                    },
                ],
            },
        ])

        test('admin can', async () => {
            const [o10n] = await createTestOrganization(adminClient)
            const [property] = await createTestProperty(adminClient, o10n)
            const items = getItemsForAccessTest(property)
            const [data] = await registerMetersByTestClient(adminClient, o10n, items)

            const meters = await Meter.getAll(adminClient, {
                organization: { id: o10n.id },
                property: { id: property.id },
            })
            expect(meters).toHaveLength(1)
            expect(meters[0].number).toBe(items[0].meters[0].number)

            const metersReadings = await MeterReading.getAll(adminClient, { meter: { id_in: map(meters, 'id') } })
            expect(metersReadings).toHaveLength(1)
            expect(metersReadings[0].date).toBe(items[0].meters[0].readings[0].date)

            expect(data).toEqual({
                items: [{
                    address: items[0].address,
                    accountNumber: items[0].accountNumber,
                    result: {
                        error: null,
                        data: {
                            propertyId: property.id,
                            meters: [{
                                number: items[0].meters[0].number,
                                result: {
                                    error: null,
                                    data: {
                                        id: meters[0].id,
                                        readings: [{
                                            v1: items[0].meters[0].readings[0].v1,
                                            v2: items[0].meters[0].readings[0].v2,
                                            v3: null,
                                            v4: null,
                                            result: {
                                                error: null,
                                                data: {
                                                    id: metersReadings[0].id,
                                                },
                                            },
                                        }],
                                    },
                                },
                            }],
                        },
                    },
                }],
            })
        })

        test('support can', async () => {
            const [o10n] = await createTestOrganization(adminClient)
            const [property] = await createTestProperty(adminClient, o10n)
            const items = getItemsForAccessTest(property)
            const [data] = await registerMetersByTestClient(supportClient, o10n, items)

            const meters = await Meter.getAll(adminClient, {
                organization: { id: o10n.id },
                property: { id: property.id },
            })
            expect(meters).toHaveLength(1)
            expect(meters[0].number).toBe(items[0].meters[0].number)

            const metersReadings = await MeterReading.getAll(adminClient, { meter: { id_in: map(meters, 'id') } })
            expect(metersReadings).toHaveLength(1)
            expect(metersReadings[0].date).toBe(items[0].meters[0].readings[0].date)

            expect(data).toEqual({
                items: [{
                    address: items[0].address,
                    accountNumber: items[0].accountNumber,
                    result: {
                        error: null,
                        data: {
                            propertyId: property.id,
                            meters: [{
                                number: items[0].meters[0].number,
                                result: {
                                    error: null,
                                    data: {
                                        id: meters[0].id,
                                        readings: [{
                                            v1: items[0].meters[0].readings[0].v1,
                                            v2: items[0].meters[0].readings[0].v2,
                                            v3: null,
                                            v4: null,
                                            result: {
                                                error: null,
                                                data: {
                                                    id: metersReadings[0].id,
                                                },
                                            },
                                        }],
                                    },
                                },
                            }],
                        },
                    },
                }],
            })
        })

        describe('staff', () => {
            test('with permissions can', async () => {
                const staffClient = await makeEmployeeUserClientWithAbilities({
                    canManageMeters: true,
                    canManageMeterReadings: true,
                })

                const items = getItemsForAccessTest(staffClient.property)
                const [data] = await registerMetersByTestClient(staffClient, staffClient.organization, items)

                const meters = await Meter.getAll(adminClient, {
                    organization: { id: staffClient.organization.id },
                    property: { id: staffClient.property.id },
                })
                expect(meters).toHaveLength(1)
                expect(meters[0].number).toBe(items[0].meters[0].number)

                const metersReadings = await MeterReading.getAll(adminClient, { meter: { id_in: map(meters, 'id') } })
                expect(metersReadings).toHaveLength(1)
                expect(metersReadings[0].date).toBe(items[0].meters[0].readings[0].date)

                expect(data).toEqual({
                    items: [{
                        address: items[0].address,
                        accountNumber: items[0].accountNumber,
                        result: {
                            error: null,
                            data: {
                                propertyId: staffClient.property.id,
                                meters: [{
                                    number: items[0].meters[0].number,
                                    result: {
                                        error: null,
                                        data: {
                                            id: meters[0].id,
                                            readings: [{
                                                v1: items[0].meters[0].readings[0].v1,
                                                v2: items[0].meters[0].readings[0].v2,
                                                v3: null,
                                                v4: null,
                                                result: {
                                                    error: null,
                                                    data: {
                                                        id: metersReadings[0].id,
                                                    },
                                                },
                                            }],
                                        },
                                    },
                                }],
                            },
                        },
                    }],
                })
            })

            test('without permissions can\'t', async () => {
                const staffClient = await makeEmployeeUserClientWithAbilities({
                    canManageMeters: false,
                    canManageMeterReadings: false,
                })

                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await registerMetersByTestClient(staffClient, staffClient.organization, [])
                })
            })
        })

        describe.skip('service user', () => {
            test('with access rights can', async () => {
                const serviceClient = await makeClientWithServiceUser()
                const [o10n] = await createTestOrganization(adminClient)
                const [property] = await createTestProperty(adminClient, o10n)

                const items = getItemsForAccessTest(property)
                const [data] = await registerMetersByTestClient(serviceClient, o10n, items)

                const meters = await Meter.getAll(adminClient, {
                    organization: { id: o10n.id },
                    property: { id: property.id },
                })
                expect(meters).toHaveLength(1)
                expect(meters[0].number).toBe(items[0].meters[0].number)

                const metersReadings = await MeterReading.getAll(adminClient, { meter: { id_in: map(meters, 'id') } })
                expect(metersReadings).toHaveLength(1)
                expect(metersReadings[0].date).toBe(items[0].meters[0].readings[0].date)

                expect(data).toEqual({
                    items: [{
                        address: items[0].address,
                        accountNumber: items[0].accountNumber,
                        result: {
                            error: null,
                            data: {
                                propertyId: property.id,
                                meters: [{
                                    number: items[0].meters[0].number,
                                    result: {
                                        error: null,
                                        data: {
                                            id: meters[0].id,
                                            readings: [{
                                                v1: items[0].meters[0].readings[0].v1,
                                                v2: items[0].meters[0].readings[0].v2,
                                                v3: null,
                                                v4: null,
                                                result: {
                                                    error: null,
                                                    data: {
                                                        id: metersReadings[0].id,
                                                    },
                                                },
                                            }],
                                        },
                                    },
                                }],
                            },
                        },
                    }],
                })
            })

            test('without permissions can\'t', async () => {
                const staffClient = await makeEmployeeUserClientWithAbilities({
                    canManageMeters: false,
                    canManageMeterReadings: false,
                })

                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await registerMetersByTestClient(staffClient, staffClient.organization, [])
                })
            })
        })

        test('resident can\'t execute', async () => {
            await expectToThrowAccessDeniedErrorToResult(async () => {
                await registerMetersByTestClient(residentClient, o10n, [])
            })
        })

        test('anonymous can\'t execute', async () => {
            await expectToThrowAuthenticationError(async () => {
                await registerMetersByTestClient(anonymousClient, o10n, [])
            }, 'result')
        })
    })

    test('cannot create Meter if Meter with same accountNumber exist in user organization in other unit type', async () => {
        // тут должна быть ошибка внутри возвращаемого json
    })
})
