/**
 * Generated by `createschema miniapp.B2BAppAccessRight 'user:Relationship:User:PROTECT;'`
 */

const dayjs = require('dayjs')
const { makeLoggedInAdminClient, makeClient } = require('@open-condo/keystone/test.utils')
const {
    makeClientWithSupportUser,
    makeClientWithNewRegisteredAndLoggedInUser,
    registerNewServiceUserByTestClient,
} = require('@condo/domains/user/utils/testSchema')
const {
    createTestB2BApp,
    createTestB2BAppAccessRight,
    updateTestB2BAppAccessRight,
    B2BAppAccessRight,
} = require('@condo/domains/miniapp/utils/testSchema')
const {
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowAccessDeniedErrorToObjects,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowValidationFailureError,
} = require('@open-condo/keystone/test.utils')
const { NON_SERVICE_USER_ERROR } = require('@condo/domains/miniapp/constants')

describe('B2BAppAccessRight', () => {
    describe('CRUD', () => {
        let admin
        let support
        let user
        let anonymous
        beforeAll(async () => {
            admin = await makeLoggedInAdminClient()
            support = await makeClientWithSupportUser()
            user = await makeClientWithNewRegisteredAndLoggedInUser()
            anonymous = await makeClient()
        })
        describe('Create', () => {
            let app
            let serviceUser
            beforeEach(async () => {
                [serviceUser] = await registerNewServiceUserByTestClient(admin)
                const [newApp] = await createTestB2BApp(admin)
                app = newApp

            })
            test('Admin can', async () => {
                const [right] = await createTestB2BAppAccessRight(admin, serviceUser, app)
                expect(right).toBeDefined()
            })
            test('Support can', async () => {
                const [right] = await createTestB2BAppAccessRight(support, serviceUser, app)
                expect(right).toBeDefined()
            })
            test('User cannot', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestB2BAppAccessRight(user, serviceUser, app)
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestB2BAppAccessRight(anonymous, serviceUser, app)
                })
            })
        })
        describe('Read', () => {
            let right
            beforeAll(async () => {
                const [app] = await createTestB2BApp(admin)
                const [serviceUser] = await registerNewServiceUserByTestClient(admin)
                const [accessRight] = await createTestB2BAppAccessRight(admin, serviceUser, app)
                right = accessRight
            })
            test('Admin can', async () => {
                const rights = await B2BAppAccessRight.getAll(admin, {
                    id: right.id,
                })
                expect(rights).toBeDefined()
                expect(rights).toHaveLength(1)
                expect(rights[0]).toHaveProperty('id', right.id)
            })
            test('Support can', async () => {
                const rights = await B2BAppAccessRight.getAll(support, {
                    id: right.id,
                })
                expect(rights).toBeDefined()
                expect(rights).toHaveLength(1)
                expect(rights[0]).toHaveProperty('id', right.id)
            })
            test('User cannot', async () => {
                await expectToThrowAccessDeniedErrorToObjects(async () => {
                    await B2BAppAccessRight.getAll(user, {
                        id: right.id,
                    })
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await B2BAppAccessRight.getAll(anonymous, {
                        id: right.id,
                    })
                })
            })
        })
        describe('Update', () => {
            let right
            let userToChange
            beforeAll(async () => {
                const [app] = await createTestB2BApp(admin)
                const [serviceUser] = await registerNewServiceUserByTestClient(admin)
                const [accessRight] = await createTestB2BAppAccessRight(admin, serviceUser, app)
                right = accessRight
            })
            beforeEach(async () => {
                [userToChange] = await registerNewServiceUserByTestClient(admin)
            })
            test('Admin can', async () => {
                const [newRight] = await updateTestB2BAppAccessRight(admin, right.id, {
                    user: { connect: { id: userToChange.id } },
                })
                expect(newRight).toBeDefined()
                expect(newRight).toHaveProperty(['user', 'id'], userToChange.id)
            })
            test('Support can', async () => {
                const [newRight] = await updateTestB2BAppAccessRight(support, right.id, {
                    user: { connect: { id: userToChange.id } },
                })
                expect(newRight).toBeDefined()
                expect(newRight).toHaveProperty(['user', 'id'], userToChange.id)
            })
            test('User cannot', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestB2BAppAccessRight(user, right.id, {
                        deletedAt: dayjs().toISOString(),
                    })
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestB2BAppAccessRight(user, right.id, {
                        deletedAt: dayjs().toISOString(),
                    })
                })
            })
        })
        describe('Delete', () => {
            let right
            beforeAll(async () => {
                const [app] = await createTestB2BApp(admin)
                const [serviceUser] = await registerNewServiceUserByTestClient(admin)
                const [accessRight] = await createTestB2BAppAccessRight(admin, serviceUser, app)
                right = accessRight
            })
            test('Nobody can', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRight.delete(admin, right.id)
                })
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRight.delete(support, right.id)
                })
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRight.delete(user, right.id)
                })
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRight.delete(anonymous, right.id)
                })
            })
        })
    })
    describe('Validations', () => {
        test('Cannot be linked to non-service user', async () => {
            const admin = await makeLoggedInAdminClient()
            const [app] = await createTestB2BApp(admin)
            const client = await makeClientWithNewRegisteredAndLoggedInUser()
            const [serviceUser] = await registerNewServiceUserByTestClient(admin)
            await expectToThrowValidationFailureError(async () => {
                await createTestB2BAppAccessRight(admin, client.user, app)
            }, NON_SERVICE_USER_ERROR)
            const [right] = await createTestB2BAppAccessRight(admin, serviceUser, app)
            await expectToThrowValidationFailureError(async () => {
                await updateTestB2BAppAccessRight(admin, right.id, {
                    user: { connect: { id: client.user.id } },
                })
            }, NON_SERVICE_USER_ERROR)
        })
    })
})
