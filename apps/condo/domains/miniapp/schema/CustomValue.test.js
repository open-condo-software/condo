/**
 * Generated by `createschema miniapp.CustomValue 'objectId:Text; data:Json; customField:Relationship:CustomField:PROTECT; sourceType:Text; sourceId:Text; organization:Relationship:Organization:PROTECT;'`
 */

const { makeLoggedInAdminClient, makeClient, UUID_RE, expectValuesOfCommonFields, expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj, expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const { CustomValue, createTestCustomField, createTestB2BApp,
    createTestB2BAppContext, createTestB2BAppAccessRightSet,
    createTestB2BAppAccessRight, createTestCustomValue, updateTestCustomValue } = require('@condo/domains/miniapp/utils/testSchema')
const {
    createTestOrganization,
} = require('@condo/domains/organization/utils/testSchema')
const {
    makeEmployeeUserClientWithAbilities,
} = require('@condo/domains/organization/utils/testSchema')
const { FLAT_UNIT_TYPE, APARTMENT_UNIT_TYPE } = require('@condo/domains/property/constants/common')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')
const { makeClientWithServiceUser } = require('@condo/domains/user/utils/testSchema')

const { B2B_APP_SOURCE_TYPE, ERRORS } = require('./CustomValue')


describe('CustomValue', () => {
    let admin
    let support
    let manager
    let anonymous
    let customField
    let organization
    let b2bApp
    let property

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        manager = await makeEmployeeUserClientWithAbilities({
            canManageB2BApps: true,
            canManageRoles: true,
        })
        anonymous = await makeClient()

        const [b2bAppObj] = await createTestB2BApp(admin)
        b2bApp = b2bAppObj

        const [orgObj] = await createTestOrganization(admin)
        organization = orgObj

        const [propertyObj] = await createTestProperty(admin, organization)
        property = propertyObj

        const [customFieldObj] = await createTestCustomField(admin, { schemaName: 'Property' })
        customField = customFieldObj
    })

    describe('CRUD tests', () => {
        describe('create', () => {
            test('admin can', async () => {
                const payload = {
                    objectId: property.id,
                    sourceType: B2B_APP_SOURCE_TYPE,
                    sourceId: b2bApp.id,
                }

                const [obj, attrs] = await createTestCustomValue(admin, customField, organization, payload)

                expectValuesOfCommonFields(obj, attrs, admin)
                expect(obj.data).toEqual(attrs.data)
                expect(obj.objectId).toEqual(attrs.objectId)
                expect(obj.sourceType).toEqual(attrs.sourceType)
                expect(obj.sourceId).toEqual(attrs.sourceId)
                expect(obj.unitName).toEqual(attrs.unitName)
                expect(obj.unitType).toEqual(attrs.unitType)
                expect(obj.addressKey).toEqual(attrs.addressKey)
                expect(obj.uniqKey).toEqual(attrs.uniqKey)
            })

            test('support can', async () => {
                const payload = {
                    objectId: property.id,
                    sourceType: B2B_APP_SOURCE_TYPE,
                    sourceId: b2bApp.id,
                }

                const [obj, attrs] = await createTestCustomValue(support, customField, organization, payload)

                expectValuesOfCommonFields(obj, attrs, support)
                expect(obj.data).toEqual(attrs.data)
                expect(obj.objectId).toEqual(attrs.objectId)
                expect(obj.sourceType).toEqual(attrs.sourceType)
                expect(obj.sourceId).toEqual(attrs.sourceId)
                expect(obj.unitName).toEqual(attrs.unitName)
                expect(obj.unitType).toEqual(attrs.unitType)
                expect(obj.addressKey).toEqual(attrs.addressKey)
                expect(obj.uniqKey).toEqual(attrs.uniqKey)
            })

            test('anonymous can\'t', async () => {
                const client = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    const payload = {
                        objectId: property.id,
                        sourceType: B2B_APP_SOURCE_TYPE,
                        sourceId: b2bApp.id,
                    }

                    const [obj, attrs] = await createTestCustomValue(client, customField, organization, payload)
                })
            })
        })

        describe('hard delete', () => {
            const payload = {}
            let customValueToDelete

            beforeAll(async () => {
                const [property] = await createTestProperty(admin, organization)

                payload.objectId = property.id
                payload.sourceType = B2B_APP_SOURCE_TYPE
                payload.sourceId = b2bApp.id

                const [customValueToDeleteObj] = await createTestCustomValue(admin, customField, organization, payload)
                customValueToDelete = customValueToDeleteObj
            })

            test('admin can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await CustomValue.delete(admin, customValueToDelete.id)
                })
            })

            test('support can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await CustomValue.delete(support, customValueToDelete.id)
                })
            })

            test('user can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await CustomValue.delete(manager, customValueToDelete.id)
                })
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await CustomValue.delete(anonymous, customValueToDelete.id)
                })
            })
        })

        describe('read', () => {
            test('anonymous can\'t', async () => {
                const payload = {
                    objectId: property.id,
                    sourceType: B2B_APP_SOURCE_TYPE,
                    sourceId: b2bApp.id,
                }

                const [obj, attrs] = await createTestCustomValue(admin, customField, organization, payload)

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await CustomValue.getAll(client, {}, { sortBy: ['updatedAt_DESC'] })
                })
            })
        })
    })

    describe('Validation tests', () => {
        describe('data', () => {
            const CUSTOM_FIELDS = {}
            let commonPayload = {}

            beforeAll(async () => {
                const [stringCustomFieldObj] = await createTestCustomField(support, {
                    schemaName: 'Property',
                    type: 'String',
                })
                CUSTOM_FIELDS.string = stringCustomFieldObj

                const [stringWithValidationsCustomFieldObj] = await createTestCustomField(support, {
                    schemaName: 'Property',
                    type: 'String',
                    validationRules: { minLength: 2, maxLength: 5, pattern: '^[a-zA-Z]+$' },
                })
                CUSTOM_FIELDS.stringWithValidations = stringWithValidationsCustomFieldObj

                const [jsonCustomFieldObj] = await createTestCustomField(support, {
                    schemaName: 'Property',
                    type: 'Json',
                })
                CUSTOM_FIELDS.json = jsonCustomFieldObj

                const [jsonCustomFieldWithValidationsObj] = await createTestCustomField(support, {
                    schemaName: 'Property',
                    type: 'Json',
                    validationRules: {},
                })
                CUSTOM_FIELDS.jsonWithValidations = jsonCustomFieldWithValidationsObj

                commonPayload = {
                    objectId: property.id,
                    sourceType: B2B_APP_SOURCE_TYPE,
                    sourceId: b2bApp.id,
                }
            })

            describe('failing cases:', () => {
                const PAYLOADS = {
                    // type valdations
                    'string: can\'t convert number to string': { customFieldType: 'string', data: 24 },

                    // validationRules validations
                    'string: too big': { customFieldType: 'stringWithValidations', data: 'abcdefg' },
                    'string: does not follow regexp': { customFieldType: 'stringWithValidations', data: '12345' },
                    'string: too small': { customFieldType: 'stringWithValidations', data: 'a' },

                    'json: non existing property': { customFieldType: 'jsonWithValidations', data: {} },
                    'json: bad inner property type': { customFieldType: 'jsonWithValidations', data: {} },
                    'json: not all required fields are specified': { customFieldType: 'jsonWithValidations', data: {} },
                }

                test.each(Object.keys(PAYLOADS))('bad value: %p', async (key) => {
                    const customFieldType = PAYLOADS[key].customFieldType
                    const customField = CUSTOM_FIELDS[customFieldType]

                    const extraAttrs = { ...commonPayload, data: PAYLOADS[key].data }

                    await expectToThrowGQLError(async () => {
                        await createTestCustomValue(support, customField, organization, extraAttrs)
                    }, { code: ERRORS.BAD_DATA.code, type: ERRORS.BAD_DATA.type })
                })
            })
        })
    })

    describe('real life cases', () => {
        test('Custom field for b2b integrations', async () => {

            // 1. Support creates custom field with specific validations for b2b integrations to use
            const [customField] = await createTestCustomField(support, {
                schemaName: 'Property',
                name: 'Special building id',
                type: 'String',
                validationRules: {
                    minLength: 2,
                    maxLength: 5,
                },
                isUniquePerObject: false,
            })

            // 2. Organization is created, B2B integration is set up
            const orgEmployeeClient = await makeEmployeeUserClientWithAbilities({
                canManageB2BApps: true,
                canManageRoles: true,
            })

            const organization = orgEmployeeClient.organization
            const [property1] = await createTestProperty(support, organization)
            const [property2] = await createTestProperty(support, organization)

            const b2bApp1serviceUserClient = await makeClientWithServiceUser()
            const b2bApp1serviceUser = b2bApp1serviceUserClient.user

            const [b2bApp1] = await createTestB2BApp(support)

            const [b2bApp1accessRightSet] = await createTestB2BAppAccessRightSet(support, b2bApp1, { canReadOrganizations: true, canReadCustomValues: true, canManageCustomValues: true })
            const [b2BAppAccessRight] = await createTestB2BAppAccessRight(support, b2bApp1serviceUser, b2bApp1, b2bApp1accessRightSet)

            const b2bAppContext1 = await createTestB2BAppContext(support, b2bApp1, organization, {
                status: CONTEXT_FINISHED_STATUS,
            })

            // 3. B2B Integration service user creates custom values to custom fields created on step 1

            // One probably needs to check out the field and validations first
            //const [customFieldObjAsServiceUser] = await CustomField.getAll(b2bApp1serviceUserClient, { id: customField.id })

            await createTestCustomValue(b2bApp1serviceUserClient, customField, organization, {
                objectId: property1.id,
                sourceType: B2B_APP_SOURCE_TYPE,
                sourceId: b2bApp1.id,
                data: '123',
                addressKey: property1.addressKey,
                unitName: null,
                unitType: null,
            })

            await createTestCustomValue(b2bApp1serviceUserClient, customField, organization, {
                objectId: property2.id,
                sourceType: B2B_APP_SOURCE_TYPE,
                sourceId: b2bApp1.id,
                data: '12',
                addressKey: property2.addressKey,
                unitName: null,
                unitType: null,
                uniqKey: 'test-uniq-key-0',
            })

            await createTestCustomValue(b2bApp1serviceUserClient, customField, organization, {
                objectId: property1.id,
                sourceType: B2B_APP_SOURCE_TYPE,
                sourceId: b2bApp1.id,
                data: '123',
                addressKey: property1.addressKey,
                unitName: '1',
                unitType: FLAT_UNIT_TYPE,
                uniqKey: 'test-uniq-key-1',
            })

            await createTestCustomValue(b2bApp1serviceUserClient, customField, organization, {
                objectId: property1.id,
                sourceType: B2B_APP_SOURCE_TYPE,
                sourceId: b2bApp1.id,
                data: '1234',
                addressKey: property1.addressKey,
                unitName: '1',
                unitType: APARTMENT_UNIT_TYPE,
            })

            await createTestCustomValue(b2bApp1serviceUserClient, customField, organization, {
                objectId: property2.id,
                sourceType: B2B_APP_SOURCE_TYPE,
                sourceId: b2bApp1.id,
                data: 'abc',
                addressKey: property2.addressKey,
                unitName: '1',
                unitType: FLAT_UNIT_TYPE,
            })

            // 4. B2B Integration read and filter on custom values

            const b2bApp1ServiceUserCustomValues = await CustomValue.getAll(b2bApp1serviceUserClient, {})
            expect(b2bApp1ServiceUserCustomValues).toHaveLength(5)

            // Filter by uniq key
            const b2bApp1ServiceUserCustomValuesFilteredByUniqKey = await CustomValue.getAll(b2bApp1serviceUserClient, {
                uniqKey: 'test-uniq-key-0',
            })
            expect(b2bApp1ServiceUserCustomValuesFilteredByUniqKey).toHaveLength(1)
            expect(b2bApp1ServiceUserCustomValuesFilteredByUniqKey[0].data).toEqual('12')


            // 5. Staff users read and filter on custom values

            const staffUserCustomValues = await CustomValue.getAll(orgEmployeeClient, {})
            expect(staffUserCustomValues).toHaveLength(5)
        })
    })
})
