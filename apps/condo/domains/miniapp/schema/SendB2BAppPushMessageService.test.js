/**
 * Generated by `createservice miniapp.SendB2BAppPushMessageService '--type=mutations'`
 */

const { faker } = require('@faker-js/faker')

const conf = require('@open-condo/config')
const { makeLoggedInAdminClient, makeClient, UUID_RE, expectToThrowAccessDeniedErrorToResult, expectToThrowAuthenticationErrorToResult, waitFor, expectToThrowGQLErrorToResult } = require('@open-condo/keystone/test.utils')

const { LOCALES } = require('@condo/domains/common/constants/locale')
const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const { sendB2BAppPushMessageByTestClient, createTestAppMessageSetting, createTestB2BApp, createTestB2BAppContext, createTestB2BAppAccessRightSet, createTestB2BAppAccessRight } = require('@condo/domains/miniapp/utils/testSchema')
const { MESSAGE_SENT_STATUS, B2B_APP_MESSAGE_PUSH_TYPE, DEVICE_PLATFORM_ANDROID, APP_MASTER_ID_ANDROID, PASS_TICKET_CREATED_MESSAGE_TYPE } = require('@condo/domains/notification/constants/constants')
const { Message, syncRemoteClientWithPushTokenByTestClient } = require('@condo/domains/notification/utils/testSchema')
const { createTestOrganizationEmployeeRole, registerNewOrganization, inviteNewOrganizationEmployee, acceptOrRejectOrganizationInviteById } = require('@condo/domains/organization/utils/testSchema')
const { User, updateTestUser, makeClientWithServiceUser, makeClientWithSupportUser, makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')

const { ERRORS } = require('./SendB2BAppPushMessageService')

describe('SendB2BAppPushMessageService', () => {
    let serviceUser,
        admin,
        support,
        staffClient,
        anonymous,
        organization,
        b2bApp

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()
    })

    beforeEach(async () => {
        staffClient = await makeClientWithNewRegisteredAndLoggedInUser({
            locale: faker.helpers.arrayElement(Object.keys(LOCALES)),
        })
        serviceUser = await makeClientWithServiceUser()

        const [testOrganization] = await registerNewOrganization(staffClient)
        const [app] = await createTestB2BApp(support)
        await createTestB2BAppContext(staffClient, app, testOrganization, { status: CONTEXT_FINISHED_STATUS })

        const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
            canExecuteSendB2BAppPushMessage: true,
        })
        await createTestB2BAppAccessRight(support, serviceUser.user, app, accessRightSet)

        await syncRemoteClientWithPushTokenByTestClient(staffClient, { devicePlatform: DEVICE_PLATFORM_ANDROID, appId: APP_MASTER_ID_ANDROID })

        organization = testOrganization
        b2bApp = app
    })

    describe('Access', () => {
        describe('Service user', () => {
            test('can execute', async () => {
                const [result] = await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user)

                expect(result.id).toMatch(UUID_RE)
            })

            test('can not execute if organization has not B2BAppContext with b2bApp', async () => {
                const otherServiceUser = await makeClientWithServiceUser()

                const [organization] = await registerNewOrganization(staffClient)
                const [b2bApp] = await createTestB2BApp(support)

                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await sendB2BAppPushMessageByTestClient(otherServiceUser, b2bApp, organization, staffClient.user)
                })
            })

            test('can not execute if service user has not B2BAppAccessRightSet with canExecuteSendB2BAppPushMessage', async () => {
                const otherServiceUser = await makeClientWithServiceUser()

                const [organization] = await registerNewOrganization(staffClient)
                const [b2bApp] = await createTestB2BApp(support)
                await createTestB2BAppContext(staffClient, b2bApp, organization, { status: CONTEXT_FINISHED_STATUS })

                const [accessRightSet] = await createTestB2BAppAccessRightSet(support, b2bApp, {
                    canExecuteSendB2BAppPushMessage: false,
                })
                await createTestB2BAppAccessRight(support, serviceUser.user, b2bApp, accessRightSet)

                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await sendB2BAppPushMessageByTestClient(otherServiceUser, b2bApp, organization, staffClient.user)
                })
            })
        })

        describe('Admin', () => {
            test('can not execute', async () => {
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await sendB2BAppPushMessageByTestClient(admin, b2bApp, organization, staffClient.user)
                })
            })
        })

        describe('Support', () => {
            test('can not execute', async () => {
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await sendB2BAppPushMessageByTestClient(support, b2bApp, organization, staffClient.user)
                })
            })
        })

        describe('User', () => {
            test('can not execute', async () => {
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await sendB2BAppPushMessageByTestClient(staffClient, b2bApp, organization, staffClient.user)
                })
            })
        })

        describe('Anonymous', () => {
            test('can not execute', async () => {
                await expectToThrowAuthenticationErrorToResult(async () => {
                    await sendB2BAppPushMessageByTestClient(anonymous, b2bApp, organization, staffClient.user)
                })
            })
        })
    })

    describe('Logic', () => {
        test('Successfully sends a message from a service user with B2B app access rights', async () => {
            const body = faker.random.alphaNumeric(8)
            const [result] = await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                type: B2B_APP_MESSAGE_PUSH_TYPE,
                meta: {
                    dv: 1,
                    body,
                },
            })
            const user = await User.getOne(support, { id: staffClient.user.id })

            await waitFor(async () => {
                const message = await Message.getOne(staffClient, { id: result.id })

                expect(message.status).toBe(MESSAGE_SENT_STATUS)
                expect(message.organization.id).toBe(organization.id)
                expect(message.user.id).toBe(user.id)
                expect(message.type).toBe(B2B_APP_MESSAGE_PUSH_TYPE)
                expect(message.meta.body).toBe(body)
                expect(message.lang).toBe(user.locale)
            })
        })

        test('Throws an error if no finished B2BContext exists for the specified organization and B2BApp', async () => {
            const [testOrganization] = await registerNewOrganization(staffClient)

            const [otherApp] = await createTestB2BApp(support)
            await createTestB2BAppContext(staffClient, otherApp, testOrganization, { status: CONTEXT_FINISHED_STATUS })

            const [accessRightSet] = await createTestB2BAppAccessRightSet(support, otherApp, {
                canExecuteSendB2BAppPushMessage: true,
            })
            await createTestB2BAppAccessRight(support, serviceUser.user, otherApp, accessRightSet)

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, testOrganization, staffClient.user)
            }, ERRORS.NO_B2B_CONTEXT)
        })

        test('Throws an error if no B2BAppAccessRight exists with canExecuteSendB2BAppPushMessage', async () => {
            const [app] = await createTestB2BApp(support)
            await createTestB2BAppContext(staffClient, app, organization, { status: CONTEXT_FINISHED_STATUS })
            const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app)
            await createTestB2BAppAccessRight(support, serviceUser.user, app, accessRightSet)

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, app, organization, staffClient.user)
            }, ERRORS.NO_B2B_APP_ACCESS_RIGHT)
        })

        test('Throws an error if no organization employee exists for the specified user and organization', async () => {
            const user = await makeClientWithNewRegisteredAndLoggedInUser()

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, user.user)
            }, ERRORS.USER_IS_NOT_AN_EMPLOYEE)
        })

        test('Throws an error if notifications are sent more often than specified in AppMessageSetting', async () => {
            const notificationWindowSize = 3600
            const numberOfNotificationInWindow = 2
            await createTestAppMessageSetting(support, {
                b2bApp,
                notificationWindowSize,
                numberOfNotificationInWindow,
            })

            const [message1] = await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                type: B2B_APP_MESSAGE_PUSH_TYPE,
            })
            expect(message1.id).toMatch(UUID_RE)

            const [message2] = await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                type: B2B_APP_MESSAGE_PUSH_TYPE,
            })
            expect(message2.id).toMatch(UUID_RE)

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                    type: B2B_APP_MESSAGE_PUSH_TYPE,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'TOO_MANY_REQUESTS',
                message: 'You have to wait {minutesRemaining} minutes to be able to send request again',
            })
        })

        test('Throws an error if AppMessageSetting has numberOfNotificationInWindow: 0', async () => {
            const numberOfNotificationInWindow = 0
            await createTestAppMessageSetting(support, {
                b2bApp,
                numberOfNotificationInWindow,
                type: PASS_TICKET_CREATED_MESSAGE_TYPE,
            })

            const [message] = await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                type: B2B_APP_MESSAGE_PUSH_TYPE,
            })
            expect(message.id).toMatch(UUID_RE)

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                    type: PASS_TICKET_CREATED_MESSAGE_TYPE,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'TOO_MANY_REQUESTS',
                message: 'You have to wait {minutesRemaining} minutes to be able to send request again',
            })
        })

        test('Throws an error if employee role has not B2BAppRole', async () => {
            const staffWithoutB2BAppRole = await makeClientWithNewRegisteredAndLoggedInUser()
            const [role] = await createTestOrganizationEmployeeRole(staffClient, organization)
            const [invitedEmployee] = await inviteNewOrganizationEmployee(staffClient, organization, staffWithoutB2BAppRole.userAttrs, role)
            await acceptOrRejectOrganizationInviteById(staffWithoutB2BAppRole, invitedEmployee)

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffWithoutB2BAppRole.user, {
                    type: PASS_TICKET_CREATED_MESSAGE_TYPE,
                })
            }, ERRORS.NO_B2B_APP_ROLE_FOR_EMPLOYEE_ROLE_AND_B2B_APP)
        })

        test('Throws an error if user is deleted', async () => {
            await updateTestUser(support, staffClient.user.id, {
                deletedAt: new Date().toISOString(),
            })

            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                    type: PASS_TICKET_CREATED_MESSAGE_TYPE,
                })
            }, ERRORS.USER_IS_NOT_AN_EMPLOYEE)
        })

        test('Create message if meta.url is valid', async () => {
            const url = `${conf.SERVER_URL}/${faker.random.word()}/${faker.random.word()}`

            const [result] = await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                type: PASS_TICKET_CREATED_MESSAGE_TYPE,
                meta: {
                    dv: 1,
                    data: {
                        url,
                        openAt: faker.random.word(),
                    },
                },
            })

            const message = await Message.getOne(staffClient, { id: result.id })

            expect(message.meta.data.url).toEqual(url)
        })

        const invalidUrlCases = [
            ['javascript:alert(1)'],
            [faker.internet.url()],
            [`${conf.SERVER_URL}.mysite.com`],
            [`${conf.SERVER_URL}.mysite.com/${faker.random.word()}`],
        ]
        test.each(invalidUrlCases)('Throws an error if meta.url is invalid: %p', async (url) => {
            await expectToThrowGQLErrorToResult(async () => {
                await sendB2BAppPushMessageByTestClient(serviceUser, b2bApp, organization, staffClient.user, {
                    type: PASS_TICKET_CREATED_MESSAGE_TYPE,
                    meta: {
                        dv: 1,
                        data: {
                            url,
                            openAt: faker.random.word(),
                        },
                    },
                })
            }, {
                mutation: 'sendB2BAppPushMessage',
                variable: ['data', 'meta', 'data', 'url'],
                code: 'BAD_USER_INPUT',
                type: 'WRONG_VALUE',
                message: 'Invalid URL: must start with server url and be safe',
            })
        })
    })
})