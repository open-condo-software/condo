/**
 * Generated by `createservice miniapp.AllOrganizationAppsService --type queries`
 */

const { GQLCustomSchema } = require('@core/keystone/schema')
const access = require('@condo/domains/miniapp/access/AllMiniAppsService')
const { ACQUIRING_APP_TYPE, BILLING_APP_TYPE, APP_TYPES } = require('@condo/domains/miniapp/constants')
const { find } = require('@core/keystone/schema')
const { APPS_FILE_ADAPTER } = require('@condo/domains/miniapp/schema/fields/integration')

const AllMiniAppsService = new GQLCustomSchema('AllMiniAppsService', {
    types: [
        {
            access: true,
            type: `enum AppType { ${APP_TYPES.join(' ')} }`,
        },
        {
            access: true,
            type: 'input AllMiniAppsInput { dv: Int!, sender: SenderFieldInput!, organization: OrganizationWhereUniqueInput! }',
        },
        {
            access: true,
            type: 'type MiniAppOutput { id: ID!, type: AppType!, connected: Boolean!, name: String!, shortDescription: String!, category: String, logo: String }',
        },
    ],
    
    queries: [
        {
            access: access.canExecuteAllMiniApps,
            schema: 'allMiniApps (data: AllMiniAppsInput!): [MiniAppOutput!]',
            resolver: async (parent, args) => {
                const { data: { organization } } = args
                const services = []

                const billingIntegrations = await find('BillingIntegration', {
                    isHidden: false,
                    deletedAt: null,
                })
                const billingContexts = await find('BillingIntegrationOrganizationContext', {
                    organization,
                    deletedAt: null,
                })
                const connectedBillingIntegrations = billingContexts.map(context => context.integration)
                for (const billing of billingIntegrations) {
                    let logoUrl = null
                    if (billing.logo) {
                        if (APPS_FILE_ADAPTER.acl && APPS_FILE_ADAPTER.acl.generateUrl) {
                            logoUrl = APPS_FILE_ADAPTER.acl.generateUrl(`${APPS_FILE_ADAPTER.folder}/${billing.logo.filename}`)
                        } else {
                            logoUrl = APPS_FILE_ADAPTER.publicUrl({ filename: billing.logo.filename })
                        }
                    }
                    services.push({
                        id: billing.id,
                        type: BILLING_APP_TYPE,
                        name: billing.name,
                        shortDescription: billing.shortDescription,
                        connected: connectedBillingIntegrations.includes(billing.id),
                        category: BILLING_APP_TYPE,
                        logo: logoUrl,
                    })
                }

                const acquiringIntegrations = await find('AcquiringIntegration', {
                    isHidden: false,
                    deletedAt: null,
                })
                const acquiringContexts = await find('AcquiringIntegrationContext', {
                    organization,
                    deletedAt: null,
                })
                const connectedAcquiringIntegrations = acquiringContexts.map(context => context.integration)
                for (const acquiring of acquiringIntegrations) {
                    let logoUrl = null
                    if (acquiring.logo) {
                        if (APPS_FILE_ADAPTER.acl && APPS_FILE_ADAPTER.acl.generateUrl) {
                            logoUrl = APPS_FILE_ADAPTER.acl.generateUrl(`${APPS_FILE_ADAPTER.folder}/${acquiring.logo.filename}`)
                        } else {
                            logoUrl = APPS_FILE_ADAPTER.publicUrl({ filename: acquiring.logo.filename })
                        }
                    }
                    services.push({
                        id: acquiring.id,
                        type: ACQUIRING_APP_TYPE,
                        name: acquiring.name,
                        shortDescription: acquiring.shortDescription,
                        connected: connectedAcquiringIntegrations.includes(acquiring.id),
                        category: ACQUIRING_APP_TYPE,
                        logo: logoUrl,
                    })
                }

                return services
            },
        },
    ],
    
})

module.exports = {
    AllMiniAppsService,
}
