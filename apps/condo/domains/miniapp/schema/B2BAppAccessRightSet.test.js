/**
 * Generated by `createschema miniapp.B2BAppAccessRightSet 'app:Relationship:B2BApp:CASCADE;'`
 */

const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient, makeClient, UUID_RE, catchErrorFrom,
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj, expectToThrowAccessDeniedErrorToObjects,
    expectToThrowUniqueConstraintViolationError, expectToThrowAccessDeniedErrorToCount,
} = require('@open-condo/keystone/test.utils')

const { createTestContact, Contact, updateTestContact } = require('@condo/domains/contact/utils/testSchema')
const {
    createTestB2BApp,
    createTestB2BAppContext,
    createTestB2BAppAccessRight,
    B2BAppAccessRight,
    updateTestB2BAppAccessRight,
    B2BAppAccessRightSet,
    createTestB2BAppAccessRightSet,
    updateTestB2BAppAccessRightSet,
} = require('@condo/domains/miniapp/utils/testSchema')
const { Organization, createTestOrganization, updateTestOrganization } = require('@condo/domains/organization/utils/testSchema')
const { registerNewOrganization } = require('@condo/domains/organization/utils/testSchema/Organization')
const { createTestProperty, Property, updateTestProperty } = require('@condo/domains/property/utils/testSchema')
const { buildFakeAddressAndMeta } = require('@condo/domains/property/utils/testSchema/factories')
const {
    createTestTicket,
    createTestTicketComment,
    TicketComment,
    updateTestTicket,
    Ticket,
    updateTestTicketComment,
} = require('@condo/domains/ticket/utils/testSchema')
const {
    makeClientWithNewRegisteredAndLoggedInUser,
    makeClientWithSupportUser,
    registerNewServiceUserByTestClient,
    makeLoggedInClient,
} = require('@condo/domains/user/utils/testSchema')


describe('B2BAppAccessRightSet', () => {
    let admin
    let support
    let integratedServiceUser, integratedToAnotherAppServiceUser
    let notServiceUser
    let anonymous

    let app
    let anotherApp

    let accessRightSet

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        notServiceUser = await makeClientWithNewRegisteredAndLoggedInUser()
        anonymous = await makeClient()

        const [createdApp] = await createTestB2BApp(support)
        app = createdApp

        const [createdApp2] = await createTestB2BApp(support)
        anotherApp = createdApp2

        const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(support, app)
        accessRightSet = createdAccessRightSet

        const [newServiceUser] = await registerNewServiceUserByTestClient(support)
        integratedServiceUser = await makeLoggedInClient({ email: newServiceUser.email, password: newServiceUser.password })
        await createTestB2BAppAccessRight(support, integratedServiceUser.user, app)

        const [newServiceUser2] = await registerNewServiceUserByTestClient(support)
        integratedToAnotherAppServiceUser = await makeLoggedInClient({ email: newServiceUser2.email, password: newServiceUser2.password })
        await createTestB2BAppAccessRight(support, integratedToAnotherAppServiceUser.user, anotherApp)
    })

    describe('Accesses', () => {
        afterEach(async () => {
            // reset to default values
            await updateTestB2BAppAccessRightSet(admin, accessRightSet.id, {
                canReadOrganizations: false,
            })
        })

        describe('Admin', () => {
            test('Can create', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                expect(createdAccessRightSet).toBeDefined()
                expect(createdAccessRightSet.id).toMatch(UUID_RE)
                expect(createdAccessRightSet).toHaveProperty('app.id', app.id)
                expect(createdAccessRightSet).toHaveProperty('canManageOrganizations', false)
                expect(createdAccessRightSet).toHaveProperty('canReadOrganizations', false)
                expect(createdAccessRightSet).toHaveProperty('canManageContacts', false)
                expect(createdAccessRightSet).toHaveProperty('canReadContacts', false)
                expect(createdAccessRightSet).toHaveProperty('canManageProperties', false)
                expect(createdAccessRightSet).toHaveProperty('canReadProperties', false)
            })

            test('Can read everything', async () => {
                const foundedAccessRightSet = await B2BAppAccessRightSet.getOne(admin, {
                    id: accessRightSet.id,
                })
                expect(foundedAccessRightSet).toHaveProperty('id', accessRightSet.id)
            })

            test('Can update', async () => {
                const [updatedAccessRightSet] = await updateTestB2BAppAccessRightSet(admin, accessRightSet.id, {
                    canReadOrganizations: true,
                })
                expect(updatedAccessRightSet).toHaveProperty('id', accessRightSet.id)
                expect(updatedAccessRightSet).toHaveProperty('canReadOrganizations', true)
            })

            test('Can soft-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                const [deletedAccessRightSet] = await B2BAppAccessRightSet.softDelete(admin, createdAccessRightSet.id)
                expect(!!deletedAccessRightSet.deletedAt).toBeTruthy()
            })

            test('Can not hard-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.delete(admin, createdAccessRightSet.id)
                })
            })
        })

        describe('Support', () => {
            test('Can create', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(support, app)

                expect(createdAccessRightSet).toBeDefined()
                expect(createdAccessRightSet.id).toMatch(UUID_RE)
                expect(createdAccessRightSet).toHaveProperty('app.id', app.id)
            })

            test('Can read everything', async () => {
                const foundedAccessRightSet = await B2BAppAccessRightSet.getOne(support, {
                    id: accessRightSet.id,
                })
                expect(foundedAccessRightSet).toHaveProperty('id', accessRightSet.id)
            })

            test('Can update', async () => {
                const [updatedAccessRightSet] = await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                    canReadOrganizations: true,
                })
                expect(updatedAccessRightSet).toHaveProperty('id', accessRightSet.id)
                expect(updatedAccessRightSet).toHaveProperty('canReadOrganizations', true)
            })

            test('Can soft-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                const [deletedAccessRightSet] = await B2BAppAccessRightSet.softDelete(support, createdAccessRightSet.id)
                expect(!!deletedAccessRightSet.deletedAt).toBeTruthy()
            })

            test('Can not hard-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.delete(support, createdAccessRightSet.id)
                })
            })
        })

        describe('Service user', () => {
            test('Can not create', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestB2BAppAccessRightSet(integratedServiceUser, app)
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestB2BAppAccessRightSet(integratedToAnotherAppServiceUser, app)
                })
            })

            test('Can only read if have B2BAppAccessRight connected to B2BApp "A" and B2BAppAccessRightSet connected to B2BApp "A"', async () => {
                const foundedAccessRightSet = await B2BAppAccessRightSet.getOne(integratedServiceUser, {
                    id: accessRightSet.id,
                })
                expect(foundedAccessRightSet).toHaveProperty('id', accessRightSet.id)

                const [foundedAccessRightSetForAnotherApp] = await B2BAppAccessRightSet.getAll(integratedToAnotherAppServiceUser, {
                    id: accessRightSet.id,
                })
                expect(foundedAccessRightSetForAnotherApp).toBeUndefined()
            })

            test('Can not update', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestB2BAppAccessRightSet(integratedServiceUser, accessRightSet.id, {
                        canReadOrganizations: true,
                    })
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestB2BAppAccessRightSet(integratedToAnotherAppServiceUser, accessRightSet.id, {
                        canReadOrganizations: true,
                    })
                })
            })

            test('Can not soft-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.softDelete(integratedToAnotherAppServiceUser, createdAccessRightSet.id)
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.softDelete(integratedServiceUser, createdAccessRightSet.id)
                })
            })

            test('Can not hard-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.delete(integratedServiceUser, createdAccessRightSet.id)
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.delete(integratedToAnotherAppServiceUser, createdAccessRightSet.id)
                })
            })
        })

        describe('Not service user', () => {
            test('Can not create', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestB2BAppAccessRightSet(notServiceUser, app)
                })
            })

            test('Can not read', async () => {
                await expectToThrowAccessDeniedErrorToObjects(async () => {
                    await B2BAppAccessRightSet.getAll(notServiceUser, {
                        id: accessRightSet.id,
                    })
                })
            })

            test('Can not update', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestB2BAppAccessRightSet(notServiceUser, accessRightSet.id, {
                        canReadOrganizations: true,
                    })
                })
            })

            test('Can not soft-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.softDelete(notServiceUser, createdAccessRightSet.id)
                })
            })

            test('Can not hard-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.delete(notServiceUser, createdAccessRightSet.id)
                })
            })
        })

        describe('Anonymous', () => {
            test('Can not create', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestB2BAppAccessRightSet(anonymous, app)
                })
            })

            test('Can not read', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await B2BAppAccessRightSet.getAll(anonymous, {
                        id: accessRightSet.id,
                    })
                })
            })

            test('Can not update', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestB2BAppAccessRightSet(anonymous, accessRightSet.id, {
                        canReadOrganizations: true,
                    })
                })
            })

            test('Can not soft-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await B2BAppAccessRightSet.softDelete(anonymous, createdAccessRightSet.id)
                })
            })

            test('Can not hard-delete', async () => {
                const [app] = await createTestB2BApp(admin)
                const [createdAccessRightSet] = await createTestB2BAppAccessRightSet(admin, app)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppAccessRightSet.delete(anonymous, createdAccessRightSet.id)
                })
            })
        })
    })

    describe('Constraints', () => {
        test('Cannot be created 2 active set of access rights for a single app', async () => {
            const [app] = await createTestB2BApp(admin)
            await createTestB2BAppAccessRightSet(admin, app)

            await expectToThrowUniqueConstraintViolationError(async () => {
                await createTestB2BAppAccessRightSet(admin, app)
            }, 'b2b_app_access_right_set_unique_app')
        })
    })
})

describe('B2BApp permissions for service user', () => {
    let support
    let user
    let serviceUser

    beforeEach(async () => {
        support = await makeClientWithSupportUser()
        user = await makeClientWithNewRegisteredAndLoggedInUser()
        const [newServiceUser] = await registerNewServiceUserByTestClient(support)
        serviceUser = await makeLoggedInClient({ email: newServiceUser.email, password: newServiceUser.password })
    })

    test('Get all permissions for app', async () => {
        const [app] = await createTestB2BApp(support)
        const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app)
        await createTestB2BAppAccessRight(support, serviceUser.user, app, accessRightSet)

        const foundRight = await B2BAppAccessRight.getOne(support, { app: { id: app.id } })
        expect(foundRight).toHaveProperty('accessRightSet.canReadContacts', false)
        expect(foundRight).toHaveProperty('accessRightSet.canManageContacts', false)
        expect(foundRight).toHaveProperty('accessRightSet.canReadMeters', false)
        expect(foundRight).toHaveProperty('accessRightSet.canManageMeters', false)
        expect(foundRight).toHaveProperty('accessRightSet.canReadMeterReadings', false)
        expect(foundRight).toHaveProperty('accessRightSet.canManageMeterReadings', false)
        expect(foundRight).toHaveProperty('accessRightSet.canReadOrganizations', false)
        expect(foundRight).toHaveProperty('accessRightSet.canManageOrganizations', false)
        expect(foundRight).toHaveProperty('accessRightSet.canReadProperties', false)
        expect(foundRight).toHaveProperty('accessRightSet.canManageProperties', false)
    })

    describe('Bulk-operations', () => {
        test('Cannot create many Properties in one request', async () => {
            const [organization] = await registerNewOrganization(user)
            const [app] = await createTestB2BApp(support)
            await createTestB2BAppContext(support, app, organization, { status: 'Finished' })
            const [right] = await createTestB2BAppAccessRight(support, serviceUser.user, app)
            const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
                canReadProperties: true,
                canManageProperties: true,
                canReadOrganizations: true,
            })
            await updateTestB2BAppAccessRight(support, right.id, { accessRightSet: { connect: { id: accessRightSet.id } } })

            const { address, addressMeta } = buildFakeAddressAndMeta(false)
            const { address: address2, addressMeta: addressMeta2 } = buildFakeAddressAndMeta(false)
            const attrs = [{
                data: {
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    organization: { connect: { id: organization.id } },
                    type: 'building',
                    name: faker.address.streetAddress(true),
                    address: address,
                    addressMeta: addressMeta,
                },
            }, {
                data:{
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    organization: { connect: { id: organization.id } },
                    type: 'building',
                    name: faker.address.streetAddress(true),
                    address: address2,
                    addressMeta: addressMeta2,
                },
            }]

            await expectToThrowAccessDeniedErrorToObjects(async () => {
                await Property.createMany(serviceUser, attrs)
            })
        })

        test('Cannot update many Properties in one request', async () => {
            const [organization] = await registerNewOrganization(user)
            const [app] = await createTestB2BApp(support)
            await createTestB2BAppContext(support, app, organization, { status: 'Finished' })
            const [right] = await createTestB2BAppAccessRight(support, serviceUser.user, app)
            const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
                canReadProperties: true,
                canManageProperties: true,
                canReadOrganizations: true,
            })
            await updateTestB2BAppAccessRight(support, right.id, { accessRightSet: { connect: { id: accessRightSet.id } } })

            const [property1] = await createTestProperty(support, organization)
            const [property2] = await createTestProperty(support, organization)

            const attrs = [{
                id: property1.id,
                data: {
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    name: faker.address.streetAddress(true),
                },
            }, {
                id: property2.id,
                data: {
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    name: faker.address.streetAddress(true),
                },
            }]
            await expectToThrowAccessDeniedErrorToObjects(async () => {
                await Property.updateMany(serviceUser, attrs)
            })
        })
    })

    test('Organization', async () => {
        const [organization] = await registerNewOrganization(user)

        const [app] = await createTestB2BApp(support)
        await createTestB2BAppContext(support, app, organization, { status: 'Finished' })
        const [right] = await createTestB2BAppAccessRight(support, serviceUser.user, app)

        // B2BApp without permissions
        {
            const countWithoutPermissions = await Organization.count(serviceUser, {})
            expect(countWithoutPermissions).toBe(0)
            const organizationWithoutPermissions = await Organization.getOne(serviceUser, { id: organization.id })
            expect(organizationWithoutPermissions).toBeUndefined()

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestOrganization(serviceUser)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestOrganization(serviceUser, organization.id, {})
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Organization.softDelete(serviceUser, organization.id)
            })
        }

        const countByUser = await Organization.count(user, {})
        expect(countByUser).toBe(1)
        const organizationByUser = await Organization.getOne(user, { id: organization.id })
        expect(organizationByUser.id).toBe(organization.id)

        // you cannot create a field "canManageOrganizations". Only reading! Always false!
        await catchErrorFrom(async () => {
            await createTestB2BAppAccessRightSet(support, app, {
                canManageOrganizations: false,
            })
        }, (e) => {
            console.log(e)
            expect(e.errors[0].message).toContain('Field "canManageOrganizations" is not defined by type "B2BAppAccessRightSetCreateInput"')
        })

        // add permissions for B2BApp
        const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
            canReadOrganizations: true,
        })
        await updateTestB2BAppAccessRight(support, right.id, { accessRightSet: { connect: { id: accessRightSet.id } } })

        // you can update 'canReadOrganizations'
        await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
            canReadOrganizations: true,
        })

        // you cannot update a field "canManageOrganizations". Only reading! Always false!
        await catchErrorFrom(async () => {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canManageOrganizations: false,
            })
        }, (e) => {
            expect(e.errors[0].message).toContain('Field "canManageOrganizations" is not defined by type "B2BAppAccessRightSetUpdateInput"')
        })

        // B2BApp with permission "canReadOrganization: true"
        {
            const countWithPermissions = await Organization.count(serviceUser, {})
            expect(countWithPermissions).toBe(1)
            const organizationWithPermissions = await Organization.getOne(serviceUser, { id: organization.id })
            expect(organizationWithPermissions.id).toBe(organization.id)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestOrganization(serviceUser)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestOrganization(serviceUser, organization.id, {})
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Organization.softDelete(serviceUser, organization.id)
            })
        }

        // B2BApp with permission "canReadOrganization: false"
        await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
            canReadOrganizations: false,
        })

        {
            const countWithoutPermissions = await Organization.count(serviceUser, {})
            expect(countWithoutPermissions).toBe(0)
            const organizationWithoutPermissions = await Organization.getOne(serviceUser, { id: organization.id })
            expect(organizationWithoutPermissions).toBeUndefined()

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestOrganization(serviceUser)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestOrganization(serviceUser, organization.id, {})
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Organization.softDelete(serviceUser, organization.id)
            })
        }
    })

    test('Property', async () => {
        const [organization] = await registerNewOrganization(user)

        const [app] = await createTestB2BApp(support)
        await createTestB2BAppContext(support, app, organization, { status: 'Finished' })
        const [right] = await createTestB2BAppAccessRight(support, serviceUser.user, app)

        const [property] = await createTestProperty(user, organization)

        // B2BApp without permissions
        {
            await expectToThrowAccessDeniedErrorToCount(async () => {
                await Property.count(serviceUser, {})
            })
            await expectToThrowAccessDeniedErrorToObjects(async () => {
                await Property.getOne(serviceUser, { id: property.id })
            })

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestProperty(serviceUser, organization)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestProperty(serviceUser, property.id, {
                    name: faker.lorem.word(),
                })
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Property.softDelete(serviceUser, property.id)
            })
        }

        const countByUser = await Property.count(user, {})
        expect(countByUser).toBe(1)
        const propertyByUser = await Property.getOne(user, { id: property.id })
        expect(propertyByUser.id).toBe(property.id)

        // add permissions for B2BApp
        const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
            canReadOrganizations: true, // required permission for manage property
        })
        await updateTestB2BAppAccessRight(support, right.id, { accessRightSet: { connect: { id: accessRightSet.id } } })

        // you can update 'canReadProperties' and 'canManageProperties'
        await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
            canReadProperties: true,
            canManageProperties: true,
        })

        // B2BApp with permissions { canReadProperties: true, canManageProperties: true, canReadOrganizations: true }
        {
            // can create
            const [createdProperty] = await createTestProperty(serviceUser, organization)
            expect(createdProperty).toBeDefined()

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(2)

            // can read
            const countWithPermissions = await Property.count(serviceUser, {})
            expect(countWithPermissions).toBe(2)
            const propertyWithPermissions = await Property.getOne(serviceUser, { id: property.id })
            expect(propertyWithPermissions.id).toBe(property.id)

            // can update
            await updateTestProperty(serviceUser, property.id, {
                name: faker.lorem.word(),
            })

            // can delete
            const [deletedProperty] = await Property.softDelete(serviceUser, createdProperty.id)
            expect(deletedProperty).toHaveProperty('id', createdProperty.id)
            expect(!!deletedProperty.deletedAt).toBeTruthy()

            const countByUser2 = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser2).toBe(1)
        }

        // B2BApp with permissions { canReadProperties: false, canManageProperties: false, canReadOrganizations: false }
        {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canReadProperties: false,
                canManageProperties: false,
                canReadOrganizations: false,
            })

            // cannot read
            await expectToThrowAccessDeniedErrorToCount(async () => {
                await Property.count(serviceUser, {})
            })
            await expectToThrowAccessDeniedErrorToObjects(async () => {
                await Property.getOne(serviceUser, { id: property.id })
            })

            // cannot create
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestProperty(serviceUser, organization)
            })

            // cannot update
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestProperty(serviceUser, property.id, {
                    name: faker.lorem.word(),
                })
            })

            // cannot delete
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Property.softDelete(serviceUser, property.id)
            })

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(1)
        }

        // B2BApp with permissions { canReadProperties: true, canManageProperties: false, canReadOrganizations: false }
        {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canReadProperties: true,
                canManageProperties: false,
                canReadOrganizations: false,
            })

            // can read
            const countWithPermissions = await Property.count(serviceUser, {})
            expect(countWithPermissions).toBe(1)
            const propertyWithPermissions = await Property.getOne(serviceUser, { id: property.id })
            expect(propertyWithPermissions.id).toBe(property.id)

            // cannot create
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestProperty(serviceUser, organization)
            })

            // cannot update
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestProperty(serviceUser, property.id, {
                    name: faker.lorem.word(),
                })
            })

            // cannot delete
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Property.softDelete(serviceUser, property.id)
            })

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(1)
        }

        // B2BApp with permissions { canReadProperties: false, canManageProperties: true, canReadOrganizations: false }
        {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canReadProperties: false,
                canManageProperties: true,
                canReadOrganizations: false,
            })

            // cannot read
            await expectToThrowAccessDeniedErrorToCount(async () => {
                await Property.count(serviceUser, {})
            })
            await expectToThrowAccessDeniedErrorToObjects(async () => {
                await Property.getOne(serviceUser, { id: property.id })
            })

            // cannot create property because you cannot read organizations
            await catchErrorFrom(async () => {
                await createTestProperty(serviceUser, organization)
            }, (e) => {
                expect(e.errors[0].message).toContain('Unable to connect a Property.organization<Organization>')
            })

            // can update
            const [updatedProperty, attrs] = await updateTestProperty(serviceUser, property.id, {
                name: faker.lorem.word(),
            })
            expect(updatedProperty).toHaveProperty('id', property.id)
            expect(updatedProperty).toHaveProperty('name', attrs.name)


            const [createdPropertyByUser] = await createTestProperty(user, organization)

            // can delete
            const [deletedProperty] = await Property.softDelete(serviceUser, createdPropertyByUser.id)
            expect(deletedProperty).toHaveProperty('id', createdPropertyByUser.id)
            expect(!!deletedProperty.deletedAt).toBeTruthy()

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(1)
        }

        // B2BApp with permissions { canReadProperties: false, canManageProperties: true, canReadOrganizations: true }
        {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canReadProperties: false,
                canManageProperties: true,
                canReadOrganizations: true,
            })

            // cannot read
            await expectToThrowAccessDeniedErrorToCount(async () => {
                await Property.count(serviceUser, {})
            })
            await expectToThrowAccessDeniedErrorToObjects(async () => {
                await Property.getOne(serviceUser, { id: property.id })
            })

            // can create
            const [createdProperty] = await createTestProperty(serviceUser, organization)
            expect(createdProperty).toBeDefined()

            // can update
            const [updatedProperty, attrs] = await updateTestProperty(serviceUser, property.id, {
                name: faker.lorem.word(),
            })
            expect(updatedProperty).toHaveProperty('id', property.id)
            expect(updatedProperty).toHaveProperty('name', attrs.name)

            // can delete
            const [deletedProperty] = await Property.softDelete(serviceUser, createdProperty.id)
            expect(deletedProperty).toHaveProperty('id', createdProperty.id)
            expect(!!deletedProperty.deletedAt).toBeTruthy()

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(1)
        }

        // B2BApp with permissions { canReadProperties: true, canManageProperties: false, canReadOrganizations: true }
        {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canReadProperties: true,
                canManageProperties: false,
                canReadOrganizations: true,
            })

            // can read
            const countWithPermissions = await Property.count(serviceUser, {})
            expect(countWithPermissions).toBe(1)
            const propertyWithPermissions = await Property.getOne(serviceUser, { id: property.id })
            expect(propertyWithPermissions).toHaveProperty('id', property.id)

            // cannot create
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestProperty(serviceUser, organization)
            })

            // canot update
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestProperty(serviceUser, property.id, {
                    name: faker.lorem.word(),
                })
            })

            const [createdPropertyByUser] = await createTestProperty(user, organization)

            // cannot delete
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await Property.softDelete(serviceUser, createdPropertyByUser.id)
            })

            await Property.softDelete(user, createdPropertyByUser.id)

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(1)
        }

        // B2BApp with permissions { canReadProperties: true, canManageProperties: true, canReadOrganizations: false }
        {
            await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
                canReadProperties: true,
                canManageProperties: true,
                canReadOrganizations: false,
            })

            // can read
            const countWithPermissions = await Property.count(serviceUser, {})
            expect(countWithPermissions).toBe(1)
            const propertyWithPermissions = await Property.getOne(serviceUser, { id: property.id })
            expect(propertyWithPermissions).toHaveProperty('id', property.id)

            // you cannot create property because you cannot read organizations
            await catchErrorFrom(async () => {
                await createTestProperty(serviceUser, organization)
            }, (e) => {
                expect(e.errors[0].message).toContain('Unable to connect a Property.organization<Organization>')
            })

            // can update
            const [updatedProperty, attrs] = await updateTestProperty(serviceUser, property.id, {
                name: faker.lorem.word(),
            })
            expect(updatedProperty).toHaveProperty('id', property.id)
            expect(updatedProperty).toHaveProperty('name', attrs.name)


            const [createdPropertyByUser] = await createTestProperty(user, organization)

            // can delete
            const [deletedProperty] = await Property.softDelete(serviceUser, createdPropertyByUser.id)
            expect(deletedProperty).toHaveProperty('id', createdPropertyByUser.id)
            expect(!!deletedProperty.deletedAt).toBeTruthy()

            const countByUser = await Property.count(user, { organization: { id: organization.id } })
            expect(countByUser).toBe(1)
        }

    })

    test('Contact', async () => {
        const [organization] = await registerNewOrganization(user)

        const [app] = await createTestB2BApp(support)
        await createTestB2BAppContext(support, app, organization, { status: 'Finished' })
        const [right] = await createTestB2BAppAccessRight(support, serviceUser.user, app)

        const [property] = await createTestProperty(user, organization)
        const [contact] = await createTestContact(user, organization, property)

        // B2BApp without permissions
        await expectToThrowAccessDeniedErrorToCount(async () => {
            await Contact.count(serviceUser, {})
        })
        await expectToThrowAccessDeniedErrorToObjects(async () => {
            await Contact.getOne(serviceUser, { id: contact.id })
        })

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestContact(serviceUser, organization, property)
        })
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestContact(serviceUser, contact.id, {})
        })
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await Contact.softDelete(serviceUser, contact.id)
        })

        const countByUser = await Contact.count(user, {})
        expect(countByUser).toBe(1)
        const contactByUser = await Contact.getOne(user, { id: contact.id })
        expect(contactByUser.id).toBe(contact.id)

        // add permissions for B2BApp
        const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
            canReadContacts: true,
            canManageContacts: true,
            canReadOrganizations: true, // required permission for manage contact
            canReadProperties: true, // required permission for manage contact
        })
        await updateTestB2BAppAccessRight(support, right.id, { accessRightSet: { connect: { id: accessRightSet.id } } })

        // you can update 'canReadContacts' and 'canManageContacts'
        await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
            canReadContacts: true,
            canManageContacts: true,
        })

        // B2BApp with permissions
        await createTestContact(serviceUser, organization, property)

        const countByUser2 = await Contact.count(user, { organization: { id: organization.id } })
        expect(countByUser2).toBe(2)

        const countWithPermissions = await Contact.count(serviceUser, {})
        expect(countWithPermissions).toBe(2)
        const contactWithPermissions = await Contact.getOne(serviceUser, { id: contact.id })
        expect(contactWithPermissions.id).toBe(contact.id)

        await updateTestContact(serviceUser, contact.id, {})
        await Contact.softDelete(serviceUser, contact.id)

        const countByUser3 = await Contact.count(user, { organization: { id: organization.id } })
        expect(countByUser3).toBe(1)
    })

    // NOTE: Currently these schemes are not added to read/manage the service user.
    //       It is used to local test the preprocessor
    test.skip('Ticket and TicketComment', async () => {
        const [organization] = await registerNewOrganization(user)

        const [app] = await createTestB2BApp(support)
        await createTestB2BAppContext(support, app, organization, { status: 'Finished' })
        const [right] = await createTestB2BAppAccessRight(support, serviceUser.user, app)

        const [property] = await createTestProperty(user, organization)
        const [ticket] = await createTestTicket(user, organization, property)

        const [ticketComment] = await createTestTicketComment(user, ticket, user.user)

        // B2BApp without permissions
        const countWithoutPermissions = await TicketComment.count(serviceUser, {})
        expect(countWithoutPermissions).toBe(0)
        const contactWithoutPermissions = await TicketComment.getOne(serviceUser, {
            ticket: { id: ticket.id },
        })
        expect(contactWithoutPermissions).toBeUndefined()

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestTicket(serviceUser, organization, property)
        })
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestTicket(serviceUser, ticket.id)
        })
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await Ticket.softDelete(serviceUser, ticket.id)
        })

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestTicketComment(serviceUser, ticket, serviceUser.user)
        })
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestTicketComment(serviceUser, ticketComment.id)
        })
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await TicketComment.softDelete(serviceUser, ticketComment.id)
        })

        // add permissions for B2BApp
        const [accessRightSet] = await createTestB2BAppAccessRightSet(support, app, {
            canReadContacts: true,
            canManageContacts: true,
            canReadOrganizations: true,
            canReadProperties: true,
            canReadTickets: true,
            canManageTickets: true,
            canReadTicketComments: true,
            canManageTicketComments: true,
        })
        await updateTestB2BAppAccessRight(support, right.id, { accessRightSet: { connect: { id: accessRightSet.id } } })

        // you can update 'canReadTickets', 'canManageTickets', 'canReadTicketComments' and 'canManageTicketComments'
        await updateTestB2BAppAccessRightSet(support, accessRightSet.id, {
            canReadTickets: true,
            canManageTickets: true,
            canReadTicketComments: true,
            canManageTicketComments: true,
        })

        await createTestTicket(serviceUser, organization, property)

        {
            const countByUser2 = await Ticket.count(user, { organization: { id: organization.id } })
            expect(countByUser2).toBe(2)

            const countWithPermissions = await Ticket.count(serviceUser, {})
            expect(countWithPermissions).toBe(2)
            const contactWithPermissions = await Ticket.getOne(serviceUser, { id: ticket.id })
            expect(contactWithPermissions.id).toBe(ticket.id)
        }

        await updateTestTicket(serviceUser, ticket.id, {})

        // NOTE: problem with field accesses - the field "user" can only be read/submitted by the user who created the comment
        const [tcByServiceUser] = await createTestTicketComment(serviceUser, ticket, serviceUser.user)

        {
            const countByUser2 = await TicketComment.count(user, { ticket: { organization: { id: organization.id } } })
            expect(countByUser2).toBe(2)

            const countWithPermissions = await TicketComment.count(serviceUser, {})
            expect(countWithPermissions).toBe(2)
            const contactWithPermissions = await TicketComment.getOne(serviceUser, { id: ticketComment.id })
            expect(contactWithPermissions.id).toBe(ticketComment.id)
        }

        // NOTE: problem with field accesses - the field "user" can only be read/submitted by the user who created the comment
        await updateTestTicketComment(serviceUser, tcByServiceUser.id)

        // await Ticket.softDelete(serviceUser, ticketByServiceUser.id)
        await TicketComment.softDelete(serviceUser, tcByServiceUser.id)

        {
            const countByUser3 = await Ticket.count(user, { organization: { id: organization.id } })
            expect(countByUser3).toBe(2)
        }

        {
            const countByUser3 = await TicketComment.count(user, { ticket: { organization: { id: organization.id } } })
            expect(countByUser3).toBe(1)
        }
    })
})
