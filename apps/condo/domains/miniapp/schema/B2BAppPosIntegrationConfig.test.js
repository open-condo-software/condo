/**
 * Generated by `createschema miniapp.B2BAppPosIntegrationConfig 'paymentsAlertPageUrl:Text;'`
 */

const { faker } = require('@faker-js/faker')

const { makeLoggedInAdminClient, makeClient, expectValuesOfCommonFields } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { B2BAppPosIntegrationConfig, createTestB2BAppPosIntegrationConfig, updateTestB2BAppPosIntegrationConfig } = require('@condo/domains/miniapp/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')


describe('B2BAppPosIntegrationConfig', () => {
    describe('CRUD tests', () => {
        let admin
        let support
        let user
        let anonymous

        beforeAll(async () => {
            admin = await makeLoggedInAdminClient()
            support = await makeClientWithSupportUser()
            user = await makeClientWithNewRegisteredAndLoggedInUser()
            anonymous = await makeClient()
        })

        describe('create', () => {
            const createPayload = {
                paymentsAlertPageUrl: faker.internet.url(),
                fetchLastPosReceiptUrl: faker.internet.url(),
            }

            test('admin can', async () => {
                const [obj, attrs] = await createTestB2BAppPosIntegrationConfig(admin, createPayload)

                expectValuesOfCommonFields(obj, attrs, admin)
                expect(obj).toEqual(expect.objectContaining(createPayload))
            })

            test('support can', async () => {
                const [obj, attrs] = await createTestB2BAppPosIntegrationConfig(support, createPayload)

                expectValuesOfCommonFields(obj, attrs, support)
                expect(obj).toEqual(expect.objectContaining(createPayload))
            })

            test('user can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestB2BAppPosIntegrationConfig(user, createPayload)
                })
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestB2BAppPosIntegrationConfig(anonymous, createPayload)
                })
            })
        })

        describe('update', () => {
            let createdB2BAppPosIntegrationConfig
            const updatePayload = {
                paymentsAlertPageUrl: faker.internet.url(),
                fetchLastPosReceiptUrl: faker.internet.url(),
            }

            beforeEach(async () => {
                [createdB2BAppPosIntegrationConfig] = await createTestB2BAppPosIntegrationConfig(admin)
            })

            test('admin can', async () => {
                const [obj] = await updateTestB2BAppPosIntegrationConfig(admin, createdB2BAppPosIntegrationConfig.id, updatePayload)

                expect(obj.v).toEqual(2)
                expect(obj).toEqual(expect.objectContaining(updatePayload))
            })

            test('support can', async () => {
                const [obj] = await updateTestB2BAppPosIntegrationConfig(support, createdB2BAppPosIntegrationConfig.id, updatePayload)

                expect(obj.v).toEqual(2)
                expect(obj).toEqual(expect.objectContaining(updatePayload))
            })

            test('user can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestB2BAppPosIntegrationConfig(user, createdB2BAppPosIntegrationConfig.id, updatePayload)
                })
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestB2BAppPosIntegrationConfig(anonymous, createdB2BAppPosIntegrationConfig.id, updatePayload)
                })
            })
        })

        describe('hard delete', () => {
            let createdB2BAppPosIntegrationConfig

            beforeAll(async () => {
                [createdB2BAppPosIntegrationConfig] = await createTestB2BAppPosIntegrationConfig(admin)
            })

            test('nobody can', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppPosIntegrationConfig.delete(admin, createdB2BAppPosIntegrationConfig.id)
                })
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppPosIntegrationConfig.delete(support, createdB2BAppPosIntegrationConfig.id)
                })
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppPosIntegrationConfig.delete(user, createdB2BAppPosIntegrationConfig.id)
                })
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await B2BAppPosIntegrationConfig.delete(anonymous, createdB2BAppPosIntegrationConfig.id)
                })
            })
        })

        describe('read', () => {
            let createdB2BAppPosIntegrationConfig

            beforeAll(async () => {
                [createdB2BAppPosIntegrationConfig] = await createTestB2BAppPosIntegrationConfig(admin)
            })

            test('admin can', async () => {
                const apps = await B2BAppPosIntegrationConfig.getAll(admin, {
                    id: createdB2BAppPosIntegrationConfig.id,
                })

                expect(apps).toBeDefined()
                expect(apps).toHaveLength(1)
                expect(apps[0]).toHaveProperty('id', createdB2BAppPosIntegrationConfig.id)
                expect(apps[0]).toHaveProperty('paymentsAlertPageUrl', createdB2BAppPosIntegrationConfig.paymentsAlertPageUrl)
            })

            test('support can', async () => {
                const apps = await B2BAppPosIntegrationConfig.getAll(support, {
                    id: createdB2BAppPosIntegrationConfig.id,
                })

                expect(apps).toBeDefined()
                expect(apps).toHaveLength(1)
                expect(apps[0]).toHaveProperty('id', createdB2BAppPosIntegrationConfig.id)
                expect(apps[0]).toHaveProperty('paymentsAlertPageUrl', createdB2BAppPosIntegrationConfig.paymentsAlertPageUrl)
            })

            test('user can', async () => {
                const apps = await B2BAppPosIntegrationConfig.getAll(user, {
                    id: createdB2BAppPosIntegrationConfig.id,
                })

                expect(apps).toBeDefined()
                expect(apps).toHaveLength(1)
                expect(apps[0]).toHaveProperty('id', createdB2BAppPosIntegrationConfig.id)
                expect(apps[0]).toHaveProperty('paymentsAlertPageUrl', createdB2BAppPosIntegrationConfig.paymentsAlertPageUrl)
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await B2BAppPosIntegrationConfig.getAll(anonymous, {
                        id: createdB2BAppPosIntegrationConfig.id,
                    })
                })
            })
        })
    })
})
