/**
 * Generated by `createschema news.NewsItemFile 'newsItem:Relationship:NewsItem:CASCADE; file:File;'`
 */

const dayjs = require('dayjs')

const { throwAuthenticationError } = require('@open-condo/keystone/apolloErrorFormatter')
const { getById } = require('@open-condo/keystone/schema')

const { RESIDENT, STAFF } = require('@condo/domains/user/constants/common')

const { getEmployedOrRelatedOrganizationsByPermissions, checkPermissionsInEmployedOrRelatedOrganizations } = require('../../organization/utils/accessSchema')
const { getUserResidents } = require('../../resident/utils/accessSchema')
const { queryFindNewsItemsScopesByResidents } = require('../utils/accessSchema')


async function canReadNewsItemFiles ({ authentication: { item: user }, context }) {
    if (!user) return throwAuthenticationError()
    if (user.deletedAt) return false

    if (user.isAdmin || user.isSupport) return {}

    if (user.type === RESIDENT) {
        const residents = await getUserResidents(context, user)
        if (!residents || !Array.isArray(residents) || residents.length < 1) return false

        const organizationsIds = residents.map((resident) => resident.organization)
        const scopesCondition = queryFindNewsItemsScopesByResidents(residents)

        return {
            newsItem: {
                isPublished: true,
                organization: { id_in: organizationsIds },
                scopes_some: scopesCondition,
                sendAt_lte: dayjs().toISOString(),
            },
        }
    }

    if (user.type === STAFF) {
        const permittedOrganizations = await getEmployedOrRelatedOrganizationsByPermissions(context, user, 'canReadNewsItems')

        return {
            organization: {
                id_in: permittedOrganizations,
            },
        }
    }

    return false
}

async function canManageNewsItemFiles ({ authentication: { item: user }, originalInput, operation, itemId, context }) {
    if (!user) return throwAuthenticationError()
    if (user.deletedAt) return false
    if (user.isAdmin) return true

    if (user.type === STAFF) {
        if (operation === 'create') {
            const newsItemId = originalInput?.newsItem?.connect?.id || null
            if (newsItemId) {
                const newsItem = await getById('NewsItem', newsItemId)
                const organizationId = newsItem?.organization || null

                if (!organizationId) return false

                return await checkPermissionsInEmployedOrRelatedOrganizations(context, user, organizationId, 'canManageNewsItems')
            }
            return false
        } else if (operation === 'update') {
            const newsItemFile = await getById('NewsItemFile', itemId)
            const organizationId = newsItemFile?.organization || null

            if (!organizationId) return newsItemFile?.createdBy === user.id

            return await checkPermissionsInEmployedOrRelatedOrganizations(context, user, organizationId, 'canManageNewsItems')
        }
    }

    return false
}

/*
  Rules are logical functions that used for list access, and may return a boolean (meaning
  all or no items are available) or a set of filters that limit the available items.
*/
module.exports = {
    canReadNewsItemFiles,
    canManageNewsItemFiles,
}
