/**
 * Generated by `createschema news.NewsItemScope 'newsItem:Relationship:NewsItem:CASCADE; property:Relationship:Property:CASCADE; unitType:Select:get,from,constant,unit_types; unitName:Text'`
 */

const { faker } = require('@faker-js/faker')
const dayjs = require('dayjs')

const {
    makeLoggedInAdminClient,
    makeClient,
    UUID_RE,
    DATETIME_RE,
    expectToThrowGQLError,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowValidationFailureError, expectToThrowAccessDeniedErrorToObjects,
} = require('@open-condo/keystone/test.utils')

const {
    NEWS_ITEM_SCOPE_TYPE_ORGANIZATION,
    NEWS_ITEM_SCOPE_TYPE_PROPERTY,
    NEWS_ITEM_SCOPE_TYPE_PROPERTY_UNIT_TYPE,
    NEWS_ITEM_SCOPE_TYPE_PROPERTY_UNIT_TYPE_UNIT_NAME,
} = require('@condo/domains/news/constants/scopesTypes')
const {
    NewsItemScope,
    createTestNewsItemScope,
    updateTestNewsItemScope,
    createTestNewsItem,
    publishTestNewsItem,
    updateTestNewsItem,
} = require('@condo/domains/news/utils/testSchema')
const {
    createTestOrganizationEmployeeRole,
    createTestOrganizationEmployee,
    createTestOrganization,
    makeEmployeeUserClientWithAbilities,
} = require('@condo/domains/organization/utils/testSchema')
const { FLAT_UNIT_TYPE } = require('@condo/domains/property/constants/common')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const {
    makeClientWithNewRegisteredAndLoggedInUser,
    makeClientWithSupportUser,
    makeClientWithResidentUser,
    makeClientWithStaffUser,
} = require('@condo/domains/user/utils/testSchema')


const getScopePayload = (o10n, newsItem, property, unitName, unitType) => ({
    dv: 1,
    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
    ...(unitType ? { unitType } : undefined),
    ...(unitName ? { unitName } : undefined),
    ...(property ? { property: { connect: { id: property.id } } } : undefined),
    ...(newsItem ? { newsItem: { connect: { id: newsItem.id } } } : undefined),
    ...(o10n ? { organization: { connect: { id: o10n.id } } } : undefined),
})

let adminClient, supportClient, anonymousClient, dummyO10n, dummyProperty, dummyNewsItem,
    residentClient, staffClient, staffClientNoPermission, dummyRoleAllow, dummyRoleDisallow

describe('NewsItemScope', () => {
    beforeAll(async () => {
        adminClient = await makeLoggedInAdminClient()
        const [o10n] = await createTestOrganization(adminClient)
        dummyO10n = o10n
        const [property] = await createTestProperty(adminClient, dummyO10n)
        dummyProperty = property
    })

    describe('CRUD tests', () => {
        beforeAll(async () => {
            supportClient = await makeClientWithSupportUser()
            anonymousClient = await makeClient()

            const [newsItem] = await createTestNewsItem(adminClient, dummyO10n)
            dummyNewsItem = newsItem
            residentClient = await makeClientWithResidentUser()

            staffClient = await makeClientWithStaffUser()
            staffClientNoPermission = await makeClientWithStaffUser()

            let [roleAllow] = await createTestOrganizationEmployeeRole(adminClient, dummyO10n, {
                canManageNewsItems: true,
                canReadNewsItems: true,
            })
            dummyRoleAllow = roleAllow
            await createTestOrganizationEmployee(adminClient, dummyO10n, staffClient.user, dummyRoleAllow)

            let [roleDisallow] = await createTestOrganizationEmployeeRole(adminClient, dummyO10n, {
                canManageNewsItems: false,
                canReadNewsItems: false,
            })
            dummyRoleDisallow = roleDisallow
            await createTestOrganizationEmployee(adminClient, dummyO10n, staffClientNoPermission.user, dummyRoleDisallow)
        })

        describe('create', () => {
            test('admin can', async () => {
                const [obj, attrs] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.dv).toEqual(1)
                expect(obj.sender).toEqual(attrs.sender)
                expect(obj.v).toEqual(1)
                expect(obj.newId).toEqual(null)
                expect(obj.deletedAt).toEqual(null)
                expect(obj.createdBy).toEqual(expect.objectContaining({ id: adminClient.user.id }))
                expect(obj.updatedBy).toEqual(expect.objectContaining({ id: adminClient.user.id }))
                expect(obj.createdAt).toMatch(DATETIME_RE)
                expect(obj.updatedAt).toMatch(DATETIME_RE)
                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.property.id).toEqual(dummyProperty.id)
            })

            test('support can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemScope(supportClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })
                })
            })

            test('stuff with permission can', async () => {
                const [obj, attrs] = await createTestNewsItemScope(staffClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.dv).toEqual(1)
                expect(obj.sender).toEqual(attrs.sender)
                expect(obj.createdBy).toEqual(expect.objectContaining({ id: staffClient.user.id }))
            })

            test('stuff without permission can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemScope(staffClientNoPermission, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })
                })
            })

            test('resident can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemScope(residentClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })
                })
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestNewsItemScope(anonymousClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })
                })
            })

            test('The scope type calculates correctly', async () => {
                const [scope1] = await createTestNewsItemScope(adminClient, dummyNewsItem)
                const [scope2] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })
                const [scope3] = await createTestNewsItemScope(adminClient, dummyNewsItem, {
                    property: { connect: { id: dummyProperty.id } },
                    unitType: FLAT_UNIT_TYPE,
                })
                const [scope4] = await createTestNewsItemScope(adminClient, dummyNewsItem, {
                    property: { connect: { id: dummyProperty.id } },
                    unitType: FLAT_UNIT_TYPE,
                    unitName: '1',
                })

                expect(scope1.type).toEqual(NEWS_ITEM_SCOPE_TYPE_ORGANIZATION)
                expect(scope2.type).toEqual(NEWS_ITEM_SCOPE_TYPE_PROPERTY)
                expect(scope3.type).toEqual(NEWS_ITEM_SCOPE_TYPE_PROPERTY_UNIT_TYPE)
                expect(scope4.type).toEqual(NEWS_ITEM_SCOPE_TYPE_PROPERTY_UNIT_TYPE_UNIT_NAME)
            })
        })

        describe('update', () => {
            test('admin can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemScope(adminClient, objCreated.id)
                })
            })

            test('support can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemScope(supportClient, objCreated.id)
                })
            })

            test('staff with permissions can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemScope(staffClient, dummyNewsItem.id, { unitName: '1' })
                })
            })

            test('staff with permissions can soft-delete', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                const [obj, attrs] = await updateTestNewsItemScope(staffClient, objCreated.id, { deletedAt: 'true' })

                expect(obj.dv).toEqual(1)
                expect(obj.sender).toEqual(attrs.sender)
                expect(obj.v).toEqual(2)
                expect(obj.updatedBy).toEqual(expect.objectContaining({ id: staffClient.user.id }))
                expect(obj.deletedAt).not.toBeNull()
            })

            test('staff without permissions can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemScope(staffClientNoPermission, objCreated.id)
                })
            })

            test('anonymous can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestNewsItemScope(anonymousClient, objCreated.id)
                })
            })
        })

        describe('hard delete', () => {
            test('admin can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemScope.delete(adminClient, objCreated.id)
                })
            })

            test('user can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                const client = await makeClientWithNewRegisteredAndLoggedInUser()
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemScope.delete(client, objCreated.id)
                })
            })

            test('anonymous can\'t', async () => {
                const [objCreated] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemScope.delete(anonymousClient, objCreated.id)
                })
            })
        })

        describe('read', () => {
            test('admin can', async () => {
                const [obj] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                const objs = await NewsItemScope.getAll(adminClient, {}, { sortBy: ['updatedAt_DESC'] })

                expect(objs.length).toBeGreaterThanOrEqual(1)
                expect(objs).toEqual(expect.arrayContaining([
                    expect.objectContaining({
                        id: obj.id,
                    }),
                ]))
            })

            test('staff with permission can', async () => {
                const [obj] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                const objs = await NewsItemScope.getAll(staffClient, {}, { sortBy: ['updatedAt_DESC'] })

                expect(objs.length).toBeGreaterThanOrEqual(1)
                expect(objs[0]).toMatchObject({
                    id: obj.id,
                })
            })

            test('staff without read permission can\'t', async () => {
                const [obj] = await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                const readObj = await NewsItemScope.getOne(staffClientNoPermission, { id: obj.id }, { sortBy: ['updatedAt_DESC'] })

                expect(readObj).toBeUndefined()
            })

            test('anonymous can\'t', async () => {
                await createTestNewsItemScope(adminClient, dummyNewsItem, { property: { connect: { id: dummyProperty.id } } })

                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await NewsItemScope.getAll(anonymousClient, {}, { sortBy: ['updatedAt_DESC'] })
                })
            })
        })

        describe('Bulk-operations', () => {
            describe('create', () => {
                test('employee can if he has access to all organizations', async () => {
                    const { organization, role, property } = await makeEmployeeUserClientWithAbilities({ canManageNewsItems: true, canReadNewsItems: true })
                    await createTestOrganizationEmployee(adminClient, organization, staffClient.user, role)
                    const [newsItem] = await createTestNewsItem(adminClient, organization)

                    const payload = [
                        { data: getScopePayload(dummyO10n, dummyNewsItem, dummyProperty, '1', FLAT_UNIT_TYPE) },
                        { data: getScopePayload(organization, newsItem, property, '2', FLAT_UNIT_TYPE) },
                    ]
                    const createdScopes = await NewsItemScope.createMany(staffClient, payload)
                    expect(createdScopes).toEqual(
                        expect.arrayContaining([
                            expect.objectContaining({
                                unitType: FLAT_UNIT_TYPE,
                                unitName: '1',
                                property: expect.objectContaining({ id: dummyProperty.id }),
                                newsItem: expect.objectContaining({ id: dummyNewsItem.id }),
                                organization: expect.objectContaining({ id: dummyO10n.id }),
                            }),
                            expect.objectContaining({
                                unitType: FLAT_UNIT_TYPE,
                                unitName: '2',
                                property: expect.objectContaining({ id: property.id }),
                                newsItem: expect.objectContaining({ id: newsItem.id }),
                                organization: expect.objectContaining({ id: organization.id }),
                            }),
                        ])
                    )
                })

                test('employee cannot if he has not access to all organizations', async () => {
                    const { organization, role, property } = await makeEmployeeUserClientWithAbilities({ canManageNewsItems: false, canReadNewsItems: false })
                    await createTestOrganizationEmployee(adminClient, organization, staffClient.user, role)
                    const [newsItem] = await createTestNewsItem(adminClient, organization)

                    const payload = [
                        { data: getScopePayload(dummyO10n, dummyNewsItem, dummyProperty, '1', FLAT_UNIT_TYPE) },
                        { data: getScopePayload(organization, newsItem, property, '2', FLAT_UNIT_TYPE) },
                    ]
                    await expectToThrowAccessDeniedErrorToObjects(async () => {
                        await NewsItemScope.createMany(staffClient, payload)
                    })
                })
            })

            describe('soft-delete', () => {
                test('employee can if he has access to all organizations', async () => {
                    const { organization, role, property } = await makeEmployeeUserClientWithAbilities({ canManageNewsItems: true, canReadNewsItems: true })
                    await createTestOrganizationEmployee(adminClient, organization, staffClient.user, role)
                    const [newsItem] = await createTestNewsItem(adminClient, organization)

                    const [scope1] = await createTestNewsItemScope(adminClient, dummyNewsItem, {
                        unitName: '1',
                        unitType: FLAT_UNIT_TYPE,
                        property: { connect: { id: dummyProperty.id } },
                    })
                    const [scope2] = await createTestNewsItemScope(adminClient, newsItem, {
                        unitName: '2',
                        unitType: FLAT_UNIT_TYPE,
                        property: { connect: { id: property.id } },
                    })

                    const deletedAt = (new Date()).toISOString()
                    const payload = [scope1.id, scope2.id].map(scopeId => ({
                        id: scopeId,
                        data: {
                            dv: 1,
                            sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                            deletedAt,
                        },
                    }))
                    const updatedScopes = await NewsItemScope.updateMany(staffClient, payload)
                    expect(updatedScopes).toEqual(
                        expect.arrayContaining([
                            expect.objectContaining({ id: scope1.id, deletedAt: expect.stringContaining('') }),
                            expect.objectContaining({ id: scope2.id, deletedAt: expect.stringContaining('') }),
                        ])
                    )
                })

                test('employee cannot if he has not access to all organizations', async () => {
                    const { organization, role, property } = await makeEmployeeUserClientWithAbilities({ canManageNewsItems: false, canReadNewsItems: false })
                    await createTestOrganizationEmployee(adminClient, organization, staffClient.user, role)
                    const [newsItem] = await createTestNewsItem(adminClient, organization)

                    const [scope1] = await createTestNewsItemScope(adminClient, dummyNewsItem, {
                        unitName: '1',
                        unitType: FLAT_UNIT_TYPE,
                        property: { connect: { id: dummyProperty.id } },
                    })
                    const [scope2] = await createTestNewsItemScope(adminClient, newsItem, {
                        unitName: '2',
                        unitType: FLAT_UNIT_TYPE,
                        property: { connect: { id: property.id } },
                    })

                    const deletedAt = (new Date()).toISOString()
                    const payload = [scope1.id, scope2.id].map(scopeId => ({
                        id: scopeId,
                        data: {
                            dv: 1,
                            sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                            deletedAt,
                        },
                    }))
                    await expectToThrowAccessDeniedErrorToObjects(async () => {
                        await NewsItemScope.updateMany(staffClient, payload)
                    })
                })
            })

            describe('update', () => {
                test('employee cannot', async () => {
                    const { organization, role, property } = await makeEmployeeUserClientWithAbilities({ canManageNewsItems: true, canReadNewsItems: true })
                    await createTestOrganizationEmployee(adminClient, organization, staffClient.user, role)
                    const [newsItem] = await createTestNewsItem(adminClient, organization)

                    const [scope1] = await createTestNewsItemScope(adminClient, dummyNewsItem, {
                        unitName: '1',
                        unitType: FLAT_UNIT_TYPE,
                        property: { connect: { id: dummyProperty.id } },
                    })
                    const [scope2] = await createTestNewsItemScope(adminClient, newsItem, {
                        unitName: '2',
                        unitType: FLAT_UNIT_TYPE,
                        property: { connect: { id: property.id } },
                    })

                    const payload = [
                        { id: scope1.id, data: getScopePayload(null, null, null, '11') },
                        { id: scope2.id, data: getScopePayload(null, null, null, '22') },
                    ]
                    await expectToThrowAccessDeniedErrorToObjects(async () => {
                        await NewsItemScope.updateMany(staffClient, payload)
                    })
                })
            })
        })
    })

    describe('Validation tests', () => {
        test('Should have correct dv field (=== 1)', async () => {
            await expectToThrowGQLError(
                async () => await createTestNewsItemScope(adminClient, dummyNewsItem, {
                    property: { connect: { id: dummyProperty.id } },
                    dv: 42,
                }),
                {
                    'code': 'BAD_USER_INPUT',
                    'type': 'DV_VERSION_MISMATCH',
                    'message': 'Wrong value for data version number',
                    'mutation': 'createNewsItemScope',
                    'variable': ['data', 'dv'],
                },
            )
        })

        test('must throw an error on trying to create/edit scope for published news item', async () => {
            const [newsItem] = await createTestNewsItem(adminClient, dummyO10n)
            await createTestNewsItemScope(adminClient, newsItem)
            await publishTestNewsItem(adminClient, newsItem.id)

            await expectToThrowGQLError(
                async () => await createTestNewsItemScope(adminClient, newsItem, { property: { connect: { id: dummyProperty.id } } }),
                {
                    code: 'BAD_USER_INPUT',
                    type: 'EDIT_DENIED_PUBLISHED',
                    message: 'The published news item is restricted from editing',
                    messageForUser: 'api.newsItem.EDIT_DENIED_PUBLISHED',
                },
            )
        })

        test('must throw an error on trying to create/edit scope for sent news item', async () => {
            const [newsItem] = await createTestNewsItem(adminClient, dummyO10n)
            await createTestNewsItemScope(adminClient, newsItem)
            await publishTestNewsItem(adminClient, newsItem.id)

            // Emulate sending
            await updateTestNewsItem(adminClient, newsItem.id, { sentAt: dayjs().toISOString() })

            await expectToThrowGQLError(
                async () => await createTestNewsItemScope(adminClient, newsItem, { property: { connect: { id: dummyProperty.id } } }),
                {
                    code: 'BAD_USER_INPUT',
                    type: 'EDIT_DENIED_ALREADY_SENT',
                    message: 'The sent news item is restricted from editing',
                    messageForUser: 'api.newsItem.EDIT_DENIED_ALREADY_SENT',
                },
            )
        })

        test('must throw an when type value is not detected', async () => {
            const [newsItem] = await createTestNewsItem(adminClient, dummyO10n)
            await expectToThrowValidationFailureError(
                async () => await createTestNewsItemScope(adminClient, newsItem, { unitName: '1' }),
                'Required field "type" is null or undefined.',
            )
        })
    })
})
