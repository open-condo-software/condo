/**
 * Generated by `createservice news.ExportNewsRecipientsService --type mutations`
 */

const dayjs = require('dayjs')
const get = require('lodash/get')
const isEmpty = require('lodash/isEmpty')
const isNil = require('lodash/isNil')

const conf = require('@open-condo/config')
const { GQLError, GQLErrorCode: { INTERNAL_ERROR } } = require('@open-condo/keystone/errors')
const { GQLCustomSchema } = require('@open-condo/keystone/schema')
const { extractReqLocale } = require('@open-condo/locales/extractReqLocale')
const { i18n } = require('@open-condo/locales/loader')

const { NOT_FOUND } = require('@condo/domains/common/constants/errors')
const { createExportFile } = require('@condo/domains/common/utils/createExportFile')
const { getHeadersTranslations, EXPORT_TYPE_NEWS_RECIPIENTS } = require('@condo/domains/common/utils/exportToExcel')
const { loadListByChunks } = require('@condo/domains/common/utils/serverSchema')
const access = require('@condo/domains/news/access/ExportNewsRecipientsService')
const { Organization } = require('@condo/domains/organization/utils/serverSchema')
const { Property } = require('@condo/domains/property/utils/serverSchema')
const { Resident } = require('@condo/domains/resident/utils/serverSchema')


const getUnitsFromProperty = ({ map }) => (
    map?.sections?.reduce((acc, section) => ([
        ...acc,
        ...getUnitsFromSection(section),
    ]), []) || []
)

const getUnitsFromSection = (section) => section.floors.flatMap(floor => floor.units.map(unit => ({ unitName: unit.label, unitType: unit.unitType })))

const buildExportFile = async ({ rows, locale }) => {
    const YesMessage = i18n('Yes', { locale })
    const NoMessage = i18n('No', { locale })
    const HeaderMessage =  i18n('excelExport.sheetNames.newsRecipients', { locale })

    const processedRows = rows.reduce((acc, row) => {
        row.hasResident = row.hasResident ? YesMessage : NoMessage
        return [...acc, row]
    }, [])
    const { url: linkToFile } = await createExportFile({
        fileName: `news_recipients_${dayjs().format('DD_MM')}.xlsx`,
        templatePath: './domains/news/templates/NewsRecipientsExportTemplate.xlsx',
        replaces: {
            header: HeaderMessage,
            newsRecipients: processedRows,
            i18n: {
                ...getHeadersTranslations(EXPORT_TYPE_NEWS_RECIPIENTS, locale),
                sheetName: i18n('excelExport.sheetNames.newsRecipients', { locale }),
            },
        },
    })

    return linkToFile
}

/**
 * List of possible errors, that this custom schema can throw
 * They will be rendered in documentation section in GraphiQL for this custom schema
 */
const errors = {
    MISSING_PROPERTY: {
        mutation: 'exportNewsRecipients',
        code: INTERNAL_ERROR,
        type: NOT_FOUND,
        message: 'Could not found property related to newsItemScope',
        messageForUser: 'api.user.exportNewsRecipients.MISSING_PROPERTY',
    },
    WRONG_ORGANIZATION_ID: {
        mutation: 'exportNewsRecipients',
        code: INTERNAL_ERROR,
        type: NOT_FOUND,
        message: 'Could not found organization by provided id',
        messageForUser: 'api.user.exportNewsRecipients.WRONG_ORGANIZATION_ID',
    },
}

const ExportNewsRecipientsService = new GQLCustomSchema('ExportNewsRecipientsService', {
    types: [
        {
            access: true,
            type: 'input ExportNewsRecipientsInput { dv: Int!, sender: JSON!, organizationId: ID!, newsItemScopes: [NewsItemScopeWhereInput] }',
        },
        {
            access: true,
            type: 'type ExportNewsRecipientsOutput { status: String!, linkToFile: String! }',
        },
    ],
    
    mutations: [
        {
            access: access.canExportNewsRecipients,
            schema: 'exportNewsRecipients(data: ExportNewsRecipientsInput!): ExportNewsRecipientsOutput',
            resolver: async (parent, args, context, info, extra = {}) => {
                const { data: { newsItemScopes, organizationId } } = args
                const locale = extractReqLocale(context.req) || conf.DEFAULT_LOCALE

                const organization = await Organization.getOne(context, {
                    id: organizationId,
                    deletedAt: null,
                })
                if (!organization) throw new GQLError(errors.WRONG_ORGANIZATION_ID, context)

                let properties
                if (!isEmpty(newsItemScopes)) {
                    properties = newsItemScopes.map(newsItemScope => {
                        if (!isNil(newsItemScope.property)) return newsItemScope.property.id
                    })
                }


                let residentsByProperties
                if (!isEmpty(properties)) {
                    residentsByProperties = await loadListByChunks({
                        context: context,
                        list: Resident,
                        chunkSize: 50,
                        limit: 100000,
                        where: {
                            property: {
                                id_in: properties,
                            },
                            deletedAt: null,
                        },
                    })
                }

                const recipientsByOrganization = []
                if (organizationId && isEmpty(newsItemScopes)) {
                    const residentsByOrganization = await Resident.getAll(context, {
                        organization: {
                            id: organizationId,
                        },
                        deletedAt: null,
                    })

                    const propertiesByOrganization = await loadListByChunks({
                        context: context,
                        list: Property,
                        chunkSize: 50,
                        limit: 100000,
                        where: {
                            organization: {
                                id: organizationId,
                            },
                            deletedAt: null,
                        },
                    })

                    for (let property of propertiesByOrganization) {
                        const units = getUnitsFromProperty({ map: property.map })

                        const recipientsData = units.reduce((acc, unit) => {
                            if (residentsByOrganization.find((resident) => unit.unitName === resident.unitName)) {
                                acc.push({ address: property.address, unitName: unit.unitName, hasResident: true })
                                return [...acc]
                            }
                            acc.push({ address: property.address, unitName: unit.unitName, hasResident: false })
                            return [...acc]
                        }, [])
                        recipientsByOrganization.push(...recipientsData)
                    }



                }

                const recipientsByProperty = []
                const recipientsByUnitType = []
                const recipientsByUnitName = []
                if (!isEmpty(newsItemScopes)) {
                    for (let newsItemScope of newsItemScopes) {
                        if (get(newsItemScope, 'property.id')) {
                            const property = await Property.getOne(context, {
                                id: newsItemScope.property.id,
                                deletedAt: null,
                            })

                            const units = getUnitsFromProperty({ map: property.map })

                            if (!newsItemScope.unitName && !newsItemScope.unitType) {
                                const recipientsData = units.reduce((acc, unit) => {
                                    if (residentsByProperties.find((resident) => unit.unitName === resident.unitName)) {
                                        acc.push({ address: property.address, unitName: unit.unitName, hasResident: true })
                                        return [...acc]
                                    }
                                    acc.push({ address: property.address, unitName: unit.unitName, hasResident: false })
                                    return [...acc]
                                }, [])
                                recipientsByProperty.push(...recipientsData)
                            }

                            if (!newsItemScope.unitName && newsItemScope.unitType) {
                                const unitsFilteredByType = units.reduce((acc, unit) => {
                                    if (unit.unitType === newsItemScope.unitType) {
                                        acc.push(unit)
                                    }
                                    return [...acc]
                                }, [])

                                const recipientsData = unitsFilteredByType.reduce((acc, unit) => {
                                    if (residentsByProperties.find(resident => unit.unitName === resident.unitName)) {
                                        acc.push({ address: property.address, unitName: unit.unitName, hasResident: true })
                                        return [...acc]
                                    }
                                    acc.push({ address: property.address, unitName: unit.unitName, hasResident: false })
                                    return [...acc]
                                }, [])

                                recipientsByUnitType.push(...recipientsData)
                            }

                            if (!newsItemScope.unitType && newsItemScope.unitName) {
                                if (residentsByProperties.find(resident => resident.unitName === newsItemScope.unitName)) {
                                    recipientsByUnitName.push({ address: property.address, unitName: newsItemScope.unitName, hasResident: true })
                                }
                                recipientsByUnitName.push({ address: property.address, unitName: newsItemScope.unitName, hasResident: false })
                            }
                        }
                    }
                }

                const result = [...recipientsByOrganization, ...recipientsByProperty, ...recipientsByUnitType, ...recipientsByUnitName]

                const linkToFile = await buildExportFile({ rows: result, locale })

                return {
                    linkToFile,
                    status: 'OK',
                }
            },
        },
    ],
    
})

module.exports = {
    ExportNewsRecipientsService,
}
