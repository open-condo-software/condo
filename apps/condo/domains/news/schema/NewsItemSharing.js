/**
 * Generated by `createschema news.NewsItemSharing 'b2bApp:Relationship:B2BApp:CASCADE; newsItem:Relationship:NewsItem:CASCADE; sharingParams:Json; status:Select:processing,published,moderation,declined,archive; statusMessage:Text; lastGetRecipientsRequest:Json; lastPostRequest:Json; lastGetStatusRequest:Json; publicationViewsCount:Integer;'`
 */

const { Text, Relationship, Select } = require('@keystonejs/fields')

const { Json } = require('@open-condo/keystone/fields')
const { historical, versioned, uuided, tracked, softDeleted, dvAndSender } = require('@open-condo/keystone/plugins')
const { GQLListSchema, getById } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/news/access/NewsItemSharing')
const { STATUSES, ALLOWED_TRANSITIONS } = require('@condo/domains/news/constants/newsItemSharingStatuses')
const publishSharedNewsItem = require('@condo/domains/news/tasks/publishSharedNewsItem')

const NewsItemSharing = new GQLListSchema('NewsItemSharing', {
    schemaDoc: 'Existence of this models means that certain NewsItem should published in certain B2BApp that implements NewsSharing API.',
    fields: {

        b2bAppContext: {
            schemaDoc: 'Connection to the miniapp that is responsible for publishing this news item',
            type: Relationship,
            ref: 'B2BAppContext',
            isRequired: true,
            knexOptions: { isNotNullable: true }, // Required relationship only!
            kmigratorOptions: { null: false, on_delete: 'models.CASCADE' },
            access: {
                create: true,
                read: true,
                update: false,
            },
        },

        newsItem: {
            schemaDoc: 'Connection to the published news item',
            type: Relationship,
            ref: 'NewsItem',
            isRequired: true,
            knexOptions: { isNotNullable: true }, // Required relationship only!
            kmigratorOptions: { null: false, on_delete: 'models.CASCADE' },
            access: {
                create: true,
                read: true,
                update: false,
            },
        },

        sharingParams: {
            schemaDoc: 'Sending parameters specific to a particular mini-app',
            type: Json,
            isRequired: false,
            access: {
                create: true,
                read: true,
                update: false,
            },
        },

        status: {
            schemaDoc: 'Publication status of the news: updated automatically',
            type: Select,
            options: 'scheduled,processing,published,declined',
            isRequired: true,
            defaultValue: 'scheduled',
        },

        statusMessage: {
            schemaDoc: 'Explanations regarding the publication status. Might be shown to user',
            type: Text,
            isRequired: false,
        },

        lastPostRequest: {
            schemaDoc: 'The outcome from the most recent invocation of the lastPostRequest',
            type: Json,
            isRequired: false,
        },
    },

    hooks: {
        validateInput: async (args) => {
            const { resolvedData, existingItem, operation } = args
            const resultItemData = { ...existingItem, ...resolvedData }

            // Check if b2bAppContext support NewsSharing
            if (operation === 'create') {
                const b2bAppContext = await getById('B2BAppContext', resultItemData.b2bAppContext)
                const b2bApp = await getById('B2BApp', b2bAppContext.app)
                if (!b2bApp.newsSharingConfig) {
                    throw new Error('B2BAppContext do not support news sharing')
                }
            }

            // Check if status transition is correct:
            if (operation === 'update') {
                const oldStatus = existingItem.status
                const newStatus = resolvedData.status
                if (newStatus && !ALLOWED_TRANSITIONS[oldStatus].includes(newStatus)) {
                    throw new Error('You cannot use this status transition')
                }
            }
        },

        /**
         * It is not guaranteed that NewsItemSharing will be created before NewsItem is published,
         * We mitigate it by explicitly checking whether the related NewsItem had been published and publishing NewsItemSharing if it true
         */
        afterChange: async ({ updatedItem }) => {
            if (updatedItem.status === STATUSES.SCHEDULED) {
                const newsItem = await getById('NewsItem', updatedItem.newsItem)
                if (newsItem.isPublished) {
                    await publishSharedNewsItem.delay(updatedItem.id)
                }
            }
        },
    },

    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical()],
    access: {
        read: access.canReadNewsItemSharings,
        create: access.canManageNewsItemSharings,
        update: access.canManageNewsItemSharings,
        delete: false,
        auth: true,
    },
})

module.exports = {
    NewsItemSharing,
}
