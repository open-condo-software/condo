/**
 * Generated by `createschema news.NewsItemFile 'newsItem:Relationship:NewsItem:CASCADE; file:File;'`
 */

const path = require('path')

const { faker } = require('@faker-js/faker')
const dayjs = require('dayjs')

const conf = require('@open-condo/config')
const { FileRecord } = require('@open-condo/files/schema/utils/testSchema')
const {
    makeLoggedInAdminClient,
    makeClient,
    UUID_RE,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
    getUploadingFile, getRandomString, waitFor, expectToThrowAccessDeniedErrorToObjects, DATETIME_RE,
    expectToThrowValidationFailureError,
} = require('@open-condo/keystone/test.utils')

const {
    NewsItem,
    NewsItemFile,
    createTestNewsItemFile,
    updateTestNewsItemFile,
    createTestNewsItem,
} = require('@condo/domains/news/utils/testSchema')
const {
    createTestOrganization,
    createTestOrganizationEmployeeRole,
    createTestOrganizationEmployee,
} = require('@condo/domains/organization/utils/testSchema')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestResident } = require('@condo/domains/resident/utils/testSchema')
const {
    makeClientWithSupportUser,
    makeClientWithResidentUser,
    makeClientWithServiceUser,
    makeClientWithStaffUser,
} = require('@condo/domains/user/utils/testSchema')

const { FLAT_UNIT_TYPE } = require('../../property/constants/common')
const { SENDING_DELAY_SEC } = require('../constants/common')
const { createTestNewsItemScope, publishTestNewsItem } = require('../utils/testSchema')


const TEST_FILE = path.resolve(conf.PROJECT_ROOT, 'apps/condo/domains/common/test-assets/dino.png')


describe('NewsItemFile', () => {
    let admin, support, anonymous
    let staffWithPermissions, staffWithoutPermissions, staffFromOtherOrg, resident, serviceUser
    let organization, otherOrganization
    let newsItem

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()

        staffWithPermissions = await makeClientWithStaffUser()
        staffWithoutPermissions = await makeClientWithStaffUser()
        staffFromOtherOrg = await makeClientWithStaffUser()
        resident = await makeClientWithResidentUser()
        serviceUser = await makeClientWithServiceUser()

        const [org] = await createTestOrganization(admin)
        const [org2] = await createTestOrganization(admin)

        organization = org
        otherOrganization = org2

        const [roleWithAccess] = await createTestOrganizationEmployeeRole(admin, organization, {
            canManageNewsItems: true,
            canReadNewsItems: true,
        })

        const [roleWithoutAccess] = await createTestOrganizationEmployeeRole(admin, organization, {
            canManageNewsItems: false,
            canReadNewsItems: false,
        })

        const [roleOtherOrg] = await createTestOrganizationEmployeeRole(admin, otherOrganization, {
            canManageNewsItems: true,
            canReadNewsItems: true,
        })

        await createTestOrganizationEmployee(admin, organization, staffWithPermissions.user, roleWithAccess)
        await createTestOrganizationEmployee(admin, organization, staffWithoutPermissions.user, roleWithoutAccess)
        await createTestOrganizationEmployee(admin, otherOrganization, staffFromOtherOrg.user, roleOtherOrg)

        const [createdNewsItem] = await createTestNewsItem(admin, organization)
        await createTestNewsItemScope(admin, createdNewsItem)
        const [newsItemPublished] = await publishTestNewsItem(admin, createdNewsItem.id)
        newsItem = newsItemPublished
    })

    describe('Accesses', () => {
        describe('Create', () => {
            it('anonymous can not', async () => {
                const fileMeta = {
                    user: { id: admin.user.id },
                    fileClientId: 'condo',
                    modelNames: ['NewsItemFile'],
                    dv: 1, sender: { dv: 1, fingerprint: 'test-utils' },
                }
                const file = await getUploadingFile(TEST_FILE, fileMeta, admin)

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestNewsItemFile(anonymous, newsItem, organization,  { file })
                })
            })

            it('admin can', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)

                expect(item.id).toMatch(UUID_RE)
                expect(item.newsItem.id).toEqual(newsItem.id)
                expect(item.file).toBeDefined()
            })

            it('support can not', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemFile(support, newsItem, organization)
                })
            })

            it('staff with canManageNewsItems can', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)

                expect(item.id).toMatch(UUID_RE)
                expect(item.newsItem.id).toEqual(newsItem.id)
            })

            it('staff without canManageNewsItems can not', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemFile(staffWithoutPermissions, newsItem, organization)
                })
            })

            it('staff from other organization can not', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemFile(staffFromOtherOrg, newsItem, organization)
                })
            })

            it('resident can not', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemFile(resident, newsItem, organization)
                })
            })

            it('service user can not', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemFile(serviceUser, newsItem, organization)
                })
            })
        })

        describe('Read', () => {
            let newsItemFile

            beforeAll(async () => {
                [newsItemFile] = await createTestNewsItemFile(admin, newsItem, organization)
            })

            it('anonymous can not', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await NewsItemFile.getAll(anonymous, { id: newsItemFile.id })
                })
            })

            it('admin can', async () => {
                const items = await NewsItemFile.getAll(admin, { id: newsItemFile.id })
                expect(items).toHaveLength(1)
            })

            it('support can', async () => {
                const items = await NewsItemFile.getAll(support, { id: newsItemFile.id })
                expect(items).toHaveLength(1)
            })

            it('staff with canReadNewsItems can', async () => {
                const items = await NewsItemFile.getAll(staffWithPermissions, { id: newsItemFile.id })
                expect(items).toHaveLength(1)
            })

            it('staff without canReadNewsItems can not', async () => {
                const items = await NewsItemFile.getAll(staffWithoutPermissions, { id: newsItemFile.id })
                expect(items).toHaveLength(0)
            })

            it('staff from other organization can not', async () => {
                const items = await NewsItemFile.getAll(staffFromOtherOrg, { id: newsItemFile.id })
                expect(items).toHaveLength(0)
            })

            describe('resident', () => {
                // let residentClient, property
                //
                // beforeAll(async () => {
                //     residentClient = await makeClientWithResidentUser()
                //     ;[property] = await createTestProperty(admin, organization)
                //     await createTestResident(admin, residentClient.user, property)
                // })

                it('can read published news item files for his property and for hit organization', async () => {
                    const residentClient = await makeClientWithResidentUser()
                    const residentClient2 = await makeClientWithResidentUser()
                    const [property] = await createTestProperty(admin, organization)
                    const [organization2] = await createTestOrganization(admin)
                    const [property2] = await createTestProperty(admin, organization2)

                    const unitType1 = FLAT_UNIT_TYPE
                    const unitName1 = getRandomString()

                    await createTestResident(admin, residentClient.user, property, {
                        unitType: unitType1,
                        unitName: unitName1,
                    })
                    await createTestResident(admin, residentClient2.user, property2, {
                        unitType: unitType1,
                        unitName: unitName1,
                    })

                    const [newsItem] = await createTestNewsItem(
                        admin,
                        organization,
                    )
                    const [createdNewsItemFile] = await createTestNewsItemFile(admin, newsItem, organization)
                    await createTestNewsItemScope(admin, newsItem, {
                        property: { connect: { id: property.id } },
                        unitType: unitType1,
                        unitName: unitName1,
                    })

                    {
                        const newsItemFile = await NewsItemFile.getAll(residentClient, { id: createdNewsItemFile.id })
                        expect(newsItemFile).toHaveLength(0)
                    }

                    await publishTestNewsItem(admin, newsItem.id)

                    await waitFor(async () => {
                        const newsItems1 = await NewsItem.getAll(residentClient, { id: newsItem.id })

                        expect(newsItems1).toHaveLength(1)
                    }, { delay: (SENDING_DELAY_SEC + 4) * 1000 })

                    const newsItemFile = await NewsItemFile.getAll(residentClient, { id: createdNewsItemFile.id })
                    expect(newsItemFile).toHaveLength(1)

                    const newsItemFile2 = await NewsItemFile.getAll(residentClient2, { id: createdNewsItemFile.id })
                    expect(newsItemFile2).toHaveLength(0)
                })

                it('can not read unpublished news item', async () => {
                    const residentClient = await makeClientWithResidentUser()
                    const [property] = await createTestProperty(admin, organization)

                    const unitType1 = FLAT_UNIT_TYPE
                    const unitName1 = getRandomString()

                    await createTestResident(admin, residentClient.user, property, {
                        unitType: unitType1,
                        unitName: unitName1,
                    })

                    const [newsItem] = await createTestNewsItem(
                        admin,
                        organization,
                    )
                    const [createdNewsItemFile] = await createTestNewsItemFile(admin, newsItem, organization)

                    await createTestNewsItemScope(admin, newsItem, {
                        property: { connect: { id: property.id } },
                        unitType: unitType1,
                        unitName: unitName1,
                    })

                    const newsItemFile = await NewsItemFile.getAll(residentClient, { id: createdNewsItemFile.id })
                    expect(newsItemFile).toHaveLength(0)
                })

                it('can not read not send news item', async () => {
                    const residentClient = await makeClientWithResidentUser()
                    const [property] = await createTestProperty(admin, organization)

                    const unitType1 = FLAT_UNIT_TYPE
                    const unitName1 = getRandomString()

                    await createTestResident(admin, residentClient.user, property, {
                        unitType: unitType1,
                        unitName: unitName1,
                    })

                    const [newsItem] = await createTestNewsItem(
                        admin,
                        organization,
                        { sendAt: dayjs().add(1, 'day').toISOString() },
                    )
                    const [createdNewsItemFile] = await createTestNewsItemFile(admin, newsItem, organization)

                    await createTestNewsItemScope(admin, newsItem, {
                        property: { connect: { id: property.id } },
                        unitType: unitType1,
                        unitName: unitName1,
                    })

                    await publishTestNewsItem(admin, newsItem.id)

                    const newsItemFile = await NewsItemFile.getAll(residentClient, { id: createdNewsItemFile.id })
                    expect(newsItemFile).toHaveLength(0)
                })
            })

            it('service user can not read', async () => {
                await expectToThrowAccessDeniedErrorToObjects(async () => {
                    await NewsItemFile.getAll(serviceUser, { id: newsItemFile.id })
                })
            })
        })

        describe('Update', () => {
            it('anonymous can not', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestNewsItemFile(anonymous, item.id)
                })
            })

            it('admin can', async () => {
                const fileMeta = {
                    user: { id: admin.user.id },
                    fileClientId: 'condo',
                    modelNames: ['NewsItemFile'],
                    dv: 1, sender: { dv: 1, fingerprint: 'test-utils' },
                }
                const file = await getUploadingFile(TEST_FILE, fileMeta, admin)

                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                const [updatedFile] = await updateTestNewsItemFile(admin, item.id, { file })

                expect(updatedFile.v).toEqual(2)
            })

            it('support can not', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemFile(support, item.id)
                })
            })

            it('staff with canManageNewsItems can', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)
                const [updatedFile] = await updateTestNewsItemFile(staffWithPermissions, item.id)
                expect(updatedFile.v).toEqual(2)
            })

            it('staff without canManageNewsItems can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemFile(staffWithoutPermissions, item.id)
                })
            })

            it('staff from other organization can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemFile(staffFromOtherOrg, item.id)
                })
            })

            it('resident can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemFile(resident, item.id)
                })
            })

            it('service user can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemFile(serviceUser, item.id)
                })
            })
        })

        describe('Soft delete', () => {
            it('anonymous can not', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await NewsItemFile.softDelete(anonymous, item.id)
                })
            })

            it('admin can', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                const [deletedFile] = await NewsItemFile.softDelete(admin, item.id)
                expect(deletedFile.deletedAt).not.toBeNull()
                expect(deletedFile.deletedAt).toMatch(DATETIME_RE)
            })

            it('support can not', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemFile.softDelete(support, item.id)
                })
            })

            it('staff with canManageNewsItems can', async () => {
                const [item] = await createTestNewsItemFile(staffWithPermissions, newsItem, organization)
                const [deletedFile] = await NewsItemFile.softDelete(staffWithPermissions, item.id)
                expect(deletedFile.deletedAt).not.toBeNull()
                expect(deletedFile.deletedAt).toMatch(DATETIME_RE)
            })

            it('staff without canManageNewsItems can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemFile.softDelete(staffWithoutPermissions, item.id)
                })
            })

            it('staff from other organization can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemFile.softDelete(staffFromOtherOrg, item.id)
                })
            })

            it('resident can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemFile.softDelete(resident, item.id)
                })
            })

            it('service user can not', async () => {
                const [item] = await createTestNewsItemFile(admin, newsItem, organization)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemFile.softDelete(serviceUser, item.id)
                })
            })
        })
    })

    describe('Validations', () => {
        it('file is required', async () => {
            await expectToThrowValidationFailureError(async () => {
                await createTestNewsItemFile(admin, newsItem, organization, {
                    file: undefined,
                })
            }, 'Required field "file" is null or undefined.')
        })
    })
})
