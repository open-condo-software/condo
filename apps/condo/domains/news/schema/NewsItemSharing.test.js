/**
 * Generated by `createschema news.NewsItemSharing 'b2bApp:Relationship:B2BApp:CASCADE; newsItem:Relationship:NewsItem:CASCADE; sharingParams:Json; status:Select:processing,published,moderation,declined,archive; statusMessage:Text; lastGetRecipientsRequest:Json; lastPostRequest:Json; lastGetStatusRequest:Json; publicationViewsCount:Integer;'`
 */
const { faker } = require('@faker-js/faker')

const { makeLoggedInAdminClient, makeClient, expectValuesOfCommonFields, catchErrorFrom,
    waitFor,
    initTestExpressApp,
    getTestExpressApp, expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')


const { _internalScheduleTaskByNameByTestClient } = require('@condo/domains/common/utils/testSchema')
const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const { createTestB2BAppNewsSharingConfig, createTestB2BApp, createTestB2BAppContext } = require('@condo/domains/miniapp/utils/testSchema')
const { SENDING_DELAY_SEC } = require('@condo/domains/news/constants/common')
const { ALLOWED_TRANSITIONS, STATUSES } = require('@condo/domains/news/constants/newsItemSharingStatuses')
const { NewsItem, NewsItemSharing, createTestNewsItemSharing, updateTestNewsItemSharing } = require('@condo/domains/news/utils/testSchema')
const { createTestNewsItem, createTestNewsItemScope, publishTestNewsItem } = require('@condo/domains/news/utils/testSchema')
const { NewsSharingTestingApp, FAULTY_PUBLISH_URL_500, SUCCESS_PUBLISH_URL } = require('@condo/domains/news/utils/testSchema/NewsSharingTestingApp')
const { createTestOrganization } = require('@condo/domains/organization/utils/testSchema')
const { createTestOrganizationEmployeeRole, createTestOrganizationEmployee } = require('@condo/domains/organization/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

const { ERRORS } = require('./NewsItemSharing')



describe('NewsItemSharing', () => {

    let admin
    let support
    let anonymous
    let user
    let staffWithPermissions
    let staffWOPermissions

    let dummyO10n

    let dummyB2BContext

    let dummyNewsItem
    let dummyPublishedNewsItem
    let dummyNewsItemSharing

    let testExpressAppBaseUrl

    let successB2BAppNewsSharingContext
    let failingB2BAppNewsSharingContext

    initTestExpressApp('NewsSharing', new NewsSharingTestingApp().prepareMiddleware())

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()
        user = await makeClientWithNewRegisteredAndLoggedInUser()
        staffWOPermissions = await makeClientWithNewRegisteredAndLoggedInUser()
        staffWithPermissions = await makeClientWithNewRegisteredAndLoggedInUser()

        const [o10n] = await createTestOrganization(admin)

        const [canManageNewsItemsRole] = await createTestOrganizationEmployeeRole(admin, o10n, { canManageNewsItems: true, canReadNewsItems: true })
        await createTestOrganizationEmployee(admin, o10n, staffWithPermissions.user, canManageNewsItemsRole)

        const [emptyRole] = await createTestOrganizationEmployeeRole(admin, o10n)
        await createTestOrganizationEmployee(admin, o10n, staffWOPermissions.user, emptyRole)

        const testExpressApp = getTestExpressApp('NewsSharing')
        testExpressAppBaseUrl = testExpressApp.baseUrl

        // Success config
        const [B2BAppNewsSharingConfig] = await createTestB2BAppNewsSharingConfig(admin, {
            publishUrl: `${testExpressAppBaseUrl}${SUCCESS_PUBLISH_URL}`,
        })
        const [B2BApp] = await createTestB2BApp(admin, { contextDefaultStatus: CONTEXT_FINISHED_STATUS, newsSharingConfig: { connect: { id: B2BAppNewsSharingConfig.id } } })
        const [B2BContext] = await createTestB2BAppContext(admin, B2BApp, o10n)

        // This config returns 500 on every /publish request
        const [failingB2BAppNewsSharingConfig] = await createTestB2BAppNewsSharingConfig(admin, {
            publishUrl: `${testExpressAppBaseUrl}${FAULTY_PUBLISH_URL_500}`,
        })
        const [failingNewsSharingConfigB2BApp] = await createTestB2BApp(admin, { contextDefaultStatus: CONTEXT_FINISHED_STATUS, newsSharingConfig: { connect: { id: failingB2BAppNewsSharingConfig.id } } })
        const [failingNewsSharingConfigB2BContext] = await createTestB2BAppContext(admin, failingNewsSharingConfigB2BApp, o10n)

        const [newsItem] = await createTestNewsItem(admin, o10n, {
            title: 'ðŸš§ Planned Water Outage Notification ðŸš§',
            body: 'We are conducting a planned water outage on September 25 2023 The outage will last approximately 4 hours',
        })
        await createTestNewsItemScope(admin, newsItem)

        const [publishedNewsItem] = await createTestNewsItem(admin, o10n, {
            title: 'ðŸš§ Planned Water Outage Notification ðŸš§',
            body: 'We are conducting a planned water outage on September 25 2023 The outage will last approximately 4 hours',
        })
        await createTestNewsItemScope(admin, publishedNewsItem)
        await publishTestNewsItem(admin, publishedNewsItem.id)

        const [newsItemSharing] = await createTestNewsItemSharing(admin, B2BContext, newsItem)

        dummyO10n = o10n
        dummyB2BContext = B2BContext
        dummyNewsItem = newsItem
        dummyPublishedNewsItem = publishedNewsItem
        dummyNewsItemSharing = newsItemSharing

        successB2BAppNewsSharingContext = dummyB2BContext
        failingB2BAppNewsSharingContext = failingNewsSharingConfigB2BContext
    })

    describe('CRUD tests', () => {

        describe('create', () => {
            test('admin can', async () => {
                const [obj, attrs] = await createTestNewsItemSharing(admin, dummyB2BContext, dummyNewsItem)

                expectValuesOfCommonFields(obj, attrs, admin)
                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.b2bAppContext.id).toEqual(dummyB2BContext.id)
            })

            test('support can', async () => {
                const [obj, attrs] = await createTestNewsItemSharing(support, dummyB2BContext, dummyNewsItem)

                expectValuesOfCommonFields(obj, attrs, support)
                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.b2bAppContext.id).toEqual(dummyB2BContext.id)
            })

            test('staff with permissions can', async () => {
                const [obj, attrs] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem)

                expectValuesOfCommonFields(obj, attrs, staffWithPermissions)
                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.b2bAppContext.id).toEqual(dummyB2BContext.id)
            })

            test('staff w\\o permissions can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemSharing(staffWOPermissions, dummyB2BContext, dummyNewsItem)
                })
            })

            test('user can\'t', async () => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestNewsItemSharing(user, dummyB2BContext, dummyNewsItem)
                })
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestNewsItemSharing(anonymous, dummyB2BContext, dummyNewsItem)
                })
            })
        })

        describe('update', () => {

            const payload = { statusMessage: 'test' }

            test('admin can', async () => {
                const [objCreated] = await createTestNewsItemSharing(admin, dummyB2BContext, dummyNewsItem)

                const [obj] = await updateTestNewsItemSharing(admin, objCreated.id, payload)

                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.b2bAppContext.id).toEqual(dummyB2BContext.id)
                expect(obj.statusMessage).toEqual('test')
            })

            test('newsItem can not be updated', async () => {
                const [objCreated] = await createTestNewsItemSharing(admin, dummyB2BContext, dummyNewsItem)

                // TODO(pahaz): DOMA-10368 use expectToThrowGraphQLRequestError
                await catchErrorFrom(
                    async () => await updateTestNewsItemSharing(admin, objCreated.id, { newsItem: { connect: { id: dummyPublishedNewsItem } } }),
                    (error) => {
                        expect(error.errors[0].name).toEqual('UserInputError')
                        expect(error.errors[0].message).toContain('Field "newsItem" is not defined by type "NewsItemSharingUpdateInput"')
                    }
                )
            })

            test('b2bAppContext can not be updated', async () => {
                const [objCreated] = await createTestNewsItemSharing(admin, dummyB2BContext, dummyNewsItem)

                await catchErrorFrom(
                    async () => await updateTestNewsItemSharing(admin, objCreated.id, { b2bAppContext: { connect: { id: dummyB2BContext } } }),
                    (error) => {
                        expect(error.errors[0].name).toEqual('UserInputError')
                        expect(error.errors[0].message).toContain('Field "b2bAppContext" is not defined by type "NewsItemSharingUpdateInput"')
                    }
                )
            })

            test('support can', async () => {
                const [objCreated] = await createTestNewsItemSharing(support, dummyB2BContext, dummyNewsItem)

                const [obj] = await updateTestNewsItemSharing(support, objCreated.id, payload)

                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.b2bAppContext.id).toEqual(dummyB2BContext.id)
                expect(obj.statusMessage).toEqual('test')
            })

            test('staff with permissions can', async () => {
                const [objCreated] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem)

                const [obj] = await updateTestNewsItemSharing(staffWithPermissions, objCreated.id, payload)

                expect(obj.newsItem.id).toEqual(dummyNewsItem.id)
                expect(obj.b2bAppContext.id).toEqual(dummyB2BContext.id)
                expect(obj.statusMessage).toEqual('test')
            })

            test('staff w\\o permissions can\'t', async () => {
                const [objCreated] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemSharing(staffWOPermissions, objCreated.id, payload)
                })
            })

            test('user can\'t', async () => {
                const [objCreated] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem)
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestNewsItemSharing(user, objCreated.id, payload)
                })
            })

            test('anonymous can\'t', async () => {
                const [objCreated] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem)
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestNewsItemSharing(anonymous, objCreated.id, payload)
                })
            })

            test('should allow to make change published status to error', async () => {
                const [newsItemSharing] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem, {
                    status: STATUSES.PUBLISHED,
                })

                const [obj] = await updateTestNewsItemSharing(admin, newsItemSharing.id, { status: STATUSES.ERROR })

                expect(obj.status).toEqual(STATUSES.ERROR)
            })
        })

        describe('hard delete', () => {
            test('admin can\'t', async () => {
                const admin = await makeLoggedInAdminClient()
                const [objCreated] = await createTestNewsItemSharing(admin, dummyB2BContext, dummyNewsItem)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await NewsItemSharing.delete(admin, objCreated.id)
                })
            })
        })

        describe('read', () => {
            test('admin can', async () => {
                const objs = await NewsItemSharing.getAll(admin, { id: dummyNewsItemSharing.id })

                expect(objs).toHaveLength(1)
                expect(objs).toEqual(expect.arrayContaining([
                    expect.objectContaining(dummyNewsItemSharing),
                ]))
            })

            test('support can', async () => {
                const objs = await NewsItemSharing.getAll(support, { id: dummyNewsItemSharing.id })

                expect(objs).toHaveLength(1)
                expect(objs).toEqual(expect.arrayContaining([
                    expect.objectContaining(dummyNewsItemSharing),
                ]))
            })

            test('staff with permissions can', async () => {
                const objs =    await NewsItemSharing.getAll(staffWithPermissions, { id: dummyNewsItemSharing.id })

                expect(objs).toHaveLength(1)
                expect(objs).toEqual(expect.arrayContaining([
                    expect.objectContaining(dummyNewsItemSharing),
                ]))
            })

            test('staff w\\o permissions can\'t', async () => {
                const objs = await NewsItemSharing.getAll(staffWOPermissions, { id: dummyNewsItemSharing.id })

                expect(objs).toHaveLength(0)
            })

            test('user can\'t', async () => {
                const objs = await NewsItemSharing.getAll(user, { id: dummyNewsItemSharing.id })

                expect(objs).toHaveLength(0)
            })

            test('anonymous can\'t', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await NewsItemSharing.getAll(anonymous, { id: dummyNewsItemSharing.id })
                })
            })
        })
    })

    describe('Validation tests', () => {
        test('should not allow to create NewsItemSharing if b2bAppContext do not support news sharing', async () => {
            const [B2BApp] = await createTestB2BApp(admin)
            const [B2BContext] = await createTestB2BAppContext(admin, B2BApp, dummyO10n)

            await expectToThrowGQLError(
                async () => await createTestNewsItemSharing(admin, B2BContext, dummyPublishedNewsItem),
                ERRORS.B2B_APP_CONTEXT_DOES_NOT_SUPPORT_NEWS_SHARING
            )
        })

        describe('should allow to make correct status transitions', () => {
            // Get all allowed transitions: *[ SCHEDULED -> PROCESSING ]
            const cases = Object.entries(ALLOWED_TRANSITIONS).flatMap(([fromStatus, allowedTransitions]) =>
                allowedTransitions.map(toStatus => [fromStatus, toStatus])
            )
            
            test.each(cases)('%p -> %p', async (fromStatus, toStatus) => {
                const [newsItemSharing] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem, {
                    status: fromStatus,
                })

                const [upd] = await updateTestNewsItemSharing(admin, newsItemSharing.id, {
                    status: toStatus,
                })

                expect(upd.status).toEqual(toStatus)
            })
        })

        describe('should not allow to make wrong transitions', () => {
            const extraAttrForCases = [
                { statusMessage: faker.random.alphaNumeric(5) },
                { lastPostRequest: faker.random.alphaNumeric(5) },
            ]

            test.each(extraAttrForCases)('should not allow to change published news', async (extraAttr) => {
                const [newsItemSharing] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem, {
                    status: STATUSES.PUBLISHED,
                })

                await expectToThrowGQLError(
                    async () => await updateTestNewsItemSharing(admin, newsItemSharing.id, extraAttr),
                    ERRORS.CANT_CHANGE_PUBLISHED_NEWS_ITEM_SHARINGS
                )
            })

            // Get all non-allowed transitions: *[ SCHEDULED -> PUBLISHED ]
            const cases = Object.entries(ALLOWED_TRANSITIONS).flatMap(([fromStatus, allowedTransitions]) => {
                return Object.keys(ALLOWED_TRANSITIONS).map(toStatus => {
                    if (fromStatus !== toStatus && !allowedTransitions.includes(toStatus)) {
                        return [fromStatus, toStatus]
                    }
                    return null
                }).filter(Boolean)
            })
            
            test.each(cases)('%p -> %p', async (fromStatus, toStatus) => {
                const [newsItemSharing] = await createTestNewsItemSharing(staffWithPermissions, dummyB2BContext, dummyNewsItem, {
                    status: fromStatus,
                })
                
                await expectToThrowGQLError(
                    async () => await updateTestNewsItemSharing(admin, newsItemSharing.id, { 
                        status: toStatus,
                    }),
                    ERRORS.BAD_STATUS_TRANSITION
                )
            })
        })
    })

    describe('Real life tests', () => {

        test.skip('NewsItemSharing is sent if created on a published and sent NewsItem', async () => {
            const [newsItem] = await createTestNewsItem(admin, dummyO10n, {
                title: 'ðŸš§ Planned Water Outage Notification ðŸš§',
                body: 'We are conducting a planned water outage on September 25 2023 The outage will last approximately 4 hours',
            })
            await createTestNewsItemScope(admin, newsItem)
            await publishTestNewsItem(admin, newsItem.id)
            await waitFor(async () => {
                const [res] = await _internalScheduleTaskByNameByTestClient(admin, { taskName: 'notifyResidentsAboutDelayedNewsItem' })
                expect(res.id).toBeDefined()
            }, { delay: (SENDING_DELAY_SEC + 2) * 1000 })

            await waitFor(async () => {
                const createdNewsItem = await NewsItem.getOne(admin, { id: newsItem.id })
                expect(createdNewsItem.sentAt).toBeDefined()
            }, { delay: (SENDING_DELAY_SEC + 2) * 1000 })

            const [obj, attrs] = await createTestNewsItemSharing(admin, successB2BAppNewsSharingContext, newsItem)

            await waitFor(
                async () => {
                    const newsItemSharing = await NewsItemSharing.getOne(admin, { id: obj.id })
                    expect(newsItemSharing.status).toEqual(STATUSES.PUBLISHED)
                },
                { delay: (SENDING_DELAY_SEC + 2) * 1000, timeout: 1000 * 60 * 2, interval: 3000 }
            )

            expectValuesOfCommonFields(obj, attrs, admin)
            expect(obj.newsItem.id).toEqual(dummyPublishedNewsItem.id)
            expect(obj.b2bAppContext.id).toEqual(successB2BAppNewsSharingContext.id)
        })

        test('NewsItemSharing is sent if created on an unpublished NewsItem, that is later published', async () => {
            const [newsItem] = await createTestNewsItem(admin, dummyO10n, {
                title: 'ðŸš§ Planned Water Outage Notification ðŸš§',
                body: 'We are conducting a planned water outage on September 25 2023 The outage will last approximately 4 hours',
            })
            await createTestNewsItemScope(admin, newsItem)

            const [obj, attrs] = await createTestNewsItemSharing(admin, successB2BAppNewsSharingContext, newsItem)

            const newsItemSharing = await NewsItemSharing.getOne(admin, { id: obj.id })
            expect(newsItemSharing.status).toEqual(STATUSES.SCHEDULED)

            await publishTestNewsItem(admin, newsItem.id)

            await waitFor(async () => {
                const [res] = await _internalScheduleTaskByNameByTestClient(admin, { taskName: 'publishDelayedSharedNewsItems' })
                expect(res.id).toBeDefined()
            }, { delay: (SENDING_DELAY_SEC + 2) * 1000 })

            await waitFor(
                async () => {
                    const newsItemSharing = await NewsItemSharing.getOne(admin, { id: obj.id })
                    expect(newsItemSharing.status).toEqual(STATUSES.PUBLISHED)
                },
                { delay: (SENDING_DELAY_SEC + 2) * 1000, timeout: 1000 * 60 * 5, interval: 3000 }
            )

            expectValuesOfCommonFields(obj, attrs, admin)
        })

        test('NewsItemSharing correctly resets to status error if failed to send', async () => {
            const [newsItem] = await createTestNewsItem(admin, dummyO10n, {
                title: 'ðŸš§ Planned Water Outage Notification ðŸš§',
                body: 'We are conducting a planned water outage on September 25 2023 The outage will last approximately 4 hours',
            })
            await createTestNewsItemScope(admin, newsItem)

            const [obj, attrs] = await createTestNewsItemSharing(admin, failingB2BAppNewsSharingContext, newsItem)

            const newsItemSharing = await NewsItemSharing.getOne(admin, { id: obj.id })
            expect(newsItemSharing.status).toEqual(STATUSES.SCHEDULED)

            await publishTestNewsItem(admin, newsItem.id)

            await waitFor(async () => {
                const [res] = await _internalScheduleTaskByNameByTestClient(admin, { taskName: 'publishDelayedSharedNewsItems' })
                expect(res.id).toBeDefined()
            }, { delay: (SENDING_DELAY_SEC + 2) * 1000 })

            await waitFor(
                async () => {
                    const newsItemSharing = await NewsItemSharing.getOne(admin, { id: obj.id })
                    expect(newsItemSharing.status).toEqual(STATUSES.ERROR)
                },
                { delay: 3000, timeout: 1000 * 60 * 5, interval: 3000 }
            )

            expectValuesOfCommonFields(obj, attrs, admin)
        })
    })
})
