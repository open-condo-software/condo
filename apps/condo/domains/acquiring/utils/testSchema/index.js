/**
 * Generated by `createschema acquiring.AcquiringIntegration 'name:Text;'`
 * In most cases you should not change it by hands
 * Please, don't remove `AUTOGENERATE MARKER`s
 */
const faker = require('faker')
const {createTestProperty} = require("@condo/domains/property/utils/testSchema");
const { createTestResident } = require("@condo/domains/resident/utils/testSchema");
const {
    createTestBillingIntegration,
    createTestBillingIntegrationOrganizationContext,
    createTestBillingAccount,
    createTestBillingProperty,
    createTestBillingReceipt,
} = require("@condo/domains/billing/utils/testSchema");
const {makeClientWithNewRegisteredAndLoggedInUser} = require("@condo/domains/user/utils/testSchema");
const {createTestOrganizationEmployee, createTestOrganizationEmployeeRole} = require("@condo/domains/organization/utils/testSchema");

const { generateGQLTestUtils } = require('@condo/domains/common/utils/codegeneration/generate.test.utils')
const { MULTIPAYMENT_INIT_STATUS } = require('../../constants')
const { makeLoggedInAdminClient } = require('@core/keystone/test.utils')
const { registerNewOrganization } = require('@condo/domains/organization/utils/testSchema/organization')

const { AcquiringIntegration: AcquiringIntegrationGQL } = require('@condo/domains/acquiring/gql')
const { AcquiringIntegrationAccessRight: AcquiringIntegrationAccessRightGQL } = require('@condo/domains/acquiring/gql')
const { AcquiringIntegrationContext: AcquiringIntegrationContextGQL } = require('@condo/domains/acquiring/gql')
const { MultiPayment: MultiPaymentGQL } = require('@condo/domains/acquiring/gql')
/* AUTOGENERATE MARKER <IMPORT> */

const AcquiringIntegration = generateGQLTestUtils(AcquiringIntegrationGQL)
const AcquiringIntegrationAccessRight = generateGQLTestUtils(AcquiringIntegrationAccessRightGQL)
const AcquiringIntegrationContext = generateGQLTestUtils(AcquiringIntegrationContextGQL)
const MultiPayment = generateGQLTestUtils(MultiPaymentGQL)
/* AUTOGENERATE MARKER <CONST> */

function getRandomHiddenCard() {
    const prefix = Math.floor(Math.random() * 9000 + 1000)
    const suffix = Math.floor(Math.random() * 9000 + 1000)
    return `${prefix}********${suffix}`
}

async function createTestAcquiringIntegration (client, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const name = faker.company.companyName().replace(/ /, '-').toUpperCase() + ' TEST ACQUIRING'
    const attrs = {
        dv: 1,
        sender,
        name,
        ...extraAttrs,
    }
    const obj = await AcquiringIntegration.create(client, attrs)
    return [obj, attrs]
}

async function updateTestAcquiringIntegration (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await AcquiringIntegration.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestAcquiringIntegrationAccessRight (client, integration, user, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!integration || !integration.id) throw new Error('no integration')
    if (!user || !user.id) throw new Error('no user')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const attrs = {
        dv: 1,
        sender,
        integration: { connect: {id: integration.id } },
        user: { connect: { id: user.id } },
        ...extraAttrs,
    }
    const obj = await AcquiringIntegrationAccessRight.create(client, attrs)
    return [obj, attrs]
}

async function updateTestAcquiringIntegrationAccessRight (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await AcquiringIntegrationAccessRight.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestAcquiringIntegrationContext (client, organization, integration, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!organization || !organization.id) throw new Error('no organization.id')
    if (!integration || !integration.id) throw new Error('no integration.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const settings = { dv: 1 }
    const state = { dv: 1 }

    const attrs = {
        dv: 1,
        sender,
        integration: { connect: { id: integration.id } },
        organization: { connect: { id: organization.id } },
        settings,
        state,
        ...extraAttrs,
    }
    const obj = await AcquiringIntegrationContext.create(client, attrs)
    return [obj, attrs]
}

async function updateTestAcquiringIntegrationContext (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await AcquiringIntegrationContext.update(client, id, attrs)
    return [obj, attrs]
}

async function makeAcquiringContext () {
    const admin = await makeLoggedInAdminClient()
    const [integration] = await createTestAcquiringIntegration(admin)
    const [organization] = await registerNewOrganization(admin)
    const [context] = await createTestAcquiringIntegrationContext(admin, organization, integration)
    return context
}

async function makeAcquiringContextAndIntegrationManager() {
    const admin = await makeLoggedInAdminClient()
    const [integration] = await createTestAcquiringIntegration(admin)
    const [organization] = await registerNewOrganization(admin)
    const [context] = await createTestAcquiringIntegrationContext(admin, organization, integration)
    const client = await makeClientWithNewRegisteredAndLoggedInUser()
    const [role] = await createTestOrganizationEmployeeRole(admin, organization, {
        canManageIntegrations: true,
    })
    await createTestOrganizationEmployee(admin, organization, client.user, role)

    return {
        context,
        client
    }
}

async function makeAcquiringContextAndIntegrationAccount() {
    const admin = await makeLoggedInAdminClient()
    const [integration] = await createTestAcquiringIntegration(admin)
    const [organization] = await registerNewOrganization(admin)
    const [context] = await createTestAcquiringIntegrationContext(admin, organization, integration)
    const client = await makeClientWithNewRegisteredAndLoggedInUser()
    await createTestAcquiringIntegrationAccessRight(admin, integration, client.user)
    return {
        context,
        client
    }
}

async function createTestMultiPayment (client, receipts, resident, integration, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!receipts) throw new Error('no receipts')
    if (!resident) throw new Error('no resident')
    if (!integration) throw new Error('no integration')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const amount = String(receipts.reduce((acc, cur) => acc + parseFloat(cur.toPay), 0))
    const commission = String(Math.floor(Math.random() * 100) / 2)

    const attrs = {
        dv: 1,
        sender,
        amount,
        commission,
        currencyCode: 'RUB',
        serviceCategory: 'TEST DOCUMENT',
        status: MULTIPAYMENT_INIT_STATUS,
        resident: { connect: { id: resident.id } },
        receipts: receipts,
        integration: { connect: { id: integration.id } },
        ...extraAttrs,
    }
    const obj = await MultiPayment.create(client, attrs)
    return [obj, attrs]
}

async function updateTestMultiPayment (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await MultiPayment.update(client, id, attrs)
    return [obj, attrs]
}

// Utils used to generate bunch of entities for working with MultiPayments
async function makePayerFromClient (client, receiptsAmount = 1) {
    if (!client) throw new Error('No client')
    const admin = await makeLoggedInAdminClient()

    const [organization] = await registerNewOrganization(admin)
    const [property] = await createTestProperty(admin, organization)

    const [acquiringIntegration] = await createTestAcquiringIntegration(admin)
    const [acquiringContext] = await createTestAcquiringIntegrationContext(admin, organization, acquiringIntegration)

    const [billingIntegration] = await createTestBillingIntegration(admin)
    const [billingContext] = await createTestBillingIntegrationOrganizationContext(admin, organization, billingIntegration)
    const [billingProperty] = await createTestBillingProperty(admin, billingContext, {address: property.address})
    const [billingAccount] = await createTestBillingAccount(admin, billingContext, billingProperty)
    const billingReceipts = []
    for (let i = 0; i < receiptsAmount; i++) {
        const [receipt] = await createTestBillingReceipt(admin, billingContext, billingProperty, billingAccount)
        billingReceipts.push(receipt)
    }

    const [resident] = await createTestResident(admin, client.user, organization, property)

    return {
        organization,
        property,
        acquiringIntegration,
        acquiringContext,
        billingIntegration,
        billingContext,
        billingProperty,
        billingAccount,
        billingReceipts,
        resident
    }
}

/* AUTOGENERATE MARKER <FACTORY> */

module.exports = {
    AcquiringIntegration, createTestAcquiringIntegration, updateTestAcquiringIntegration,
    AcquiringIntegrationAccessRight, createTestAcquiringIntegrationAccessRight, updateTestAcquiringIntegrationAccessRight,
    AcquiringIntegrationContext, createTestAcquiringIntegrationContext, updateTestAcquiringIntegrationContext,
    MultiPayment, createTestMultiPayment, updateTestMultiPayment,
    makeAcquiringContext,
    makeAcquiringContextAndIntegrationAccount,
    makeAcquiringContextAndIntegrationManager,
    makePayerFromClient,
    getRandomHiddenCard
/* AUTOGENERATE MARKER <EXPORTS> */
}
