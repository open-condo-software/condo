/**
 * Generated by `createschema acquiring.PaymentWebhookDeliveryWhiteListItem`
 */

const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient,
    makeClient,
    UUID_RE,
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowAccessDeniedErrorToObjects,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const {
    PaymentWebhookDeliveryWhiteListItem,
    createTestPaymentWebhookDeliveryWhiteListItem,
    updateTestPaymentWebhookDeliveryWhiteListItem,
} = require('@condo/domains/acquiring/utils/testSchema')
const {
    makeClientWithSupportUser,
    makeClientWithNewRegisteredAndLoggedInUser,
} = require('@condo/domains/user/utils/testSchema')


describe('PaymentWebhookDeliveryWhiteListItem', () => {
    let adminClient
    let supportClient

    beforeAll(async () => {
        adminClient = await makeLoggedInAdminClient()
        supportClient = await makeClientWithSupportUser()
    })

    describe('CRUD', () => {
        describe('Create', () => {
            test('admin: can create PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                expect(item.id).toMatch(UUID_RE)
                expect(item.url).toContain('https://')
                expect(item.isEnabled).toBe(true)
            })

            test('support: can create PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(supportClient)

                expect(item.id).toMatch(UUID_RE)
                expect(item.isEnabled).toBe(true)
            })

            test('anonymous: cannot create PaymentWebhookDeliveryWhiteListItem', async () => {
                const anonymousClient = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestPaymentWebhookDeliveryWhiteListItem(anonymousClient)
                })
            })

            test('user: cannot create PaymentWebhookDeliveryWhiteListItem', async () => {
                const userClient = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestPaymentWebhookDeliveryWhiteListItem(userClient)
                })
            })

            test('should create with custom name and description', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                    name: 'Production Webhook',
                    description: 'Main webhook for production environment',
                })

                expect(item.name).toBe('Production Webhook')
                expect(item.description).toBe('Main webhook for production environment')
            })

            test('should create with isEnabled=false', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                    isEnabled: false,
                })

                expect(item.isEnabled).toBe(false)
            })
        })

        describe('Read', () => {
            test('admin: can read PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                const readItem = await PaymentWebhookDeliveryWhiteListItem.getOne(adminClient, { id: item.id })

                expect(readItem.id).toBe(item.id)
                expect(readItem.url).toBe(item.url)
            })

            test('support: can read PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                const readItem = await PaymentWebhookDeliveryWhiteListItem.getOne(supportClient, { id: item.id })

                expect(readItem.id).toBe(item.id)
            })

            test('anonymous: cannot read PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)
                const anonymousClient = await makeClient()

                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await PaymentWebhookDeliveryWhiteListItem.getOne(anonymousClient, { id: item.id })
                })
            })

            test('user: cannot read PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)
                const userClient = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObjects(async () => {
                    await PaymentWebhookDeliveryWhiteListItem.getOne(userClient, { id: item.id })
                })
            })
        })

        describe('Update', () => {
            test('admin: can update PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                const [updatedItem] = await updateTestPaymentWebhookDeliveryWhiteListItem(adminClient, item.id, {
                    name: 'Updated Name',
                    isEnabled: false,
                })

                expect(updatedItem.name).toBe('Updated Name')
                expect(updatedItem.isEnabled).toBe(false)
            })

            test('support: can update PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                const [updatedItem] = await updateTestPaymentWebhookDeliveryWhiteListItem(supportClient, item.id, {
                    description: 'Updated by support',
                })

                expect(updatedItem.description).toBe('Updated by support')
            })

            test('anonymous: cannot update PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)
                const anonymousClient = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestPaymentWebhookDeliveryWhiteListItem(anonymousClient, item.id, {
                        isEnabled: false,
                    })
                })
            })

            test('user: cannot update PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)
                const userClient = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestPaymentWebhookDeliveryWhiteListItem(userClient, item.id, {
                        isEnabled: false,
                    })
                })
            })
        })

        describe('Delete', () => {
            test('admin: cannot hard delete PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await PaymentWebhookDeliveryWhiteListItem.delete(adminClient, item.id)
                })
            })

            test('admin: can soft delete PaymentWebhookDeliveryWhiteListItem', async () => {
                const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient)

                const [deletedItem] = await updateTestPaymentWebhookDeliveryWhiteListItem(adminClient, item.id, {
                    deletedAt: new Date().toISOString(),
                })

                expect(deletedItem.deletedAt).not.toBeNull()

                // Should not be found in normal queries
                const foundItem = await PaymentWebhookDeliveryWhiteListItem.getOne(adminClient, { id: item.id })
                expect(foundItem).toBeUndefined()
            })
        })
    })

    describe('Constraints', () => {
        test('should enforce unique URL constraint', async () => {
            const url = `https://unique-test-${faker.random.alphaNumeric(10)}.com/webhook`

            await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, { url })

            await expect(async () => {
                await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, { url })
            }).rejects.toThrow()
        })

        test('should allow same URL after soft delete', async () => {
            const url = `https://reuse-test-${faker.random.alphaNumeric(10)}.com/webhook`

            const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, { url })

            // Soft delete
            await updateTestPaymentWebhookDeliveryWhiteListItem(adminClient, item.id, {
                deletedAt: new Date().toISOString(),
            })

            // Should be able to create with same URL
            const [newItem] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, { url })

            expect(newItem.id).not.toBe(item.id)
            expect(newItem.url).toBe(url)
        })

        test('should require valid HTTPS URL', async () => {
            const invalidUrl = `not-a-valid-url-${faker.datatype.uuid()}`
            await expectToThrowGQLError(async () => {
                await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                    url: invalidUrl,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_URL',
            })
        })

        test('should reject HTTP URLs (non-HTTPS)', async () => {
            const httpUrl = `http://example.com/webhook/${faker.datatype.uuid()}`
            await expectToThrowGQLError(async () => {
                await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                    url: httpUrl,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_URL',
            })
        })
    })

    describe('Querying', () => {
        test('can query by isEnabled', async () => {
            const [enabledItem] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                isEnabled: true,
            })
            const [disabledItem] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                isEnabled: false,
            })

            const enabledItems = await PaymentWebhookDeliveryWhiteListItem.getAll(adminClient, {
                isEnabled: true,
                id_in: [enabledItem.id, disabledItem.id],
            })

            expect(enabledItems).toHaveLength(1)
            expect(enabledItems[0].id).toBe(enabledItem.id)
        })

        test('can query by url', async () => {
            const url = `https://search-test-${faker.random.alphaNumeric(10)}.com/webhook`
            const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, { url })

            const items = await PaymentWebhookDeliveryWhiteListItem.getAll(adminClient, { url })

            expect(items).toHaveLength(1)
            expect(items[0].id).toBe(item.id)
        })

        test('can query by name contains', async () => {
            const uniqueName = `UniqueTestName-${faker.random.alphaNumeric(10)}`
            const [item] = await createTestPaymentWebhookDeliveryWhiteListItem(adminClient, {
                name: uniqueName,
            })

            const items = await PaymentWebhookDeliveryWhiteListItem.getAll(adminClient, {
                name_contains: 'UniqueTestName',
                id: item.id,
            })

            expect(items).toHaveLength(1)
            expect(items[0].name).toBe(uniqueName)
        })
    })
})
