/**
 * Generated by `createservice acquiring.SumPaymentsService`
 */

const { GQLCustomSchema } = require('@condo/keystone/schema')
const access = require('@condo/domains/acquiring/access/SumPaymentsService')
const { GqlWithKnexLoadList } = require('../../common/utils/serverSchema')
const Big = require('big.js')



const SumPaymentsService = new GQLCustomSchema('SumPaymentsService', {
    types: [
        {
            access: true,
            type: 'type SumPaymentsOutput { sum: String! }',
        },
    ],

    queries: [
        {
            access: access.canSumPayments,
            schema: 'sumPayments(where: PaymentWhereInput!): SumPaymentsOutput',
            resolver: async (parent, args, context, info, extra = {}) => {
                // TODO(codegen): write SumPaymentsService logic!
                const { where } = args
                // TODO: throw errors in a following way
                // throw new GQLError(errors.NAME_OF_ERROR_FOR_USAGE_INSIDE_THIS_MODULE_ONLY)
                const paymentLoader = new GqlWithKnexLoadList({
                    listKey: 'Payment',
                    fields: 'id',
                    where: where,
                })
                const idObjects = await paymentLoader.load()
                const aggregate = await paymentLoader.loadAggregate('SUM(amount) as "amountSum"', idObjects.map(({ id }) => id))
                const sum = Big(aggregate.amountSum || 0).toFixed(8)
                return {
                    sum: sum,
                }
            },
        },
    ],

})

module.exports = {
    SumPaymentsService,
}
