/**
 * Generated by `createschema settings.MobileFeatureConfig 'organization:Relationship:Organization:CASCADE; emergencyPhone:Text; commonPhone:Text; onlyGreaterThanPreviousMeterReadingIsEnabled:Checkbox; meta:Json; ticketSubmittingIsEnabled:Checkbox'`
 */

const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient,
    makeClient,
    UUID_RE,
    expectValuesOfCommonFields,
    expectToThrowUniqueConstraintViolationError,
    expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { HOT_WATER_METER_RESOURCE_ID } = require('@condo/domains/meter/constants/constants')
const { createTestMeter } = require('@condo/domains/meter/utils/testSchema')
const { SERVICE_PROVIDER_TYPE } = require('@condo/domains/organization/constants/common')
const {
    createTestOrganization,
    createTestOrganizationEmployee,
    createTestOrganizationEmployeeRole,
    registerNewOrganization,
} = require('@condo/domains/organization/utils/testSchema')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const {
    registerResidentByTestClient,
    registerServiceConsumerByTestClient,
} = require('@condo/domains/resident/utils/testSchema')
const {
    MobileFeatureConfig,
    createTestMobileFeatureConfig,
    updateTestMobileFeatureConfig,
} = require('@condo/domains/settings/utils/testSchema')
const {
    makeClientWithNewRegisteredAndLoggedInUser,
    makeClientWithSupportUser,
    makeClientWithResidentUser,
} = require('@condo/domains/user/utils/testSchema')

describe('MobileFeatureConfig', () => {
    let admin, support
    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
    })
    describe('CRUD tests', () => {
        describe('accesses', () => {
            describe('admin', () => {
                test('can create', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [obj, attrs] = await createTestMobileFeatureConfig(admin, organization)

                    expectValuesOfCommonFields(obj, attrs, admin)
                })

                test('can update', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [objCreated] = await createTestMobileFeatureConfig(admin, organization)

                    const [obj, attrs] = await updateTestMobileFeatureConfig(admin, objCreated.id)

                    expect(obj.dv).toEqual(1)
                    expect(obj.sender).toEqual(attrs.sender)
                    expect(obj.v).toEqual(2)
                    expect(obj.updatedBy).toEqual(expect.objectContaining({ id: admin.user.id }))
                })

                test('can\'t hard delete', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [objCreated] = await createTestMobileFeatureConfig(admin, organization)

                    await expectToThrowAccessDeniedErrorToObj(async () => {
                        await MobileFeatureConfig.delete(admin, objCreated.id)
                    })
                })

                test('can read', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [obj, attrs] = await createTestMobileFeatureConfig(admin, organization)

                    const objs = await MobileFeatureConfig.getAll(admin, {}, { sortBy: ['updatedAt_DESC'] })

                    expect(objs.length).toBeGreaterThanOrEqual(1)
                    expect(objs).toEqual(expect.arrayContaining([
                        expect.objectContaining({
                            id: obj.id,
                        }),
                    ]))
                })
            })

            describe('support', () => {
                test('can create', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [obj, attrs] = await createTestMobileFeatureConfig(support, organization)

                    expectValuesOfCommonFields(obj, attrs, support)
                })

                test('can update', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [objCreated] = await createTestMobileFeatureConfig(support, organization)

                    const [obj, attrs] = await updateTestMobileFeatureConfig(support, objCreated.id)

                    expect(obj.dv).toEqual(1)
                    expect(obj.sender).toEqual(attrs.sender)
                    expect(obj.v).toEqual(2)
                    expect(obj.updatedBy).toEqual(expect.objectContaining({ id: support.user.id }))
                })

                test('can\'t hard delete', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [objCreated] = await createTestMobileFeatureConfig(support, organization)

                    await expectToThrowAccessDeniedErrorToObj(async () => {
                        await MobileFeatureConfig.delete(support, objCreated.id)
                    })
                })

                test('can read', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [obj, attrs] = await createTestMobileFeatureConfig(support, organization)

                    const objs = await MobileFeatureConfig.getAll(support, {}, { sortBy: ['updatedAt_DESC'] })

                    expect(objs.length).toBeGreaterThanOrEqual(1)
                    expect(objs).toEqual(expect.arrayContaining([
                        expect.objectContaining({
                            id: obj.id,
                        }),
                    ]))
                })
            })

            describe('anonymous', () => {
                test('can\'t create', async () => {
                    const client = await makeClient()
                    await expectToThrowAuthenticationErrorToObj(async () => {
                        await createTestMobileFeatureConfig(client, { id: 'id' })
                    })
                })

                test('can\'t update', async () => {
                    const client = await makeClient()
                    await expectToThrowAuthenticationErrorToObj(async () => {
                        await updateTestMobileFeatureConfig(client, 'id')
                    })
                })

                test('can\'t hard delete', async () => {
                    const client = await makeClient()
                    await expectToThrowAccessDeniedErrorToObj(async () => {
                        await MobileFeatureConfig.delete(client, 'id')
                    })
                })

                test('can\'t read', async () => {
                    const client = await makeClient()
                    await expectToThrowAuthenticationErrorToObjects(async () => {
                        await MobileFeatureConfig.getAll(client, {}, { sortBy: ['updatedAt_DESC'] })
                    })
                })
            })

            describe('employee', () => {
                test('can create', async () => {
                    const client = await makeClientWithNewRegisteredAndLoggedInUser()
                    const [organization] = await createTestOrganization(admin)

                    const [role] = await createTestOrganizationEmployeeRole(admin, organization, {
                        canManageMobileFeatureConfigs: true,
                    })
                    await createTestOrganizationEmployee(admin, organization, client.user, role)

                    const [obj, attrs] = await createTestMobileFeatureConfig(client, organization)

                    expect(obj.id).toMatch(UUID_RE)
                    expect(obj.dv).toEqual(1)
                    expect(obj.sender).toEqual(attrs.sender)
                    expect(obj.createdBy).toEqual(expect.objectContaining({ id: client.user.id }))
                })

                test('can update', async () => {
                    const client = await makeClientWithNewRegisteredAndLoggedInUser()
                    const [organization] = await createTestOrganization(admin)

                    const [role] = await createTestOrganizationEmployeeRole(admin, organization, {
                        canManageMobileFeatureConfigs: true,
                    })
                    await createTestOrganizationEmployee(admin, organization, client.user, role)

                    const [objCreated] = await createTestMobileFeatureConfig(admin, organization)

                    const [obj, attrs] = await updateTestMobileFeatureConfig(client, objCreated.id)

                    expect(obj.id).toMatch(UUID_RE)
                    expect(obj.dv).toEqual(1)
                    expect(obj.sender).toEqual(attrs.sender)
                    expect(obj.v).toEqual(2)
                    expect(obj.updatedBy).toEqual(expect.objectContaining({ id: client.user.id }))
                })

                test('can\'t delete', async () => {
                    const client = await makeClientWithNewRegisteredAndLoggedInUser()

                    await expectToThrowAccessDeniedErrorToObj(async () => {
                        await MobileFeatureConfig.delete(client, 'id')
                    })
                })

                test('can read', async () => {
                    const client = await makeClientWithNewRegisteredAndLoggedInUser()
                    const [organization] = await createTestOrganization(admin)

                    const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
                    await createTestOrganizationEmployee(admin, organization, client.user, role)

                    const [objCreated] = await createTestMobileFeatureConfig(admin, organization)

                    const objs = await MobileFeatureConfig.getAll(client, {}, { sortBy: ['updatedAt_DESC'] })

                    expect(objs).toHaveLength(1)
                    expect(objs[0]).toMatchObject({
                        id: objCreated.id,
                    })
                })
            })

            describe('resident', () => {
                test('Can read config of managing company, he is linked to', async () => {
                    const manager = await makeClientWithNewRegisteredAndLoggedInUser()
                    const [managingCompany] = await registerNewOrganization(manager)
                    const [property] = await createTestProperty(manager, managingCompany)

                    const [managingConfig] = await createTestMobileFeatureConfig(manager, managingCompany)
                    expect(managingCompany).toHaveProperty('id')

                    const residentUser = await makeClientWithResidentUser()

                    const noResidenceConfigs = await MobileFeatureConfig.getAll(residentUser, {
                        organization: { id: managingCompany.id },
                    })

                    expect(noResidenceConfigs).toHaveLength(0)

                    const [resident] = await registerResidentByTestClient(residentUser, {
                        address: property.address,
                        addressMeta: property.addressMeta,
                    })
                    expect(resident).toHaveProperty(['organization', 'id'], managingCompany.id)

                    const residenceConfigs = await MobileFeatureConfig.getAll(residentUser, {
                        organization: { id: managingCompany.id },
                    })
                    expect(residenceConfigs).toEqual([
                        expect.objectContaining({ id: managingConfig.id }),
                    ])
                })
                test('Can read configs from organizations linked via ServiceConsumer', async () => {
                    const providerManager = await makeClientWithNewRegisteredAndLoggedInUser()
                    const [serviceProvider] = await registerNewOrganization(providerManager, {
                        type: SERVICE_PROVIDER_TYPE,
                    })
                    const [property] = await createTestProperty(providerManager, serviceProvider)

                    const [providerConfig] = await createTestMobileFeatureConfig(providerManager, serviceProvider)
                    expect(providerConfig).toHaveProperty('id')

                    const residentUser = await makeClientWithResidentUser()
                    const [resident] = await registerResidentByTestClient(residentUser, {
                        address: property.address,
                        addressMeta: property.addressMeta,
                    })
                    expect(resident).toHaveProperty('addressKey', property.addressKey)

                    const noConsumerConfigs = await MobileFeatureConfig.getAll(residentUser, {
                        organization: { id_in: [serviceProvider.id] },
                    })
                    expect(noConsumerConfigs).toHaveLength(0)

                    const accountNumber = faker.random.numeric()
                    const [meter] = await createTestMeter(providerManager, serviceProvider, property, { id: HOT_WATER_METER_RESOURCE_ID }, {
                        accountNumber,
                    })
                    expect(meter).toHaveProperty('accountNumber', accountNumber)

                    const [consumer] = await registerServiceConsumerByTestClient(residentUser, {
                        residentId: resident.id,
                        accountNumber,
                        organizationId: serviceProvider.id,
                    })
                    expect(consumer).toHaveProperty('id')

                    const consumerConfigs = await MobileFeatureConfig.getAll(residentUser, {
                        organization: { id_in: [serviceProvider.id] },
                    })
                    expect(consumerConfigs).toEqual([
                        expect.objectContaining({ id: providerConfig.id }),
                    ])
                })
            })
        })

        describe('Validation tests', () => {

            test('organization uniq constraint', async () => {
                const [organization] = await createTestOrganization(admin)

                await createTestMobileFeatureConfig(admin, organization, {
                    commonPhone: undefined,
                    ticketSubmittingIsDisabled: false,
                })

                await expectToThrowUniqueConstraintViolationError(
                    async () => await createTestMobileFeatureConfig(admin, organization, { ticketSubmittingIsDisabled: false }),
                    'mobilefeatureconfig_unique_organization',
                )
            })

            test('TICKET_SUBMITTING_PHONES_NOT_CONFIGURED', async () => {
                const [organization] = await createTestOrganization(admin)

                await expectToThrowGQLError(
                    async () => await createTestMobileFeatureConfig(admin, organization, {
                        commonPhone: undefined,
                        ticketSubmittingIsDisabled: true,
                    }),
                    {
                        code: 'BAD_USER_INPUT',
                        type: 'TICKET_SUBMITTING_PHONES_NOT_CONFIGURED',
                        message: 'commonPhone field not specified',
                    })
            })

            test('COMMON_PHONE_INVALID', async () => {
                const [organization] = await createTestOrganization(admin)

                await expectToThrowGQLError(
                    async () => await createTestMobileFeatureConfig(admin, organization, {
                        commonPhone: 'undefined',
                        ticketSubmittingIsDisabled: true,
                    }),
                    {
                        code: 'BAD_USER_INPUT',
                        type: 'WRONG_PHONE_FORMAT',
                        message: 'Wrong phone number format',
                    })
            })

            describe('contentConfiguration field validation', () => {
                test('should accept valid contentConfiguration with marketplace', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [obj] = await createTestMobileFeatureConfig(admin, organization, {
                        contentConfiguration: {
                            marketplace: {
                                appId: '1234-1234-1234-1234',
                            },
                        },
                    })

                    expect(obj.contentConfiguration).toEqual({
                        marketplace: {
                            appId: '1234-1234-1234-1234',
                        },
                    })
                })

                test('should accept empty contentConfiguration', async () => {
                    const [organization] = await createTestOrganization(admin)

                    const [obj] = await createTestMobileFeatureConfig(admin, organization, {
                        contentConfiguration: {},
                    })

                    expect(obj.contentConfiguration).toEqual({ marketplace: null })
                })

                test('should reject contentConfiguration with invalid marketplace appId type', async () => {
                    const [organization] = await createTestOrganization(admin)

                    await expectToThrowGQLError(
                        async () => await createTestMobileFeatureConfig(admin, organization, {
                            contentConfiguration: {
                                marketplace: {
                                    appId: 12345,
                                },
                            },
                        }),
                        {
                            code: 'BAD_USER_INPUT',
                            type: 'CONTENT_CONFIGURATION_INVALID',
                            message: '"contentConfiguration" field validation error. JSON was not in the correct format',
                        }
                    )
                })

                test('should update with valid contentConfiguration', async () => {
                    const [organization] = await createTestOrganization(admin)
                    const [objCreated] = await createTestMobileFeatureConfig(admin, organization)

                    const [objUpdated] = await updateTestMobileFeatureConfig(admin, objCreated.id, {
                        contentConfiguration: {
                            marketplace: {
                                appId: 'com.updated.app',
                            },
                        },
                    })

                    expect(objUpdated.contentConfiguration).toEqual({
                        marketplace: {
                            appId: 'com.updated.app',
                        },
                    })
                })
            })
        })
    })
})