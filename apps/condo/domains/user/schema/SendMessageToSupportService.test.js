/**
 * Generated by `createservice user.SendMessageToSupportService`
 */

const path = require('path')

const { faker } = require('@faker-js/faker')

const conf = require('@open-condo/config')
const { makeLoggedInAdminClient, UploadingFile, expectToThrowGQLErrorToResult } = require('@open-condo/keystone/test.utils')

const { RU_LOCALE } = require('@condo/domains/common/constants/locale')
const { MESSAGE_SENDING_STATUS } = require('@condo/domains/notification/constants/constants')
const { Message } = require('@condo/domains/notification/utils/testSchema')
const { registerNewOrganization } = require('@condo/domains/organization/utils/testSchema/Organization')
const { makeClientWithProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { makeClientWithResidentAccessAndProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestResident, createTestServiceConsumer } = require('@condo/domains/resident/utils/testSchema')
const { supportSendMessageToSupportByTestClient } = require('@condo/domains/user/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')
const { addResidentAccess } = require('@condo/domains/user/utils/testSchema')

const EMAIL_FROM = 'doma-test-message-to-support@mailforspam.com'

describe('SendMessageToSupportService', () => {
    test('with userAgent fallback', async () => {
        const residentClient = await makeClientWithResidentAccessAndProperty()
        const adminClient = await makeLoggedInAdminClient()
        await createTestResident(adminClient, residentClient.user, residentClient.property)

        const payload = {
            text: `Test message from resident to support. This message should be sent from ${EMAIL_FROM}`,
            emailFrom: EMAIL_FROM,
            os: 'android 8',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
        }

        const [result] = await supportSendMessageToSupportByTestClient(residentClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)
        const messages = await Message.getAll(adminClient, { id: result.id })
        expect(messages).toHaveLength(1)
        expect(messages[0].meta.userAgent).toBe('node-fetch/1.0 (+https://github.com/bitinn/node-fetch)')
    })

    test('with platform and userAgent', async () => {
        const residentClient = await makeClientWithResidentAccessAndProperty()
        const adminClient = await makeLoggedInAdminClient()
        await createTestResident(adminClient, residentClient.user, residentClient.property)

        const payload = {
            text: `Test message from resident to support. This message should be sent from ${EMAIL_FROM}`,
            emailFrom: EMAIL_FROM,
            os: 'android 8',
            app: 'appName',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            platform: 'android',
            userAgent: 'someUserAgentInfo',
        }

        const [result] = await supportSendMessageToSupportByTestClient(residentClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)
        const messages = await Message.getAll(adminClient, { id: result.id })
        expect(messages).toHaveLength(1)
        expect(messages[0].meta.app).toBe('appName')
        expect(messages[0].meta.platform).toBe('android')
        expect(messages[0].meta.userAgent).toBe('someUserAgentInfo')
    })

    test('with attachments, with emailFrom', async () => {
        const userClient = await makeClientWithProperty()
        const adminClient = await makeLoggedInAdminClient()
        await createTestResident(adminClient, userClient.user, userClient.property)

        const os = 'android v11'

        const payload = {
            os,
            attachments: [
                new UploadingFile(path.resolve(conf.PROJECT_ROOT, 'apps/condo/domains/common/test-assets/simple-text-file.txt')),
                new UploadingFile(path.resolve(conf.PROJECT_ROOT, 'apps/condo/domains/common/test-assets/dino.png')),
            ],
            text: `Test message from resident to support. This message should be sent from ${EMAIL_FROM} and contains an attachment.`,
            emailFrom: EMAIL_FROM, // email passed from mobile application
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            meta: {},
        }

        const [result] = await supportSendMessageToSupportByTestClient(userClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)

        const messages = await Message.getAll(adminClient, { id: result.id })
        expect(messages).toHaveLength(1)
        expect(messages[0].meta.attachments).toHaveLength(2)
        expect(messages[0].meta.os).toEqual(os)
    })

    test('no attachments, wrong email', async () => {
        const userClient = await makeClientWithNewRegisteredAndLoggedInUser()
        const payload = {
            text: 'Test with wrong email.',
            emailFrom: 'some-wrong_email',
            os: 'android 13',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            meta: {},
        }

        await expectToThrowGQLErrorToResult(
            async () => await supportSendMessageToSupportByTestClient(userClient, payload),
            {
                mutation: 'sendMessageToSupport',
                variable: ['data', 'emailFrom'],
                code: 'BAD_USER_INPUT',
                type: 'WRONG_FORMAT',
                message: 'Wrong format of specified email',
                messageForUser: 'api.user.sendMessageToSupport.WRONG_EMAIL_FORMAT',
            },
        )
    })

    test('no attachments', async () => {
        const residentClient = await makeClientWithResidentAccessAndProperty()
        const adminClient = await makeLoggedInAdminClient()
        await createTestResident(adminClient, residentClient.user, residentClient.property)

        const payload = {
            text: `Test message from resident to support. This message should be sent from ${EMAIL_FROM}`,
            emailFrom: EMAIL_FROM, // email passed from mobile application
            os: 'android 8',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            meta: {},
        }

        const [result] = await supportSendMessageToSupportByTestClient(residentClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)
        const messages = await Message.getAll(adminClient, { id: result.id })
        expect(messages).toHaveLength(1)
    })

    test('synthetic test with two organizations', async () => {
        const userClient = await makeClientWithProperty()
        const adminClient = await makeLoggedInAdminClient()
        const [organization] = await registerNewOrganization(userClient)
        const [property] = await createTestProperty(adminClient, organization)

        await createTestResident(adminClient, userClient.user, userClient.property)
        await createTestResident(adminClient, userClient.user, property)
        await addResidentAccess(userClient.user)

        const payload = {
            text: `Test message from resident to support. This message should be sent from ${EMAIL_FROM}. Resident must be attached to two organizations.`,
            emailFrom: EMAIL_FROM, // email passed from mobile application
            os: 'ios 15.1',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            meta: {},
        }

        const [result] = await supportSendMessageToSupportByTestClient(userClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)

        const messages = await Message.getAll(adminClient, { id: result.id })
        expect(messages).toHaveLength(1)
        expect(messages[0].meta.residentsExtraInfo).toHaveLength(2)
    })

    test('with two organizations and two service consumers', async () => {
        const userClient = await makeClientWithProperty()
        const adminClient = await makeLoggedInAdminClient()
        const [organization1] = await registerNewOrganization(userClient)
        const [organization2] = await registerNewOrganization(userClient)

        const [resident] = await createTestResident(adminClient, userClient.user, userClient.property, {
            unitName: faker.random.alphaNumeric(8),
        })
        await createTestServiceConsumer(adminClient, resident, organization1, {
            accountNumber: faker.random.alphaNumeric(8),
        })
        await createTestServiceConsumer(adminClient, resident, organization2, {
            accountNumber: faker.random.alphaNumeric(8),
        })
        await addResidentAccess(userClient.user)

        const payload = {
            text: `Test message from resident to support. This message should be sent from ${EMAIL_FROM}. Message must have residents extra info.`,
            emailFrom: EMAIL_FROM, // email passed from mobile application
            os: 'ios 15.1',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            meta: {},
        }

        const [result] = await supportSendMessageToSupportByTestClient(userClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)

        const messages = await Message.getAll(adminClient, { id: result.id })
        expect(messages).toHaveLength(1)
        const residentsExtraInfo = messages[0].meta.residentsExtraInfo[0]
        expect(residentsExtraInfo.address).not.toHaveLength(0)
        expect(residentsExtraInfo.organization).not.toBeFalsy()
        expect(residentsExtraInfo.unitName).not.toBeFalsy()
        const [serviceConsumer1, serviceConsumer2] = residentsExtraInfo.serviceConsumers
        expect(serviceConsumer1.organizationName).not.toEqual(serviceConsumer2.organizationName)
        expect(serviceConsumer1.accountNumber).not.toEqual(serviceConsumer2.accountNumber)
    })

    test('no attachments, no email', async () => {
        const userClient = await makeClientWithNewRegisteredAndLoggedInUser()
        const payload = {
            text: 'Test message from resident to support. In this message resident has not passed the email address, so the sender\'s email is default',
            os: 'android 12',
            appVersion: '0.0.1a',
            lang: RU_LOCALE,
            meta: {},
        }

        const [result] = await supportSendMessageToSupportByTestClient(userClient, payload)
        expect(result.status).toEqual(MESSAGE_SENDING_STATUS)
    })
})