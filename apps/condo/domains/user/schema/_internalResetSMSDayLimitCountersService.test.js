/**
 * Generated by `createservice user._internalResetSMSDayLimitCountersService`
 */

const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient,
    makeClient,
    expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult, expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const { CONFIRM_PHONE_COUNTER_PREFIX } = require('@condo/domains/user/constants/common')
const { ERRORS } = require('@condo/domains/user/schema/_internalResetSMSDayLimitCountersService')
const { RedisGuard } = require('@condo/domains/user/utils/serverSchema/guards')
const {
    _internalResetSMSDayLimitCountersByTestClient,
    createTestPhone,
    makeClientWithSupportUser,
    makeClientWithNewRegisteredAndLoggedInUser,
} = require('@condo/domains/user/utils/testSchema')


const redisGuard = new RedisGuard()
const COUNTER_VALUE_TO_UPDATE = 2

describe('_internalResetSMSDayLimitCountersService', () => {
    let userWithDirectAccess, admin, support, userWithoutDirectAccess, anonymous, phone

    beforeAll(async () => {
        userWithDirectAccess = await makeClientWithNewRegisteredAndLoggedInUser({
            rightsSet: {
                create: {
                    name: faker.lorem.words(3),
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    canExecute_internalResetSMSDayLimitCounters: true,
                },
            },
        })
        anonymous = await makeClient()
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        userWithoutDirectAccess = await makeClientWithNewRegisteredAndLoggedInUser()
    })

    beforeEach(async () => {
        phone = createTestPhone()
        const key = `${CONFIRM_PHONE_COUNTER_PREFIX}${phone}`

        for (let i = 0; i < COUNTER_VALUE_TO_UPDATE; i++)  {
            await redisGuard.incrementDayCounter(key)
        }
        const value = await redisGuard.getCounterValue(key)

        expect(Number(value)).toEqual(COUNTER_VALUE_TO_UPDATE)
    })

    describe('Access', () => {
        test('user with direct access (canExecute_internalResetSMSDayLimitCounters): can execute', async () => {
            const [data] = await _internalResetSMSDayLimitCountersByTestClient(userWithDirectAccess, {
                key: phone,
            })

            expect(data.ok).toEqual(true)
        })

        test('admin: can execute', async () => {
            await expectToThrowAccessDeniedErrorToResult(async () => {
                await _internalResetSMSDayLimitCountersByTestClient(admin, {
                    key: phone,
                })
            })
        })

        test('support: can not execute', async () => {
            await expectToThrowAccessDeniedErrorToResult(async () => {
                await _internalResetSMSDayLimitCountersByTestClient(support, {
                    key: phone,
                })
            })
        })

        test('user: can not execute', async () => {
            await expectToThrowAccessDeniedErrorToResult(async () => {
                await _internalResetSMSDayLimitCountersByTestClient(userWithoutDirectAccess, {
                    key: phone,
                })
            })
        })

        test('anonymous: can not execute', async () => {
            await expectToThrowAuthenticationErrorToResult(async () => {
                await _internalResetSMSDayLimitCountersByTestClient(anonymous, {
                    key: phone,
                })
            })
        })
    })

    describe('Logic', () => {
        test('reset counter by phone number', async () => {
            const key = `${CONFIRM_PHONE_COUNTER_PREFIX}${phone}`

            await _internalResetSMSDayLimitCountersByTestClient(userWithDirectAccess, {
                key: phone,
            })
            const value = await redisGuard.getCounterValue(key)

            expect(value).toBeNull()
        })

        test('reset counter by ip', async () => {
            const ip = faker.internet.ipv4()
            const key = `${CONFIRM_PHONE_COUNTER_PREFIX}${ip}`

            for (let i = 0; i < COUNTER_VALUE_TO_UPDATE; i++)  {
                await redisGuard.incrementDayCounter(key)
            }
            const beforeReset = await redisGuard.getCounterValue(key)

            expect(Number(beforeReset)).toEqual(COUNTER_VALUE_TO_UPDATE)

            await _internalResetSMSDayLimitCountersByTestClient(userWithDirectAccess, {
                key: ip,
            })
            const afterReset = await redisGuard.getCounterValue(key)

            expect(afterReset).toBeNull()
        })

        test('throws error if key is not valid ip or phone', async () => {
            const key = faker.random.alphaNumeric(8)
            for (let i = 0; i < COUNTER_VALUE_TO_UPDATE; i++)  {
                await redisGuard.incrementDayCounter(key)
            }
            const beforeReset = await redisGuard.getCounterValue(key)

            expect(Number(beforeReset)).toEqual(COUNTER_VALUE_TO_UPDATE)

            await expectToThrowGQLError(async () => {
                await _internalResetSMSDayLimitCountersByTestClient(userWithDirectAccess, {
                    key,
                })
            }, ERRORS.INVALID_KEY, 'result')
        })

        test('throws error if key is not exists', async () => {
            const phone = createTestPhone()

            await expectToThrowGQLError(async () => {
                await _internalResetSMSDayLimitCountersByTestClient(userWithDirectAccess, {
                    key: phone,
                })
            }, {
                ...ERRORS.KEY_NOT_FOUND,
                message: `Key '${phone}' does not exist.`,
            }, 'result')
        })
    })
})