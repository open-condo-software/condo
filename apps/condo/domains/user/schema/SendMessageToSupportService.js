/**
 * Generated by `createservice user.SendMessageToSupportService`
 */

const dayjs = require('dayjs')
const { get } = require('lodash')
const { v4: uuid } = require('uuid')

const conf = require('@open-condo/config')
const { GQLError, GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const FileAdapter = require('@open-condo/keystone/fileAdapter/fileAdapter')
const { getKVClient } = require('@open-condo/keystone/kv')
const { getLogger } = require('@open-condo/keystone/logging')
const { GQLCustomSchema } = require('@open-condo/keystone/schema')

const { WRONG_FORMAT } = require('@condo/domains/common/constants/errors')
const { LOCALES } = require('@condo/domains/common/constants/locale')
const { normalizeEmail } = require('@condo/domains/common/utils/mail')
const { MESSAGE_FORWARDED_TO_SUPPORT_TYPE } = require('@condo/domains/notification/constants/constants')
const { sendMessage } = require('@condo/domains/notification/utils/serverSchema')
const { Resident, ServiceConsumer } = require('@condo/domains/resident/utils/serverSchema')
const access = require('@condo/domains/user/access/SendMessageToSupportService')

const logger = getLogger()

const SUPPORT_EMAIL_MOBILE = conf['HELP_REQUISITES'] && get(JSON.parse(conf['HELP_REQUISITES']), 'support_email_mobile', null)
if (!SUPPORT_EMAIL_MOBILE) logger.warn('No HELP_REQUISITES.support_email_mobile!')

const fileAdapter = new FileAdapter('forwarded-emails-attachments')
const kv = getKVClient()

const APPEAL_NUMBER_KEY = 'send_message_to_support:appeal_number'

const ERRORS = {
    WRONG_EMAIL_FORMAT: {
        mutation: 'sendMessageToSupport',
        variable: ['data', 'emailFrom'],
        code: BAD_USER_INPUT,
        type: WRONG_FORMAT,
        message: 'Wrong format of specified email',
        messageForUser: 'api.user.sendMessageToSupport.WRONG_EMAIL_FORMAT',
    },
}

const SendMessageToSupportService = new GQLCustomSchema('SendMessageToSupportService', {
    types: [
        {
            access: true,
            type: `enum SendMessageToSupportLang { ${Object.keys(LOCALES).join(' ')} }`,
        },
        {
            access: true,
            type: 'input SendMessageToSupportInput { dv: Int!, sender: SenderFieldInput!, text: String!, emailFrom: String, attachments: [Upload], os: String!, appVersion: String!, lang: SendMessageToSupportLang!, meta: JSON! }',
        },
        {
            access: true,
            type: 'type SendMessageToSupportOutput { id: String!, status: String! }',
        },
    ],

    mutations: [
        {
            access: access.canSendMessageToSupport,
            schema: 'sendMessageToSupport(data: SendMessageToSupportInput!): SendMessageToSupportOutput',
            doc: {
                summary: 'If you have any problem you can use this to notify our support team',
                errors: ERRORS,
            },
            resolver: async (parent, args, context) => {
                const { data } = args
                const { dv, sender, text, emailFrom, attachments = [], os, appVersion, lang } = data

                if (!SUPPORT_EMAIL_MOBILE) throw new Error('Wrong server side support email configuration!')

                const user = get(context, ['req', 'user'])
                if (!user) throw new Error('You cant execute sendMessageToSupport without user context!')

                const normalizedEmailFrom = normalizeEmail(emailFrom)
                if (emailFrom && !normalizedEmailFrom) throw new GQLError(ERRORS.WRONG_EMAIL_FORMAT, context)

                const attachmentsData = await Promise.all(attachments)

                const filesPromises = attachmentsData.map((result) => {
                    const { filename: originalFilename, mimetype, encoding, createReadStream } = result
                    const stream = createReadStream()
                    return fileAdapter.save({
                        stream,
                        id: `${dayjs().format('YYYY-MM-DD_HH-mm-ss')}_${uuid()}`,
                        filename: originalFilename,
                    }).then(({ filename, id }) => {
                        const ret = {
                            encoding,
                            filename,
                            id,
                            mimetype,
                            originalFilename,
                            publicUrl: fileAdapter.publicUrl({ filename }),
                        }

                        if (fileAdapter.acl && fileAdapter.acl.generateUrl) {
                            ret.publicUrl = fileAdapter.acl.generateUrl({
                                filename: `${fileAdapter.folder}/${filename}`,
                                originalFilename,
                            })
                        }

                        return ret
                    })
                })

                const files = await Promise.all(filesPromises)

                const residents = await Resident.getAll(context,
                    { user: { id: user.id }, deletedAt: null },
                    'id address unitName organization { name tin }'
                )
                const serviceConsumers = await ServiceConsumer.getAll(context,
                    { resident: { id_in: residents.map(({ id }) => id) }, deletedAt: null },
                    'id resident { id } accountNumber organization { name }'
                )

                const residentsExtraInfo = []

                for (const resident of residents) {
                    const residentServiceConsumers = serviceConsumers.filter(({ resident: { id } }) => id === resident.id)

                    const residentInfo = { address: resident.address, unitName: resident.unitName, organization: null }

                    if (residentServiceConsumers) {
                        residentInfo.serviceConsumers = [...residentServiceConsumers.map(({ accountNumber, organization: { name: organizationName } }) => ({
                            accountNumber,
                            organizationName,
                        }))]
                    }

                    const { organization } = resident
                    if (organization) {
                        residentInfo.organization = { name: organization.name, tin: organization.tin }
                    }

                    residentsExtraInfo.push(residentInfo)
                }

                // NOTE: Used to generate unique subjects, so messages are not grouped by mailing server
                const appealNumber = await kv.incr(APPEAL_NUMBER_KEY)

                const messageAttrs = {
                    sender,
                    lang,
                    type: MESSAGE_FORWARDED_TO_SUPPORT_TYPE,
                    to: {
                        email: SUPPORT_EMAIL_MOBILE,
                    },
                    emailFrom: normalizedEmailFrom ? `${user.name} <${normalizedEmailFrom}>` : null,
                    meta: {
                        dv,
                        text,
                        residentsExtraInfo,
                        os,
                        appVersion,
                        attachments: files,
                        appealNumber,
                    },
                }

                const sendingResult = await sendMessage(context, messageAttrs)

                return {
                    id: sendingResult.id,
                    status: sendingResult.status,
                }
            },
        },
    ],

})

module.exports = {
    SendMessageToSupportService,
}
