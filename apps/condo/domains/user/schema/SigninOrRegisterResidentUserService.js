/**
 * Generated by `createservice user.SigninOrRegisterResidentUserService`
 */
const { GQLCustomSchema } = require('@core/keystone/schema')
const access = require('@condo/domains/user/access/SigninOrRegisterResidentUserService')
const {
    CONFIRM_PHONE_ACTION_EXPIRED,
} = require('@condo/domains/user/constants/errors')
const { ConfirmPhoneAction, User } = require('@condo/domains/user/utils/serverSchema')

const SigninOrRegisterResidentUserService = new GQLCustomSchema('SigninOrRegisterResidentUserService', {
    types: [
        {
            access: true,
            type: 'input SigninOrRegisterResidentUserInput { dv: Int!, sender: JSON!, token: String! }',
        },
        {
            access: true,
            type: 'type SigninOrRegisterResidentUserOutput { item: User, token: String! }',
        },
    ],

    mutations: [
        {
            access: access.canSigninOrRegisterResidentUser,
            schema: 'signinOrRegisterResidentUser(data: SigninOrRegisterResidentUserInput!): SigninOrRegisterResidentUserOutput',
            resolver: async (parent, args, context, info, extra = {}) => {
                const { data: { token } } = args
                const userData = {
                    type: 'resident',
                    isPhoneVerified: false,
                }
                const [action] = await ConfirmPhoneAction.getAll(context,
                    {
                        token,
                        completedAt: null,
                        isPhoneVerified: true,
                    }
                )
                if (!action) {
                    throw new Error(`${CONFIRM_PHONE_ACTION_EXPIRED}] Unable to find confirm phone action`)
                }
                userData.phone = action.phone
                userData.type = 'resident'
                userData.isPhoneVerified = true
                let [user] = await User.getAll(context, { type: 'resident', phone: userData.phone })
                if (!user) {
                    // TODO(zuch): fix bug when user can not be created with server utils becaues of createAt and updatedAt fields
                    // user = await User.create(context, userData)
                    const { data: userCreated, errors: createErrors } = await context.executeGraphQL({
                        context: context.createContext({ skipAccessControl: true }),
                        query: `
                            mutation create($data: UserCreateInput!) {
                            user: createUser(data: $data) {
                                id
                                name
                                email
                                isAdmin
                                isActive
                            }
                            }
                        `,
                        variables: { data: userData },
                    })
                    if (createErrors) {
                        const msg = '[error] Unable to create user'
                        throw new Error(msg)
                    }
                    // end
                    user = userCreated
                }
                await ConfirmPhoneAction.update(context, action.id, { completedAt: new Date().toISOString() })
                const sessionToken = await context.startAuthedSession({ item: user, list: context.lists['User'] })
                const result = {
                    item: user,
                    token: sessionToken,
                }
                return result
            },
        },
    ],

})

module.exports = {
    SigninOrRegisterResidentUserService,
}
