/**
 * Generated by `createservice user.SigninResidentUserService`
 */
const { GQLCustomSchema } = require('@core/keystone/schema')
const { getSchemaCtx } = require('@core/keystone/schema')
const access = require('@condo/domains/user/access/SigninResidentUserService')
const { ConfirmPhoneAction: ConfirmPhoneActionServerUtils, User: UserServerUtils } = require('@condo/domains/user/utils/serverSchema')
const { getRandomString } = require('@core/keystone/test.utils')
const { GQLError, GQLErrorCode: { BAD_USER_INPUT, INTERNAL_ERROR } } = require('@core/keystone/errors')
const { TOKEN_NOT_FOUND, UNABLE_TO_CREATE_USER } = require('../constants/errors')

/**
 * List of possible errors, that this custom schema can throw
 * They will be rendered in documentation section in GraphiQL for this custom schema
 */
const errors = {
    UNABLE_TO_FIND_CONFIRM_PHONE_ACTION: {
        mutation: 'signinResidentUser',
        variable: ['data', 'token'],
        code: BAD_USER_INPUT,
        type: TOKEN_NOT_FOUND,
        message: 'Unable to find a non-expired confirm phone action, that corresponds to provided token',
        messageForUser: 'api.user.signinResidentUser.TOKEN_NOT_FOUND',
    },
    UNABLE_TO_CREATE_USER: {
        code: INTERNAL_ERROR,
        type: UNABLE_TO_CREATE_USER,
        mutation: 'signinResidentUser',
        message: 'Something went wrong while trying to create a User record',
        messageForUser: 'api.user.signinResidentUser.UNABLE_TO_CREATE_USER',
    },
}

const SigninResidentUserService = new GQLCustomSchema('SigninResidentUserService', {
    types: [
        {
            access: true,
            type: 'input SigninResidentUserInput { dv: Int!, sender: SenderFieldInput!, token: String! }',
        },
        {
            access: true,
            type: 'type SigninResidentUserOutput { user: User, token: String! }',
        },
    ],

    mutations: [
        {
            access: access.canSigninResidentUser,
            schema: 'signinResidentUser(data: SigninResidentUserInput!): SigninResidentUserOutput',
            doc: {
                summary: 'Authenticates resident user for mobile apps',
                errors,
            },
            resolver: async (parent, args, context, info, extra = {}) => {
                const { data: { dv, sender, token } } = args
                const userData = {
                    dv,
                    sender,
                    type: 'resident',
                    isPhoneVerified: false,
                }
                const [action] = await ConfirmPhoneActionServerUtils.getAll(context,
                    {
                        token,
                        expiresAt_gte: new Date().toISOString(),
                        completedAt: null,
                        isPhoneVerified: true,
                    }
                )
                if (!action) {
                    throw new GQLError(errors.UNABLE_TO_FIND_CONFIRM_PHONE_ACTION, context)
                }
                userData.phone = action.phone
                userData.type = 'resident'
                userData.isPhoneVerified = true
                userData.password = getRandomString()
                let [user] = await UserServerUtils.getAll(context, { type: 'resident', phone: userData.phone })
                if (!user) {
                    // TODO(zuch): fix bug when user can not be created with server utils becaues of createAt and updatedAt fields
                    // user = await User.create(context, userData)
                    const { data: { result: createdUser }, errors: createErrors } = await context.executeGraphQL({
                        context: context.createContext({ skipAccessControl: true }),
                        query: `
                            mutation create($data: UserCreateInput!) {
                              result: createUser(data: $data) {
                                id
                                name
                              }
                            }
                        `,
                        variables: { data: userData },
                    })
                    if (createErrors) {
                        throw new GQLError(errors.UNABLE_TO_CREATE_USER, context)
                    }
                    user = createdUser
                }
                await ConfirmPhoneActionServerUtils.update(context, action.id, { completedAt: new Date().toISOString() })
                const { keystone } = await getSchemaCtx('User')
                const sessionToken = await context.startAuthedSession({ item: user, list: keystone.lists['User'] })
                const result = {
                    user,
                    token: sessionToken,
                }
                return result
            },
        },
    ],

})

module.exports = {
    SigninResidentUserService,
}
