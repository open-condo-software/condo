/**
 * Generated by `createservice user.ResetUserService --type mutations`
 */

const { GQLCustomSchema, getById, getSchemaCtx } = require('@core/keystone/schema')

const access = require('@condo/domains/user/access/ResetUserService')
const { DELETED_USER_NAME } = require('@condo/domains/user/constants')
const { User } = require('@condo/domains/user/utils/serverSchema')

const { DV_UNKNOWN_VERSION_ERROR, NOT_FOUND_ERROR } = require('@condo/domains/common/constants/errors')


const ResetUserService = new GQLCustomSchema('ResetUserService', {
    types: [
        {
            access: true,
            type: 'input ResetUserInput { dv: Int!, sender: JSON! id: String!}',
        },
    ],
    
    mutations: [
        {
            access: access.canResetUser,
            schema: 'resetUser(data: ResetUserInput!): User',
            resolver: async (parent, args, context, info, extra = {}) => {
                const { data } = args
                const { dv, id } = data

                if (dv !== 1) {
                    throw new Error(`${DV_UNKNOWN_VERSION_ERROR}dv] Unknown \`dv\``)
                }

                const user = await getById('User', id)
                if (!user) {
                    throw new Error(`${NOT_FOUND_ERROR}user] No user found for this id`)
                }


                const updatedUser = await User.update(context, id, {
                    phone: null,
                    email: null,
                    name: DELETED_USER_NAME,
                    isPhoneVerified: false,
                    isEmailVerified: false,
                })

                return updatedUser
            },
        },
    ],
    
})

module.exports = {
    ResetUserService,
}
