/**
 * Generated by `createservice user.RegisterNewServiceUserService`
 */
const crypto = require('crypto')

const conf = require('@open-condo/config')
const { GQLCustomSchema } = require('@open-condo/keystone/schema')

const { SERVICE_USER_CREATED_MESSAGE_TYPE } = require('@condo/domains/notification/constants/constants')
const { sendMessage } = require('@condo/domains/notification/utils/serverSchema')
const access = require('@condo/domains/user/access/RegisterNewServiceUserService')
const { SERVICE } = require('@condo/domains/user/constants/common')
const { User } = require('@condo/domains/user/utils/serverSchema')

const LOWER_LETTERS = 'abcdefghijklmnopqrstuvwxyz'
const UPPER_LETTERS = LOWER_LETTERS.toUpperCase()
const OTHER_CHARS = '01234567890'
const PASS_ALPHABET = LOWER_LETTERS + UPPER_LETTERS + OTHER_CHARS
const PASS_LENGTH = 32

function generateStrongPassword () {
    return [...Array(PASS_LENGTH)]
        .map(() => PASS_ALPHABET[crypto.randomInt(PASS_ALPHABET.length)])
        .join('')
}


const RegisterNewServiceUserService = new GQLCustomSchema('RegisterNewServiceUserService', {
    types: [
        {
            access: true,
            type: 'input RegisterNewServiceUserInput { dv: Int!, sender: SenderFieldInput!, name: String!, email: String!, meta: JSON }',
        },
        {
            access: true,
            type: 'type RegisterNewServiceUserOutput { id: ID!, email: String!, password: String! }',
        },
    ],
    
    mutations: [
        {
            access: access.canRegisterNewServiceUser,
            schema: 'registerNewServiceUser(data: RegisterNewServiceUserInput!): RegisterNewServiceUserOutput',
            resolver: async (parent, args, context) => {
                const userData = {
                    ...args.data,
                    type: SERVICE,
                    password: generateStrongPassword(),
                }

                const user = await User.create(context, userData)

                await sendMessage(context, {
                    to: { email: user.email },
                    type: SERVICE_USER_CREATED_MESSAGE_TYPE,
                    sender: args.data.sender,
                    meta: {
                        dv: 1,
                        data: {
                            email: user.email,
                            password: userData.password,
                            serverUrl: conf['SERVER_URL'],
                        },
                    },
                })

                return { id: user.id, email: user.email, password: userData.password }
            },
        },
    ],
    
})

module.exports = {
    RegisterNewServiceUserService,
    PASS_ALPHABET,
    PASS_LENGTH,
}
