/**
 * Generated by `createschema ticket.IncidentChange 'incident:Relationship:Incident:CASCADE;'`
 */
const get = require('lodash/get')

const conf = require('@open-condo/config')
const { versioned, uuided, tracked, dvAndSender, analytical } = require('@open-condo/keystone/plugins')
const { GQLListSchema, getById, find } = require('@open-condo/keystone/schema')
const { extractReqLocale } = require('@open-condo/locales/extractReqLocale')
const { getTranslations } = require('@open-condo/locales/loader')

const {
    generateChangeTrackableFieldsFrom,
    buildSetOfFieldsToTrackFrom,
} = require('@condo/domains/common/utils/serverSchema/changeTrackable')
const access = require('@condo/domains/ticket/access/IncidentChange')
const { OMIT_INCIDENT_CHANGE_TRACKABLE_FIELDS } = require('@condo/domains/ticket/constants')
const { Incident } = require('@condo/domains/ticket/schema/Incident')
const {
    incidentChangeDisplayNameResolversForSingleRelations,
    incidentRelatedManyToManyResolvers,
} = require('@condo/domains/ticket/utils/serverSchema/IncidentChange')
const { RESIDENT } = require('@condo/domains/user/constants/common')


const getTranslation = (translations, key) => {
    if (translations[key]) return translations[key]
    return key
}

const keysOfLocalizedTextFields = new Map()

const IncidentChange = new GQLListSchema('IncidentChange', {
    schemaDoc: 'Incremental changes of Incident',
    fields: {

        incident: {
            schemaDoc: 'Related incident, whose change is logged in this entity',
            type: 'Relationship',
            ref: 'Incident',
            isRequired: true,
            knexOptions: { isNotNullable: true }, // Required relationship only!
            kmigratorOptions: { null: false, on_delete: 'models.CASCADE' },
        },

        ...generateChangeTrackableFieldsFrom(
            buildSetOfFieldsToTrackFrom(Incident.schema, { except: OMIT_INCIDENT_CHANGE_TRACKABLE_FIELDS }),
            incidentChangeDisplayNameResolversForSingleRelations,
            incidentRelatedManyToManyResolvers,
            keysOfLocalizedTextFields,
        ),

        // TODO(DOMA-2567) duplicate from TicketChange
        changedByRole: {
            schemaDoc: 'Type of user who changed the incident, can be employee role from same organization or related, resident or deleted employee',
            type: 'Virtual',
            resolver: async (item, args, context) => {
                const locale = extractReqLocale(context.req) || conf.DEFAULT_LOCALE
                const translations = getTranslations(locale)

                const incident = await getById('Incident', item.incident)
                const userId = get(item, 'createdBy')
                if (!incident || !userId) return getTranslation(translations, 'pages.condo.ticket.TicketChanges.notice.DeletedCreatedAt.title')

                const user = await getById('User', userId)
                if (!user) return getTranslation(translations, 'pages.condo.ticket.TicketChanges.notice.DeletedCreatedAt.title')
                if (user.type === RESIDENT) return getTranslation(translations, 'Contact')

                const orgId = get(incident, 'organization', null)
                if (!orgId) return getTranslation(translations, 'DeletedEmployee')

                const orgEmployees = await find('OrganizationEmployee', {
                    organization: { id: orgId },
                    user: { id: userId },
                    deletedAt: null,
                    isBlocked: false,
                })

                if (orgEmployees.length) {
                    const roleID = orgEmployees[0].role
                    // TODO(DOMA-8919): Think about deleted roles
                    const role = await getById('OrganizationEmployeeRole', roleID)

                    return getTranslation(translations, role ? role.name : 'employee.role.unknownRole')
                }

                const links = await find('OrganizationLink', {
                    to: { id: orgId },
                })
                const relatedOrgIds = links.map(link => link.from).filter(Boolean)
                const relatedOrgEmployees = await find('OrganizationEmployee', {
                    organization: { id_in: relatedOrgIds },
                    user: { id: userId },
                    deletedAt: null,
                    isBlocked: false,
                })

                if (relatedOrgEmployees.length) {
                    const roleID = relatedOrgEmployees[0].role
                    // TODO(DOMA-8919): Think about deleted roles
                    const role = await getById('OrganizationEmployeeRole', roleID)

                    return getTranslation(translations, role ? role.name : 'employee.role.unknownRole')
                }

                return getTranslation(translations, 'DeletedEmployee')
            },
        },

    },
    plugins: [uuided(), versioned(), tracked(), dvAndSender(), analytical()],
    access: {
        read: access.canReadIncidentChanges,
        create: access.canManageIncidentChanges,
        update: access.canManageIncidentChanges,
        delete: false,
        auth: true,
    },
})

module.exports = {
    IncidentChange,
}
