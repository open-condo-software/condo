/**
 * Generated by `createservice ticket.CreateResidentTicketService --type mutations`
 */
const { Contact } = require('@condo/domains/contact/utils/serverSchema')
const { Property } = require('@condo/domains/property/utils/serverSchema')
const { Ticket } = require('../utils/serverSchema')
const { GQLCustomSchema } = require('@core/keystone/schema')
const access = require('@condo/domains/ticket/access/CreateResidentTicketService')
const { getSectionAndFloorByUnitName } = require('@condo/domains/ticket/utils/unit')

const TICKET_MOBILE_SOURCE_ID = '3068d49a-a45c-4c3a-a02d-ea1a53e1febb'

const CreateResidentTicketService = new GQLCustomSchema('CreateResidentTicketService', {
    types: [
        {
            access: true,
            type: 'input CreateResidentTicketInput { dv: Int!, sender: JSON!, details: String!, propertyId: String!, unitName: String }',
        },
        {
            access: true,
            type: 'type ResidentTicketOutput { organization: Organization!, property: Property!, unitName: String,' +
                'sectionName: String, floorName: String, number: Int!, client: User!, clientName: String,' +
                'clientEmail: String, clientPhone: String, contact: Contact, operator: User, assignee: User, executor: User,' +
                'details: String!, related: Ticket, isEmergency: Boolean,' +
                'isPaid: Boolean, source: TicketSource!, id: String!, createdBy: User!, createdAt: String!,' +
                'updatedAt: String, updatedBy: User, watchers: [User], classifier: TicketClassifier, meta: JSON, sourceMeta: JSON,' +
                'dv: Int, sender: JSON, v: Int, deletedAt: String, newId: String }',
        },
    ],

    mutations: [
        {
            access: access.canCreateResidentTicket,
            schema: 'createResidentTicket(data: CreateResidentTicketInput!): ResidentTicketOutput',
            resolver: async (parent, args, context, info, extra = {}) => {
                const { data } = args
                const { dv: newTicketDv, sender: newTicketSender, details, propertyId, unitName } = data
                const [property] = await Property.getAll(context, { id: propertyId })
                if (!property) throw Error('In our system there is no property with this id')
                const organizationId = property.organization?.id
                const { sectionName, floorName } = getSectionAndFloorByUnitName(property, unitName)
                if (unitName && (!sectionName || !floorName)) throw Error('unitName is wrong')
                const user = context?.req?.user

                const [contact] = await Contact.getAll(context, {
                    email: user?.email, organization: { id: organizationId }, property: { id: propertyId },
                })
                if (!contact) {
                    await Contact.create(context, {
                        dv: newTicketDv,
                        sender: newTicketSender,
                        organization: { connect: { id: organizationId } },
                        property: { connect: { id: propertyId } },
                        unitName,
                        email: user?.email,
                        phone: user?.phone,
                        name: user?.name,
                    })
                }

                return await Ticket.create(context, {
                    dv: newTicketDv,
                    sender: newTicketSender,
                    organization: { connect: { id: organizationId } },
                    client: { connect: { id: user.id } },
                    property: { connect: { id: propertyId } },
                    unitName,
                    sectionName,
                    floorName,
                    source: { connect: { id: TICKET_MOBILE_SOURCE_ID } },
                    details,
                })
            },
        },
    ],
})

module.exports = {
    CreateResidentTicketService,
}