/**
 * Generated by `createschema ticket.TicketObserver 'ticket:Relationship:Ticket:CASCADE; user:Relationship:User:CASCADE'`
 */

const { faker } = require('@faker-js/faker')

const {
    makeLoggedInAdminClient,
    makeClient,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const {
    createTestOrganizationEmployeeRole,
    createTestOrganizationEmployee,
    createTestOrganizationWithAccessToAnotherOrganization,
    updateTestOrganizationEmployee,
} = require('@condo/domains/organization/utils/testSchema')
const { makeClientWithProperty } = require('@condo/domains/property/utils/testSchema')
const { ERRORS } = require('@condo/domains/ticket/schema/TicketObserver')
const {
    TicketObserver,
    createTestTicket,
    updateTestTicket,
    createTestTicketObserver,
    updateTestTicketObserver,
} = require('@condo/domains/ticket/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')

describe('TicketObserver', () => {
    describe('access: read/update by organization', () => {
        test('staff from same organization can read and update', async () => {
            const admin = await makeLoggedInAdminClient()

            const staff1 = await makeClientWithProperty()
            const [ticket] = await createTestTicket(staff1, staff1.organization, staff1.property)
            const [observer] = await createTestTicketObserver(staff1, ticket, staff1.user)

            const staff2 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [role] = await createTestOrganizationEmployeeRole(admin, staff1.organization, { canReadTickets: true, canManageTickets: true })
            await createTestOrganizationEmployee(admin, staff1.organization, staff2.user, role)

            const observers = await TicketObserver.getAll(staff2, { id: observer.id })
            expect(observers).toHaveLength(1)
            expect(observers[0].id).toEqual(observer.id)

            const [updated] = await updateTestTicketObserver(staff2, observer.id)
            expect(updated.id).toEqual(observer.id)
            expect(updated.v).toEqual(2)
        })

        test('staff from related organization can read and update', async () => {
            const admin = await makeLoggedInAdminClient()
            const { clientFrom, organizationTo, propertyTo, organizationFrom, employeeFrom } = await createTestOrganizationWithAccessToAnotherOrganization()

            const [role] = await createTestOrganizationEmployeeRole(admin, organizationFrom, { canReadTickets: true, canManageTickets: true })
            await updateTestOrganizationEmployee(admin, employeeFrom.id, { role: { connect: { id: role.id } } })

            const [ticket] = await createTestTicket(admin, organizationTo, propertyTo)
            const [observer] = await createTestTicketObserver(admin, ticket, admin.user)

            const observers = await TicketObserver.getAll(clientFrom, { id: observer.id })
            expect(observers).toHaveLength(1)
            expect(observers[0].id).toEqual(observer.id)

            const [updated] = await updateTestTicketObserver(clientFrom, observer.id)
            expect(updated.id).toEqual(observer.id)
            expect(updated.v).toEqual(2)
        })

        test('staff from another organization cannot read and cannot update', async () => {
            const staff1 = await makeClientWithProperty()
            const [ticket] = await createTestTicket(staff1, staff1.organization, staff1.property)
            const [observer] = await createTestTicketObserver(staff1, ticket, staff1.user)

            const outsider = await makeClientWithProperty()

            const observers = await TicketObserver.getAll(outsider, { id: observer.id })
            expect(observers).toHaveLength(0)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestTicketObserver(outsider, observer.id)
            })
        })
    })

    describe('validation: ticket required on create only', () => {
        test('create: should require ticket field', async () => {
            const admin = await makeLoggedInAdminClient()

            const attrs = {
                dv: 1,
                sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                user: { connect: { id: admin.user.id } },
            }

            await expectToThrowGQLError(async () => {
                await TicketObserver.create(admin, attrs)
            }, ERRORS.TICKET_REQUIRED)
        })

        test('nested create from Ticket.observers: should not require ticket field', async () => {
            const admin = await makeLoggedInAdminClient()
            const staff = await makeClientWithProperty()
            const observerClient = await makeClientWithNewRegisteredAndLoggedInUser()

            const [ticket] = await createTestTicket(staff, staff.organization, staff.property)

            await expect(async () => {
                await updateTestTicket(admin, ticket.id, {
                    observers: {
                        create: [{
                            user: { connect: { id: observerClient.user.id } },
                            dv: 1,
                            sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                        }],
                    },
                })
            }).not.toThrow()
        })

        test('update: ticket is not required', async () => {
            const admin = await makeLoggedInAdminClient()

            const staff1 = await makeClientWithProperty()
            const [ticket] = await createTestTicket(staff1, staff1.organization, staff1.property)
            const [observer] = await createTestTicketObserver(staff1, ticket, staff1.user)

            const [updated] = await updateTestTicketObserver(admin, observer.id)
            expect(updated.id).toEqual(observer.id)
            expect(updated.v).toEqual(2)
        })
    })

    test('anonymous: cannot read', async () => {
        const client = await makeClient()

        await expectToThrowAuthenticationErrorToObjects(async () => {
            await TicketObserver.getAll(client, {})
        })
    })
})
