/**
 * Generated by `createschema ticket.TicketFile 'organization:Text;file?:File;ticket?:Relationship:Ticket:SET_NULL;'`
 */

const {
    makeClient,
    UUID_RE,
    DATETIME_RE,
    makeLoggedInAdminClient,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowAuthenticationErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { updateTestOrganizationEmployee } = require('@condo/domains/organization/utils/testSchema')
const { createTestOrganizationEmployeeRole } = require('@condo/domains/organization/utils/testSchema')
const { createTestOrganizationWithAccessToAnotherOrganization } = require('@condo/domains/organization/utils/testSchema')
const { createTestOrganization, createTestOrganizationEmployee } = require('@condo/domains/organization/utils/testSchema')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestTicket } = require('@condo/domains/ticket/utils/testSchema')
const { 
    TicketFile, 
    createTestTicketFile, 
    updateTestTicketFile,
    makeClientWithTicket,
} = require('@condo/domains/ticket/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')


describe('TicketFile', () => {
    let admin
    let organization
    let property
    let clientWithCanReadTicket
    let clientWithoutCanReadTicket

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        clientWithCanReadTicket = await makeClientWithNewRegisteredAndLoggedInUser()
        clientWithoutCanReadTicket = await makeClientWithNewRegisteredAndLoggedInUser()
        const [testOrganization] = await createTestOrganization(admin)
        organization = testOrganization
        const [testProperty] = await createTestProperty(admin, organization)
        property = testProperty
        const [roleWithCanReadTickets] = await createTestOrganizationEmployeeRole(admin, organization, { canReadTickets: true })
        const [roleWithoutCanReadTickets] = await createTestOrganizationEmployeeRole(admin, organization, { canReadTickets: false })
        await createTestOrganizationEmployee(admin, organization, clientWithCanReadTicket.user, roleWithCanReadTickets)
        await createTestOrganizationEmployee(admin, organization, clientWithoutCanReadTicket.user, roleWithoutCanReadTickets)
    })

    describe('User', () => {
        it('can create temporary TicketFile [no ticket relation]', async () => {
            const client = await makeClientWithNewRegisteredAndLoggedInUser()
            const [ticketFile, attrs] = await createTestTicketFile(client)
            expect(ticketFile.id).toMatch(UUID_RE)
            expect(ticketFile.dv).toEqual(1)
            expect(ticketFile.sender).toEqual(attrs.sender)
            expect(ticketFile.v).toEqual(1)
            expect(ticketFile.newId).toEqual(null)
            expect(ticketFile.deletedAt).toEqual(null)
            expect(ticketFile.createdBy).toEqual(expect.objectContaining({ id: client.user.id }))
            expect(ticketFile.updatedBy).toEqual(expect.objectContaining({ id: client.user.id }))
            expect(ticketFile.createdAt).toMatch(DATETIME_RE)
            expect(ticketFile.updatedAt).toMatch(DATETIME_RE)
        })
        it('can create TicketFile', async () => {
            const client = await makeClientWithTicket()
            const [ticketFile, attrs] = await createTestTicketFile(client, client.ticket)
            expect(ticketFile.id).toMatch(UUID_RE)
            expect(ticketFile.dv).toEqual(1)
            expect(ticketFile.sender).toEqual(attrs.sender)
            expect(ticketFile.v).toEqual(1)
            expect(ticketFile.newId).toEqual(null)
            expect(ticketFile.deletedAt).toEqual(null)
            expect(ticketFile.createdBy).toEqual(expect.objectContaining({ id: client.user.id }))
            expect(ticketFile.updatedBy).toEqual(expect.objectContaining({ id: client.user.id }))
            expect(ticketFile.createdAt).toMatch(DATETIME_RE)
            expect(ticketFile.updatedAt).toMatch(DATETIME_RE)
            expect(ticketFile.organization).toEqual(expect.objectContaining({ id: client.organization.id }))
            expect(ticketFile.ticket).toEqual(expect.objectContaining({ id: client.ticket.id }))
        })

        it('can read TicketFile if employee has canReadTickets', async () => {
            const [ticket] = await createTestTicket(admin, organization, property)
            const [ticketFile] = await createTestTicketFile(admin, ticket)

            const readTickets = await TicketFile.getOne(clientWithCanReadTicket, { id: ticketFile.id })

            expect(readTickets).toBeDefined()
        })

        it('can not read TicketFile if employee has not canReadTickets', async () => {
            const [ticket] = await createTestTicket(admin, organization, property)
            const [ticketFile] = await createTestTicketFile(admin, ticket)

            const readTickets = await TicketFile.getOne(clientWithoutCanReadTicket, { id: ticketFile.id })

            expect(readTickets).toBeUndefined()
        })

        it('cannot read TicketFile from another organization', async () => {
            const client = await makeClientWithTicket()
            await createTestTicketFile(client, client.ticket)
            const anotherClient = await makeClientWithTicket()
            const objs = await TicketFile.getAll(anotherClient, {}, { sortBy: ['updatedAt_DESC'] })
            expect(objs).toHaveLength(0)
        })

        it('can update temporary TicketFile', async () => {
            const client = await makeClientWithTicket()
            const [ticketFileCreated] = await createTestTicketFile(client)
            const [ticketFileUpdated, attrsUpdate] = await updateTestTicketFile(client, ticketFileCreated.id, { ticket: { connect: { id: client.ticket.id } } })
            expect(ticketFileUpdated.id).toEqual(ticketFileUpdated.id)
            expect(ticketFileUpdated.dv).toEqual(1)
            expect(ticketFileUpdated.sender).toEqual(attrsUpdate.sender)
            expect(ticketFileUpdated.v).toEqual(2)
            expect(ticketFileUpdated.organization).toEqual(expect.objectContaining({ id: client.organization.id }))
            expect(ticketFileUpdated.ticket).toEqual(expect.objectContaining({ id: client.ticket.id }))
        })
        it('cannot delete TicketFile', async () => {
            const userClient = await makeClientWithTicket()
            const [ticketFileCreated] = await createTestTicketFile(userClient, userClient.ticket)
            await expectToThrowAccessDeniedErrorToObj(async () => {
                // TODO(codegen): check 'user: delete TicketFile' test!
                await TicketFile.delete(userClient, ticketFileCreated.id)
            })
        })

        it('can read own TicketFile', async () => {
            const client = await makeClientWithNewRegisteredAndLoggedInUser()
            const [ticketFile] = await createTestTicketFile(client)

            const readTicketFile = await TicketFile.getOne(client, { id: ticketFile.id })

            expect(readTicketFile).toHaveProperty('id', ticketFile.id)
        })
    })

    describe('Anonymous', () => {
        it('cannot create TicketFile', async () => {
            const client = await makeClient()

            await expectToThrowAuthenticationErrorToObj(async () => {
                await createTestTicketFile(client)
            })
        })
        it('cannot read TicketFile', async () => {
            const client = await makeClient()
            await expectToThrowAuthenticationErrorToObjects(async () => {
                await TicketFile.getAll(client)
            })
        })
        it('cannot update TicketFile', async () => {
            const userClient = await makeClientWithTicket()
            const [ticketFileCreated] = await createTestTicketFile(userClient, userClient.ticket)
            const client = await makeClient()
            const payload = { ticket: { connect: { id: userClient.ticket.id } } }
            await expectToThrowAuthenticationErrorToObj(async () => {
                await updateTestTicketFile(client, ticketFileCreated.id, payload)
            })
        })
        it('cannot delete TicketFile', async () => {
            const userClient = await makeClientWithTicket()
            const [ticketFileCreated] = await createTestTicketFile(userClient, userClient.ticket)
            const client = await makeClient()
            await expectToThrowAccessDeniedErrorToObj(async () => {
                // TODO(codegen): check 'anonymous: delete TicketFile' test!
                await TicketFile.delete(client, ticketFileCreated.id)
            })
        })
    })

    describe('Employee from "from" relation organization', () => {
        it('can create ticket file for his "to" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { clientFrom, organizationTo, propertyTo, organizationFrom, employeeFrom } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [role] = await createTestOrganizationEmployeeRole(admin, organizationFrom, {
                canManageTickets: true,
            })
            await updateTestOrganizationEmployee(admin, employeeFrom.id, {
                role: { connect: { id: role.id } },
            })
            const [ticket] = await createTestTicket(admin, organizationTo, propertyTo)

            const [ticketFile] = await createTestTicketFile(clientFrom, ticket)
            expect(ticketFile.id).toMatch(UUID_RE)
        })

        it('cannot create ticket file for not his "to" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { clientFrom, organizationFrom, employeeFrom, propertyTo } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [role] = await createTestOrganizationEmployeeRole(admin, organizationFrom, {
                canManageTickets: true,
            })
            await updateTestOrganizationEmployee(admin, employeeFrom.id, {
                role: { connect: { id: role.id } },
            })
            const { organizationTo } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [ticket] = await createTestTicket(admin, organizationTo, propertyTo)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestTicketFile(clientFrom, ticket)
            })
        })

        it('can read ticket file from his "to" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { clientFrom, organizationTo, propertyTo } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [ticket] = await createTestTicket(admin, organizationTo, propertyTo)
            await createTestTicketFile(admin, ticket)

            const objs = await TicketFile.getAll(clientFrom)
            expect(objs).toHaveLength(1)
        })

        it('can update ticket file for his "to" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { clientFrom, organizationTo, propertyTo, organizationFrom, employeeFrom } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [role] = await createTestOrganizationEmployeeRole(admin, organizationFrom, {
                canManageTickets: true,
            })
            await updateTestOrganizationEmployee(admin, employeeFrom.id, {
                role: { connect: { id: role.id } },
            })
            const [ticket] = await createTestTicket(admin, organizationTo, propertyTo)
            const [ticketFile] = await createTestTicketFile(clientFrom, ticket)
            const [updatedTicketFile] = await updateTestTicketFile(clientFrom, ticketFile.id, {})
            expect(updatedTicketFile.id).toEqual(ticketFile.id)
        })
    })

    describe('Employee from "to" relation organization', () => {
        it('cannot create ticket file for his "from" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { organizationTo, propertyFrom, clientTo, organizationFrom, employeeFrom } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [role] = await createTestOrganizationEmployeeRole(admin, organizationFrom, {
                canManageTickets: true,
            })
            await updateTestOrganizationEmployee(admin, employeeFrom.id, {
                role: { connect: { id: role.id } },
            })
            const [ticket] = await createTestTicket(admin, organizationTo, propertyFrom)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestTicketFile(clientTo, ticket)
            })
        })

        it('cannot read ticket file from his "from" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { organizationTo, propertyFrom, clientTo } = await createTestOrganizationWithAccessToAnotherOrganization()
            await createTestTicket(admin, organizationTo, propertyFrom)

            const objs = await TicketFile.getAll(clientTo)
            expect(objs).toHaveLength(0)
        })

        it('cannot update ticket file for his "from" related organization', async () => {
            const admin = await makeLoggedInAdminClient()
            const { clientTo, organizationTo, propertyFrom } = await createTestOrganizationWithAccessToAnotherOrganization()
            const [ticket] = await createTestTicket(admin, organizationTo, propertyFrom)
            const [ticketFile] = await createTestTicketFile(admin, ticket)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestTicketFile(clientTo, ticketFile.id, {})
            })
        })
    })
})
