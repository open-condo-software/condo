/**
 * Generated by `createschema ticket.UserTicketCommentReadTime 'user:Relationship:User:CASCADE; ticket:Relationship:Ticket:CASCADE; readResidentCommentAt:DateTimeUtc;'`
 */

const { faker } = require('@faker-js/faker')

const { makeLoggedInAdminClient, UUID_RE, expectToThrowAccessDeniedErrorToObj, expectToThrowUniqueConstraintViolationError } = require('@open-condo/keystone/test.utils')

const { HOLDING_TYPE } = require('@condo/domains/organization/constants/common')
const {
    createTestOrganization, createTestOrganizationEmployeeRole, createTestOrganizationEmployee, updateTestOrganizationEmployee, createTestOrganizationLink,
} = require('@condo/domains/organization/utils/testSchema')
const { makeClientWithProperty, createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestResident } = require('@condo/domains/resident/utils/testSchema')
const { createTestTicket, createTestUserTicketCommentReadTime, updateTestUserTicketCommentReadTime, UserTicketCommentReadTime } = require('@condo/domains/ticket/utils/testSchema')
const { makeClientWithResidentUser, makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')

describe('UserTicketCommentReadTime', () => {
    describe('employee', () => {
        describe('create', () => {
            it('can create UserTicketCommentReadTime to comment in employee organization', async () => {
                const userClient = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)

                expect(userTicketCommentRead.id).toMatch(UUID_RE)
            })

            it('can create UserTicketCommentReadTime to comment in employee related organization', async () => {
                const admin = await makeLoggedInAdminClient()
                const [organization1] = await createTestOrganization(admin)
                const [property] = await createTestProperty(admin, organization1)
                const [organization2] = await createTestOrganization(admin, { type: HOLDING_TYPE })

                const userClient = await makeClientWithNewRegisteredAndLoggedInUser()
                const [role] = await createTestOrganizationEmployeeRole(admin, organization2, {
                    canManageTickets: true,
                })
                await createTestOrganizationEmployee(admin, organization2, userClient.user, role)
                await createTestOrganizationLink(admin, organization2, organization1)

                const [ticket] = await createTestTicket(userClient, organization1, property)
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)

                expect(userTicketCommentRead.id).toMatch(UUID_RE)
            })

            it('cannot create UserTicketCommentReadTime to comment in not employee organization', async () => {
                const admin = await makeLoggedInAdminClient()
                const userClient = await makeClientWithProperty()
                const [organization1] = await createTestOrganization(admin)
                const [property1] = await createTestProperty(admin, organization1)

                const [ticket] = await createTestTicket(admin, organization1, property1)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)
                })
            })

            it('cannot create UserTicketCommentReadTime with same user and ticket fields', async () => {
                const userClient = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)

                await expectToThrowUniqueConstraintViolationError(async () => {
                    await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)
                }, 'unique_user_and_ticket')
            })

            it('can create UserTicketCommentReadTime if user has another soft deleted employee in organization', async () => {
                const admin = await makeLoggedInAdminClient()
                const userClient = await makeClientWithNewRegisteredAndLoggedInUser()

                const [organization] = await createTestOrganization(admin)
                const [property] = await createTestProperty(admin, organization)
                const [employeeRole] = await createTestOrganizationEmployeeRole(admin, organization, {
                    canManageTickets: true,
                })
                const [employee] = await createTestOrganizationEmployee(admin, organization, userClient.user, employeeRole)

                await updateTestOrganizationEmployee(admin, employee.id, {
                    deletedAt: 'true',
                })

                await createTestOrganizationEmployee(admin, organization, userClient.user, employeeRole)

                const [ticket] = await createTestTicket(userClient, organization, property)
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)

                expect(userTicketCommentRead.id).toMatch(UUID_RE)
            })
        })

        describe('read', () => {
            it('can read own UserTicketCommentReadTime', async () => {
                const userClient = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)

                const userTicketCommentReadObjs = await UserTicketCommentReadTime.getAll(userClient)

                expect(userTicketCommentReadObjs).toHaveLength(1)
                expect(userTicketCommentReadObjs[0].id).toEqual(userTicketCommentRead.id)
            })

            it('cannot read UserTicketCommentReadTime with other user', async () => {
                const userClient = await makeClientWithProperty()
                const userClient1 = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)

                const userTicketCommentReadObjs = await UserTicketCommentReadTime.getAll(userClient1)

                expect(userTicketCommentReadObjs).toHaveLength(0)
            })
        })

        describe('update', () => {
            it('can update own UserTicketCommentReadTime', async () => {
                const userClient = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)
                const newReadResidentCommentAt = new Date().toISOString()

                const [updatedUserTicketCommentRead] = await updateTestUserTicketCommentReadTime(userClient, userTicketCommentRead.id, {
                    readResidentCommentAt: newReadResidentCommentAt,
                })

                expect(updatedUserTicketCommentRead.id).toEqual(userTicketCommentRead.id)
                expect(updatedUserTicketCommentRead.readResidentCommentAt).toEqual(newReadResidentCommentAt)
            })

            it('cannot update UserTicketCommentReadTime with other user', async () => {
                const userClient = await makeClientWithProperty()
                const userClient1 = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)
                const newReadResidentCommentAt = new Date().toISOString()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestUserTicketCommentReadTime(userClient1, userTicketCommentRead.id, {
                        readResidentCommentAt: newReadResidentCommentAt,
                    })
                })
            })

            it('cannot update UserTicketCommentReadTime with same user and ticket fields', async () => {
                const userClient = await makeClientWithProperty()
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property)
                const [ticket1] = await createTestTicket(userClient, userClient.organization, userClient.property)
                await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket)
                const [userTicketCommentReadTime] = await createTestUserTicketCommentReadTime(userClient, userClient.user, ticket1)

                await expectToThrowUniqueConstraintViolationError(async () => {
                    await updateTestUserTicketCommentReadTime(userClient, userTicketCommentReadTime.id, {
                        ticket: { connect: { id: ticket.id } },
                    })
                }, 'unique_user_and_ticket')
            })
        })
    })

    describe('resident', () => {
        describe('create', () => {
            it('cannot create UserTicketCommentReadTime for other users tickets', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const anotherResidentClient = await makeClientWithResidentUser()

                const [organization] = await createTestOrganization(admin)
                const [property] = await createTestProperty(admin, organization)
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, property, { unitName })
                await createTestResident(admin, anotherResidentClient.user, property, { unitName: 'different-unit' })

                const [ticket] = await createTestTicket(anotherResidentClient, organization, property, {
                    unitName: 'different-unit',
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestUserTicketCommentReadTime(residentClient, residentClient.user, ticket)
                })
            })

            it('can create UserTicketCommentReadTime for their own tickets', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()

                const [organization] = await createTestOrganization(admin)
                const [property] = await createTestProperty(admin, organization)
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, property, { unitName })
                const [ticket] = await createTestTicket(residentClient, organization, property, { unitName })

                const [userTicketCommentReadTime] = await createTestUserTicketCommentReadTime(
                    residentClient, 
                    residentClient.user, 
                    ticket,
                )

                expect(userTicketCommentReadTime).toBeDefined()
                expect(userTicketCommentReadTime.user.id).toBe(residentClient.user.id)
                expect(userTicketCommentReadTime.ticket.id).toBe(ticket.id)
            })

            it('cannot create UserTicketCommentReadTime with invalid ticket', async () => {
                const residentClient = await makeClientWithResidentUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestUserTicketCommentReadTime(residentClient, residentClient.user, { id: faker.datatype.uuid() })
                })
            })

            it('cannot create UserTicketCommentReadTime with restricted fields', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()

                const [organization] = await createTestOrganization(admin)
                const [property] = await createTestProperty(admin, organization)
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, property, { unitName })
                const [ticket] = await createTestTicket(residentClient, organization, property, { unitName })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestUserTicketCommentReadTime(
                        residentClient, 
                        residentClient.user, 
                        ticket,
                        {
                            readCommentAt: new Date().toISOString(),
                            readOrganizationCommentAt: new Date().toISOString(),
                        }
                    )
                })
            })

        })

        describe('read', () => {
            it('can read their own UserTicketCommentReadTime', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const userClient = await makeClientWithProperty()
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, userClient.property, { unitName })
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property, { unitName })
                
                await createTestUserTicketCommentReadTime(userClient, residentClient.user, ticket)

                const userTicketCommentReadObjs = await UserTicketCommentReadTime.getAll(residentClient)

                expect(userTicketCommentReadObjs).toHaveLength(1)
                expect(userTicketCommentReadObjs[0].user.id).toBe(residentClient.user.id)
            })

            it('cannot read other users UserTicketCommentReadTime', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const anotherResidentClient = await makeClientWithResidentUser()
                const userClient = await makeClientWithProperty()
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, userClient.property, { unitName })
                await createTestResident(admin, anotherResidentClient.user, userClient.property, { unitName: 'other-unit' })
                
                const [ticket1] = await createTestTicket(residentClient, userClient.organization, userClient.property, { unitName })
                const [ticket2] = await createTestTicket(anotherResidentClient, userClient.organization, userClient.property, { unitName: 'other-unit' })
                
                await createTestUserTicketCommentReadTime(userClient, residentClient.user, ticket1)
                await createTestUserTicketCommentReadTime(userClient, anotherResidentClient.user, ticket2)

                const userTicketCommentReadObjs = await UserTicketCommentReadTime.getAll(residentClient)
                
                expect(userTicketCommentReadObjs).toHaveLength(1)
                expect(userTicketCommentReadObjs[0].user.id).toBe(residentClient.user.id)
            })
        })

        describe('update', () => {
            it('cannot update UserTicketCommentReadTime with restricted fields', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const userClient = await makeClientWithProperty()
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, userClient.property, { unitName })
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property, { unitName })
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, residentClient.user, ticket)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestUserTicketCommentReadTime(residentClient, userTicketCommentRead.id, {
                        user: { connect: { id: faker.datatype.uuid() } },
                    })
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestUserTicketCommentReadTime(residentClient, userTicketCommentRead.id, {
                        ticket: { connect: { id: faker.datatype.uuid() } },
                    })
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestUserTicketCommentReadTime(residentClient, userTicketCommentRead.id, {
                        readCommentAt: new Date().toISOString(),
                    })
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestUserTicketCommentReadTime(residentClient, userTicketCommentRead.id, {
                        readOrganizationCommentAt: new Date().toISOString(),
                    })
                })
            })

            it('can update UserTicketCommentReadTime with allowed fields', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const userClient = await makeClientWithProperty()
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, userClient.property, { unitName })
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property, { unitName })
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, residentClient.user, ticket)

                const newReadTime = new Date().toISOString()
                const [updated] = await updateTestUserTicketCommentReadTime(residentClient, userTicketCommentRead.id, {
                    readResidentCommentAt: newReadTime,
                })

                expect(updated.readResidentCommentAt).toBe(newReadTime)
            })

            it('cannot update other users UserTicketCommentReadTime', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const anotherResidentClient = await makeClientWithResidentUser()
                const userClient = await makeClientWithProperty()
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, userClient.property, { unitName })
                await createTestResident(admin, anotherResidentClient.user, userClient.property, { unitName: 'other-unit' })
                
                const [ticket] = await createTestTicket(anotherResidentClient, userClient.organization, userClient.property, { unitName: 'other-unit' })
                const [otherUserTicketCommentReadTime] = await createTestUserTicketCommentReadTime(userClient, anotherResidentClient.user, ticket)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestUserTicketCommentReadTime(residentClient, otherUserTicketCommentReadTime.id, {
                        readResidentCommentAt: new Date().toISOString(),
                    })
                })
            })
        })

        describe('delete', () => {
            it('cannot delete UserTicketCommentReadTime', async () => {
                const admin = await makeLoggedInAdminClient()
                const residentClient = await makeClientWithResidentUser()
                const userClient = await makeClientWithProperty()
                const unitName = faker.random.alphaNumeric(5)

                await createTestResident(admin, residentClient.user, userClient.property, { unitName })
                const [ticket] = await createTestTicket(userClient, userClient.organization, userClient.property, { unitName })
                const [userTicketCommentRead] = await createTestUserTicketCommentReadTime(userClient, residentClient.user, ticket)

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await UserTicketCommentReadTime.delete(residentClient, userTicketCommentRead.id)
                })
            })
        })
    })
})
