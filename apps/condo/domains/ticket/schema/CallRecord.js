/**
 * Generated by `createschema ticket.CallRecord 'organization:Relationship:Organization:CASCADE;file?:File;callerPhone:Text;destCallerPhone:Text;talkTime:Integer;startDate:DateTimeUtc;isIncomingCall:Checkbox;importId:Text;'`
 */
const { GQLError } = require('@open-condo/keystone/errors')
const FileAdapter = require('@open-condo/keystone/fileAdapter/fileAdapter')
const { getFileMetaAfterChange } = require('@open-condo/keystone/fileAdapter/fileAdapter')
const { historical, versioned, uuided, tracked, softDeleted, dvAndSender } = require('@open-condo/keystone/plugins')
const { GQLListSchema } = require('@open-condo/keystone/schema')

const { PHONE_FIELD } = require('@condo/domains/common/schema/fields')
const { ORGANIZATION_OWNED_FIELD } = require('@condo/domains/organization/schema/fields')
const access = require('@condo/domains/ticket/access/CallRecord')
const { CALL_RECORD_ERRORS } = require('@condo/domains/ticket/constants/errors')

const CALL_RECORDS_FOLDER_NAME = 'ticket-call-record'
const Adapter = new FileAdapter(CALL_RECORDS_FOLDER_NAME, false)
const fileMetaAfterChange = getFileMetaAfterChange(Adapter)

const CallRecord = new GQLListSchema('CallRecord', {
    schemaDoc: 'Conversation record between operator and client',
    fields: {
        organization: {
            ...ORGANIZATION_OWNED_FIELD,
            schemaDoc: 'Organization of the operator',
        },
        file: {
            schemaDoc: 'Conversation file',
            type: 'File',
            adapter: Adapter,
        },
        callerPhone: {
            ...PHONE_FIELD,
            schemaDoc: 'Phone number of the person who called',
        },
        destCallerPhone: {
            ...PHONE_FIELD,
            schemaDoc: 'Phone number of the person to whom called',
        },
        talkTime: {
            schemaDoc: 'Time of conversation between operator and client (in seconds)',
            type: 'Integer',
            isRequired: true,
            hooks: {
                validateInput: ({ resolvedData, context, fieldPath }) => {
                    if (resolvedData[fieldPath] && resolvedData[fieldPath] < 0) {
                        throw new GQLError(CALL_RECORD_ERRORS.NEGATIVE_TALK_TIME_VALUE, context)
                    }
                },
            },
        },
        startedAt: {
            schemaDoc: 'Call start date in UTC',
            type: 'DateTimeUtc',
            isRequired: true,
        },
        isIncomingCall: {
            schemaDoc: 'Incoming or outgoing call for operator',
            type: 'Checkbox',
            isRequired: true,
        },
        importId: {
            schemaDoc: 'Call unique identifier',
            type: 'Text',
            isRequired: true,
        },
    },
    hooks: {
        afterChange: fileMetaAfterChange,
        afterDelete: async ({ existingItem }) => {
            if (existingItem.file) {
                await Adapter.delete(existingItem.file)
            }
        },
    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical()],
    access: {
        read: access.canReadCallRecords,
        create: access.canManageCallRecords,
        update: access.canManageCallRecords,
        delete: false,
        auth: true,
    },
})

module.exports = {
    CallRecord,
}
