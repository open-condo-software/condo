/**
 * Generated by `createschema ticket.TicketFilterTemplate 'name:Text; employee:Relationship:OrganizationEmployee:CASCADE; filters:Json'`
 */

const faker = require('faker')
const { makeLoggedInAdminClient, makeClient, UUID_RE } = require('@core/keystone/test.utils')

const { TicketFilterTemplate, createTestTicketFilterTemplate, updateTestTicketFilterTemplate } = require('@condo/domains/ticket/utils/testSchema')
const {
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowValidationFailureError,
    expectToThrowAuthenticationErrorToObjects,
} = require('@condo/domains/common/utils/testSchema')
const { createTestOrganization, createTestOrganizationEmployee } = require('@condo/domains/organization/utils/testSchema')
const {
    createTestOrganizationEmployeeRole,
    updateTestOrganizationEmployee,
} = require('@condo/domains/organization/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')
const { expectToThrowMutationError } = require('@condo/domains/common/utils/testSchema')

describe('TicketFilterTemplate', () => {
    describe('Create', () => {
        test('admin: can create TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(admin, employee, {})

            expect(filtersTemplate.id).toMatch(UUID_RE)
        })

        test('employee: can create TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(user, employee, {})

            expect(filtersTemplate.id).toMatch(UUID_RE)
        })

        test('employee: cannot create TicketFilterTemplate with wrong filter field', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)
            const wrongFieldValue = faker.random.alphaNumeric(5)
            const wrongFilters = {
                wrongField: wrongFieldValue,
            }

            await expectToThrowValidationFailureError(
                async () => await createTestTicketFilterTemplate(user, employee, {
                    fields: wrongFilters,
                }),
                'fields field validation error. JSON not in the correct format - path: msg:must NOT have additional properties',
            )
        })

        test('employee: cannot create TicketFilterTemplate with wrong filter field value', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)
            const wrongFieldValue = faker.lorem.sentence()
            const wrongFilters = {
                number: wrongFieldValue,
            }

            await expectToThrowMutationError(
                async () => await createTestTicketFilterTemplate(user, employee, {
                    fields: wrongFilters,
                }),
                'Int cannot represent non-integer value',
                ['obj', 'fields', 'number']
            )
        })

        test('deleted employee: cannot create TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)
            await updateTestOrganizationEmployee(admin, employee.id, {
                deletedAt: 'true',
            })

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestTicketFilterTemplate(user, employee, {})
            })
        })

        test('blocked employee: cannot create TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)
            await updateTestOrganizationEmployee(admin, employee.id, {
                isBlocked: true,
            })

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestTicketFilterTemplate(user, employee, {})
            })
        })

        test('user: cannot create TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const employeeUser = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, employeeUser.user, role)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await createTestTicketFilterTemplate(user, employee, {})
            })
        })

        test('anonymous: cannot create TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const anonymous = await makeClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const employeeUser = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, employeeUser.user, role)

            await expectToThrowAuthenticationErrorToObj(async () => {
                await createTestTicketFilterTemplate(anonymous, employee, {})
            })
        })
    })

    describe('Read', () => {
        test('admin: can read TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(admin, employee, {})
            const templates = await TicketFilterTemplate.getAll(admin, { id: filtersTemplate.id })

            expect(templates).toHaveLength(1)
            expect(templates[0].id).toEqual(filtersTemplate.id)
        })

        test('employee: can read his TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(user, employee, {})
            const templates = await TicketFilterTemplate.getAll(user, { id: filtersTemplate.id })

            expect(templates).toHaveLength(1)
            expect(templates[0].id).toEqual(filtersTemplate.id)
        })

        test('employee: cannot read not his own TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user1 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee1] = await createTestOrganizationEmployee(admin, organization, user1.user, role)
            const user2 = await makeClientWithNewRegisteredAndLoggedInUser()
            await createTestOrganizationEmployee(admin, organization, user2.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(user1, employee1, {})
            const templates = await TicketFilterTemplate.getAll(user2, { id: filtersTemplate.id })

            expect(templates).toHaveLength(0)
        })

        test('user: cannot read TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user1 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user1.user, role)
            const user2 = await makeClientWithNewRegisteredAndLoggedInUser()

            const [filtersTemplate] = await createTestTicketFilterTemplate(user1, employee, {})
            const templates = await TicketFilterTemplate.getAll(user2, { id: filtersTemplate.id })

            expect(templates).toHaveLength(0)
        })

        test('anonymous: cannot read TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user1 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user1.user, role)
            const anonymous = await makeClient()

            const [filtersTemplate] = await createTestTicketFilterTemplate(user1, employee, {})

            await expectToThrowAuthenticationErrorToObjects(async () => {
                await TicketFilterTemplate.getAll(anonymous, { id: filtersTemplate.id })
            })
        })
    })

    describe('Update', () => {
        test('admin: can update TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(admin, employee, {})
            const newTemplateName = faker.random.alphaNumeric(8)
            const [updatedTemplate] = await updateTestTicketFilterTemplate(admin, filtersTemplate.id, {
                name: newTemplateName,
            })

            expect(updatedTemplate.id).toEqual(filtersTemplate.id)
            expect(updatedTemplate.name).toEqual(newTemplateName)
        })

        test('employee: can update his TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee] = await createTestOrganizationEmployee(admin, organization, user.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(user, employee, {})
            const newTemplateName = faker.random.alphaNumeric(8)
            const [updatedTemplate] = await updateTestTicketFilterTemplate(user, filtersTemplate.id, {
                name: newTemplateName,
            })

            expect(updatedTemplate.id).toEqual(filtersTemplate.id)
            expect(updatedTemplate.name).toEqual(newTemplateName)
        })

        test('employee: cannot update not his own TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user1 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee1] = await createTestOrganizationEmployee(admin, organization, user1.user, role)
            const user2 = await makeClientWithNewRegisteredAndLoggedInUser()
            await createTestOrganizationEmployee(admin, organization, user2.user, role)

            const [filtersTemplate] = await createTestTicketFilterTemplate(user1, employee1, {})
            const newTemplateName = faker.random.alphaNumeric(8)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestTicketFilterTemplate(user2, filtersTemplate.id, {
                    name: newTemplateName,
                })
            })
        })

        test('user: cannot update TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user1 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee1] = await createTestOrganizationEmployee(admin, organization, user1.user, role)
            const user2 = await makeClientWithNewRegisteredAndLoggedInUser()

            const [filtersTemplate] = await createTestTicketFilterTemplate(user1, employee1, {})
            const newTemplateName = faker.random.alphaNumeric(8)

            await expectToThrowAccessDeniedErrorToObj(async () => {
                await updateTestTicketFilterTemplate(user2, filtersTemplate.id, {
                    name: newTemplateName,
                })
            })
        })

        test('anonymous: cannot update TicketFilterTemplate', async () => {
            const admin = await makeLoggedInAdminClient()
            const [organization] = await createTestOrganization(admin)
            const [role] = await createTestOrganizationEmployeeRole(admin, organization, {})
            const user1 = await makeClientWithNewRegisteredAndLoggedInUser()
            const [employee1] = await createTestOrganizationEmployee(admin, organization, user1.user, role)
            const user2 = await makeClient()

            const [filtersTemplate] = await createTestTicketFilterTemplate(user1, employee1, {})
            const newTemplateName = faker.random.alphaNumeric(8)

            await expectToThrowAuthenticationErrorToObj(async () => {
                await updateTestTicketFilterTemplate(user2, filtersTemplate.id, {
                    name: newTemplateName,
                })
            })
        })
    })
})
