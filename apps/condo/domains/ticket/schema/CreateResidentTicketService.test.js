/**
 * Generated by `createservice ticket.ResidentTicketService --type mutations`
 */
const { makeClientWithProperty } = require('../../property/utils/testSchema')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestTicketClassifier } = require('@condo/domains/ticket/utils/testSchema')
const { createTestOrganization } = require('@condo/domains/organization/utils/testSchema')
const { makeLoggedInAdminClient, makeClient } = require('@core/keystone/test.utils')
const { createResidentTicketByTestClient } = require('@condo/domains/ticket/utils/testSchema')
const { UUID_RE } = require('@core/keystone/test.utils')

describe('CreateResidentTicketService', () => {
    test('user: create resident ticket', async () => {
        const admin = await makeLoggedInAdminClient()
        const client = await makeClientWithProperty()
        const [classifier] = await createTestTicketClassifier(admin)
        const [data] = await createResidentTicketByTestClient(client, classifier, client.property)
        expect(data.id).toMatch(UUID_RE)
    })

    test('anonymous: create resident ticket', async () => {
        const anon = await makeClient()
        const admin = await makeLoggedInAdminClient()
        const [organization] = await createTestOrganization(admin)
        const [classifier] = await createTestTicketClassifier(admin)
        const [property] = await createTestProperty(admin, organization)

        try {
            await createResidentTicketByTestClient(anon, classifier, property)
        } catch (error) {
            expect(error.errors).toHaveLength(1)
            expect(error.errors[0].name).toEqual('AuthenticationError')
        }
    })

    test('admin: create resident ticket', async () => {
        const admin = await makeLoggedInAdminClient()
        const [organization] = await createTestOrganization(admin)
        const [classifier] = await createTestTicketClassifier(admin)
        const [property] = await createTestProperty(admin, organization)
        const [data] = await createResidentTicketByTestClient(admin, classifier, property)
        expect(data.id).toMatch(UUID_RE)
    })
})
