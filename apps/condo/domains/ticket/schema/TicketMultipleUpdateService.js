/**
 * Generated by `createservice ticket.TicketMultipleUpdateService --type mutations`
 */

const get = require('lodash/get')

const { GQLCustomSchema, getById } = require('@open-condo/keystone/schema')

const { Organization } = require('@condo/domains/organization/utils/serverSchema')
const access = require('@condo/domains/ticket/access/TicketMultipleUpdateService')
const { DEFAULT_STATUS_TRANSITIONS } = require('@condo/domains/ticket/constants/statusTransitions')
const { Ticket } = require('@condo/domains/ticket/utils/serverSchema')


const TicketMultipleUpdateService = new GQLCustomSchema('TicketMultipleUpdateService', {
    schemaDoc: 'Mutation used by the technician mobile app to sequentially apply queued ticket updates once the device is online',
    types: [
        {
            access: true,
            type: 'input TicketMultipleUpdateInput { dv: Int!, sender: SenderFieldInput!, id: ID!, data: [TicketUpdateInput]! }',
        },
    ],
    mutations: [
        {
            access: access.canTicketMultipleUpdate,
            schema: 'ticketMultipleUpdate(data: TicketMultipleUpdateInput!): Ticket!',
            resolver: async (parent, args, context) => {
                const { data } = args

                const ticketId = get(data, 'id')
                const updateData = get(data, 'data')

                if (!ticketId) return

                const existedTicket = await getById('Ticket', ticketId)
                const organizationId = get(existedTicket, 'organization', null)
                const ticketOrganization = await Organization.getOne(context, { id: organizationId }, 'statusTransitions')
                const organizationStatusTransitions = get(ticketOrganization, 'statusTransitions', DEFAULT_STATUS_TRANSITIONS)

                let existedTicketStatusId = get(existedTicket, 'status', null)
                
                for (const ticketUpdateData of updateData) {
                    const ticketStatusToUpdate = get(ticketUpdateData, 'status.connect.id', null)

                    if (ticketStatusToUpdate) {
                        if (
                            organizationStatusTransitions[existedTicketStatusId] &&
                            organizationStatusTransitions[existedTicketStatusId].includes(ticketStatusToUpdate)
                        ) {
                            const updatedTicket = await Ticket.update(context, ticketId, ticketUpdateData, 'id status { id }')
                            existedTicketStatusId = get(updatedTicket, 'status.id', null)
                        }
                    } else {
                        await Ticket.update(context, ticketId, ticketUpdateData)
                    }
                }

                return getById('Ticket', ticketId)
            },
        },
    ],

})

module.exports = {
    TicketMultipleUpdateService,
}
