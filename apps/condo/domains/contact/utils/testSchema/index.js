/**
 * Generated by `createschema contact.Contact 'property:Relationship:Property:SET_NULL; name:Text; phone:Text; unitName?:Text; email?:Text;'`
 * In most cases you should not change it by hands
 * Please, don't remove `AUTOGENERATE MARKER`s
 */
const { faker } = require('@faker-js/faker')
const { createTestPhone } = require('@condo/domains/user/utils/testSchema')
const { createTestEmail } = require('@condo/domains/user/utils/testSchema')

const { generateGQLTestUtils, throwIfError } = require('@open-condo/codegen/generate.test.utils')

const { Contact: ContactGQL } = require('@condo/domains/contact/gql')
const { ContactRole: ContactRoleGQL } = require('@condo/domains/contact/gql')
const { FLAT_UNIT_TYPE } = require('@condo/domains/property/constants/common')
const { ContactExportTask: ContactExportTaskGQL } = require('@condo/domains/contact/gql')
const { EXCEL } = require('../../../common/constants/export')
const { _INTERNAL_SYNC_CONTACTS_WITH_RESIDENTS_FOR_ORGANIZATION_MUTATION } = require('@condo/domains/contact/gql')
/* AUTOGENERATE MARKER <IMPORT> */

const Contact = generateGQLTestUtils(ContactGQL)
const ContactRole = generateGQLTestUtils(ContactRoleGQL)
const ContactExportTask = generateGQLTestUtils(ContactExportTaskGQL)
/* AUTOGENERATE MARKER <CONST> */

async function createTestContact (client, organization, property, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!organization || !organization.id) throw new Error('no organization.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        organization: { connect: { id: organization.id } },
        property: { connect: { id: property.id } },
        unitName: faker.random.alphaNumeric(3),
        unitType: FLAT_UNIT_TYPE,
        name: faker.name.firstName(),
        email: createTestEmail(),
        phone: createTestPhone(),
        ...extraAttrs,
    }
    const obj = await Contact.create(client, attrs)
    return [obj, attrs]
}

async function createTestContacts (client, createAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const attrs = createAttrs.map(data => {
        if (!('name' in data)) {
            data['name'] = faker.name.firstName()
        }
        if (!('phone' in data)) {
            data['phone'] = createTestPhone()
        }

        return {
            data: {...data, dv: 1, sender}
        }
    })

    return await Contact.createMany(client, attrs)
}

async function updateTestContact (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await Contact.update(client, id, attrs)
    return [obj, attrs]
}

async function updateTestContacts (client, updateAttrs = {}) {
    if (!client) throw new Error('no client')

    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const attrs = updateAttrs.map(updateData => {
        const { id, data } = updateData
        return { id, data: { ...data, dv: 1, sender } }
    })

    return await Contact.updateMany(client, attrs)
}

async function createTestContactRole (client, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        name: faker.name.jobDescriptor(),
        ...extraAttrs,
    }
    const obj = await ContactRole.create(client, attrs)
    return [obj, attrs]
}

async function updateTestContactRole (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await ContactRole.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestContactExportTask (client, user, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        format: EXCEL,
        where: {},
        sortBy: {},
        locale: 'en',
        timeZone: 'Europe/Moscow',
        user: { connect: { id: user.id } },
        ...extraAttrs,
    }
    const obj = await ContactExportTask.create(client, attrs)
    return [obj, attrs]
}

async function updateTestContactExportTask (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await ContactExportTask.update(client, id, attrs)
    return [obj, attrs]
}

async function _internalSyncContactsWithResidentsForOrganizationByTestClient(client, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(_INTERNAL_SYNC_CONTACTS_WITH_RESIDENTS_FOR_ORGANIZATION_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}
/* AUTOGENERATE MARKER <FACTORY> */

module.exports = {
    Contact, createTestContact, createTestContacts, updateTestContact, updateTestContacts,
    ContactRole, createTestContactRole, updateTestContactRole,
    ContactExportTask, createTestContactExportTask, updateTestContactExportTask,
    _internalSyncContactsWithResidentsForOrganizationByTestClient,
/* AUTOGENERATE MARKER <EXPORTS> */
}
