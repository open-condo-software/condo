/**
 * Generated by `createschema billing.BillingProperty 'context:Relationship:BillingIntegrationOrganizationContext:CASCADE; importId?:Text; bindingId:Text; address:Text; raw:Json; meta:Json'`
 */
const faker = require('faker')

const { makeLoggedInClient } = require('@condo/domains/user/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')
const { createTestBillingIntegrationOrganizationContext } = require('@condo/domains/billing/utils/testSchema')
const { createTestOrganization } = require('@condo/domains/organization/utils/testSchema')
const { createTestBillingIntegration } = require('@condo/domains/billing/utils/testSchema')
const { makeLoggedInAdminClient, makeClient } = require('@core/keystone/test.utils')

const { BillingProperty, createTestBillingProperty, updateTestBillingProperty } = require('@condo/domains/billing/utils/testSchema')
const { expectToThrowAccessDeniedErrorToObj, expectToThrowAccessDeniedErrorToObjects } = require('../../common/utils/testSchema')

describe('BillingProperty', () => {
    test('user: create BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const client = await makeClientWithNewRegisteredAndLoggedInUser()

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestBillingProperty(client, context)
        })
    })

    test('anonymous: create BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const client = await makeClient()

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestBillingProperty(client, context)
        })
    })

    test('user: read BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        await createTestBillingProperty(admin, context)
        const client = await makeLoggedInClient()
        const properties = await BillingProperty.getAll(client)

        expect(properties).toHaveLength(0)
    })

    test('anonymous: read BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        await createTestBillingProperty(admin, context)
        const client = await makeClient()

        await expectToThrowAccessDeniedErrorToObjects(async () => {
            await BillingProperty.getAll(client)
        })
    })

    test('user: update BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const client = await makeLoggedInClient()
        const payload = {
            raw: faker.lorem.words(),
            globalId: faker.lorem.words(),
            address: faker.lorem.words(),
        }

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestBillingProperty(client, property.id, payload)
        })
    })

    test('anonymous: update BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const client = await makeClient()
        const payload = {
            raw: faker.lorem.words(),
            globalId: faker.lorem.words(),
            address: faker.lorem.words(),
        }

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestBillingProperty(client, property.id, payload)
        })
    })

    test('user: delete BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const client = await makeLoggedInClient()

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await BillingProperty.delete(client, property.id)
        })
    })

    test('anonymous: delete BillingProperty', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const client = await makeClient()

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await BillingProperty.delete(client, property.id)
        })
    })
})
