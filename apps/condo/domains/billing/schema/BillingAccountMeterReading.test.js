/**
 * Generated by `createschema billing.BillingAccountMeterReading 'context:Relationship:BillingIntegrationOrganizationContext:CASCADE; importId?:Text; property:Relationship:BillingProperty:CASCADE; account:Relationship:BillingAccount:CASCADE; meter:Relationship:BillingAccountMeter:CASCADE; period:CalendarDay; value1:Integer; value2:Integer; value3:Integer; date:DateTimeUtc; raw:Json; meta:Json' --force`
 */
const faker = require('faker')

const {createTestBillingMeterResource} = require("@condo/domains/billing/utils/testSchema");
const {createTestBillingAccountMeter} = require("@condo/domains/billing/utils/testSchema");
const {createTestBillingAccount} = require("@condo/domains/billing/utils/testSchema");
const {createTestBillingProperty} = require("@condo/domains/billing/utils/testSchema");
const {createTestBillingIntegrationOrganizationContext} = require("@condo/domains/billing/utils/testSchema");
const {createTestOrganization} = require("@condo/domains/organization/utils/testSchema");
const {createTestBillingIntegration} = require("@condo/domains/billing/utils/testSchema");
const {makeLoggedInClient} = require("@condo/domains/user/utils/testSchema");
const { makeLoggedInAdminClient, makeClient, UUID_RE, DATETIME_RE } = require('@core/keystone/test.utils')
const { BillingAccountMeterReading, createTestBillingAccountMeterReading, updateTestBillingAccountMeterReading } = require('@condo/domains/billing/utils/testSchema')
const { expectToThrowAccessDeniedErrorToObj, expectToThrowAccessDeniedErrorToObjects } = require('@condo/domains/common/utils/testSchema')

describe('BillingAccountMeterReading', () => {
    test('admin: create BillingAccountMeterReading', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [obj, attrs] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        expect(obj.id).toMatch(UUID_RE)
        expect(obj.dv).toEqual(1)
        expect(obj.sender).toEqual(attrs.sender)
        expect(obj.v).toEqual(1)
        expect(obj.newId).toEqual(null)
        expect(obj.deletedAt).toEqual(null)
        expect(obj.createdBy).toEqual(expect.objectContaining({ id: admin.user.id }))
        expect(obj.updatedBy).toEqual(expect.objectContaining({ id: admin.user.id }))
        expect(obj.createdAt).toMatch(DATETIME_RE)
        expect(obj.updatedAt).toMatch(DATETIME_RE)
    })

    test('user: create BillingAccountMeterReading', async () => {
        const client = await makeLoggedInClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestBillingAccountMeterReading(client, context, property, billingAccount, meter)
        })
    })

    test('anonymous: create BillingAccountMeterReading', async () => {
        const client = await makeClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestBillingAccountMeterReading(client, context, property, billingAccount, meter)
        })
    })

    test('admin: read BillingAccountMeterReading', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)
        const objs = await BillingAccountMeterReading.getAll(admin, { id: billingAccountMeterReading.id })

        expect(objs).toHaveLength(1)
    })

    test('user: read BillingAccountMeterReading', async () => {
        const client = await makeLoggedInClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)
        const objs = await BillingAccountMeterReading.getAll(client)

        expect(objs).toHaveLength(0)
    })

    test('anonymous: read BillingAccountMeterReading', async () => {
        const client = await makeClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        await expectToThrowAccessDeniedErrorToObjects(async () => {
            await BillingAccountMeterReading.getAll(client)
        })
    })

    test('admin: update BillingAccountMeterReading', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        const dv1 = faker.datatype.number()
        const dv2 = faker.datatype.number()
        const dv3 = faker.datatype.number()
        const payload = {
            value1: billingAccountMeterReading.value1 + dv1,
            value2: billingAccountMeterReading.value2 + dv2,
            value3: billingAccountMeterReading.value3 + dv3,
        }
        const [updatedBillingAccountMeterReading, attrs] = await updateTestBillingAccountMeterReading(admin, billingAccountMeterReading.id, payload)

        expect(updatedBillingAccountMeterReading.id).toEqual(billingAccountMeterReading.id)
        expect(updatedBillingAccountMeterReading.dv).toEqual(1)
        expect(updatedBillingAccountMeterReading.sender).toEqual(attrs.sender)
        expect(updatedBillingAccountMeterReading.v).toEqual(2)
        expect(updatedBillingAccountMeterReading.newId).toEqual(null)
        expect(updatedBillingAccountMeterReading.deletedAt).toEqual(null)
        expect(updatedBillingAccountMeterReading.createdBy).toEqual(expect.objectContaining({ id: admin.user.id }))
        expect(updatedBillingAccountMeterReading.updatedBy).toEqual(expect.objectContaining({ id: admin.user.id }))
        expect(updatedBillingAccountMeterReading.createdAt).toMatch(DATETIME_RE)
        expect(updatedBillingAccountMeterReading.updatedAt).toMatch(DATETIME_RE)
        expect(updatedBillingAccountMeterReading.updatedAt).not.toEqual(updatedBillingAccountMeterReading.createdAt)
        expect(updatedBillingAccountMeterReading.value1).toEqual(billingAccountMeterReading.value1 + dv1)
        expect(updatedBillingAccountMeterReading.value2).toEqual(billingAccountMeterReading.value2 + dv2)
        expect(updatedBillingAccountMeterReading.value3).toEqual(billingAccountMeterReading.value3 + dv3)
    })

    test('user: update BillingAccountMeterReading', async () => {
        const client = await makeLoggedInClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        const payload = {}
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestBillingAccountMeterReading(client, billingAccountMeterReading.id, payload)
        })
    })

    test('anonymous: update BillingAccountMeterReading', async () => {
        const client = await makeClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        const payload = {}
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestBillingAccountMeterReading(client, billingAccountMeterReading.id, payload)
        })
    })

    // You do not have access to this resource deleteBillingAccountMeterReading
    test.skip('admin: delete BillingAccountMeterReading', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)
        await BillingAccountMeterReading.delete(admin, billingAccountMeterReading.id)
        const billingAccountMeterReadings = BillingAccountMeterReading.getAll(admin, { id: billingAccountMeterReading.id })

        expect(billingAccountMeterReadings).toHaveLength(0)
    })

    test('user: delete BillingAccountMeterReading', async () => {
        const client = await makeLoggedInClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await BillingAccountMeterReading.delete(client, billingAccountMeterReading.id)
        })
    })

    test('anonymous: delete BillingAccountMeterReading', async () => {
        const client = await makeClient()
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [organization] = await createTestOrganization(admin)
        const [context] = await createTestBillingIntegrationOrganizationContext(admin, organization, integration)
        const [property] = await createTestBillingProperty(admin, context)
        const [billingAccount] = await createTestBillingAccount(admin, context, property)
        const [resource] = await createTestBillingMeterResource(admin)
        const [meter] = await createTestBillingAccountMeter(admin, context, property, billingAccount, resource)
        const [billingAccountMeterReading] = await createTestBillingAccountMeterReading(admin, context, property, billingAccount, meter)

        await expectToThrowAccessDeniedErrorToObj(async () => {
            await BillingAccountMeterReading.delete(client, billingAccountMeterReading.id)
        })
    })
})
