/**
 * Generated by `createservice billing.SumBillingReceiptsService`
 */

const Big = require('big.js')

const { getDatabaseAdapter } = require('@open-condo/keystone/databaseAdapters/utils')
const { GQLError } = require('@open-condo/keystone/errors')
const { GQLCustomSchema, getSchemaCtx } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/billing/access/SumBillingReceiptsService')
const { WRONG_VALUE } = require('@condo/domains/common/constants/errors')


const ERRORS = {
    TIN_OR_ORGANIZATION_ID_MUST_BE_SPECIFIED: {
        mutation: '_allBillingReceiptsSum',
        variable: ['where'],
        code: 'BAD_USER_INPUT',
        type: WRONG_VALUE,
        message: 'You must specify one of two values: tin or organizationId',
    },
}

const SumBillingReceiptsService = new GQLCustomSchema('SumBillingReceiptsService', {
    types: [
        {
            access: true,
            type: 'input BillingReceiptsSumInput { period: String!, organizationId: ID, tin: String, importRemoteSystem: String }',
        },
        {
            access: true,
            type: 'type BillingReceiptsSumOutput { sum: String! }',
        },
    ],
    queries: [
        {
            access: access.canSumBillingReceipts,
            schema: '_allBillingReceiptsSum (where: BillingReceiptsSumInput!): BillingReceiptsSumOutput',
            resolver: async (parent, args) => {
                const { where: { period, tin, organizationId, importRemoteSystem } } = args

                if (!tin && !organizationId) {
                    throw new GQLError(ERRORS.TIN_OR_ORGANIZATION_ID_MUST_BE_SPECIFIED)
                }

                const { keystone } = getSchemaCtx('BillingReceipt')
                const { knex } = getDatabaseAdapter(keystone)

                const query = knex('BillingReceipt')
                    .sum('BillingReceipt.toPay as totalToPay')
                    .innerJoin('BillingIntegrationOrganizationContext', 'BillingReceipt.context', 'BillingIntegrationOrganizationContext.id')
                    .innerJoin('Organization', 'BillingIntegrationOrganizationContext.organization', 'Organization.id')
                    .where('BillingReceipt.period', period)

                if (organizationId) {
                    query.andWhere('Organization.id', organizationId)
                }
                if (tin) {
                    query.andWhere('Organization.tin', tin)
                }
                if (importRemoteSystem) {
                    query
                        .andWhereNot('Organization.importId', null)
                        .andWhere('Organization.importRemoteSystem', importRemoteSystem)
                }

                const result = await query

                return {
                    sum: Big(result[0].totalToPay || 0).toFixed(8),
                }
            },
        },
    ],

})

module.exports = {
    SumBillingReceiptsService,
    ERRORS,
}