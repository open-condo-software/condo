/**
 * Generated by `createschema "billing.BillingIntegrationAccessRight integration:Relationship:BillingIntegration:PROTECT; user:Relationship:User:CASCADE;"`
 */

const { makeClientWithSupportUser } = require('../../user/utils/testSchema')
const { makeLoggedInAdminClient, makeClient } = require('@core/keystone/test.utils')
const { makeClientWithNewRegisteredAndLoggedInUser } = require('@condo/domains/user/utils/testSchema')
const {
    BillingIntegrationAccessRight,
    createTestBillingIntegrationAccessRight,
    updateTestBillingIntegrationAccessRight,
    createTestBillingIntegration,
} = require('../utils/testSchema')
const {
    expectToThrowAccessDeniedErrorToObjects,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAccessDeniedErrorToObj,
} = require('@condo/domains/common/utils/testSchema')

describe('BillingIntegrationAccessRight', () => {
    test('user: create BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)

        const client = await makeClientWithNewRegisteredAndLoggedInUser()
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await createTestBillingIntegrationAccessRight(client, integration, client.user)
        })
    })

    test('anonymous: create BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)

        const client = await makeClient()
        await expectToThrowAuthenticationErrorToObj(async () => {
            await createTestBillingIntegrationAccessRight(client, integration, admin.user)
        })
    })

    test('support: create BillingIntegrationAccessRight', async () => {
        const support = await makeClientWithSupportUser()

        const [integration] = await createTestBillingIntegration(support)
        const client = await makeClientWithNewRegisteredAndLoggedInUser()

        const [integrationAccessRight] = await createTestBillingIntegrationAccessRight(support, integration, client.user)
        expect(integrationAccessRight).toEqual(
            expect.objectContaining({
                integration: { id: integration.id, name: integration.name },
            }),
        )
    })

    test('admin: create BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()

        const [integration] = await createTestBillingIntegration(admin)
        const client = await makeClientWithNewRegisteredAndLoggedInUser()

        const [integrationAccessRight] = await createTestBillingIntegrationAccessRight(admin, integration, client.user)
        expect(integrationAccessRight).toEqual(
            expect.objectContaining({
                integration: { id: integration.id, name: integration.name },
            }),
        )
    })

    test('user: read BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        await createTestBillingIntegrationAccessRight(admin, integration, admin.user)

        const client = await makeClientWithNewRegisteredAndLoggedInUser()
        await expectToThrowAccessDeniedErrorToObjects(async () => {
            await BillingIntegrationAccessRight.getAll(client)
        })
    })

    test('anonymous: read BillingIntegrationAccessRight', async () => {
        const client = await makeClient()

        await expectToThrowAuthenticationErrorToObjects(async () => {
            await BillingIntegrationAccessRight.getAll(client)
        })
    })

    test('user: update BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [objCreated] = await createTestBillingIntegrationAccessRight(admin, integration, admin.user)

        const client = await makeClientWithNewRegisteredAndLoggedInUser()
        const payload = {}
        await expectToThrowAccessDeniedErrorToObj(async () => {
            await updateTestBillingIntegrationAccessRight(client, objCreated.id, payload)
        })
    })

    test('anonymous: update BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [objCreated] = await createTestBillingIntegrationAccessRight(admin, integration, admin.user)

        const client = await makeClient()
        const payload = {}
        await expectToThrowAuthenticationErrorToObj(async () => {
            await updateTestBillingIntegrationAccessRight(client, objCreated.id, payload)
        })
    })

    test('admin: delete BillingIntegrationAccessRight', async () => {
        const admin = await makeLoggedInAdminClient()
        const [integration] = await createTestBillingIntegration(admin)
        const [objCreated] = await createTestBillingIntegrationAccessRight(admin, integration, admin.user)

        try {
            await BillingIntegrationAccessRight.delete(admin, objCreated.id)
        } catch (e) {
            expect(e.errors[0]).toMatchObject({
                message: expect.stringContaining('Cannot query field "deleteBillingIntegrationAccessRight" on type "Mutation"'),
                name: 'ValidationError',
            })
            expect(e.data).toBeUndefined()
        }
    })
})
