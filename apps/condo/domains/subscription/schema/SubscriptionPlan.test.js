/**
 * Generated by `createschema subscription.SubscriptionPlan 'type:Select:basic,extended; periodType:Select:monthly,yearly; name:Text; description:Text; price:Decimal; currencyCode:Text; news:Checkbox; marketplace:Checkbox; support:Checkbox; ai:Checkbox; passTickets:Checkbox; isHidden:Checkbox;'`
 */

const { makeLoggedInAdminClient, makeClient, UUID_RE, catchErrorFrom } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { SERVICE_PROVIDER_TYPE, HOLDING_TYPE } = require('@condo/domains/organization/constants/common')
const {
    SubscriptionPlan,
    createTestSubscriptionPlan,
    updateTestSubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

describe('SubscriptionPlan', () => {
    let admin, support

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
    })

    beforeEach(async () => {
        const plans = await SubscriptionPlan.getAll(admin, {
            isHidden: false,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }
    })

    describe('CRUD tests', () => {
        describe('create', () => {
            test('admin can create', async () => {
                const [obj] = await createTestSubscriptionPlan(admin, {
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                    order: 1,
                })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.name).toBe('Test Plan')
                expect(obj.order).toBe(1)
            })

            test('support can create', async () => {
                const [obj] = await createTestSubscriptionPlan(support, {
                    name: 'Support Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                expect(obj.id).toMatch(UUID_RE)
            })

            test('regular user cannot create', async () => {
                const user = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestSubscriptionPlan(user, {
                        name: 'User Plan',
                        organizationType: SERVICE_PROVIDER_TYPE,
                        isHidden: false,
                    })
                })
            })

            test('anonymous cannot create', async () => {
                const client = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestSubscriptionPlan(client, {
                        name: 'Anonymous Plan',
                        organizationType: SERVICE_PROVIDER_TYPE,
                        isHidden: false,
                    })
                })
            })
        })

        describe('update', () => {
            test('admin can update name', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: 'Original Name',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                    name: 'Updated Name',
                })

                expect(obj.name).toBe('Updated Name')
            })

            test('support can update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: 'Original Name',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const [obj] = await updateTestSubscriptionPlan(support, objCreated.id, {
                    name: 'Support Updated',
                })

                expect(obj.name).toBe('Support Updated')
            })

            test('anonymous cannot update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestSubscriptionPlan(client, objCreated.id, { name: 'Hacked' })
                })
            })
        })

        describe('hard delete', () => {
            test('admin cannot delete', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await SubscriptionPlan.delete(admin, objCreated.id)
                })
            })
        })

        describe('read', () => {
            test('admin can read', async () => {
                const [obj] = await createTestSubscriptionPlan(admin, {
                    name: 'Readable Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const objs = await SubscriptionPlan.getAll(admin, { id: obj.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(obj.id)
            })

            test('anonymous cannot read', async () => {
                await createTestSubscriptionPlan(admin, {
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await SubscriptionPlan.getAll(client, {})
                })
            })
        })
    })

    describe('Order field tests', () => {
        test('order defaults to 0', async () => {
            const [obj] = await createTestSubscriptionPlan(admin, {
                name: 'Plan without order',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            expect(obj.order).toBe(0)
        })

        test('can create plans with different orders', async () => {
            const [plan1] = await createTestSubscriptionPlan(admin, {
                name: 'First Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                order: 1,
            })

            const [plan2] = await createTestSubscriptionPlan(admin, {
                name: 'Second Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                order: 2,
            })

            expect(plan1.order).toBe(1)
            expect(plan2.order).toBe(2)
        })

        test('can update order', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: 'Test Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                order: 1,
            })

            const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                order: 5,
            })

            expect(obj.order).toBe(5)
        })

        test('can create active plan with different organizationType', async () => {
            const [plan1] = await createTestSubscriptionPlan(admin, {
                name: 'Service Provider Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            const [plan2] = await createTestSubscriptionPlan(admin, {
                name: 'Holding Plan',
                organizationType: HOLDING_TYPE,
                isHidden: false,
            })

            expect(plan1.id).toMatch(UUID_RE)
            expect(plan2.id).toMatch(UUID_RE)
        })
    })

    describe('Field access restrictions', () => {
        test('cannot update organizationType', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: 'Test Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            await catchErrorFrom(async () => {
                await updateTestSubscriptionPlan(admin, objCreated.id, {
                    organizationType: HOLDING_TYPE,
                })
            }, ({ errors }) => {
                expect(errors[0].message).toContain('Field "organizationType" is not defined by type "SubscriptionPlanUpdateInput"')
            })
        })
    })

    describe('trialDays field tests', () => {
        test('trialDays defaults to 0', async () => {
            const [obj] = await createTestSubscriptionPlan(admin, {
                name: 'Plan without trialDays',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            expect(obj.trialDays).toBe(0)
        })

        test('can create plan with custom trialDays', async () => {
            const [obj] = await createTestSubscriptionPlan(admin, {
                name: 'Plan with trial',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            expect(obj.trialDays).toBe(14)
        })

        test('can update trialDays', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: 'Test Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                trialDays: 7,
            })

            const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                trialDays: 30,
            })

            expect(obj.trialDays).toBe(30)
        })
    })
})
