/**
 * Generated by `createschema subscription.SubscriptionPlan 'type:Select:basic,extended; periodType:Select:monthly,yearly; name:Text; description:Text; price:Decimal; currencyCode:Text; news:Checkbox; marketplace:Checkbox; support:Checkbox; ai:Checkbox; passTickets:Checkbox; isHidden:Checkbox;'`
 */

const { faker } = require('@faker-js/faker')

const { makeLoggedInAdminClient, makeClient, UUID_RE, expectToThrowGQLError, catchErrorFrom } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { SERVICE_PROVIDER_TYPE, HOLDING_TYPE } = require('@condo/domains/organization/constants/common')
const {
    SubscriptionPlan,
    createTestSubscriptionPlan,
    updateTestSubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

const { ERRORS } = require('./SubscriptionPlan')

describe('SubscriptionPlan', () => {
    let admin, support

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
    })

    describe('CRUD tests', () => {
        describe('create', () => {
            test('admin can create', async () => {
                const planName = faker.commerce.productName()
                const [obj] = await createTestSubscriptionPlan(admin, {
                    name: planName,
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                    priority: 1,
                })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.name).toBe(planName)
                expect(obj.priority).toBe(1)
            })

            test('support can create', async () => {
                const [obj] = await createTestSubscriptionPlan(support, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                expect(obj.id).toMatch(UUID_RE)
            })

            test('regular user cannot create', async () => {
                const user = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestSubscriptionPlan(user, {
                        name: faker.commerce.productName(),
                        organizationType: SERVICE_PROVIDER_TYPE,
                        isHidden: false,
                    })
                })
            })

            test('anonymous cannot create', async () => {
                const client = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestSubscriptionPlan(client, {
                        name: faker.commerce.productName(),
                        organizationType: SERVICE_PROVIDER_TYPE,
                        isHidden: false,
                    })
                })
            })
        })

        describe('update', () => {
            test('admin can update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const updatedName = faker.commerce.productName()
                const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                    name: updatedName,
                })

                expect(obj.name).toBe(updatedName)
            })

            test('support can update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const updatedName = faker.commerce.productName()
                const [obj] = await updateTestSubscriptionPlan(support, objCreated.id, {
                    name: updatedName,
                })

                expect(obj.name).toBe(updatedName)
            })

            test('anonymous cannot update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestSubscriptionPlan(client, objCreated.id, { name: faker.commerce.productName() })
                })
            })
        })

        describe('read', () => {
            test('admin can read', async () => {
                const [obj] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const objs = await SubscriptionPlan.getAll(admin, { id: obj.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(obj.id)
            })

            test('anonymous cannot read', async () => {
                await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await SubscriptionPlan.getAll(client, {})
                })
            })

            test('admin can read hidden plans', async () => {
                const [hiddenPlan] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: true,
                })

                const objs = await SubscriptionPlan.getAll(admin, { id: hiddenPlan.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(hiddenPlan.id)
            })

            test('support can read hidden plans', async () => {
                const [hiddenPlan] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: true,
                })

                const objs = await SubscriptionPlan.getAll(support, { id: hiddenPlan.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(hiddenPlan.id)
            })

            test('regular user can read not hidden plans', async () => {
                const [visiblePlan] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                })
                const [hiddenPlan] = await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: true,
                })

                const user = await makeClientWithNewRegisteredAndLoggedInUser()
                const objs = await SubscriptionPlan.getAll(user, {
                    id_in: [visiblePlan.id, hiddenPlan.id],
                })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(visiblePlan.id)
            })
        })
    })

    describe('Priority field tests', () => {
        test('priority defaults to 0', async () => {
            const [obj] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            expect(obj.priority).toBe(0)
        })

        test('can create plans with different priorities', async () => {
            const [plan1] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                priority: 1,
            })

            const [plan2] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                priority: 2,
            })

            expect(plan1.priority).toBe(1)
            expect(plan2.priority).toBe(2)
        })

        test('can update priority', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                priority: 1,
            })

            const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                priority: 5,
            })

            expect(obj.priority).toBe(5)
        })
    })

    describe('Field access restrictions', () => {
        test('can create active plan with different organizationType', async () => {
            const [plan1] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            const [plan2] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: HOLDING_TYPE,
                isHidden: false,
            })

            expect(plan1.id).toMatch(UUID_RE)
            expect(plan2.id).toMatch(UUID_RE)
        })
        
        test('cannot update organizationType', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            await catchErrorFrom(async () => {
                await updateTestSubscriptionPlan(admin, objCreated.id, {
                    organizationType: HOLDING_TYPE,
                })
            }, ({ errors }) => {
                expect(errors[0].message).toContain('Field "organizationType" is not defined by type "SubscriptionPlanUpdateInput"')
            })
        })
    })

    describe('trialDays field tests', () => {
        test('trialDays defaults to 0', async () => {
            const [obj] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
            })

            expect(obj.trialDays).toBe(0)
        })

        test('can create plan with custom trialDays', async () => {
            const [obj] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            expect(obj.trialDays).toBe(14)
        })

        test('can update trialDays', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                trialDays: 7,
            })

            const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                trialDays: 30,
            })

            expect(obj.trialDays).toBe(30)
        })

        test('cannot create plan with negative trialDays', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlan(admin, {
                    name: faker.commerce.productName(),
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isHidden: false,
                    trialDays: -1,
                })
            }, ERRORS.TRIAL_DAYS_MUST_BE_NON_NEGATIVE, 'obj')
        })

        test('cannot update plan with negative trialDays', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                name: faker.commerce.productName(),
                organizationType: SERVICE_PROVIDER_TYPE,
                isHidden: false,
                trialDays: 7,
            })

            await expectToThrowGQLError(async () => {
                await updateTestSubscriptionPlan(admin, objCreated.id, {
                    trialDays: -5,
                })
            }, ERRORS.TRIAL_DAYS_MUST_BE_NON_NEGATIVE, 'obj')
        })
    })
})
