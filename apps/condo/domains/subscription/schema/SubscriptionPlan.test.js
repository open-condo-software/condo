/**
 * Generated by `createschema subscription.SubscriptionPlan 'type:Select:basic,extended; periodType:Select:monthly,yearly; name:Text; description:Text; price:Decimal; currencyCode:Text; news:Checkbox; marketplace:Checkbox; support:Checkbox; ai:Checkbox; passTickets:Checkbox; isActive:Checkbox;'`
 */

const { makeLoggedInAdminClient, makeClient, UUID_RE, expectToThrowGQLError } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { SERVICE_PROVIDER_TYPE } = require('@condo/domains/organization/constants/common')
const { SUBSCRIPTION_TYPE } = require('@condo/domains/subscription/constants')
const {
    SubscriptionPlan,
    createTestSubscriptionPlan,
    updateTestSubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

describe('SubscriptionPlan', () => {
    let admin, support

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
    })

    beforeEach(async () => {
        const plans = await SubscriptionPlan.getAll(admin, {
            isActive: true,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }
    })

    describe('CRUD tests', () => {
        describe('create', () => {
            test('admin can create', async () => {
                const [obj] = await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.type).toBe(SUBSCRIPTION_TYPE.BASIC)
                expect(obj.name).toBe('Test Plan')
            })

            test('support can create', async () => {
                const [obj] = await createTestSubscriptionPlan(support, {
                    type: SUBSCRIPTION_TYPE.EXTENDED,
                    name: 'Support Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                expect(obj.id).toMatch(UUID_RE)
            })

            test('regular user cannot create', async () => {
                const user = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestSubscriptionPlan(user, {
                        type: SUBSCRIPTION_TYPE.BASIC,
                        name: 'User Plan',
                        organizationType: SERVICE_PROVIDER_TYPE,
                        isActive: true,
                    })
                })
            })

            test('anonymous cannot create', async () => {
                const client = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestSubscriptionPlan(client, {
                        type: SUBSCRIPTION_TYPE.BASIC,
                        name: 'Anonymous Plan',
                        organizationType: SERVICE_PROVIDER_TYPE,
                        isActive: true,
                    })
                })
            })
        })

        describe('update', () => {
            test('admin can update name', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Original Name',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                    name: 'Updated Name',
                })

                expect(obj.name).toBe('Updated Name')
            })

            test('support can update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Original Name',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                const [obj] = await updateTestSubscriptionPlan(support, objCreated.id, {
                    name: 'Support Updated',
                })

                expect(obj.name).toBe('Support Updated')
            })

            test('anonymous cannot update', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestSubscriptionPlan(client, objCreated.id, { name: 'Hacked' })
                })
            })
        })

        describe('hard delete', () => {
            test('admin cannot delete', async () => {
                const [objCreated] = await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await SubscriptionPlan.delete(admin, objCreated.id)
                })
            })
        })

        describe('read', () => {
            test('admin can read', async () => {
                const [obj] = await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Readable Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                const objs = await SubscriptionPlan.getAll(admin, { id: obj.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(obj.id)
            })

            test('anonymous cannot read', async () => {
                await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Test Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await SubscriptionPlan.getAll(client, {})
                })
            })
        })
    })

    describe('Validation tests', () => {
        test('cannot create duplicate active plan with same type and organizationType', async () => {
            await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'First Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlan(admin, {
                    type: SUBSCRIPTION_TYPE.BASIC,
                    name: 'Duplicate Plan',
                    organizationType: SERVICE_PROVIDER_TYPE,
                    isActive: true,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'DUPLICATE_ACTIVE_PLAN',
                message: 'An active subscription plan with this type and organizationType already exists',
            }, 'obj')
        })

        test('can create inactive plan with same type and organizationType', async () => {
            await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Active Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            const [inactivePlan] = await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Inactive Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: false,
            })

            expect(inactivePlan.id).toMatch(UUID_RE)
            expect(inactivePlan.isActive).toBe(false)
        })

        test('can create active plan with different type', async () => {
            await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Basic Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            const [extendedPlan] = await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.EXTENDED,
                name: 'Extended Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            expect(extendedPlan.id).toMatch(UUID_RE)
            expect(extendedPlan.type).toBe(SUBSCRIPTION_TYPE.EXTENDED)
        })

        test('can create active plan with different organizationType', async () => {
            await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Managing Company Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            const [holdingPlan] = await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Holding Plan',
                organizationType: 'HOLDING',
                isActive: true,
            })

            expect(holdingPlan.id).toMatch(UUID_RE)
        })

        test('cannot activate plan if another active plan exists with same type and organizationType', async () => {
            await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Active Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            const [inactivePlan] = await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Inactive Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: false,
            })

            await expectToThrowGQLError(async () => {
                await updateTestSubscriptionPlan(admin, inactivePlan.id, { isActive: true })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'DUPLICATE_ACTIVE_PLAN',
                message: 'An active subscription plan with this type and organizationType already exists',
            }, 'obj')
        })
    })

    describe('Field access restrictions', () => {
        test('cannot update type', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Test Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                type: SUBSCRIPTION_TYPE.EXTENDED,
            })

            expect(obj.type).toBe(SUBSCRIPTION_TYPE.BASIC)
        })

        test('cannot update organizationType', async () => {
            const [objCreated] = await createTestSubscriptionPlan(admin, {
                type: SUBSCRIPTION_TYPE.BASIC,
                name: 'Test Plan',
                organizationType: SERVICE_PROVIDER_TYPE,
                isActive: true,
            })

            const [obj] = await updateTestSubscriptionPlan(admin, objCreated.id, {
                organizationType: 'HOLDING',
            })

            expect(obj.organizationType).toBe(SERVICE_PROVIDER_TYPE)
        })
    })
})
