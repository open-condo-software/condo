/**
 * Generated by `createschema subscription.SubscriptionPlanPricingRule 'name:Text; description:Text; subscriptionPlan:Relationship:SubscriptionPlan:CASCADE; period:Select:monthly,yearly; currencyCode:Text; organization:Relationship:Organization:CASCADE; organizationFeatures:Json; discountPercent:Decimal; fixedPrice:Decimal; priority:Integer; isActive:Checkbox; canBePromoted:Checkbox; promotionText:Text;'`
 */

const { makeLoggedInAdminClient, makeClient, UUID_RE, expectToThrowGQLError } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { MANAGING_COMPANY_TYPE } = require('@condo/domains/organization/constants/common')
const { ACTIVE_BANKING_FEATURE, HIGH_REVENUE_CUSTOMER_FEATURE } = require('@condo/domains/organization/constants/features')
const { SUBSCRIPTION_TYPE, SUBSCRIPTION_PERIOD } = require('@condo/domains/subscription/constants')
const {
    SubscriptionPlan,
    SubscriptionPlanPricingRule,
    createTestSubscriptionPlanPricingRule,
    updateTestSubscriptionPlanPricingRule,
    createTestSubscriptionPlan,
    updateTestSubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

describe('SubscriptionPlanPricingRule', () => {
    let admin, support
    let subscriptionPlan

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()

        const plans = await SubscriptionPlan.getAll(admin, {
            isActive: true,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }

        const [plan] = await createTestSubscriptionPlan(admin, {
            type: SUBSCRIPTION_TYPE.BASIC,
            name: 'Test Plan',
            organizationType: MANAGING_COMPANY_TYPE,
            isActive: true,
        })
        subscriptionPlan = plan
    })

    afterAll(async () => {
        const plans = await SubscriptionPlan.getAll(admin, {
            isActive: true,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }
    })

    describe('CRUD tests', () => {
        describe('create', () => {
            test('admin can create with fixedPrice', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: 'RUB',
                    discountPercent: null,
                })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.fixedPrice).toBe('1000.00000000')
                expect(obj.currencyCode).toBe('RUB')
            })

            test('admin can create with discountPercent', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '15',
                    fixedPrice: null,
                })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.discountPercent).toBe('15.0000')
            })

            test('support can create', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(support, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.YEARLY,
                    fixedPrice: '10000.00',
                    currencyCode: 'RUB',
                    discountPercent: null,
                })

                expect(obj.id).toMatch(UUID_RE)
            })

            test('regular user cannot create', async () => {
                const user = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestSubscriptionPlanPricingRule(user, subscriptionPlan, {
                        period: SUBSCRIPTION_PERIOD.MONTHLY,
                        discountPercent: '10',
                    })
                })
            })

            test('anonymous cannot create', async () => {
                const client = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestSubscriptionPlanPricingRule(client, subscriptionPlan, {
                        period: SUBSCRIPTION_PERIOD.MONTHLY,
                        discountPercent: '10',
                    })
                })
            })
        })

        describe('update', () => {
            test('admin can update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '10',
                    fixedPrice: null,
                })

                const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                    discountPercent: '20',
                })

                expect(obj.discountPercent).toBe('20.0000')
            })

            test('support can update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '10',
                    fixedPrice: null,
                })

                const [obj] = await updateTestSubscriptionPlanPricingRule(support, objCreated.id, {
                    name: 'Updated Name',
                })

                expect(obj.name).toBe('Updated Name')
            })

            test('anonymous cannot update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '10',
                    fixedPrice: null,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestSubscriptionPlanPricingRule(client, objCreated.id, { name: 'Hacked' })
                })
            })
        })

        describe('hard delete', () => {
            test('admin cannot delete', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '10',
                    fixedPrice: null,
                })

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await SubscriptionPlanPricingRule.delete(admin, objCreated.id)
                })
            })
        })

        describe('read', () => {
            test('admin can read', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '10',
                    fixedPrice: null,
                })

                const objs = await SubscriptionPlanPricingRule.getAll(admin, { id: obj.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(obj.id)
            })

            test('anonymous cannot read', async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    discountPercent: '10',
                    fixedPrice: null,
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await SubscriptionPlanPricingRule.getAll(client, {})
                })
            })
        })
    })

    describe('Validation tests', () => {
        test('must have either fixedPrice or discountPercent', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: null,
                    discountPercent: null,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_PRICING_RULE_VALUES',
                message: 'You must specify either fixedPrice or discountPercent, but not both',
            }, 'obj')
        })

        test('cannot have both fixedPrice and discountPercent', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: 'RUB',
                    discountPercent: '10',
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_PRICING_RULE_VALUES',
                message: 'You must specify either fixedPrice or discountPercent, but not both',
            }, 'obj')
        })

        test('currencyCode is required when fixedPrice is set', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: null,
                    discountPercent: null,
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'CURRENCY_REQUIRED_FOR_FIXED_PRICE',
                message: 'currencyCode is required when fixedPrice is specified',
            }, 'obj')
        })

        test('can create multiple rules for same plan with different periods', async () => {
            const [monthlyRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '1000.00',
                currencyCode: 'RUB',
                discountPercent: null,
            })

            const [yearlyRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.YEARLY,
                fixedPrice: '10000.00',
                currencyCode: 'RUB',
                discountPercent: null,
            })

            expect(monthlyRule.id).toMatch(UUID_RE)
            expect(yearlyRule.id).toMatch(UUID_RE)
            expect(monthlyRule.period).toBe(SUBSCRIPTION_PERIOD.MONTHLY)
            expect(yearlyRule.period).toBe(SUBSCRIPTION_PERIOD.YEARLY)
        })

        test('can create multiple rules for same plan and period with different priorities', async () => {
            const [baseRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '1000.00',
                currencyCode: 'RUB',
                discountPercent: null,
                priority: 100,
            })

            const [discountRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                discountPercent: '10',
                fixedPrice: null,
                priority: 50,
            })

            expect(baseRule.id).toMatch(UUID_RE)
            expect(discountRule.id).toMatch(UUID_RE)
            expect(baseRule.priority).toBe(100)
            expect(discountRule.priority).toBe(50)
        })

        test('can update from discountPercent to fixedPrice', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                discountPercent: '10',
                fixedPrice: null,
            })

            const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                discountPercent: null,
                fixedPrice: '500.00',
                currencyCode: 'RUB',
            })

            expect(obj.fixedPrice).toBe('500.00000000')
            expect(obj.discountPercent).toBeNull()
        })

        test('isActive defaults to true', async () => {
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                discountPercent: '10',
                fixedPrice: null,
            })

            expect(obj.isActive).toBe(true)
        })

        test('can deactivate rule', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                discountPercent: '10',
                fixedPrice: null,
            })

            const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                isActive: false,
            })

            expect(obj.isActive).toBe(false)
        })
    })

    describe('Conditions validation tests', () => {
        test('can create rule with null conditions', async () => {
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '1000.00',
                currencyCode: 'RUB',
                discountPercent: null,
                conditions: null,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toBeNull()
        })

        test('can create rule with valid single condition', async () => {
            const conditions = {
                fact: 'organizationFeatures',
                operator: 'contains',
                value: ACTIVE_BANKING_FEATURE,
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '1000.00',
                currencyCode: 'RUB',
                discountPercent: null,
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('can create rule with valid all conditions', async () => {
            const conditions = {
                all: [
                    { fact: 'organizationFeatures', operator: 'contains', value: ACTIVE_BANKING_FEATURE },
                    { fact: 'organizationFeatures', operator: 'contains', value: HIGH_REVENUE_CUSTOMER_FEATURE },
                ],
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '0.00',
                currencyCode: 'RUB',
                discountPercent: null,
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('can create rule with valid any conditions', async () => {
            const conditions = {
                any: [
                    { fact: 'organizationFeatures', operator: 'contains', value: ACTIVE_BANKING_FEATURE },
                    { fact: 'organizationIds', operator: 'contains', value: 'some-org-id' },
                ],
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                discountPercent: '20',
                fixedPrice: null,
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('can create rule with organizationIds condition', async () => {
            const conditions = {
                all: [
                    { fact: 'organizationIds', operator: 'contains', value: 'org-uuid-1' },
                ],
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '500.00',
                currencyCode: 'RUB',
                discountPercent: null,
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('cannot create rule with invalid conditions structure', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: 'RUB',
                    discountPercent: null,
                    conditions: {
                        all: 'not an array',
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all: must be an array',
            }, 'obj')
        })

        test('cannot create rule with unsupported fact', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: 'RUB',
                    discountPercent: null,
                    conditions: {
                        all: [
                            { fact: 'unknownFact', operator: 'equal', value: 'test' },
                        ],
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all[0]: unsupported fact "unknownFact". Supported: organizationIds, organizationFeatures',
            }, 'obj')
        })

        test('cannot create rule with unsupported operator', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: 'RUB',
                    discountPercent: null,
                    conditions: {
                        all: [
                            { fact: 'organizationIds', operator: 'unknownOp', value: 'test' },
                        ],
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all[0]: unsupported operator "unknownOp". Supported: contains, doesNotContain, equal, notEqual, in, notIn',
            }, 'obj')
        })

        test('cannot create rule with missing operator in condition', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTHLY,
                    fixedPrice: '1000.00',
                    currencyCode: 'RUB',
                    discountPercent: null,
                    conditions: {
                        all: [
                            { fact: 'organizationFeatures', value: ACTIVE_BANKING_FEATURE },
                        ],
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all[0]: missing or invalid "operator"',
            }, 'obj')
        })

        test('can update rule conditions', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                fixedPrice: '1000.00',
                currencyCode: 'RUB',
                discountPercent: null,
                conditions: null,
            })

            const newConditions = {
                fact: 'organizationFeatures',
                operator: 'contains',
                value: ACTIVE_BANKING_FEATURE,
            }

            const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                conditions: newConditions,
            })

            expect(obj.conditions).toEqual(newConditions)
        })
    })
})
