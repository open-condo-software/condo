/**
 * Generated by `createschema subscription.SubscriptionPlanPricingRule 'name:Text; description:Text; subscriptionPlan:Relationship:SubscriptionPlan:CASCADE; period:Select:monthly,yearly; conditions:Json; price:Decimal; currencyCode:Text; priority:Integer; isHidden:Checkbox;'`
 */

const { faker } = require('@faker-js/faker')

const { makeLoggedInAdminClient, makeClient, UUID_RE, expectToThrowGQLError } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj, expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
} = require('@open-condo/keystone/test.utils')

const { MANAGING_COMPANY_TYPE } = require('@condo/domains/organization/constants/common')
const { ACTIVE_BANKING_FEATURE, HIGH_REVENUE_CUSTOMER_FEATURE } = require('@condo/domains/organization/constants/features')
const { SUBSCRIPTION_PERIOD } = require('@condo/domains/subscription/constants')
const {
    SubscriptionPlanPricingRule,
    createTestSubscriptionPlanPricingRule,
    updateTestSubscriptionPlanPricingRule,
    createTestSubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

const { ERRORS } = require('./SubscriptionPlanPricingRule')

describe('SubscriptionPlanPricingRule', () => {
    let admin, support
    let subscriptionPlan

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()

        const [plan] = await createTestSubscriptionPlan(admin, {
            name: faker.commerce.productName(),
            organizationType: MANAGING_COMPANY_TYPE,
            isHidden: false,
        })
        subscriptionPlan = plan
    })

    describe('CRUD tests', () => {
        describe('create', () => {
            test('admin can create', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                expect(obj.id).toMatch(UUID_RE)
                expect(obj.price).toBe('1000.00000000')
                expect(obj.currencyCode).toBe('RUB')
            })

            test('support can create', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(support, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.YEAR,
                    price: '10000.00',
                    currencyCode: 'RUB',
                })

                expect(obj.id).toMatch(UUID_RE)
            })

            test('regular user cannot create', async () => {
                const user = await makeClientWithNewRegisteredAndLoggedInUser()

                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestSubscriptionPlanPricingRule(user, subscriptionPlan, {
                        period: SUBSCRIPTION_PERIOD.MONTH,
                        price: '1000.00',
                        currencyCode: 'RUB',
                    })
                })
            })

            test('anonymous cannot create', async () => {
                const client = await makeClient()

                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestSubscriptionPlanPricingRule(client, subscriptionPlan, {
                        period: SUBSCRIPTION_PERIOD.MONTH,
                        price: '1000.00',
                        currencyCode: 'RUB',
                    })
                })
            })
        })

        describe('update', () => {
            test('admin can update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                    price: '2000.00',
                })

                expect(obj.price).toBe('2000.00000000')
            })

            test('support can update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                const [obj] = await updateTestSubscriptionPlanPricingRule(support, objCreated.id, {
                    name: 'Updated Name',
                })

                expect(obj.name).toBe('Updated Name')
            })

            test('anonymous cannot update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestSubscriptionPlanPricingRule(client, objCreated.id, { name: 'Hacked' })
                })
            })

            test('regular user cannot update', async () => {
                const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                const user = await makeClientWithNewRegisteredAndLoggedInUser()
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await updateTestSubscriptionPlanPricingRule(user, objCreated.id, { name: 'Hacked' })
                })
            })
        })

        describe('read', () => {
            test('admin can read all rules', async () => {
                const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                const objs = await SubscriptionPlanPricingRule.getAll(admin, { id: obj.id })

                expect(objs).toHaveLength(1)
                expect(objs[0].id).toBe(obj.id)
            })

            test('support can read all rules including hidden', async () => {
                const [visibleRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                    isHidden: false,
                })

                const [hiddenRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.YEAR,
                    price: '500.00',
                    currencyCode: 'RUB',
                    isHidden: true,
                })

                const supportRules = await SubscriptionPlanPricingRule.getAll(support, {
                    subscriptionPlan: { id: subscriptionPlan.id },
                })

                const supportRuleIds = supportRules.map(r => r.id)
                expect(supportRuleIds).toContain(visibleRule.id)
                expect(supportRuleIds).toContain(hiddenRule.id)
            })

            test('regular user can read only visible rules (isHidden=false)', async () => {
                const [visibleRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                    isHidden: false,
                })

                const [hiddenRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.YEAR,
                    price: '500.00',
                    currencyCode: 'RUB',
                    isHidden: true,
                })

                const user = await makeClientWithNewRegisteredAndLoggedInUser()

                const userRules = await SubscriptionPlanPricingRule.getAll(user, {
                    subscriptionPlan: { id: subscriptionPlan.id },
                })

                const userRuleIds = userRules.map(r => r.id)
                expect(userRuleIds).toContain(visibleRule.id)
                expect(userRuleIds).not.toContain(hiddenRule.id)
            })

            test('anonymous cannot read', async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                })

                const client = await makeClient()
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await SubscriptionPlanPricingRule.getAll(client, {})
                })
            })
        })
    })

    describe('Validation tests', () => {
        test('can create multiple rules for same plan with different periods', async () => {
            const priority = 100
            const [monthlyRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
                priority,
            })

            const [yearlyRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.YEAR,
                price: '10000.00',
                currencyCode: 'RUB',
                priority,
            })

            expect(monthlyRule.id).toMatch(UUID_RE)
            expect(yearlyRule.id).toMatch(UUID_RE)
            expect(monthlyRule.period).toBe(SUBSCRIPTION_PERIOD.MONTH)
            expect(yearlyRule.period).toBe(SUBSCRIPTION_PERIOD.YEAR)
        })

        test('can create multiple rules for same plan and period with different priorities', async () => {
            const highPriority = 100
            const lowPriority = 50
            const [highPriorityRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
                priority: highPriority,
            })

            const [lowPriorityRule] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '500.00',
                currencyCode: 'RUB',
                priority: lowPriority,
            })

            expect(highPriorityRule.id).toMatch(UUID_RE)
            expect(lowPriorityRule.id).toMatch(UUID_RE)
            expect(highPriorityRule.priority).toBe(highPriority)
            expect(lowPriorityRule.priority).toBe(lowPriority)
        })

        test('isHidden defaults to false', async () => {
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
            })

            expect(obj.isHidden).toBe(false)
        })

        test('can hide rule', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
            })

            const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                isHidden: true,
            })

            expect(obj.isHidden).toBe(true)
        })
    })

    describe('Conditions validation tests', () => {
        test('can create rule with null conditions', async () => {
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
                conditions: null,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toBeNull()
        })

        test('can create rule with valid single condition', async () => {
            const conditions = {
                fact: 'organizationFeatures',
                operator: 'contains',
                value: ACTIVE_BANKING_FEATURE,
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('can create rule with valid all conditions', async () => {
            const conditions = {
                all: [
                    { fact: 'organizationFeatures', operator: 'contains', value: ACTIVE_BANKING_FEATURE },
                    { fact: 'organizationFeatures', operator: 'contains', value: HIGH_REVENUE_CUSTOMER_FEATURE },
                ],
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '0.00',
                currencyCode: 'RUB',
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('can create rule with valid any conditions', async () => {
            const conditions = {
                any: [
                    { fact: 'organizationFeatures', operator: 'contains', value: ACTIVE_BANKING_FEATURE },
                    { fact: 'organizationIds', operator: 'contains', value: 'some-org-id' },
                ],
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '2000.00',
                currencyCode: 'RUB',
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('can create rule with organizationIds condition', async () => {
            const conditions = {
                all: [
                    { fact: 'organizationIds', operator: 'contains', value: 'org-uuid-1' },
                ],
            }
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '500.00',
                currencyCode: 'RUB',
                conditions,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.conditions).toEqual(conditions)
        })

        test('cannot create rule with invalid conditions structure', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                    conditions: {
                        all: 'not an array',
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all: must be an array',
            }, 'obj')
        })

        test('cannot create rule with unsupported fact', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                    conditions: {
                        all: [
                            { fact: 'unknownFact', operator: 'equal', value: 'test' },
                        ],
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all[0]: unsupported fact "unknownFact". Supported: organizationIds, organizationFeatures',
            }, 'obj')
        })

        test('cannot create rule with unsupported operator', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                    conditions: {
                        all: [
                            { fact: 'organizationIds', operator: 'unknownOp', value: 'test' },
                        ],
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all[0]: unsupported operator "unknownOp". Supported: contains, equal, notEqual, in, notIn',
            }, 'obj')
        })

        test('cannot create rule with missing operator in condition', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: 'RUB',
                    conditions: {
                        all: [
                            { fact: 'organizationFeatures', value: ACTIVE_BANKING_FEATURE },
                        ],
                    },
                })
            }, {
                code: 'BAD_USER_INPUT',
                type: 'INVALID_CONDITIONS',
                message: 'conditions.all[0]: missing or invalid "operator"',
            }, 'obj')
        })

        test('can update rule conditions', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
                conditions: null,
            })

            const newConditions = {
                fact: 'organizationFeatures',
                operator: 'contains',
                value: ACTIVE_BANKING_FEATURE,
            }

            const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                conditions: newConditions,
            })

            expect(obj.conditions).toEqual(newConditions)
        })
    })

    describe('Price and currencyCode validation', () => {
        test('can create rule with null price and null currencyCode (custom price)', async () => {
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: null,
                currencyCode: null,
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.price).toBeNull()
            expect(obj.currencyCode).toBeNull()
        })

        test('can create rule with price and currencyCode', async () => {
            const [obj] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1500.00',
                currencyCode: 'USD',
            })

            expect(obj.id).toMatch(UUID_RE)
            expect(obj.price).toBe('1500.00000000')
            expect(obj.currencyCode).toBe('USD')
        })

        test('cannot create rule with price but without currencyCode', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: '1000.00',
                    currencyCode: null,
                })
            }, ERRORS.PRICE_AND_CURRENCY_MUST_BE_SET_TOGETHER, 'obj')
        })

        test('cannot create rule with currencyCode but without price', async () => {
            await expectToThrowGQLError(async () => {
                await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                    period: SUBSCRIPTION_PERIOD.MONTH,
                    price: null,
                    currencyCode: 'RUB',
                })
            }, ERRORS.PRICE_AND_CURRENCY_MUST_BE_SET_TOGETHER, 'obj')
        })

        test('cannot update rule to have price without currencyCode', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
            })

            await expectToThrowGQLError(async () => {
                await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                    currencyCode: null,
                })
            }, ERRORS.PRICE_AND_CURRENCY_MUST_BE_SET_TOGETHER, 'obj')
        })

        test('cannot update rule to have currencyCode without price', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
            })

            await expectToThrowGQLError(async () => {
                await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                    price: null,
                })
            }, ERRORS.PRICE_AND_CURRENCY_MUST_BE_SET_TOGETHER, 'obj')
        })

        test('can update rule to have both null price and currencyCode', async () => {
            const [objCreated] = await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
                period: SUBSCRIPTION_PERIOD.MONTH,
                price: '1000.00',
                currencyCode: 'RUB',
            })

            const [obj] = await updateTestSubscriptionPlanPricingRule(admin, objCreated.id, {
                price: null,
                currencyCode: null,
            })

            expect(obj.price).toBeNull()
            expect(obj.currencyCode).toBeNull()
        })
    })

})
