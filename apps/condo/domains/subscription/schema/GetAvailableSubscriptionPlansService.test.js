/**
 * Generated by `createservice subscription.GetAvailableSubscriptionPlansService --type queries`
 */

const { makeLoggedInAdminClient, makeClient, expectToThrowGQLError } = require('@open-condo/keystone/test.utils')
const { expectToThrowAccessDeniedErrorToResult, expectToThrowAuthenticationErrorToResult } = require('@open-condo/keystone/test.utils')

const { MANAGING_COMPANY_TYPE, HOLDING_TYPE } = require('@condo/domains/organization/constants/common')
const { registerNewOrganization } = require('@condo/domains/organization/utils/testSchema')
const { SUBSCRIPTION_PERIOD } = require('@condo/domains/subscription/constants')
const {
    getAvailableSubscriptionPlansByTestClient,
    createTestSubscriptionPlan,
    createTestSubscriptionPlanPricingRule,
    updateTestSubscriptionPlan,
    activateSubscriptionPlanByTestClient,
    SubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

const { ERRORS } = require('./GetAvailableSubscriptionPlansService')

describe('GetAvailableSubscriptionPlansService', () => {
    let admin, support, user, anonymous
    let organization, subscriptionPlan

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()

        const plans = await SubscriptionPlan.getAll(admin, {
            isHidden: false,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }

        const [plan] = await createTestSubscriptionPlan(admin, {
            name: 'Test Plan for GetAvailable',
            organizationType: MANAGING_COMPANY_TYPE,
            isHidden: false,
            trialDays: 14,
        })
        subscriptionPlan = plan

        // Create pricing rule
        await createTestSubscriptionPlanPricingRule(admin, subscriptionPlan, {
            period: SUBSCRIPTION_PERIOD.MONTHLY,
            price: '1000.00',
            currencyCode: 'RUB',
        })
    })

    afterAll(async () => {
        const plans = await SubscriptionPlan.getAll(admin, {
            isHidden: false,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }
    })

    beforeEach(async () => {
        user = await makeClientWithNewRegisteredAndLoggedInUser()
        const [org] = await registerNewOrganization(user)
        organization = org
    })

    describe('Access', () => {
        test('admin can get available plans', async () => {
            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            expect(result.plans).toBeDefined()
        })

        test('support can get available plans', async () => {
            const [result] = await getAvailableSubscriptionPlansByTestClient(support, organization)

            expect(result.plans).toBeDefined()
        })

        test('organization admin can get available plans for own organization', async () => {
            const [result] = await getAvailableSubscriptionPlansByTestClient(user, organization)

            expect(result.plans).toBeDefined()
        })

        test('user cannot get available plans for other organization', async () => {
            const otherUser = await makeClientWithNewRegisteredAndLoggedInUser()
            const [otherOrg] = await registerNewOrganization(otherUser)

            await expectToThrowAccessDeniedErrorToResult(async () => {
                await getAvailableSubscriptionPlansByTestClient(user, otherOrg)
            })
        })

        test('anonymous cannot get available plans', async () => {
            await expectToThrowAuthenticationErrorToResult(async () => {
                await getAvailableSubscriptionPlansByTestClient(anonymous, organization)
            })
        })
    })

    describe('Logic', () => {
        test('returns plans with calculated prices and trialAvailable flag', async () => {
            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            expect(result.plans).toHaveLength(1)
            const plan = result.plans[0]
            expect(plan.plan.id).toBe(subscriptionPlan.id)
            expect(plan.trialAvailable).toBe(true)
            expect(plan.prices).toHaveLength(1)
            expect(plan.prices[0].period).toBe(SUBSCRIPTION_PERIOD.MONTHLY)
            expect(plan.prices[0].price).toBe('1000.00')
            expect(plan.prices[0].currencyCode).toBe('RUB')
        })

        test('trialAvailable is false when trial already used', async () => {
            // Activate trial first
            await activateSubscriptionPlanByTestClient(admin, organization, subscriptionPlan, { isTrial: true })

            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const plan = result.plans.find(p => p.plan.id === subscriptionPlan.id)
            expect(plan.trialAvailable).toBe(false)
        })

        test('trialAvailable is false when trialDays is 0', async () => {
            const [noTrialPlan] = await createTestSubscriptionPlan(admin, {
                name: 'No Trial Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 0,
            })

            await createTestSubscriptionPlanPricingRule(admin, noTrialPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '500.00',
                currencyCode: 'RUB',
            })

            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const plan = result.plans.find(p => p.plan.id === noTrialPlan.id)
            expect(plan.trialAvailable).toBe(false)
        })

        test('returns empty array if no plans match organization type', async () => {
            // Create plan for different organization type
            const [differentTypePlan] = await createTestSubscriptionPlan(admin, {
                name: 'Different Type Plan',
                organizationType: HOLDING_TYPE,
                isHidden: false,
            })

            await createTestSubscriptionPlanPricingRule(admin, differentTypePlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '2000.00',
                currencyCode: 'RUB',
            })

            // Should only return the plan matching organization type
            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const planIds = result.plans.map(p => p.plan.id)
            expect(planIds).toContain(subscriptionPlan.id)
            expect(planIds).not.toContain(differentTypePlan.id)
        })

        test('does not return hidden plans', async () => {
            const [hiddenPlan] = await createTestSubscriptionPlan(admin, {
                name: 'Hidden Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: true,
            })

            await createTestSubscriptionPlanPricingRule(admin, hiddenPlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '500.00',
                currencyCode: 'RUB',
            })

            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const planIds = result.plans.map(p => p.plan.id)
            expect(planIds).not.toContain(hiddenPlan.id)
        })

        test('throws error if organization not found', async () => {
            const fakeOrg = { id: '00000000-0000-0000-0000-000000000000' }

            await expectToThrowGQLError(async () => {
                await getAvailableSubscriptionPlansByTestClient(admin, fakeOrg)
            }, ERRORS.ORGANIZATION_NOT_FOUND, 'result')
        })

        test('returns prices for multiple periods', async () => {
            // Create plan with multiple rules
            const [multiRulePlan] = await createTestSubscriptionPlan(admin, {
                name: 'Multi Rule Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            // Monthly price
            await createTestSubscriptionPlanPricingRule(admin, multiRulePlan, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '1000.00',
                currencyCode: 'RUB',
            })

            // Yearly price
            await createTestSubscriptionPlanPricingRule(admin, multiRulePlan, {
                period: SUBSCRIPTION_PERIOD.YEARLY,
                price: '10000.00',
                currencyCode: 'RUB',
            })

            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const plan = result.plans.find(p => p.plan.id === multiRulePlan.id)
            expect(plan).toBeDefined()
            expect(plan.prices).toHaveLength(2)

            const monthlyPrice = plan.prices.find(p => p.period === SUBSCRIPTION_PERIOD.MONTHLY)
            expect(monthlyPrice.price).toBe('1000.00')

            const yearlyPrice = plan.prices.find(p => p.period === SUBSCRIPTION_PERIOD.YEARLY)
            expect(yearlyPrice.price).toBe('10000.00')
        })

        test('returns custom price for organization with matching condition', async () => {
            const [planWithCustomPrice] = await createTestSubscriptionPlan(admin, {
                name: 'Plan with custom price',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            // Regular price (lower priority)
            await createTestSubscriptionPlanPricingRule(admin, planWithCustomPrice, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '1000.00',
                currencyCode: 'RUB',
                priority: 10,
            })

            // Custom price for specific organization (higher priority)
            await createTestSubscriptionPlanPricingRule(admin, planWithCustomPrice, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '500.00',
                currencyCode: 'RUB',
                priority: 100,
                conditions: {
                    all: [
                        { fact: 'organizationIds', operator: 'contains', value: organization.id },
                    ],
                },
            })

            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const plan = result.plans.find(p => p.plan.id === planWithCustomPrice.id)
            // Should return the custom price (matches this org)
            expect(plan.prices).toHaveLength(1)
            expect(plan.prices[0].price).toBe('500.00')
        })

        test('returns empty prices when no matching conditions', async () => {
            const [planWithFeaturePrice] = await createTestSubscriptionPlan(admin, {
                name: 'Plan with feature price',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            // Price with feature condition that org doesn't have
            await createTestSubscriptionPlanPricingRule(admin, planWithFeaturePrice, {
                period: SUBSCRIPTION_PERIOD.MONTHLY,
                price: '800.00',
                currencyCode: 'RUB',
                conditions: {
                    all: [
                        { fact: 'organizationFeatures', operator: 'contains', value: 'some_feature' },
                    ],
                },
            })

            const [result] = await getAvailableSubscriptionPlansByTestClient(admin, organization)

            const plan = result.plans.find(p => p.plan.id === planWithFeaturePrice.id)
            // prices will be empty because org doesn't have the feature
            expect(plan.prices).toHaveLength(0)
        })
    })
})