/**
 * Generated by `createschema subscription.PricingRule 'name:Text; description:Text; subscriptionPlan:Relationship:SubscriptionPlan:SET_NULL; organization:Relationship:Organization:CASCADE; organizationFeatures:Json; validFrom:DateTimeUtc; validTo:DateTimeUtc; ruleType:Select:percentage_discount,fixed_discount,fixed_price; discountPercent:Decimal; discountAmount:Decimal; fixedPrice:Decimal; priority:Integer; isActive:Checkbox; canBePromoted:Checkbox; promotionText:Text;'`
 */

const { historical, versioned, uuided, tracked, softDeleted, dvAndSender } = require('@open-condo/keystone/plugins')
const { GQLListSchema } = require('@open-condo/keystone/schema')

const { MONEY_AMOUNT_FIELD, PERCENT_FIELD } = require('@condo/domains/common/schema/fields')
const { ALL_FEATURES } = require('@condo/domains/organization/constants/features')
const access = require('@condo/domains/subscription/access/PricingRule')
const { PRICING_RULE_TYPES } = require('@condo/domains/subscription/constants')


const PricingRule = new GQLListSchema('PricingRule', {
    schemaDoc: 'Pricing rule that modifies subscription plan price based on conditions',
    fields: {

        name: {
            schemaDoc: 'Human-readable name of the pricing rule',
            type: 'Text',
            isRequired: true,
        },

        description: {
            schemaDoc: 'Detailed description of the pricing rule',
            type: 'Text',
            isRequired: false,
        },

        subscriptionPlan: {
            schemaDoc: 'Subscription plan this rule applies to. If null, applies to all plans',
            type: 'Relationship',
            ref: 'SubscriptionPlan',
            isRequired: false,
            kmigratorOptions: { null: true, on_delete: 'models.SET_NULL' },
        },

        organization: {
            schemaDoc: 'Specific organization this rule applies to. If null, applies to all organizations',
            type: 'Relationship',
            ref: 'Organization',
            isRequired: false,
            kmigratorOptions: { null: true, on_delete: 'models.CASCADE' },
        },

        organizationFeatures: {
            schemaDoc: 'List of organization features required for this rule to apply. All features must be present',
            type: 'Json',
            isRequired: false,
            defaultValue: [],
            hooks: {
                validateInput: ({ resolvedData, fieldPath, addFieldValidationError }) => {
                    const features = resolvedData[fieldPath]
                    if (!features) return
                    if (!Array.isArray(features)) {
                        return addFieldValidationError('organizationFeatures must be an array')
                    }
                    for (const feature of features) {
                        if (!ALL_FEATURES.includes(feature)) {
                            return addFieldValidationError(`Unknown feature: ${feature}. Allowed: ${ALL_FEATURES.join(', ')}`)
                        }
                    }
                },
            },
        },

        validFrom: {
            schemaDoc: 'Start date when this rule becomes active. If null, rule is always valid from the past',
            type: 'DateTimeUtc',
            isRequired: false,
        },

        validTo: {
            schemaDoc: 'End date when this rule stops being active. If null, rule is always valid into the future',
            type: 'DateTimeUtc',
            isRequired: false,
        },

        ruleType: {
            schemaDoc: 'Type of price modification: percentage_discount, fixed_discount, or fixed_price',
            type: 'Select',
            options: PRICING_RULE_TYPES,
            isRequired: true,
        },

        discountPercent: {
            ...PERCENT_FIELD,
            schemaDoc: 'Discount percentage (0-100). Used when ruleType is percentage_discount',
            isRequired: false,
        },

        discountAmount: {
            ...MONEY_AMOUNT_FIELD,
            schemaDoc: 'Fixed discount amount. Used when ruleType is fixed_discount',
            isRequired: false,
        },

        fixedPrice: {
            ...MONEY_AMOUNT_FIELD,
            schemaDoc: 'Fixed price to set. Used when ruleType is fixed_price',
            isRequired: false,
        },

        priority: {
            schemaDoc: 'Rule priority. Higher priority rules are applied first. Default is 100',
            type: 'Integer',
            defaultValue: 100,
            isRequired: true,
        },

        isActive: {
            schemaDoc: 'Whether this rule is currently active',
            type: 'Checkbox',
            defaultValue: true,
            isRequired: true,
        },

        canBePromoted: {
            schemaDoc: 'Whether this rule can be shown as a promotion on the frontend',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        promotionText: {
            schemaDoc: 'Promotional text to display on the frontend when canBePromoted is true',
            type: 'Text',
            isRequired: false,
        },

    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical()],
    access: {
        read: access.canReadPricingRules,
        create: access.canManagePricingRules,
        update: access.canManagePricingRules,
        delete: false,
        auth: true,
    },
})

module.exports = {
    PricingRule,
}
