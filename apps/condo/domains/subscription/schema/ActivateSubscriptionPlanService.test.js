/**
 * Generated by `createservice subscription.ActivateSubscriptionPlanService --type mutations`
 */

const dayjs = require('dayjs')

const { makeLoggedInAdminClient, makeClient, expectToThrowGQLError } = require('@open-condo/keystone/test.utils')
const { expectToThrowAccessDeniedErrorToResult, expectToThrowAuthenticationErrorToResult } = require('@open-condo/keystone/test.utils')

const { MANAGING_COMPANY_TYPE, HOLDING_TYPE } = require('@condo/domains/organization/constants/common')
const { registerNewOrganization } = require('@condo/domains/organization/utils/testSchema')
const {
    activateSubscriptionPlanByTestClient,
    createTestSubscriptionPlan,
    updateTestSubscriptionPlan,
    SubscriptionPlan,
} = require('@condo/domains/subscription/utils/testSchema')
const { makeClientWithNewRegisteredAndLoggedInUser, makeClientWithSupportUser } = require('@condo/domains/user/utils/testSchema')

const { ERRORS } = require('./ActivateSubscriptionPlanService')

describe('ActivateSubscriptionPlanService', () => {
    let admin, support, user, anonymous
    let organization, subscriptionPlan

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeClientWithSupportUser()
        anonymous = await makeClient()

        const plans = await SubscriptionPlan.getAll(admin, {
            isHidden: false,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }

        const [plan] = await createTestSubscriptionPlan(admin, {
            name: 'Test Plan for ActivateSubscription',
            organizationType: MANAGING_COMPANY_TYPE,
            isHidden: false,
            trialDays: 14,
        })
        subscriptionPlan = plan
    })

    afterAll(async () => {
        const plans = await SubscriptionPlan.getAll(admin, {
            isHidden: false,
            deletedAt: null,
        })
        for (const plan of plans) {
            await updateTestSubscriptionPlan(admin, plan.id, { deletedAt: new Date() })
        }
    })

    beforeEach(async () => {
        user = await makeClientWithNewRegisteredAndLoggedInUser()
        const [org] = await registerNewOrganization(user, { type: MANAGING_COMPANY_TYPE })
        organization = org
    })

    describe('Access', () => {
        test('admin can activate trial', async () => {
            const [result] = await activateSubscriptionPlanByTestClient(admin, organization, subscriptionPlan, { isTrial: true })

            expect(result.subscriptionContext).toBeDefined()
            expect(result.subscriptionContext.isTrial).toBe(true)
        })

        test('support can activate trial', async () => {
            const [result] = await activateSubscriptionPlanByTestClient(support, organization, subscriptionPlan, { isTrial: true })

            expect(result.subscriptionContext).toBeDefined()
            expect(result.subscriptionContext.isTrial).toBe(true)
        })

        test('organization admin can activate trial for own organization', async () => {
            const [result] = await activateSubscriptionPlanByTestClient(user, organization, subscriptionPlan, { isTrial: true })

            expect(result.subscriptionContext).toBeDefined()
            expect(result.subscriptionContext.isTrial).toBe(true)
        })

        test('user cannot activate for other organization', async () => {
            const otherUser = await makeClientWithNewRegisteredAndLoggedInUser()
            const [otherOrg] = await registerNewOrganization(otherUser, { type: MANAGING_COMPANY_TYPE })

            await expectToThrowAccessDeniedErrorToResult(async () => {
                await activateSubscriptionPlanByTestClient(user, otherOrg, subscriptionPlan, { isTrial: true })
            })
        })

        test('anonymous cannot activate', async () => {
            await expectToThrowAuthenticationErrorToResult(async () => {
                await activateSubscriptionPlanByTestClient(anonymous, organization, subscriptionPlan, { isTrial: true })
            })
        })
    })

    describe('Trial Logic', () => {
        test('creates trial subscription context with correct dates based on trialDays', async () => {
            const [result] = await activateSubscriptionPlanByTestClient(admin, organization, subscriptionPlan, { isTrial: true })

            const context = result.subscriptionContext
            expect(context.isTrial).toBe(true)
            expect(context.organization.id).toBe(organization.id)
            expect(context.subscriptionPlan.id).toBe(subscriptionPlan.id)

            const startAt = dayjs(context.startAt)
            const endAt = dayjs(context.endAt)
            expect(endAt.diff(startAt, 'day')).toBe(subscriptionPlan.trialDays)
        })

        test('creates trial with custom trialDays from plan', async () => {
            const [customPlan] = await createTestSubscriptionPlan(admin, {
                name: 'Custom Trial Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 30,
            })

            const [result] = await activateSubscriptionPlanByTestClient(admin, organization, customPlan, { isTrial: true })

            const startAt = dayjs(result.subscriptionContext.startAt)
            const endAt = dayjs(result.subscriptionContext.endAt)
            expect(endAt.diff(startAt, 'day')).toBe(30)
        })

        test('throws error if organization not found', async () => {
            const fakeOrg = { id: '00000000-0000-0000-0000-000000000000' }

            await expectToThrowGQLError(async () => {
                await activateSubscriptionPlanByTestClient(admin, fakeOrg, subscriptionPlan, { isTrial: true })
            }, ERRORS.ORGANIZATION_NOT_FOUND, 'result')
        })

        test('throws error if plan not found', async () => {
            const fakePlan = { id: '00000000-0000-0000-0000-000000000000' }

            await expectToThrowGQLError(async () => {
                await activateSubscriptionPlanByTestClient(admin, organization, fakePlan, { isTrial: true })
            }, ERRORS.PLAN_NOT_FOUND, 'result')
        })

        test('throws error if plan is hidden', async () => {
            const [hiddenPlan] = await createTestSubscriptionPlan(admin, {
                name: 'Hidden Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: true,
                trialDays: 14,
            })

            await expectToThrowGQLError(async () => {
                await activateSubscriptionPlanByTestClient(admin, organization, hiddenPlan, { isTrial: true })
            }, ERRORS.PLAN_NOT_FOUND, 'result')
        })

        test('throws error if trial is not available for plan (trialDays = 0)', async () => {
            const [noTrialPlan] = await createTestSubscriptionPlan(admin, {
                name: 'No Trial Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 0,
            })

            await expectToThrowGQLError(async () => {
                await activateSubscriptionPlanByTestClient(admin, organization, noTrialPlan, { isTrial: true })
            }, ERRORS.TRIAL_NOT_AVAILABLE, 'result')
        })

        test('throws error if organization type does not match plan', async () => {
            const [differentTypePlan] = await createTestSubscriptionPlan(admin, {
                name: 'Different Type Plan',
                organizationType: HOLDING_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            await expectToThrowGQLError(async () => {
                await activateSubscriptionPlanByTestClient(admin, organization, differentTypePlan, { isTrial: true })
            }, ERRORS.INVALID_ORGANIZATION_TYPE, 'result')
        })

        test('throws error if trial already used for this plan', async () => {
            // First activation
            await activateSubscriptionPlanByTestClient(admin, organization, subscriptionPlan, { isTrial: true })

            // Second activation should fail
            await expectToThrowGQLError(async () => {
                await activateSubscriptionPlanByTestClient(admin, organization, subscriptionPlan, { isTrial: true })
            }, ERRORS.TRIAL_ALREADY_USED, 'result')
        })

        test('can activate trial for different plans', async () => {
            // First plan trial
            const [result1] = await activateSubscriptionPlanByTestClient(admin, organization, subscriptionPlan, { isTrial: true })
            expect(result1.subscriptionContext.isTrial).toBe(true)

            // Create another plan
            const [anotherPlan] = await createTestSubscriptionPlan(admin, {
                name: 'Another Plan',
                organizationType: MANAGING_COMPANY_TYPE,
                isHidden: false,
                trialDays: 14,
            })

            // Second plan trial should work
            const [result2] = await activateSubscriptionPlanByTestClient(admin, organization, anotherPlan, { isTrial: true })
            expect(result2.subscriptionContext.isTrial).toBe(true)
        })
    })

    describe('Paid Subscription Logic', () => {
        test('creates UserHelpRequest when isTrial is false (returns null subscriptionContext)', async () => {
            const [result] = await activateSubscriptionPlanByTestClient(user, organization, subscriptionPlan, { isTrial: false })

            expect(result.subscriptionContext).toBeNull()
        })

        test('support can create paid subscription request', async () => {
            const [result] = await activateSubscriptionPlanByTestClient(support, organization, subscriptionPlan, { isTrial: false })

            expect(result.subscriptionContext).toBeNull()
        })
    })
})