/**
 * Generated by `createservice subscription.ActivateTrialSubscriptionPlanService --type mutations`
 */

const dayjs = require('dayjs')

const { GQLError, GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const { GQLCustomSchema, find } = require('@open-condo/keystone/schema')

const access = require('@condo/domains/subscription/access/ActivateTrialSubscriptionPlanService')
const { SubscriptionContext } = require('@condo/domains/subscription/utils/serverSchema')

const TRIAL_PERIOD_DAYS = 14

/**
 * List of possible errors, that this custom schema can throw
 * They will be rendered in documentation section in GraphiQL for this custom schema
 */
const ERRORS = {
    ORGANIZATION_NOT_FOUND: {
        mutation: 'activateTrialSubscriptionPlan',
        variable: ['data', 'organization'],
        code: BAD_USER_INPUT,
        type: 'ORGANIZATION_NOT_FOUND',
        message: 'Organization not found',
    },
    PLAN_NOT_FOUND: {
        mutation: 'activateTrialSubscriptionPlan',
        variable: ['data', 'subscriptionPlan'],
        code: BAD_USER_INPUT,
        type: 'PLAN_NOT_FOUND',
        message: 'Subscription plan not found or inactive',
    },
    INVALID_ORGANIZATION_TYPE: {
        mutation: 'activateTrialSubscriptionPlan',
        variable: ['data', 'organization'],
        code: BAD_USER_INPUT,
        type: 'INVALID_ORGANIZATION_TYPE',
        message: 'Plan is not available for this organization type',
    },
    TRIAL_ALREADY_USED: {
        mutation: 'activateTrialSubscriptionPlan',
        variable: ['data', 'subscriptionPlan'],
        code: BAD_USER_INPUT,
        type: 'TRIAL_ALREADY_USED',
        message: 'Trial subscription for this plan has already been used',
    },
}

const ActivateTrialSubscriptionPlanService = new GQLCustomSchema('ActivateTrialSubscriptionPlanService', {
    types: [
        {
            access: true,
            type: 'input ActivateTrialSubscriptionPlanInput { dv: Int!, sender: SenderFieldInput!, organization: OrganizationWhereUniqueInput!, subscriptionPlan: SubscriptionPlanWhereUniqueInput! }',
        },
        {
            access: true,
            type: 'type ActivateTrialSubscriptionPlanOutput { subscriptionContext: SubscriptionContext! }',
        },
    ],

    mutations: [
        {
            access: access.canActivateTrialSubscriptionPlan,
            schema: 'activateTrialSubscriptionPlan(data: ActivateTrialSubscriptionPlanInput!): ActivateTrialSubscriptionPlanOutput',
            doc: {
                summary: 'Activates a trial subscription for an organization',
                errors: ERRORS,
            },
            resolver: async (parent, args, context) => {
                const { data } = args
                const { dv, sender, organization: organizationInput, subscriptionPlan: planInput } = data

                const [organization] = await find('Organization', {
                    id: organizationInput.id,
                    deletedAt: null,
                })
                if (!organization) {
                    throw new GQLError(ERRORS.ORGANIZATION_NOT_FOUND, context)
                }

                const [plan] = await find('SubscriptionPlan', {
                    id: planInput.id,
                    isActive: true,
                    deletedAt: null,
                })
                if (!plan) {
                    throw new GQLError(ERRORS.PLAN_NOT_FOUND, context)
                }

                // Check organization type compatibility
                if (plan.organizationType && plan.organizationType !== organization.type) {
                    throw new GQLError(ERRORS.INVALID_ORGANIZATION_TYPE, context)
                }

                // Check if trial already used for this plan
                const [existingTrial] = await find('SubscriptionContext', {
                    organization: organization.id,
                    subscriptionPlan: plan.id,
                    isTrial: true,
                    deletedAt: null,
                })

                if (existingTrial) {
                    throw new GQLError(ERRORS.TRIAL_ALREADY_USED, context)
                }

                // Trial dates
                const startAt = dayjs().startOf('day')
                const endAt = startAt.add(TRIAL_PERIOD_DAYS, 'day')

                // Create trial subscription context
                const subscriptionContext = await SubscriptionContext.create(context, {
                    dv,
                    sender,
                    organization: { connect: { id: organization.id } },
                    subscriptionPlan: { connect: { id: plan.id } },
                    startAt: startAt.toISOString(),
                    endAt: endAt.toISOString(),
                    isTrial: true,
                })

                return { subscriptionContext }
            },
        },
    ],
})

module.exports = {
    ActivateTrialSubscriptionPlanService,
    ERRORS,
}
