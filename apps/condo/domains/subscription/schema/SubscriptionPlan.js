/**
 * Generated by `createschema subscription.SubscriptionPlan 'type:Select:basic,extended; periodType:Select:monthly,yearly; name:Text; description:Text; price:Decimal; currencyCode:Text; news:Checkbox; marketplace:Checkbox; support:Checkbox; ai:Checkbox; passTickets:Checkbox; isHidden:Checkbox;'`
 */

const { GQLError, GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const { historical, versioned, uuided, tracked, softDeleted, dvAndSender, analytical } = require('@open-condo/keystone/plugins')
const { GQLListSchema } = require('@open-condo/keystone/schema')

const { UUID_REGEXP } = require('@condo/domains/common/constants/regexps')
const { ORGANIZATION_TYPES } = require('@condo/domains/organization/constants/common')
const access = require('@condo/domains/subscription/access/SubscriptionPlan')

const ERRORS = {
    TRIAL_DAYS_MUST_BE_NON_NEGATIVE: {
        code: BAD_USER_INPUT,
        type: 'TRIAL_DAYS_MUST_BE_NON_NEGATIVE',
        message: 'trialDays must be >= 0',
    },
    ENABLED_APPS_MUST_BE_ARRAY_OF_IDS: {
        code: BAD_USER_INPUT,
        type: 'ENABLED_APPS_MUST_BE_ARRAY_OF_IDS',
        message: 'enabledB2BApps and enabledB2CApps must be arrays of valid UUIDs',
    },
}

const SubscriptionPlan = new GQLListSchema('SubscriptionPlan', {
    schemaDoc: 'Subscription plan that defines a product with features. Prices are defined via SubscriptionPlanPricingRule',
    fields: {

        name: {
            schemaDoc: 'Human-readable name of the subscription plan',
            type: 'Text',
            isRequired: true,
        },

        description: {
            schemaDoc: 'Detailed description of the subscription plan. Shown to end users.',
            type: 'Text',
            isRequired: false,
        },

        organizationType: {
            schemaDoc: 'Type of organization this plan is available for',
            type: 'Select',
            options: ORGANIZATION_TYPES,
            dataType: 'string',
            isRequired: true,
            access: {
                read: true,
                create: true,
                update: false,
            },
        },

        isHidden: {
            schemaDoc: 'Whether this plan is hidden and not available for purchase',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        trialDays: {
            schemaDoc: 'Number of trial days for this plan. If 0, trial activation is not available for this plan',
            type: 'Integer',
            defaultValue: 0,
            isRequired: true,
            hooks: {
                validateInput: async ({ resolvedData, fieldPath, existingItem, context }) => {
                    const trialDays = resolvedData[fieldPath] !== undefined ? resolvedData[fieldPath] : existingItem?.trialDays

                    if (trialDays !== null && trialDays !== undefined && trialDays < 0) {
                        throw new GQLError(ERRORS.TRIAL_DAYS_MUST_BE_NON_NEGATIVE, context)
                    }
                },
            },
        },

        priority: {
            schemaDoc: 'Priority for sorting plans on frontend and selecting active subscription (higher values = higher priority)',
            type: 'Integer',
            defaultValue: 0,
            isRequired: true,
        },

        canBePromoted: {
            schemaDoc: 'Whether this plan can be promoted to users',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        payments: {
            schemaDoc: 'Whether payments feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        meters: {
            schemaDoc: 'Whether meters feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        tickets: {
            schemaDoc: 'Whether tickets feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        news: {
            schemaDoc: 'Whether news feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        marketplace: {
            schemaDoc: 'Whether marketplace feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        support: {
            schemaDoc: 'Whether support feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        ai: {
            schemaDoc: 'Whether AI feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        customization: {
            schemaDoc: 'Whether customization feature is included in this plan',
            type: 'Checkbox',
            defaultValue: false,
            isRequired: true,
        },

        enabledB2BApps: {
            schemaDoc: 'List of B2B miniapp IDs enabled in this plan. Apps work as opt-in: if an app appears in at least one plan for this organizationType, it becomes restricted and must be explicitly listed here to be available. Apps not listed in any plan remain available to all organizations of this type.',
            type: 'Json',
            defaultValue: [],
            isRequired: true,
            hooks: {
                validateInput: async ({ resolvedData, fieldPath, context }) => {
                    const value = resolvedData[fieldPath]
                    if (value === undefined) return

                    if (!Array.isArray(value)) {
                        throw new GQLError(ERRORS.ENABLED_APPS_MUST_BE_ARRAY_OF_IDS, context)
                    }

                    for (const id of value) {
                        if (typeof id !== 'string' || !UUID_REGEXP.test(id)) {
                            throw new GQLError(ERRORS.ENABLED_APPS_MUST_BE_ARRAY_OF_IDS, context)
                        }
                    }
                },
            },
        },

        enabledB2CApps: {
            schemaDoc: 'List of B2C miniapp IDs enabled in this plan. Apps work as opt-in: if an app appears in at least one plan for this organizationType, it becomes restricted and must be explicitly listed here to be available. Apps not listed in any plan remain available to all organizations of this type.',
            type: 'Json',
            defaultValue: [],
            isRequired: true,
            hooks: {
                validateInput: async ({ resolvedData, fieldPath, context }) => {
                    const value = resolvedData[fieldPath]
                    if (value === undefined) return

                    if (!Array.isArray(value)) {
                        throw new GQLError(ERRORS.ENABLED_APPS_MUST_BE_ARRAY_OF_IDS, context)
                    }

                    for (const id of value) {
                        if (typeof id !== 'string' || !UUID_REGEXP.test(id)) {
                            throw new GQLError(ERRORS.ENABLED_APPS_MUST_BE_ARRAY_OF_IDS, context)
                        }
                    }
                },
            },
        },

    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical(), analytical()],
    access: {
        read: access.canReadSubscriptionPlans,
        create: access.canManageSubscriptionPlans,
        update: access.canManageSubscriptionPlans,
        delete: false,
        auth: true,
    },
})

module.exports = {
    SubscriptionPlan,
    ERRORS,
}
