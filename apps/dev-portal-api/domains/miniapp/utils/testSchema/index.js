/**
 * Generated by `createschema miniapp.B2CApp 'name:Text'`
 * In most cases you should not change it by hands
 * Please, don't remove `AUTOGENERATE MARKER`s
 */
const { faker } = require('@faker-js/faker')
const conf = require('@open-condo/config')
const path = require('path')
const { generateGQLTestUtils, throwIfError } = require('@open-condo/codegen/generate.test.utils')
const { buildFakeAddressAndMeta } = require('@app/condo/domains/property/utils/testSchema/factories')
const { registerNewServiceUserByTestClient } = require('@app/condo/domains/user/utils/testSchema')

const {
    B2BApp: B2BAppGQL,
    PUBLISH_B2B_APP_MUTATION,

    B2CApp: B2CAppGQL,
    B2CAppAccessRight: B2CAppAccessRightGQL,
    B2CAppBuild: B2CAppBuildGQL,
    B2CAppPublishRequest: B2CAppPublishRequestGQL,
    PUBLISH_B2C_APP_MUTATION,
    IMPORT_B2C_APP_MUTATION,
    ALL_B2C_APP_PROPERTIES_QUERY,
    CREATE_B2C_APP_PROPERTY_MUTATION,
    DELETE_B2C_APP_PROPERTY_MUTATION,
    GET_B2C_APP_INFO_QUERY,

    GET_OIDC_CLIENT_QUERY,
    CREATE_OIDC_CLIENT_MUTATION,
    GENERATE_OIDC_CLIENT_SECRET_MUTATION,
    UPDATE_OIDC_CLIENT_URL_MUTATION,
    REGISTER_APP_USER_SERVICE_MUTATION,
} = require('@dev-portal-api/domains/miniapp/gql')
const { UploadingFile } = require('@open-condo/keystone/test.utils')
const { DEV_ENVIRONMENT } = require('@dev-portal-api/domains/miniapp/constants/publishing')
const { generateGqlQueries } = require("@open-condo/codegen/generate.gql")
const { DEFAULT_COLOR_SCHEMA } = require("@dev-portal-api/domains/miniapp/constants/b2c")
const { B2BAppPublishRequest: B2BAppPublishRequestGQL } = require('@dev-portal-api/domains/miniapp/gql')
/* AUTOGENERATE MARKER <IMPORT> */

const B2BApp = generateGQLTestUtils(B2BAppGQL)
const B2BAppPublishRequest = generateGQLTestUtils(B2BAppPublishRequestGQL)

const B2CApp = generateGQLTestUtils(B2CAppGQL)
const B2CAppAccessRight = generateGQLTestUtils(B2CAppAccessRightGQL)
const B2CAppBuild = generateGQLTestUtils(B2CAppBuildGQL)
const B2CAppPublishRequest = generateGQLTestUtils(B2CAppPublishRequestGQL)
/* AUTOGENERATE MARKER <CONST> */

const FAKE_BUILD_ASSET_PATH = path.resolve(conf.PROJECT_ROOT, 'apps/dev-portal-api/domains/miniapp/utils/testSchema/assets/build.zip')
const FAKE_B2C_APP_LOGO_PATH = path.resolve(conf.PROJECT_ROOT, 'apps/dev-portal-api/domains/miniapp/utils/testSchema/assets/logo.png')

const CondoB2BApp = generateGQLTestUtils(generateGqlQueries('B2BApp', '{ id name developer developerUrl logo { publicUrl filename } importId importRemoteSystem deletedAt v oidcClient { id } }'))
const CondoB2CApp = generateGQLTestUtils(generateGqlQueries('B2CApp', '{ id name developer logo { publicUrl filename } currentBuild { id } importId importRemoteSystem deletedAt v oidcClient { id } }'))
const CondoB2CAppBuild = generateGQLTestUtils(generateGqlQueries('B2CAppBuild', '{ id version data { publicUrl } importId importRemoteSystem }'))
const CondoB2CAppProperty = generateGQLTestUtils(generateGqlQueries('B2CAppProperty', '{ id address }'))
const CondoB2CAppAccessRight = generateGQLTestUtils(generateGqlQueries('B2CAppAccessRight', '{ id user { id } app { id } importId importRemoteSystem }'))
const CondoOIDCClient = generateGQLTestUtils(generateGqlQueries('OidcClient', '{ id clientId payload isEnabled name importId importRemoteSystem }'))

function generateBuildVersion () {
    return `${faker.datatype.number()}.${faker.datatype.number()}.${faker.datatype.number()}`
}

function generateRedirectUri () {
    const url = faker.internet.url()
    if (!url.endsWith('/')) {
        return `${url}/`
    } else {
        return url
    }
}

async function createCondoB2CApp (client) {
    const attrs = {
        dv: 1,
        sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
        name: faker.commerce.productName(),
        developer: faker.company.name(),
        colorSchema: DEFAULT_COLOR_SCHEMA,
        logo: new UploadingFile(FAKE_B2C_APP_LOGO_PATH),
    }

    const obj = await CondoB2CApp.create(client, attrs)
    return [obj, attrs]
}

async function updateCondoB2CApp(client, app, extraAttrs = {}) {
    const attrs = {
        dv: 1,
        sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
        ...extraAttrs,
    }
    const obj = await CondoB2CApp.update(client, app.id, attrs)
    return [obj, attrs]
}

async function updateCondoB2BApp(client, app, extraAttrs = {}) {
    const attrs = {
        dv: 1,
        sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
        ...extraAttrs,
    }
    const obj = await CondoB2BApp.update(client, app.id, attrs)
    return [obj, attrs]
}

async function createCondoB2CAppBuild (client, app, extraAttrs = {}) {
    const attrs = {
        dv: 1,
        sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
        app: { connect: { id: app.id } },
        version: `${faker.datatype.number()}.${faker.datatype.number()}.${faker.datatype.number()}`,
        data: new UploadingFile(FAKE_BUILD_ASSET_PATH),
        ...extraAttrs
    }

    const obj = await CondoB2CAppBuild.create(client, attrs)
    return [obj, attrs]
}

async function createCondoB2CAppProperties(client, condoApp, amount) {
    if (!client) throw new Error('No client')
    if (!condoApp || !condoApp.id) throw new Error('No app')

    const attrs = []
    for (let i = 0; i < amount; i++) {
        attrs.push({
            data: {
                dv: 1,
                sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                app: { connect: { id: condoApp.id } },
                ...buildFakeAddressAndMeta(false)
            }
        })
    }

    const objs = await CondoB2CAppProperty.createMany(client, attrs)

    return [objs, attrs]
}

async function createCondoB2CAppAccessRight(client, condoApp, condoUser = null) {
    let user = condoUser

    if (!condoUser) {
        [user] = await registerNewServiceUserByTestClient(client)
    }

    const attrs = {
        dv: 1,
        sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
        app: { connect: { id: condoApp.id } },
        user: { connect: { id: user.id } },
    }

    const obj =  await CondoB2CAppAccessRight.create(client, attrs)

    return [obj, attrs]
}

async function createTestB2BApp (client, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const name = faker.commerce.product()

    const attrs = {
        dv: 1,
        sender,
        name,
        ...extraAttrs,
    }
    const obj = await B2BApp.create(client, attrs)
    return [obj, attrs]
}

async function updateTestB2BApp (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await B2BApp.update(client, id, attrs)
    return [obj, attrs]
}

async function createTestB2CApp (client, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const name = `${faker.commerce.product()}`

    const attrs = {
        dv: 1,
        sender,
        name,
        ...extraAttrs,
    }
    const obj = await B2CApp.create(client, attrs)
    return [obj, attrs]
}

async function updateTestB2BApps (client, attrsArray) {
    if (!client) throw new Error('no client')
    if (!Array.isArray(attrsArray)) throw new Error('payload is not an array')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const data = attrsArray.map(item => ({ id: item.id, data: { ...item.data, dv: 1, sender } }))
    const objs = await B2BApp.updateMany(client, data)

    return [objs, data]
}

async function updateTestB2CApp (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await B2CApp.update(client, id, attrs)
    return [obj, attrs]
}

async function updateTestB2CApps (client, attrsArray) {
    if (!client) throw new Error('no client')
    if (!Array.isArray(attrsArray)) throw new Error('payload is not an array')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const data = attrsArray.map(item => ({ id: item.id, data: { ...item.data, dv: 1, sender } }))
    const objs = await B2CApp.updateMany(client, data)

    return [objs, data]
}

async function createTestB2CAppBuild (client, app, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const version = generateBuildVersion()
    const data = new UploadingFile(FAKE_BUILD_ASSET_PATH)

    const attrs = {
        dv: 1,
        sender,
        app: { connect: { id: app.id } },
        data,
        version,
        ...extraAttrs,
    }
    const obj = await B2CAppBuild.create(client, attrs)
    return [obj, attrs]
}

async function updateTestB2CAppBuild (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await B2CAppBuild.update(client, id, attrs)
    return [obj, attrs]
}

async function publishB2BAppByTestClient(client, app, options = undefined, environment = DEV_ENVIRONMENT) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        app: { id: app.id },
        environment,
        options: options || { info: true },
    }
    const { data, errors } = await client.mutate(PUBLISH_B2B_APP_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function publishB2CAppByTestClient(client, app, options = undefined, environment = DEV_ENVIRONMENT) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')

    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        app: { id: app.id },
        environment,
        options: options || { info: true },
    }
    const { data, errors } = await client.mutate(PUBLISH_B2C_APP_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function createTestB2BAppPublishRequest (client, app, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        app: { connect: { id: app.id } },
        ...extraAttrs,
    }
    const obj = await B2BAppPublishRequest.create(client, attrs)
    return [obj, attrs]
}

async function updateTestB2BAppPublishRequest (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await B2BAppPublishRequest.update(client, id, attrs)
    return [obj, attrs]
}


async function createTestB2CAppPublishRequest (client, app, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        app: { connect: { id: app.id } },
        ...extraAttrs,
    }
    const obj = await B2CAppPublishRequest.create(client, attrs)
    return [obj, attrs]
}

async function updateTestB2CAppPublishRequest (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await B2CAppPublishRequest.update(client, id, attrs)
    return [obj, attrs]
}

async function importB2CAppByTestClient(client, app, condoDevApp = null, condoProdApp = null, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')
    if (condoDevApp && !condoDevApp.id) throw new Error('no condoDevApp.id')
    if (condoProdApp && !condoProdApp.id) throw new Error('no condoProdApp.id')

    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const from = {}
    if (condoDevApp) {
        from.developmentApp =  { id: condoDevApp.id }
    }
    if (condoProdApp) {
        from.productionApp = { id: condoProdApp.id }
    }

    const attrs = {
        dv: 1,
        sender,
        to: { app: { id: app.id } },
        from,
        options: { info: true, builds: true, publish: true, accessRight: true },
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(IMPORT_B2C_APP_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function allB2CAppPropertiesByTestClient(client, app, environment, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')
    if (!environment) throw new Error('no environment')

    const attrs = {
        app: { id: app.id },
        environment,
        first: 100,
        skip: 0,
        ...extraAttrs,
    }
    const { data, errors } = await client.query(ALL_B2C_APP_PROPERTIES_QUERY, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function createB2CAppPropertyByTestClient(client, app, environment, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')

    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }
    const { address } = buildFakeAddressAndMeta(false)

    const attrs = {
        dv: 1,
        sender,
        app: { id: app.id },
        environment,
        address,
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(CREATE_B2C_APP_PROPERTY_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function deleteB2CAppPropertyByTestClient(client, id, environment) {
    if (!client) throw new Error('no client')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        id,
        environment,
    }
    const { data, errors } = await client.mutate(DELETE_B2C_APP_PROPERTY_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}


async function getB2CAppInfoByTestClient(client, app, environment = DEV_ENVIRONMENT) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')
    const attrs = {
        app: { id: app.id },
        environment,
    }
    const { data, errors } = await client.query(GET_B2C_APP_INFO_QUERY, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function getOIDCClientByTestClient(client, app, environment = DEV_ENVIRONMENT) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')

    const attrs = {
        app: { id: app.id },
        environment,
    }
    const { data, errors } = await client.query(GET_OIDC_CLIENT_QUERY, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function createOIDCClientByTestClient(client, app, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        environment: DEV_ENVIRONMENT,
        app: { id: app.id },
        redirectUri: generateRedirectUri(),
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(CREATE_OIDC_CLIENT_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function generateOIDCClientSecretByTestClient(client, app, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        environment: DEV_ENVIRONMENT,
        app: { id: app.id },
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(GENERATE_OIDC_CLIENT_SECRET_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}

async function updateOIDCClientUrlByTestClient(client, app, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        app: { id: app.id },
        environment: DEV_ENVIRONMENT,
        redirectUri: generateRedirectUri(),
        ...extraAttrs,
    }

    const { data, errors } = await client.mutate(UPDATE_OIDC_CLIENT_URL_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}
async function createTestB2CAppAccessRight (client, app, condoUserId, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app.id')
    if (!condoUserId) throw new Error('no condoUserId')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        app: { connect: { id: app.id } },
        condoUserId,
        ...extraAttrs,
    }
    const obj = await B2CAppAccessRight.create(client, attrs)
    return [obj, attrs]
}

async function updateTestB2CAppAccessRight (client, id, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!id) throw new Error('no id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        ...extraAttrs,
    }
    const obj = await B2CAppAccessRight.update(client, id, attrs)
    return [obj, attrs]
}


async function registerAppUserServiceByTestClient(client, app, confirmEmailAction, extraAttrs = {}) {
    if (!client) throw new Error('no client')
    if (!app || !app.id) throw new Error('no app.id')
    if (!confirmEmailAction || !confirmEmailAction.id) throw new Error('no confirmEmailAction.id')
    const sender = { dv: 1, fingerprint: faker.random.alphaNumeric(8) }

    const attrs = {
        dv: 1,
        sender,
        environment: DEV_ENVIRONMENT,
        app: { id: app.id },
        confirmEmailAction: { id: confirmEmailAction.id },
        ...extraAttrs,
    }
    const { data, errors } = await client.mutate(REGISTER_APP_USER_SERVICE_MUTATION, { data: attrs })
    throwIfError(data, errors)
    return [data.result, attrs]
}
/* AUTOGENERATE MARKER <FACTORY> */

module.exports = {
    CondoB2BApp, updateCondoB2BApp,

    CondoB2CApp, createCondoB2CApp, updateCondoB2CApp,
    CondoB2CAppBuild, createCondoB2CAppBuild,
    CondoB2CAppProperty, createCondoB2CAppProperties,
    CondoB2CAppAccessRight, createCondoB2CAppAccessRight,
    CondoOIDCClient,

    B2BApp, createTestB2BApp, updateTestB2BApp, updateTestB2BApps,
    B2BAppPublishRequest, createTestB2BAppPublishRequest, updateTestB2BAppPublishRequest,
    publishB2BAppByTestClient,

    B2CApp, createTestB2CApp, updateTestB2CApp, updateTestB2CApps, getB2CAppInfoByTestClient,
    B2CAppAccessRight, createTestB2CAppAccessRight, updateTestB2CAppAccessRight,
    B2CAppBuild, createTestB2CAppBuild, updateTestB2CAppBuild, generateBuildVersion,
    B2CAppPublishRequest, createTestB2CAppPublishRequest, updateTestB2CAppPublishRequest,
    publishB2CAppByTestClient,
    importB2CAppByTestClient,
    allB2CAppPropertiesByTestClient, createB2CAppPropertyByTestClient, deleteB2CAppPropertyByTestClient,

    getOIDCClientByTestClient, createOIDCClientByTestClient, generateOIDCClientSecretByTestClient, updateOIDCClientUrlByTestClient,
    registerAppUserServiceByTestClient,
/* AUTOGENERATE MARKER <EXPORTS> */
}
