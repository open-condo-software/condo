/**
 * Generated by `createservice miniapp.UpdateB2BAppContextService`
 */

const dayjs = require('dayjs')

const { GQLError, GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const { GQLCustomSchema } = require('@open-condo/keystone/schema')

const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const { CondoB2BAppContextGql } = require('@dev-portal-api/domains/condo/gql')
const access = require('@dev-portal-api/domains/miniapp/access/UpdateB2BAppContextService')
const { CONTEXT_UPDATE_ACTIONS, CONNECT_ACTION } = require('@dev-portal-api/domains/miniapp/constants/b2bAppContext')
const { B2B_APP_CONTEXT_NOT_FOUND } = require('@dev-portal-api/domains/miniapp/constants/errors')
const { findCondoB2BApp } = require('@dev-portal-api/domains/miniapp/utils/serverSchema/findCondoApp')


const ERRORS = {
    B2B_APP_CONTEXT_NOT_FOUND: {
        code: BAD_USER_INPUT,
        type: B2B_APP_CONTEXT_NOT_FOUND,
        message: 'B2BAppContext not found for specified organization',
        messageForUser: 'api.miniapp.updateB2BAppContext.B2B_APP_CONTEXT_NOT_FOUND',
    },
}

const UpdateB2BAppContextService = new GQLCustomSchema('UpdateB2BAppContextService', {
    types: [
        {
            access: true,
            type: `enum B2BAppContextAction { ${CONTEXT_UPDATE_ACTIONS.join(' ')} }`,
        },
        {
            access: true,
            type: 'input OrganizationWhereUniqueInput { id: ID! }',
        },
        {
            access: true,
            type: 'input UpdateB2BAppContextInput { dv: Int!, sender: SenderFieldInput!, app: B2BAppWhereUniqueInput!, environment: AppEnvironment!, organization: OrganizationWhereUniqueInput!, action: B2BAppContextAction! }',
        },
        {
            access: true,
            type: 'type UpdateB2BAppContextOutput { success: Boolean! }',
        },
    ],
    
    mutations: [
        {
            access: access.canUpdateB2BAppContext,
            schema: 'updateB2BAppContext(data: UpdateB2BAppContextInput!): UpdateB2BAppContextOutput',
            resolver: async (parent, args, context) => {
                const { data: { dv, sender, action, organization: { id: organizationId } } } = args

                const { condoApp, serverClient } = await findCondoB2BApp({ args, context })

                const [condoAppContext] = await serverClient.getModels({
                    modelGql: CondoB2BAppContextGql,
                    where: {
                        app: { id: condoApp.id },
                        organization: { id: organizationId },
                    },
                    first: 1,
                })

                if (!condoAppContext) {
                    throw new GQLError(ERRORS.B2B_APP_CONTEXT_NOT_FOUND, context)
                }

                const updatePayload = {
                    dv,
                    sender,
                }

                if (action === CONNECT_ACTION) {
                    updatePayload.status = CONTEXT_FINISHED_STATUS
                } else {
                    updatePayload.deletedAt = dayjs().toISOString()
                }

                await serverClient.updateModel({
                    modelGql: CondoB2BAppContextGql,
                    id: condoAppContext.id,
                    updateInput: updatePayload,
                })

                return {
                    success: true,
                }
            },
        },
    ],
    
})

module.exports = {
    UpdateB2BAppContextService,
}
