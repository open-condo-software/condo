/**
 * Generated by `createservice miniapp.UpdateB2BAppContextService`
 */

const dayjs = require('dayjs')

const { GQLCustomSchema } = require('@open-condo/keystone/schema')

const { CONTEXT_FINISHED_STATUS } = require('@condo/domains/miniapp/constants')
const { productionClient, developmentClient } = require('@dev-portal-api/domains/common/utils/serverClients')
const { CondoB2BAppContextGql } = require('@dev-portal-api/domains/condo/gql')
const access = require('@dev-portal-api/domains/miniapp/access/UpdateB2BAppContextService')
const { CONTEXT_UPDATE_ACTIONS, CONNECT_ACTION } = require('@dev-portal-api/domains/miniapp/constants/b2bAppContext')
const { PROD_ENVIRONMENT } = require('@dev-portal-api/domains/miniapp/constants/publishing')

const UpdateB2BAppContextService = new GQLCustomSchema('UpdateB2BAppContextService', {
    types: [
        {
            access: true,
            type: `enum B2BAppContextAction { ${CONTEXT_UPDATE_ACTIONS.join(' ')} }`,
        },
        {
            access: true,
            type: 'input UpdateB2BAppContextInput { dv: Int!, sender: SenderFieldInput!, id: ID!, environment: AppEnvironment!, action: B2BAppContextAction! }',
        },
        {
            access: true,
            type: 'type UpdateB2BAppContextOutput { success: Boolean! }',
        },
    ],
    
    mutations: [
        {
            access: access.canUpdateB2BAppContext,
            schema: 'updateB2BAppContext(data: UpdateB2BAppContextInput!): UpdateB2BAppContextOutput',
            resolver: async (parent, args) => {
                const { data: { dv, sender, id, environment, action } } = args

                const serverClient = environment === PROD_ENVIRONMENT
                    ? productionClient
                    : developmentClient

                const updatePayload = {
                    dv,
                    sender,
                }

                if (action === CONNECT_ACTION) {
                    updatePayload.status = CONTEXT_FINISHED_STATUS
                } else {
                    updatePayload.deletedAt = dayjs().toISOString()
                }

                await serverClient.updateModel({
                    modelGql: CondoB2BAppContextGql,
                    id,
                    updateInput: updatePayload,
                })

                return {
                    success: true,
                }
            },
        },
    ],
    
})

module.exports = {
    UpdateB2BAppContextService,
}
