/**
 * Generated by `createservice miniapp.UpdateB2BAppContextService`
 */

const { faker } = require('@faker-js/faker')
const dayjs = require('dayjs')

const { GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const { makeClient } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult,
    expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const { CONTEXT_FINISHED_STATUS, CONTEXT_IN_PROGRESS_STATUS } = require('@condo/domains/miniapp/constants')
const { CONNECT_ACTION, DISCONNECT_ACTION } = require('@dev-portal-api/domains/miniapp/constants/b2bAppContext')
const { PROD_ENVIRONMENT, DEV_ENVIRONMENT } = require('@dev-portal-api/domains/miniapp/constants/publishing')
const { PUBLISH_REQUEST_APPROVED_STATUS } = require('@dev-portal-api/domains/miniapp/constants/publishing')
const {
    createTestB2BApp,
    updateCondoB2BApp,
    publishB2BAppByTestClient,
    B2BApp,
    createCondoB2BAppContexts,
    createTestB2BAppPublishRequest,
    updateB2BAppContextByTestClient,
    CondoB2BAppContext,
} = require('@dev-portal-api/domains/miniapp/utils/testSchema')
const {
    makeLoggedInAdminClient,
    makeLoggedInSupportClient,
    makeRegisteredAndLoggedInUser,
    makeLoggedInCondoAdminClient,
} = require('@dev-portal-api/domains/user/utils/testSchema')

describe('UpdateB2BAppContextService', () => {
    let condoAdmin
    let admin
    let support
    let user
    let anotherUser
    let anonymous

    let app
    let devContext
    let prodContext
    let organization

    beforeAll(async () => {
        condoAdmin = await makeLoggedInCondoAdminClient()
        admin = await makeLoggedInAdminClient()
        support = await makeLoggedInSupportClient()
        user = await makeRegisteredAndLoggedInUser()
        anotherUser = await makeRegisteredAndLoggedInUser()
        anonymous = await makeClient();

        // Create and publish app
        [app] = await createTestB2BApp(user)
        await createTestB2BAppPublishRequest(support, app, {
            isAppTested: true,
            isContractSigned: true,
            isInfoApproved: true,
            status: PUBLISH_REQUEST_APPROVED_STATUS,
        })

        // Publish to dev and prod environments
        await publishB2BAppByTestClient(user, app)
        app = await B2BApp.getOne(user, { id: app.id })
        await updateCondoB2BApp(condoAdmin, { id: app.developmentExportId }, { importId: null, importRemoteSystem: null })
        await publishB2BAppByTestClient(user, app, { info: true }, PROD_ENVIRONMENT)
        app = await B2BApp.getOne(user, { id: app.id })
        await updateCondoB2BApp(condoAdmin, { id: app.productionExportId }, { importId: null, importRemoteSystem: null })
    })

    beforeEach(async () => {
        // Create context in progress status for each test
        const [devContexts] = await createCondoB2BAppContexts(condoAdmin, { id: app.developmentExportId }, 1, CONTEXT_IN_PROGRESS_STATUS)
        devContext = devContexts[0]
        organization = devContext.organization

        const [prodContexts] = await createCondoB2BAppContexts(condoAdmin, { id: app.productionExportId }, 1, CONTEXT_IN_PROGRESS_STATUS)
        prodContext = prodContexts[0]
    })

    describe('Access tests', () => {
        test('Admin can update context for any app', async () => {
            const [result] = await updateB2BAppContextByTestClient(admin, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
            expect(result).toHaveProperty('success', true)

            const updatedContext = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(updatedContext).toHaveProperty('status', CONTEXT_FINISHED_STATUS)
        })

        test('Support can update context for any app', async () => {
            const [result] = await updateB2BAppContextByTestClient(support, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
            expect(result).toHaveProperty('success', true)

            const updatedContext = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(updatedContext).toHaveProperty('status', CONTEXT_FINISHED_STATUS)
        })

        describe('User', () => {
            test('Can update context for his own app', async () => {
                const [result] = await updateB2BAppContextByTestClient(user, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
                expect(result).toHaveProperty('success', true)

                const updatedContext = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
                expect(updatedContext).toHaveProperty('status', CONTEXT_FINISHED_STATUS)
            })

            test('Cannot update context for another user app', async () => {
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await updateB2BAppContextByTestClient(anotherUser, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
                })
            })
        })

        test('Anonymous cannot update any context', async () => {
            await expectToThrowAuthenticationErrorToResult(async () => {
                await updateB2BAppContextByTestClient(anonymous, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
            })
        })
    })

    describe('Logic tests', () => {
        test('Must throw APP_NOT_FOUND error if invalid app id passed', async () => {
            await expectToThrowGQLError(async () => {
                await updateB2BAppContextByTestClient(support, { id: faker.datatype.uuid() }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
            }, {
                code: BAD_USER_INPUT,
                type: 'APP_NOT_FOUND',
            }, 'result')
        })

        test('Must throw B2B_APP_CONTEXT_NOT_FOUND error if organization is wrong', async () => {
            const wrongOrgId = faker.datatype.uuid()
            await expectToThrowGQLError(async () => {
                await updateB2BAppContextByTestClient(support, { id: app.id }, DEV_ENVIRONMENT, { id: wrongOrgId }, CONNECT_ACTION)
            }, {
                code: BAD_USER_INPUT,
                type: 'B2B_APP_CONTEXT_NOT_FOUND',
            }, 'result')
        })

        test('Must throw B2B_APP_CONTEXT_NOT_FOUND error if context was deleted', async () => {
            await CondoB2BAppContext.update(condoAdmin, devContext.id, {
                deletedAt: dayjs().toISOString(),
            })

            await expectToThrowGQLError(async () => {
                await updateB2BAppContextByTestClient(support, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
            }, {
                code: BAD_USER_INPUT,
                type: 'B2B_APP_CONTEXT_NOT_FOUND',
            }, 'result')
        })

        test('Connect action must translate context to finished status', async () => {
            const contextBefore = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(contextBefore).toBeDefined()
            expect(contextBefore).toHaveProperty('status', CONTEXT_IN_PROGRESS_STATUS)

            const [result] = await updateB2BAppContextByTestClient(user, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, CONNECT_ACTION)
            expect(result).toHaveProperty('success', true)

            const contextAfter = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(contextAfter).toBeDefined()
            expect(contextAfter).toHaveProperty('status', CONTEXT_FINISHED_STATUS)
        })

        test('Disconnect action must delete context', async () => {
            const contextBefore = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(contextBefore).toBeDefined()
            expect(contextBefore).toHaveProperty('status', CONTEXT_IN_PROGRESS_STATUS)

            const [result] = await updateB2BAppContextByTestClient(user, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, DISCONNECT_ACTION)
            expect(result).toHaveProperty('success', true)

            const contextAfter = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(contextAfter).toBeUndefined()
        })

        test('Can update context in prod environment', async () => {
            const [result] = await updateB2BAppContextByTestClient(user, { id: app.id }, PROD_ENVIRONMENT, { id: prodContext.organization.id }, CONNECT_ACTION)
            expect(result).toHaveProperty('success', true)

            const updatedContext = await CondoB2BAppContext.getOne(condoAdmin, { id: prodContext.id })
            expect(updatedContext).toHaveProperty('status', CONTEXT_FINISHED_STATUS)
        })

        test('Can disconnect already connected context', async () => {
            await CondoB2BAppContext.update(condoAdmin, devContext.id, {
                status: CONTEXT_FINISHED_STATUS,
            })

            const [result] = await updateB2BAppContextByTestClient(user, { id: app.id }, DEV_ENVIRONMENT, { id: organization.id }, DISCONNECT_ACTION)
            expect(result).toHaveProperty('success', true)

            const contextAfter = await CondoB2BAppContext.getOne(condoAdmin, { id: devContext.id })
            expect(contextAfter).toBeUndefined()
        })
    })
})