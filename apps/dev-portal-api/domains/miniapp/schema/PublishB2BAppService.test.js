/**
 * Generated by `createservice miniapp.PublishB2BAppService`
 */

const { faker } = require('@faker-js/faker')
const dayjs = require('dayjs')

const { generateGqlQueries } = require('@open-condo/codegen/generate.gql')
const { generateGQLTestUtils } = require('@open-condo/codegen/generate.test.utils')
const { GQLErrorCode: { BAD_USER_INPUT, INTERNAL_ERROR } } = require('@open-condo/keystone/errors')
const {
    makeClient,
    expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult,
    expectToThrowGQLError,
} = require('@open-condo/keystone/test.utils')

const { B2B_APP_CATEGORIES } = require('@condo/domains/miniapp/constants')
const { REMOTE_SYSTEM } = require('@dev-portal-api/domains/common/constants/common')
const {
    APP_NOT_FOUND,
    FIRST_PUBLISH_WITHOUT_INFO,
    CONDO_APP_NOT_FOUND,
    PUBLISH_NOT_ALLOWED,
} = require('@dev-portal-api/domains/miniapp/constants/errors')
const { PROD_ENVIRONMENT, PUBLISH_REQUEST_APPROVED_STATUS, DEV_ENVIRONMENT } = require('@dev-portal-api/domains/miniapp/constants/publishing')
const {
    publishB2BAppByTestClient,
    createTestB2BApp,
    updateTestB2BApp,
    B2BApp,
    createTestB2BAppPublishRequest,
    updateTestB2BAppPublishRequest,
    createOIDCClientByTestClient,
    updateCondoB2BApp,
} = require('@dev-portal-api/domains/miniapp/utils/testSchema')
const {
    makeLoggedInAdminClient,
    makeLoggedInSupportClient,
    makeRegisteredAndLoggedInUser,
    makeLoggedInCondoAdminClient,
} = require('@dev-portal-api/domains/user/utils/testSchema')

const CondoB2BApp = generateGQLTestUtils(generateGqlQueries('B2BApp', '{ id name developer developerUrl shortDescription detailedDescription category logo { publicUrl } importId importRemoteSystem deletedAt v oidcClient { id importId importRemoteSystem } }'))
const CondoOIDCClient = generateGQLTestUtils(generateGqlQueries('OidcClient', '{ id deletedAt isEnabled clientId payload }'))

describe('PublishB2BAppService', () => {
    let admin
    let support
    let user
    let anonymous
    let condoAdmin
    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        condoAdmin = await makeLoggedInCondoAdminClient()
        support = await makeLoggedInSupportClient()
        user = await makeRegisteredAndLoggedInUser()
        anonymous = await makeClient()
    })
    describe('Access tests', () => {
        let userApp
        let anotherApp
        beforeAll(async () => {
            [userApp] = await createTestB2BApp(user);
            [anotherApp] = await createTestB2BApp(admin)
        })
        test('Admin can publish any app', async () => {
            const [result] = await publishB2BAppByTestClient(admin, userApp)
            expect(result).toHaveProperty('success', true)
        })
        test('Support can publish any app', async () => {
            const [result] = await publishB2BAppByTestClient(support, userApp)
            expect(result).toHaveProperty('success', true)
        })
        describe('User', () => {
            test('Can publish app if user if app creator', async () => {
                const [result] = await publishB2BAppByTestClient(user, userApp)
                expect(result).toHaveProperty('success', true)
            })
            test('Cannot otherwise', async () => {
                await expectToThrowAccessDeniedErrorToResult(async () => {
                    await publishB2BAppByTestClient(user, anotherApp)
                })
            })
        })
        test('Anonymous cannot', async () => {
            await expectToThrowAuthenticationErrorToResult(async () => {
                await publishB2BAppByTestClient(anonymous, userApp)
            })
        })
    })
    describe('Logic tests', () => {
        describe('B2BAppPublishRequest', () => {
            test('Mutation must throw GQLError if an attempt is made to publish to a production stand without a approved B2BAppPublishRequest for app', async () => {
                const [app] = await createTestB2BApp(user)
                await expectToThrowGQLError(async () => {
                    await publishB2BAppByTestClient(user, app, { info: true }, PROD_ENVIRONMENT)
                }, {
                    code: BAD_USER_INPUT,
                    type: PUBLISH_NOT_ALLOWED,
                }, 'result')
                const [request] = await createTestB2BAppPublishRequest(user, app)
                expect(request).toHaveProperty('id')

                await expectToThrowGQLError(async () => {
                    await publishB2BAppByTestClient(user, app, { info: true }, PROD_ENVIRONMENT)
                }, {
                    code: BAD_USER_INPUT,
                    type: PUBLISH_NOT_ALLOWED,
                }, 'result')

                const [updatedRequest] = await updateTestB2BAppPublishRequest(support, request.id, {
                    isAppTested: true,
                    isContractSigned: true,
                    isInfoApproved: true,
                    status: PUBLISH_REQUEST_APPROVED_STATUS,
                })
                expect(updatedRequest).toHaveProperty('status', PUBLISH_REQUEST_APPROVED_STATUS)

                const [result] = await publishB2BAppByTestClient(user, app, { info: true }, PROD_ENVIRONMENT)
                expect(result).toHaveProperty('success', true)

                const [deletedRequest] = await updateTestB2BAppPublishRequest(support, request.id, {
                    deletedAt: dayjs().toISOString(),
                })
                expect(deletedRequest).toHaveProperty('deletedAt')
                expect(deletedRequest.deletedAt).not.toBeNull()

                await expectToThrowGQLError(async () => {
                    await publishB2BAppByTestClient(user, app, { info: true }, PROD_ENVIRONMENT)
                }, {
                    code: BAD_USER_INPUT,
                    type: PUBLISH_NOT_ALLOWED,
                }, 'result')
            })
        })
        describe('B2BApp', () => {
            let app
            beforeEach(async () => {
                [app] = await createTestB2BApp(user)
            })
            test('Mutation must throw GQLError if app is not found', async () => {
                await expectToThrowGQLError(async () => {
                    await publishB2BAppByTestClient(admin, { id: faker.datatype.uuid() })
                }, {
                    code: BAD_USER_INPUT,
                    type: APP_NOT_FOUND,
                }, 'result')
            })
            test('Info must be included if app was not published before', async () => {
                await expectToThrowGQLError(async () => {
                    await publishB2BAppByTestClient(user, app, {})
                }, {
                    code: BAD_USER_INPUT,
                    type: FIRST_PUBLISH_WITHOUT_INFO,
                }, 'result')
            })
            test('Condo app must be created / updated if info passed as an option', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(apiApp).toHaveProperty('developmentExportId')
                expect(apiApp.developmentExportId).not.toBeNull()

                const createdCondoApp = await CondoB2BApp.getOne(condoAdmin, { id: apiApp.developmentExportId })
                expect(createdCondoApp).toHaveProperty('id', apiApp.developmentExportId)
                expect(createdCondoApp).toHaveProperty('importId', apiApp.id)
                expect(createdCondoApp).toHaveProperty('importRemoteSystem', REMOTE_SYSTEM)
                expect(createdCondoApp).toHaveProperty('deletedAt', null)
                expect(createdCondoApp).toHaveProperty('v', 1)

                const [secondResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(secondResult).toHaveProperty('success', true)

                const updatedCondoApp = await CondoB2BApp.getOne(condoAdmin, { id: apiApp.developmentExportId })
                expect(updatedCondoApp).toHaveProperty('id', apiApp.developmentExportId)
                expect(updatedCondoApp).toHaveProperty('importId', apiApp.id)
                expect(updatedCondoApp).toHaveProperty('importRemoteSystem', REMOTE_SYSTEM)
                expect(updatedCondoApp).toHaveProperty('deletedAt', null)
                expect(updatedCondoApp).toHaveProperty('v', 2)
            })
            test('Condo app must be recreated in case of deletion', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const firstApiApp = await B2BApp.getOne(admin, { id: app.id })
                const firstCondoAppId = firstApiApp.developmentExportId

                const deletedCondoApp = await CondoB2BApp.update(condoAdmin, firstCondoAppId, {
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    deletedAt: dayjs().toISOString(),
                })
                expect(deletedCondoApp.deletedAt).not.toBeNull()

                const [secondResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(secondResult).toHaveProperty('success', true)

                const secondApiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(secondApiApp.developmentExportId).not.toBeNull()
                expect(secondApiApp.developmentExportId).not.toBe(firstCondoAppId)
            })
            test('Publish job must transfer all B2BApp fields properly', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(apiApp).toHaveProperty('developmentExportId')
                expect(apiApp.developmentExportId).not.toBeNull()

                const createdCondoApp = await CondoB2BApp.getOne(condoAdmin, { id: apiApp.developmentExportId })
                expect(createdCondoApp).toHaveProperty('name', app.name)
                expect(createdCondoApp).toHaveProperty('developer', user.user.name)
                // TODO: uncomment once files are done
                // expect(createdCondoApp).toHaveProperty(['logo', 'publicUrl'])
                // const initialLogo = createdCondoApp.logo.publicUrl
                
                const commonPayload = {
                    name: faker.commerce.product(),
                    developer: faker.company.name(),
                    developerUrl: faker.internet.url(),
                    shortDescription: faker.lorem.sentence(),
                    detailedDescription: faker.lorem.paragraph(),
                    category: B2B_APP_CATEGORIES[Math.floor(Math.random() * B2B_APP_CATEGORIES.length)],
                }
                await updateTestB2BApp(user, app.id, commonPayload)

                const [secondResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(secondResult).toHaveProperty('success', true)

                const updatedCondoApp = await CondoB2BApp.getOne(condoAdmin, { id: apiApp.developmentExportId })
                expect(updatedCondoApp).toEqual(expect.objectContaining(commonPayload))
                // expect(updatedCondoApp).toHaveProperty(['logo', 'publicUrl'])
                // expect(updatedCondoApp.logo.publicUrl).not.toBe(initialLogo)
            })
            test('Publishing app with no developer or logo must use author name and default logo', async () => {
                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(apiApp).toHaveProperty('developer', null)
                expect(apiApp).toHaveProperty('logo', null)

                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const createdCondoApp = await CondoB2BApp.getOne(condoAdmin, { importId: apiApp.id, importRemoteSystem: REMOTE_SYSTEM })
                expect(createdCondoApp).toHaveProperty('developer', user.user.name)
                // TODO: uncomment once files are done
                // expect(createdCondoApp).toHaveProperty(['logo', 'publicUrl'])
            })
            test('exportId must be restored from null if condo app was found by importId', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                const condoAppId = apiApp.developmentExportId

                const [updatedApiApp] = await updateTestB2BApp(admin, app.id, { developmentExportId: null })
                expect(updatedApiApp).toHaveProperty('developmentExportId', null)

                const [secondResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(secondResult).toHaveProperty('success', true)

                const finalApiApp = await B2BApp.getOne(user, { id: app.id })
                expect(finalApiApp).toHaveProperty('developmentExportId', condoAppId)

                const condoApps = await CondoB2BApp.getAll(condoAdmin, { importId: app.id, importRemoteSystem: REMOTE_SYSTEM })
                expect(condoApps).toHaveLength(1)
            })
            test('Must update exportId if condo app was found by importId', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                const condoAppId = apiApp.developmentExportId
                const [updatedApiApp] = await updateTestB2BApp(admin, app.id, { developmentExportId: faker.datatype.uuid() })

                expect(updatedApiApp.developmentExportId).not.toEqual(condoAppId)

                const [secondResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(secondResult).toHaveProperty('success', true)

                const finalApiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(finalApiApp).toHaveProperty('developmentExportId', condoAppId)
            })
            test('Must throw an error if condo app was deleted and info is not passed', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(apiApp.developmentExportId).not.toBeNull()
                const condoAppId = apiApp.developmentExportId

                const deletedCondoApp = await CondoB2BApp.update(condoAdmin, condoAppId, {
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    deletedAt: dayjs().toISOString(),
                })
                expect(deletedCondoApp.deletedAt).not.toBeNull()

                await expectToThrowGQLError(async () => {
                    await publishB2BAppByTestClient(user, app, { info: false })
                }, {
                    code: INTERNAL_ERROR,
                    type: CONDO_APP_NOT_FOUND,
                }, 'result')
            })
        })
        describe('OIDCClient', () => {
            let app
            let oidcClient
            beforeEach(async () => {
                [app] = await createTestB2BApp(user);
                [oidcClient] = await createOIDCClientByTestClient(user, app)
            })
            test('Created OIDC client must become enabled after publishing', async () => {
                const condoClientBefore = await CondoOIDCClient.getOne(condoAdmin, { id: oidcClient.id })
                expect(condoClientBefore).toHaveProperty('isEnabled', false)
                expect(condoClientBefore).toHaveProperty('deletedAt', null)
                expect(condoClientBefore).toHaveProperty('payload')
                expect(condoClientBefore).toHaveProperty('clientId')

                const [result] = await publishB2BAppByTestClient(user, app)
                expect(result).toHaveProperty('success', true)

                const condoClientAfter = await CondoOIDCClient.getOne(condoAdmin, { id: oidcClient.id })
                expect(condoClientAfter).toHaveProperty('isEnabled', true)
                expect(condoClientAfter).toHaveProperty('deletedAt', null)
                expect(condoClientAfter).toHaveProperty('clientId', condoClientBefore.clientId)
                expect(condoClientAfter).toHaveProperty('payload', condoClientBefore.payload)
            })
            test('B2BApp must be linked to OIDC client if not linked before', async () => {
                const [result] = await publishB2BAppByTestClient(user, app)
                expect(result).toHaveProperty('success', true)

                const exportField = `${DEV_ENVIRONMENT}ExportId`

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                expect(apiApp).toHaveProperty(exportField)
                expect(apiApp[exportField]).not.toBeNull()


                const condoAppAfter = await CondoB2BApp.getOne(condoAdmin, { id: apiApp[exportField] })
                expect(condoAppAfter).toHaveProperty('oidcClient')
                expect(condoAppAfter.oidcClient).toEqual(expect.objectContaining({
                    id: oidcClient.id,
                    importId: app.id,
                    importRemoteSystem: REMOTE_SYSTEM,
                }))
            })
            test('B2BApp.oidcClient must not be set, if already manually linked', async () => {
                const [anotherApp] = await createTestB2BApp(user)
                const [result] = await publishB2BAppByTestClient(user, anotherApp)
                expect(result).toHaveProperty('success', true)

                const exportField = `${DEV_ENVIRONMENT}ExportId`

                const apiApp = await B2BApp.getOne(admin, { id: anotherApp.id })
                expect(apiApp).toHaveProperty(exportField)
                expect(apiApp[exportField]).not.toBeNull()

                const condoAppId = apiApp[exportField]

                const condoAppBefore = await CondoB2BApp.getOne(condoAdmin, { id: condoAppId })
                expect(condoAppBefore).toHaveProperty('oidcClient', null)

                const [updatedCondoApp] = await updateCondoB2BApp(condoAdmin, { id: condoAppId }, {
                    oidcClient: { connect: { id: oidcClient.id } },
                })

                expect(updatedCondoApp).toHaveProperty(['oidcClient', 'id'], oidcClient.id)

                const [apiClient] = await createOIDCClientByTestClient(user, anotherApp)
                expect(apiClient).toHaveProperty('id')

                const [secondResult] = await publishB2BAppByTestClient(user, anotherApp)
                expect(secondResult).toHaveProperty('success', true)

                const updatedCondoAppAfter = await CondoB2BApp.getOne(condoAdmin, { id: condoAppId })
                expect(updatedCondoAppAfter).toHaveProperty(['oidcClient', 'id'], oidcClient.id)

            })
            test('B2BApp.oidcClient can be overwritten if linked client is deleted', async () => {
                const [anotherApp] = await createTestB2BApp(user)
                const [result] = await publishB2BAppByTestClient(user, anotherApp)
                expect(result).toHaveProperty('success', true)

                const exportField = `${DEV_ENVIRONMENT}ExportId`

                const apiApp = await B2BApp.getOne(admin, { id: anotherApp.id })
                expect(apiApp).toHaveProperty(exportField)
                expect(apiApp[exportField]).not.toBeNull()

                const condoAppId = apiApp[exportField]

                const condoAppBefore = await CondoB2BApp.getOne(condoAdmin, { id: condoAppId })
                expect(condoAppBefore).toHaveProperty('oidcClient', null)

                const [updatedCondoApp] = await updateCondoB2BApp(condoAdmin, { id: condoAppId }, {
                    oidcClient: { connect: { id: oidcClient.id } },
                })

                expect(updatedCondoApp).toHaveProperty(['oidcClient', 'id'], oidcClient.id)

                await CondoOIDCClient.update(condoAdmin, oidcClient.id, {
                    dv: 1,
                    sender: { dv: 1, fingerprint: faker.random.alphaNumeric(8) },
                    deletedAt: dayjs().toISOString(),
                })

                const [apiClient] = await createOIDCClientByTestClient(user, anotherApp)
                expect(apiClient).toHaveProperty('id')

                const [secondResult] = await publishB2BAppByTestClient(user, anotherApp)
                expect(secondResult).toHaveProperty('success', true)

                const updatedCondoAppAfter = await CondoB2BApp.getOne(condoAdmin, { id: condoAppId })
                expect(updatedCondoAppAfter).toHaveProperty(['oidcClient', 'id'], apiClient.id)
            })
            test('B2BApp remains linked to same OIDC client after multiple publishes', async () => {
                const [firstResult] = await publishB2BAppByTestClient(user, app, { info: true })
                expect(firstResult).toHaveProperty('success', true)

                const apiApp = await B2BApp.getOne(admin, { id: app.id })
                const condoAppAfterFirst = await CondoB2BApp.getOne(condoAdmin, { id: apiApp.developmentExportId })
                expect(condoAppAfterFirst.oidcClient.id).toBe(oidcClient.id)

                // Second publish should keep the same OIDC client link
                const [secondResult] = await publishB2BAppByTestClient(user, app)
                expect(secondResult).toHaveProperty('success', true)

                const condoAppAfterSecond = await CondoB2BApp.getOne(condoAdmin, { id: apiApp.developmentExportId })
                expect(condoAppAfterSecond.oidcClient.id).toBe(oidcClient.id)
            })
        })
        test('Publish all at once must work as expected', async () => {
            const [app] = await createTestB2BApp(user)

            const [result] = await publishB2BAppByTestClient(user, app, { info: true })
            expect(result).toHaveProperty('success', true)

            const condoApp = await CondoB2BApp.getOne(condoAdmin, { importId: app.id, importRemoteSystem: REMOTE_SYSTEM })
            expect(condoApp).toHaveProperty('id')
        })
    })
})