/**
 * Generated by `createservice miniapp.PublishB2BAppService`
 */

const { GQLError, GQLErrorCode: { BAD_USER_INPUT, INTERNAL_ERROR } } = require('@open-condo/keystone/errors')
const { GQLCustomSchema } = require('@open-condo/keystone/schema')

const access = require('@dev-portal-api/domains/miniapp/access/PublishB2BAppService')
const { APP_NOT_FOUND, FIRST_PUBLISH_WITHOUT_INFO } = require('@dev-portal-api/domains/miniapp/constants/errors')
const { B2BApp } = require('@dev-portal-api/domains/miniapp/utils/serverSchema')

const B2B_APP_EXPORTED_FIELDS = 'id name developer developerUrl createdBy { name } logo { publicUrl originalFilename } shortDescription detailedDescription category developmentAppUrl productionAppUrl developmentExportId productionExportId'

/**
 * List of possible errors, that this custom schema can throw
 * They will be rendered in documentation section in GraphiQL for this custom schema
 */
const ERRORS = {
    APP_NOT_FOUND: {
        code: BAD_USER_INPUT,
        type: APP_NOT_FOUND,
        message: 'The application with the specified ID was not found',
        messageForUser: 'api.miniapp.B2BApp.APP_NOT_FOUND',
    },
    FIRST_PUBLISH_WITHOUT_INFO: {
        code: BAD_USER_INPUT,
        type: FIRST_PUBLISH_WITHOUT_INFO,
        message: 'The first publication of the application should include information about the application',
        messageForUser: 'api.miniapp.publishB2BApp.FIRST_PUBLISH_WITHOUT_INFO',
    },
}

function getExportIdField (environment) {
    return `${environment}ExportId`
}

const PublishB2BAppService = new GQLCustomSchema('PublishB2BAppService', {
    types: [
        {
            access: true,
            type: 'input B2BAppPublishOptions { info: Boolean }',
        },
        {
            access: true,
            type: 'input PublishB2CAppInput { dv: Int!, sender: SenderFieldInput!, app: B2BAppWhereUniqueInput!, environment: AppEnvironment!, options: B2BAppPublishOptions! }',
        },
        {
            access: true,
            type: 'type PublishB2BAppOutput { success: Boolean! }',
        },
    ],
    
    mutations: [
        {
            access: access.canPublishB2BApp,
            schema: 'publishB2BApp(data: PublishB2BAppInput!): PublishB2BAppOutput',
            resolver: async (parent, args, context, info, extra = {}) => {
                const { data: { app: { id }, options, environment } } = args

                const app = await B2BApp.getOne(
                    context,
                    { id, deletedAt: null },
                    B2B_APP_EXPORTED_FIELDS
                )

                if (!app) {
                    throw new GQLError(ERRORS.APP_NOT_FOUND, context)
                }

                const exportIdField = getExportIdField(environment)
                let exportId = app[exportIdField]

                if (!exportId && !options.info) {
                    throw new GQLError(ERRORS.FIRST_PUBLISH_WITHOUT_INFO, context)
                }

                return {
                    success: false,
                }
            },
        },
    ],
    
})

module.exports = {
    PublishB2BAppService,
}
