/**
 * Generated by `createservice miniapp.AllB2BAppContextsService`
 */

const { GQLCustomSchema } = require('@open-condo/keystone/schema')

const { CondoB2BAppContextGql } = require('@dev-portal-api/domains/condo/gql')
const access = require('@dev-portal-api/domains/miniapp/access/AllB2BAppContextsService')
const { findCondoB2BApp } = require('@dev-portal-api/domains/miniapp/utils/serverSchema/findCondoApp')

const AllB2BAppContextsService = new GQLCustomSchema('AllB2BAppContextsService', {
    types: [
        {
            access: true,
            type: 'input AllB2BAppContextsInput { app: B2BAppWhereUniqueInput!, first: Int!, skip: Int!, environment: AppEnvironment!, search: String }',
        },
        {
            access: true,
            type: 'enum B2BAppContextStatus { InProgress Error Finished }',
        },
        {
            access: true,
            type: 'type OrganizationInfo { id: ID! name: String! tin: String }',
        },
        {
            access: true,
            type: 'type B2BAppContext { id: ID!, status: B2BAppContextStatus!, organization: OrganizationInfo! }',
        },
        {
            access: true,
            type: 'type B2BAppContextMeta { count: Int! }',
        },
        {
            access: true,
            type: 'type AllB2BAppContextsOutput { objs: [B2BAppContext!]!, meta: B2BAppContextMeta! }',
        },
    ],
    
    queries: [
        {
            access: access.canExecuteAllB2BAppContexts,
            schema: 'allB2BAppContexts(data: AllB2BAppContextsInput!): AllB2BAppContextsOutput',
            resolver: async (parent, args, context) => {
                const { data: { first, skip, search } } = args
                const { condoApp, serverClient } = await findCondoB2BApp({ args, context })

                const where = {
                    app: { id: condoApp.id },
                }

                if (search) {
                    where.organization = {
                        OR: [
                            { name_contains_i: search },
                            { tin_contains_i: search },
                        ],
                    }
                }

                return await serverClient.getModelsWithCount({
                    modelGql: CondoB2BAppContextGql,
                    where,
                    first,
                    skip,
                    sortBy: ['status_DESC', 'createdAt_DESC', 'id_ASC'],
                })
            },
        },
    ],
    
})

module.exports = {
    AllB2BAppContextsService,
}
