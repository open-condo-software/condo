/**
 * Generated by `createschema miniapp.B2CApp 'name:Text'`
 */

const path = require('path')

const { faker } = require('@faker-js/faker')
const dayjs = require('dayjs')

const conf = require('@open-condo/config')
const { makeClient } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowGQLError,
    UploadingFile,
} = require('@open-condo/keystone/test.utils')

const { INVALID_MIMETYPE } = require('@dev-portal-api/domains/common/constants/errors')
const {
    B2CApp,
    createTestB2CApp,
    updateTestB2CApp,
    updateTestB2CApps,
} = require('@dev-portal-api/domains/miniapp/utils/testSchema')
const {
    makeLoggedInAdminClient,
    makeLoggedInSupportClient,
    makeRegisteredAndLoggedInUser,
} = require('@dev-portal-api/domains/user/utils/testSchema')

const PNG_LOGO_ASSET_PATH = path.resolve(conf.PROJECT_ROOT, 'apps/dev-portal-api/domains/miniapp/utils/testSchema/assets/logo.png')
const JPG_LOGO_ASSET_PATH = path.resolve(conf.PROJECT_ROOT, 'apps/dev-portal-api/domains/miniapp/utils/testSchema/assets/logo.jpg')

describe('B2CApp', () => {
    let admin
    let support
    let user
    let anotherUser
    let anonymous
    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        support = await makeLoggedInSupportClient()
        user = await makeRegisteredAndLoggedInUser()
        anotherUser = await makeRegisteredAndLoggedInUser()
        anonymous = await makeClient()
    })
    describe('CRUD tests', () => {
        describe('Create', () => {
            test('Admin can', async () => {
                const [app] = await createTestB2CApp(admin)
                expect(app).toHaveProperty('id')
            })
            test('Support can', async () => {
                const [app] = await createTestB2CApp(support)
                expect(app).toHaveProperty('id')
            })
            test('User can', async () => {
                const [app] = await createTestB2CApp(user)
                expect(app).toHaveProperty('id')
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await createTestB2CApp(anonymous)
                })
            })
        })
        describe('Update', () => {
            let app
            beforeAll(async () => {
                [app] = await createTestB2CApp(user)
            })
            test('Admin can', async () => {
                const name = faker.music.songName()
                const [updatedApp] = await updateTestB2CApp(admin, app.id, { name })
                expect(updatedApp).toHaveProperty('name', name)
            })
            test('Support can', async () => {
                const name = faker.music.songName()
                const [updatedApp] = await updateTestB2CApp(support, app.id, { name })
                expect(updatedApp).toHaveProperty('name', name)
            })
            describe('User', () => {
                test('App creator can', async () => {
                    const name = faker.music.songName()
                    const [updatedApp] = await updateTestB2CApp(user, app.id, { name })
                    expect(updatedApp).toHaveProperty('name', name)
                })
                test('Other users cannot', async () => {
                    await expectToThrowAccessDeniedErrorToObj(async () => {
                        const name = faker.music.songName()
                        await updateTestB2CApp(anotherUser, app.id, { name })
                    })
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    const name = faker.music.songName()
                    await updateTestB2CApp(anonymous, app.id, { name })
                })
            })
        })
        describe('Read', () => {
            let app
            beforeAll(async () => {
                [app] = await createTestB2CApp(user)
            })
            test('Admin can', async () => {
                const readApp = await B2CApp.getOne(admin, { id: app.id })
                expect(readApp).toHaveProperty('id', app.id)
            })
            test('Support can', async () => {
                const readApp = await B2CApp.getOne(support, { id: app.id })
                expect(readApp).toHaveProperty('id', app.id)
            })
            describe('User', () => {
                test('App creator can', async () => {
                    const readApp = await B2CApp.getOne(user, { id: app.id })
                    expect(readApp).toHaveProperty('id', app.id)
                })
                test('Other users cannot', async () => {
                    const readApp = await B2CApp.getOne(anotherUser, { id: app.id })
                    expect(readApp).toBeUndefined()
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await B2CApp.getOne(anonymous, { id: app.id })
                })
            })
        })
        describe('Soft-delete', () => {
            let app
            beforeEach(async () => {
                [app] = await createTestB2CApp(user)
            })
            test('Admin can', async () => {
                const [deletedApp] = await updateTestB2CApp(admin, app.id, {
                    deletedAt: dayjs().toISOString(),
                })
                expect(deletedApp).toHaveProperty('deletedAt')
                expect(deletedApp.deletedAt).not.toBeNull()
            })
            test('Support can', async () => {
                const [deletedApp] = await updateTestB2CApp(support, app.id, {
                    deletedAt: dayjs().toISOString(),
                })
                expect(deletedApp).toHaveProperty('deletedAt')
                expect(deletedApp.deletedAt).not.toBeNull()
            })
            describe('User', () => {
                test('App creator can', async () => {
                    const [deletedApp] = await updateTestB2CApp(user, app.id, {
                        deletedAt: dayjs().toISOString(),
                    })
                    expect(deletedApp).toHaveProperty('deletedAt')
                    expect(deletedApp.deletedAt).not.toBeNull()
                })
                test('Other users cannot', async () => {
                    await expectToThrowAccessDeniedErrorToObj(async () => {
                        await updateTestB2CApp(anotherUser, app.id, {
                            deletedAt: dayjs().toISOString(),
                        })
                    })
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObj(async () => {
                    await updateTestB2CApp(anonymous, app.id, {
                        deletedAt: dayjs().toISOString(),
                    })
                })
            })
        })
        test('Hard delete is prohibited', async () => {
            const [app] = await createTestB2CApp(user)
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await B2CApp.delete(admin, app.id)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await B2CApp.delete(support, app.id)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await B2CApp.delete(user, app.id)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await B2CApp.delete(anotherUser, app.id)
            })
            await expectToThrowAccessDeniedErrorToObj(async () => {
                await B2CApp.delete(anonymous, app.id)
            })
        })
        test('Bulk update is supported', async () => {
            const [firstApp] = await createTestB2CApp(user)
            const [secondApp] = await createTestB2CApp(user)
            const name = faker.music.songName()
            const [response] = await updateTestB2CApps(user, [
                { id: firstApp.id, data: { name } },
                { id: secondApp.id, data: { deletedAt: dayjs().toISOString() } },
            ])
            expect(response).toEqual(expect.arrayContaining([
                expect.objectContaining({ id: firstApp.id, name }),
                expect.objectContaining({ id: secondApp.id, deletedAt: expect.stringContaining('') }),
            ]))
        })
    })
    describe('Validations', () => {
        describe('logo', () => {
            test('Png image can be passed', async () => {
                const [app] = await createTestB2CApp(admin, {
                    logo: new UploadingFile(PNG_LOGO_ASSET_PATH),
                })
                expect(app).toHaveProperty(['logo', 'publicUrl'])
                expect(app.logo.publicUrl).not.toBeNull()
            })
            test('Other images cannot', async () => {
                await expectToThrowGQLError(async () => {
                    await createTestB2CApp(admin, { logo: new UploadingFile(JPG_LOGO_ASSET_PATH) })
                }, {
                    code: 'BAD_USER_INPUT',
                    type: INVALID_MIMETYPE,
                    message: 'Attached file have invalid mimetype',
                })
            })
        })
    })
})
