/**
 * Generated by `createschema miniapp.B2BAppPublishRequest 'app:Relationship:B2BApp:CASCADE; status:Text'`
 */

const { userIsAdminOrIsSupport } = require('@open-condo/keystone/access')
const { GQLError, GQLErrorCode: { BAD_USER_INPUT } } = require('@open-condo/keystone/errors')
const { historical, versioned, uuided, tracked, softDeleted, dvAndSender, analytical } = require('@open-condo/keystone/plugins')
const { GQLListSchema } = require('@open-condo/keystone/schema')
const { webHooked } = require('@open-condo/webhooks/plugins')

const access = require('@dev-portal-api/domains/miniapp/access/B2BAppPublishRequest')
const { B2B_APP_PUBLISH_REQUEST_UNIQUE_CONSTRAINT } = require('@dev-portal-api/domains/miniapp/constants/constraints')
const { APPROVE_NOT_ALLOWED } = require('@dev-portal-api/domains/miniapp/constants/errors')
const {
    PUBLISH_REQUEST_APPROVED_STATUS,
    PUBLISH_REQUEST_STATUS_OPTIONS,
    PUBLISH_REQUEST_PENDING_STATUS,
} = require('@dev-portal-api/domains/miniapp/constants/publishing')

const ERRORS = {
    APPROVE_NOT_ALLOWED: {
        code: BAD_USER_INPUT,
        type: APPROVE_NOT_ALLOWED,
        message: `Cannot change status to "${PUBLISH_REQUEST_APPROVED_STATUS}" until all prerequisites are met`,
    },
}


const B2BAppPublishRequest = new GQLListSchema('B2BAppPublishRequest', {
    schemaDoc:
        'A model that determines the ability to publish a mini-application to the production stand, ' +
        'as well as the status of passing the pre-release checkout',
    fields: {
        app: {
            schemaDoc: 'Reference to the application to which this request applies',
            type: 'Relationship',
            ref: 'B2BApp',
            isRequired: true,
            knexOptions: { isNotNullable: true }, // Required relationship only!
            kmigratorOptions: { null: false, on_delete: 'models.CASCADE' },
            access: {
                read: true,
                create: true,
                update: false,
            },
        },
        status: {
            schemaDoc: 'Status of consideration of the current request',
            adminDoc: `You should check all model Checkboxes before moving request to "${PUBLISH_REQUEST_APPROVED_STATUS}" status`,
            type: 'Select',
            dataType: 'string',
            isRequired: true,
            options: PUBLISH_REQUEST_STATUS_OPTIONS,
            defaultValue: PUBLISH_REQUEST_PENDING_STATUS,
            access: {
                read: true,
                create: userIsAdminOrIsSupport,
                update: userIsAdminOrIsSupport,
            },
        },
        isAppTested: {
            schemaDoc:
                'Whether the application has been tested before release. ' +
                'Required prerequisite for obtaining permission to publish',
            type: 'Checkbox',
            isRequired: true,
            defaultValue: false,
            access: {
                read: true,
                create: userIsAdminOrIsSupport,
                update: userIsAdminOrIsSupport,
            },
        },
        isContractSigned: {
            schemaDoc:
                'A partnership agreement must be concluded before publication. ' +
                'This checkbox is responsible for the existence of such a contract. ' +
                'Required prerequisite for obtaining permission to publish',
            type: 'Checkbox',
            isRequired: true,
            defaultValue: false,
            access: {
                read: true,
                create: userIsAdminOrIsSupport,
                update: userIsAdminOrIsSupport,
            },
        },
        isInfoApproved: {
            schemaDoc:
                'Before publishing for the first time, it is necessary to ensure that ' +
                'all information about the application is valid and understandable for the user. ' +
                'Required prerequisite for obtaining permission to publish',
            type: 'Checkbox',
            isRequired: true,
            defaultValue: false,
            access: {
                read: true,
                create: userIsAdminOrIsSupport,
                update: userIsAdminOrIsSupport,
            },
        },
    },
    kmigratorOptions: {
        constraints: [
            {
                type: 'models.UniqueConstraint',
                fields: ['app'],
                condition: 'Q(deletedAt__isnull=True)',
                name: B2B_APP_PUBLISH_REQUEST_UNIQUE_CONSTRAINT,
            },
        ],
    },
    hooks: {
        validateInput ({ resolvedData, existingItem, context }) {
            const newItem = { ...existingItem, ...resolvedData }

            if (newItem['status'] === PUBLISH_REQUEST_APPROVED_STATUS) {
                if (!newItem['isAppTested'] || !newItem['isContractSigned'] || !newItem['isInfoApproved']) {
                    throw new GQLError(ERRORS.APPROVE_NOT_ALLOWED, context)
                }
            }
        },
    },
    plugins: [uuided(), versioned(), tracked(), softDeleted(), dvAndSender(), historical(), webHooked(), analytical()],
    access: {
        read: access.canReadB2BAppPublishRequests,
        create: access.canManageB2BAppPublishRequests,
        update: access.canManageB2BAppPublishRequests,
        delete: false,
        auth: true,
    },
})

module.exports = {
    B2BAppPublishRequest,
}
