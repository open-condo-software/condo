/**
 * Generated by `createschema user.ConfirmEmailAction 'email:Text; code:Text; isVerified:Checkbox; expiresAt:DateTimeUtc; attempts:Integer'`
 */

const {
    makeClient,
    expectToThrowAccessDeniedErrorToObj,
    expectToThrowAccessDeniedErrorToObjects,
    expectToThrowAuthenticationErrorToObj,
    expectToThrowAuthenticationErrorToObjects,
} = require('@open-condo/keystone/test.utils')

const { CONFIRM_PHONE_ACTION_CODE_LENGTH } = require('@dev-api/domains/user/constants')
const {
    ConfirmEmailAction,
    createTestConfirmEmailAction,
    updateTestConfirmPhoneAction,
    makeLoggedInAdminClient,
    makeRegisteredAndLoggedInUser,
    makeLoggedInSupportClient,
    startConfirmPhoneActionByTestClient,
    createTestPhone,
} = require('@dev-api/domains/user/utils/testSchema')

describe('ConfirmEmailAction', () => {
    const actors = {
        admin: undefined,
        support: undefined,
        user: undefined,
        anonymous: undefined,
    }
    beforeAll(async () => {
        actors.admin = await makeLoggedInAdminClient()
        actors.anonymous = await makeClient()
        actors.user = await makeRegisteredAndLoggedInUser()
        actors.support = await makeLoggedInSupportClient()
    })
    describe('CRUD', () => {
        describe('Create', () => {
            test.each(Object.keys(actors))('%p cannot', async (actor) => {
                await expectToThrowAccessDeniedErrorToObj(async () => {
                    await createTestConfirmEmailAction(actors[actor])
                })
            })
        })
        describe('Read', () => {
            test('Admin can', async () => {
                const actions = await ConfirmEmailAction.getAll(actors.admin, {}, { first: 100 })
                expect(actions.length).toBeGreaterThan(0)
            })
            test('Support cannot', async () => {
                await expectToThrowAccessDeniedErrorToObjects(async () => {
                    await ConfirmEmailAction.getAll(actors.support, {})
                })
            })
            test('User cannot', async () => {
                await expectToThrowAccessDeniedErrorToObjects(async () => {
                    await ConfirmEmailAction.getAll(actors.support, {})
                })
            })
            test('Anonymous cannot', async () => {
                await expectToThrowAuthenticationErrorToObjects(async () => {
                    await ConfirmEmailAction.getAll(actors.anonymous, {})
                })
            })
        })
        describe('Update', () => {
            // test('Support cannot', async () => {
            //     await expectToThrowAccessDeniedErrorToObj(async () => {
            //         await updateTestConfirmPhoneAction(actors.support, actionId, {})
            //     })
            // })
            // test('User cannot', async () => {
            //     await expectToThrowAccessDeniedErrorToObj(async () => {
            //         await updateTestConfirmPhoneAction(actors.user, actionId, {})
            //     })
            // })
            // test('Anonymous cannot', async () => {
            //     await expectToThrowAuthenticationErrorToObj(async () => {
            //         await updateTestConfirmPhoneAction(actors.anonymous, actionId, {})
            //     })
            // })
        })
    })
})
