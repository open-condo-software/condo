Condo API может встраиваться в сторонние поверхности и использоваться в качестве бэкенда
в мобильных, веб- и десктопных приложениях.
Для таких интеграций часто требуется уметь авторизовывать пользователей партнёра в Condo API.

Мы используем [Passport.js](https://www.passportjs.org) — популярную библиотеку для Node.js,
позволяющую легко подключать различные механизмы авторизации.

На текущий момент платформа Condo позволяет добавить авторизацию через ваш сервис партнёра, используя протокол [Open ID Connect](https://openid.net/developers/how-connect-works/)


## Протокол Open ID Connect

Чтобы добавить авторизацию в Condo через ваш сервис с использованием OIDC,
вам необходимо реализовать данный протокол на стороне своего бэкенда, став тем самым провайдером OIDC-авторизации для Condo API.

<Alert type='warning'>
Мы настоятельно рекомендуем не реализовывать протокол самостоятельно, а
использовать [одну из сертифицированных библиотек](https://openid.net/developers/certified-openid-connect-implementations/) (раздел Certified OpenID Provider Libraries)
</Alert>

После чего необходимо передать нам следующий набор параметров:

| Название параметра | Описание параметра                                                                                                  | Пример                                    |
|--------------------|---------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
| issuer             | Домен вашего бэкенда, являющегося OIDC-провайдером                                                                  | https://server.example.com                |
| authorizationURL   | API-эндпоинт вашего сервера, который начинает процесс OIDC-авторизации                                              | https://server.example.com/api/oidc/auth  |
| tokenURL           | API-эндпоинт вашего сервера, который используется для обмена кода авторизации на токен вашего API                   | https://server.example.com/api/oidc/token |
| userInfoURL        | API-эндпоинт вашего сервера, который по полученному токену будет отдавать информацию о пользователе                 | https://server.example.com/api/oidc/me    |
| scope              | scope, который необходимо запросить при авторизации, чтобы получить в эндпоинте userInfo всю необходимую информацию | "openid" или "openid user:phone"          |
| clientID           | Идентификатор OIDC-клиента, который будет использовать Condo  для авторизации в вашем сервисе                       | condo-development                         |
| clientSecret       | Секрет OIDC-клиента, использующийся Condo для обработки и дешифрования запросов                                     | ********************************          |                                                                                                | https://localhost:3000/auth/condo/callback |

### Структура userInfo

Особое внимание стоит обратить на эндпоинт `userInfoURL`,
так как именно он отвечает за создание и синхронизацию пользователей в платформе Condo с сервисом партнёра.

В минимальном варианте для корректной привязки пользователя `userInfo` должен возвращать **идентификатор пользователя** в вашем сервисе и его **номер телефона** или **email**.
Имя пользователя - необязательный атрибут в платформе Condo, однако мы настоятельно советуем передавать его дополнительно при наличии.

```json
{
  "sub": "cmd30383l000q07jy8cqo2zd7",
  "phone": "+79990001234",
  "name": "Иван Петров"
}
```

<Alert type='warning'>
Если в вашем сервисе пользователи могут существовать **без подтвержденного телефона или email'а**,
то дополнительно необходимо сообщать статус верификации данного телефона или email'a.
</Alert>

```json
{
  "sub": "cmd30383l000q07jy8cqo2zd7",
  "phone_number": "+79990001234",
  "phone_number_verified": true,
  "email": "i.petrov@example.com",
  "email_verified": false,
  "name": "Иван Петров"
}
```

<Alert type='info'>
Мы также ожидаем, что передаваемые номер телефона будет в нормализованном формате [E.164](https://ru.wikipedia.org/wiki/E.164) (+7XXXYYYYYYYY)
</Alert>

## Как происходит авторизация

После регистрации вас в качестве провайдера авторизации, мы выдадим вам имя вашего провайдера (provider name).
После чего начать процесс авторизации можно, перейдя на endpoint вида `/api/auth/:providerName?userType=...`.

<Alert type='info'>
Для авторизации сотрудников необходимо передать query-параметром `userType=staff`, для авторизации жителей - `userType=resident`
</Alert>

После чего пользователь попадет на страницу авторизации вашего сервиса

