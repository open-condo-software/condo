on:
  workflow_call:
    inputs:
      domain_name:
        required: true
        type: string
      image_name:
        required: true
        type: string
      runs-on:
        required: false
        type: string
        default: ubuntu-latest

jobs:
  tests:
    runs-on: ${{ inputs.runs-on }}

    steps:
      - name: install docker-compose plugin
        uses: open-condo-software/actions-setup-docker-compose@v1
        with:
          version: v2.28.1
      - name: install deps
        run: |
          sudo apt update && sudo apt install -y git

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.SBERCLOUD_CR_USERNAME }}
          password: ${{ secrets.SBERCLOUD_CR_PASSWORD }}

      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.SSH_DOCK_SERVER_PRIVATE_KEY }}
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: run dbs
        env:
          REGISTRY: ${{ secrets.DOCKER_REGISTRY }}/doma/utils/
        run: |
          docker-compose up -d redis postgresdb-master postgresdb-replica

      - name: run tests
        run: |
          mkdir test_logs
          chmod -R a+rw ./test_logs
          docker run -v ./test_logs:/app/test_logs --network="host" ${{ secrets.DOCKER_REGISTRY }}/${{ inputs.image_name }} bash -c "/app/run_condo_domain_tests.sh -d ${{ inputs.domain_name }}"
        env:
          DATABASE_URL: 'custom:{"default":{"read":"postgresql://postgres:postgres@127.0.0.1:5433/condo","write":"postgresql://postgres:postgres@127.0.0.1:5432/condo"}}'
          DATABASE_MAPPING: '[{"match":"*","query":"default","command":"default"}]'

      - name: Collect docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v1
        with:
          dest: './docker-logs'

      - name: Upload log artifact
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs
          path: |
            ./test_logs/*
            *.log
            ./docker-logs
          retention-days: 2
